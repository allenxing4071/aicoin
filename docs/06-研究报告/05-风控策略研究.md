# 风控策略研究

**文档编号**: AICOIN-RESEARCH-005  
**文档版本**: v1.0.0  
**创建日期**: 2025-10-22

---

## 1. 三层风控体系

```
┌────────────────────────────────────┐
│  第一层: 预执行风控                 │
│  - 仓位限制                        │
│  - 止损检查                        │
│  - 单日亏损限制                    │
└────────────────┬───────────────────┘
                 ↓
┌────────────────────────────────────┐
│  第二层: 执行监控                  │
│  - API限速                         │
│  - 滑点控制                        │
│  - 成交确认                        │
└────────────────┬───────────────────┘
                 ↓
┌────────────────────────────────────┐
│  第三层: 应急熔断                  │
│  - 极端行情自动平仓                │
│  - 连续亏损暂停                    │
│  - 人工干预机制                    │
└────────────────────────────────────┘
```

---

## 2. 核心风控规则

### 2.1 仓位限制 (RC-001)

```python
class PositionLimit:
    MAX_SINGLE_POSITION = 0.20  # 单笔最大20%
    
    def check(self, order_size, total_balance):
        if order_size > total_balance * self.MAX_SINGLE_POSITION:
            return False, f"超过仓位限制{self.MAX_SINGLE_POSITION*100}%"
        return True, "OK"

# 示例
总资金: $10,000
单笔限制: $2,000
实际订单: $1,500 ✓
实际订单: $2,500 ✗
```

### 2.2 单日亏损限制 (RC-002)

```python
class DailyLossLimit:
    MAX_DAILY_LOSS = 0.05  # 单日最大亏损5%
    
    def check(self, today_pnl, total_balance):
        loss_pct = -today_pnl / total_balance
        
        if loss_pct > self.MAX_DAILY_LOSS:
            return False, f"达到单日亏损限制{self.MAX_DAILY_LOSS*100}%"
        return True, "OK"

# 示例
总资金: $10,000
今日亏损: -$400 (4%) ✓
今日亏损: -$600 (6%) ✗ → 停止交易
```

### 2.3 最大回撤限制 (RC-003)

```python
class MaxDrawdownLimit:
    MAX_DRAWDOWN = 0.10  # 最大回撤10%
    
    def check(self, current_equity, peak_equity):
        drawdown = (peak_equity - current_equity) / peak_equity
        
        if drawdown > self.MAX_DRAWDOWN:
            return False, "触发最大回撤熔断,全部平仓"
        return True, "OK"

# 示例
历史最高净值: $11,000
当前净值: $10,000
回撤: 9.09% ✓
当前净值: $9,800
回撤: 10.9% ✗ → 强制平仓
```

### 2.4 连续亏损限制 (RC-004)

```python
class ConsecutiveLossLimit:
    MAX_CONSECUTIVE_LOSS = 3
    
    def check(self, recent_trades):
        consecutive_losses = 0
        
        for trade in reversed(recent_trades):
            if trade.pnl < 0:
                consecutive_losses += 1
            else:
                break
        
        if consecutive_losses >= self.MAX_CONSECUTIVE_LOSS:
            return False, "连续亏损3笔,暂停交易,人工审核"
        return True, "OK"
```

---

## 3. 止损策略

### 3.1 固定止损

```python
STOP_LOSS_PCT = 0.03  # 3%固定止损

def check_stop_loss(position):
    if position.unrealized_pnl_pct < -STOP_LOSS_PCT:
        close_position(position)
        log("触发止损: {position.symbol} @ {position.unrealized_pnl_pct}%")
```

### 3.2 追踪止损 (Trailing Stop)

```python
def trailing_stop(position, peak_price):
    """从最高点回撤3%止损"""
    current_price = get_current_price(position.symbol)
    drawdown = (peak_price - current_price) / peak_price
    
    if drawdown > 0.03:
        close_position(position)
        log(f"触发追踪止损: 从${peak_price}回撤至${current_price}")
```

---

## 4. 极端行情应对

### 4.1 熔断机制

```python
def circuit_breaker():
    """极端行情熔断"""
    
    # 条件1: 单日亏损>5%
    if today_loss_pct > 0.05:
        close_all_positions()
        pause_trading(24)  # 暂停24小时
        alert("熔断触发: 单日亏损{today_loss_pct}%")
    
    # 条件2: 总回撤>10%
    if max_drawdown > 0.10:
        close_all_positions()
        pause_trading(72)  # 暂停72小时
        alert("熔断触发: 最大回撤{max_drawdown}%")
    
    # 条件3: 市场波动>20%
    if market_volatility > 0.20:
        reduce_positions(0.5)  # 减仓50%
        alert("高波动预警: {market_volatility}%")
```

---

## 5. 监控与告警

### 5.1 实时监控

```python
@celery_app.task(schedule=60)  # 每分钟检查
def risk_monitoring():
    account = get_account_info()
    
    # 检查各项风控指标
    checks = [
        check_position_limit(),
        check_daily_loss(),
        check_max_drawdown(),
        check_consecutive_loss(),
    ]
    
    # 记录风险事件
    for check_name, passed, reason in checks:
        if not passed:
            log_risk_event(
                event_type=check_name,
                severity="HIGH",
                description=reason
            )
            send_alert(reason)
```

### 5.2 告警级别

| 级别 | 条件 | 响应 |
|------|------|------|
| 🟢 正常 | 所有风控指标正常 | 正常交易 |
| 🟡 警告 | 单日亏损3-5% | 减少交易频率 |
| 🔴 危险 | 单日亏损>5% 或 回撤>10% | 停止交易 |
| ⚫ 紧急 | 连续亏损5笔 或 本金损失>20% | 人工介入,策略评估 |

---

## 6. 风控参数配置

```python
# config/risk_config.py

RISK_CONFIG = {
    # 仓位控制
    "max_single_position": 0.20,  # 20%
    "max_total_position": 0.50,   # 总持仓50%
    
    # 止损
    "stop_loss_pct": 0.03,        # 3%
    "trailing_stop_pct": 0.03,    # 3%
    
    # 亏损限制
    "max_daily_loss": 0.05,       # 5%
    "max_drawdown": 0.10,         # 10%
    "max_consecutive_loss": 3,    # 3笔
    
    # 交易限制
    "max_trades_per_day": 5,
    "min_interval_minutes": 30,   # 最小交易间隔
    
    # 熔断
    "circuit_breaker_daily_loss": 0.05,
    "circuit_breaker_drawdown": 0.10,
}
```

---

## 7. 风控效果评估

### 7.1 回测验证

```python
# 无风控 vs 有风控对比
结果 (模拟数据):

无风控:
- 最大回撤: -25%
- 爆仓次数: 1次
- 月化收益: +15% (但风险极高)

有风控:
- 最大回撤: -8%
- 爆仓次数: 0次
- 月化收益: +10% (风险可控)
- 夏普比率: 1.8 (优秀)
```

---

**文档结束**

