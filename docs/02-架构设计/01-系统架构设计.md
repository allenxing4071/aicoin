# 系统架构设计

**文档编号**: AICOIN-ARCH-001  
**文档版本**: v1.0.0  
**文档状态**: ✅ 已批准  
**创建日期**: 2025-10-22  
**最后更新**: 2025-10-22  
**文档所有者**: 技术负责人  
**审阅人**: 产品经理  
**密级**: 内部公开

---

## 文档修订历史

| 版本 | 日期 | 修订人 | 修订说明 | 审批人 |
|------|------|--------|---------|--------|
| v1.0.0 | 2025-10-22 | 技术负责人 | 初始版本创建 | 产品经理 |

---

## 1. 架构概述

### 1.1 架构目标

- **高可用**: 系统可用性 ≥ 99.5%
- **低延迟**: AI 决策延迟 ≤ 5 秒
- **可扩展**: 支持未来多 AI 模型并行
- **易维护**: 模块化设计，低耦合

### 1.2 技术选型

| 层次 | 技术选型 | 版本 | 选型理由 |
|------|---------|------|---------|
| **前端** | Next.js | 14.x | SSR 性能优秀，开发效率高 |
| **后端** | FastAPI | 0.104+ | 异步高性能，类型安全 |
| **数据库** | PostgreSQL | 15.x | 可靠稳定，支持复杂查询 |
| **缓存** | Redis | 7.x | 高性能内存数据库 |
| **任务队列** | Celery | 5.x | Python 生态成熟 |
| **AI 框架** | LangChain | 0.1.x | LLM 编排标准库 |
| **容器化** | Docker | 24.x | 跨平台部署 |

### 1.3 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Next.js)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ 仪表盘    │  │ K线图表  │  │ 交易历史  │  │ 性能分析  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP/WebSocket
┌────────────────────┴────────────────────────────────────────┐
│                     API 网关层 (FastAPI)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ REST API │  │WebSocket │  │ 认证授权  │  │ 限流控制  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────┐
│                       业务逻辑层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ AI 决策引擎   │  │ 交易执行器    │  │ 风控管理器    │     │
│  │ - LLM 调用   │  │ - 订单管理    │  │ - 仓位控制    │     │
│  │ - Prompt工程 │  │ - 持仓管理    │  │ - 止损机制    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 市场数据服务  │  │ 账户管理      │  │ 性能计算      │     │
│  │ - K线获取    │  │ - 资产查询    │  │ - 夏普比率    │     │
│  │ - 订单簿     │  │ - PnL计算     │  │ - 最大回撤    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────┐
│                       数据访问层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ PostgreSQL   │  │ Redis缓存     │  │ 文件存储      │     │
│  │ - 交易记录    │  │ - 市场数据    │  │ - 日志文件    │     │
│  │ - AI决策日志  │  │ - Session    │  │ - 备份文件    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────────────┐
│                       外部接口层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ Hyperliquid  │  │ DeepSeek API │  │ CoinGecko    │     │
│  │ - 交易执行    │  │ - AI决策     │  │ - 价格数据    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       后台任务层 (Celery)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 交易循环      │  │ 数据采集      │  │ 性能计算      │     │
│  │ 5-15分钟/次   │  │ 1分钟/次      │  │ 1小时/次      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 模块设计

### 2.1 前端模块

#### 2.1.1 项目结构

```
frontend/
├── app/                      # Next.js App Router
│   ├── layout.tsx           # 根布局
│   ├── page.tsx             # 首页
│   ├── dashboard/           # 仪表盘
│   │   ├── page.tsx
│   │   └── components/
│   │       ├── TradingChart.tsx
│   │       ├── PositionPanel.tsx
│   │       ├── TradeHistory.tsx
│   │       └── PerformanceMetrics.tsx
│   └── api/                 # API 路由
│       └── websocket/
├── components/              # 共享组件
│   ├── ui/                 # shadcn/ui组件
│   └── charts/             # 图表组件
├── lib/                    # 工具库
│   ├── api-client.ts       # API客户端
│   ├── websocket.ts        # WebSocket客户端
│   └── utils.ts
├── hooks/                  # 自定义Hooks
│   ├── useWebSocket.ts
│   └── useTrades.ts
├── types/                  # TypeScript类型
└── package.json
```

#### 2.1.2 技术栈

```json
{
  "dependencies": {
    "next": "^14.0.0",
    "react": "^18.0.0",
    "typescript": "^5.0.0",
    "tailwindcss": "^3.4.0",
    "@tanstack/react-query": "^5.0.0",
    "recharts": "^2.10.0",
    "lightweight-charts": "^4.1.0",
    "zustand": "^4.4.0"
  }
}
```

### 2.2 后端模块

#### 2.2.1 项目结构

```
backend/
├── app/
│   ├── main.py              # FastAPI应用入口
│   ├── api/                 # API路由
│   │   ├── v1/
│   │   │   ├── trading.py   # 交易相关API
│   │   │   ├── market.py    # 市场数据API
│   │   │   ├── account.py   # 账户API
│   │   │   └── performance.py
│   │   └── websocket.py     # WebSocket
│   ├── core/                # 核心配置
│   │   ├── config.py        # 配置管理
│   │   ├── security.py      # 安全认证
│   │   └── celery_app.py    # Celery配置
│   ├── models/              # SQLAlchemy模型
│   │   ├── trade.py
│   │   ├── order.py
│   │   └── account.py
│   ├── schemas/             # Pydantic Schemas
│   │   ├── trade.py
│   │   └── market.py
│   ├── services/            # 业务逻辑
│   │   ├── ai/
│   │   │   ├── llm_client.py
│   │   │   ├── prompts.py
│   │   │   └── decision_parser.py
│   │   ├── trading/
│   │   │   ├── executor.py
│   │   │   ├── risk_manager.py
│   │   │   └── order_manager.py
│   │   ├── market/
│   │   │   ├── data_collector.py
│   │   │   └── hyperliquid_client.py
│   │   └── performance/
│   │       └── calculator.py
│   ├── tasks/               # Celery任务
│   │   ├── trading_loop.py
│   │   ├── data_collector.py
│   │   └── metrics_calculator.py
│   ├── utils/               # 工具函数
│   └── tests/               # 测试
├── alembic/                 # 数据库迁移
├── requirements.txt
└── Dockerfile
```

#### 2.2.2 依赖包

```txt
fastapi==0.104.1
uvicorn==0.24.0
sqlalchemy==2.0.23
alembic==1.12.1
redis==5.0.1
celery==5.3.4
langchain==0.1.0
hyperliquid-python-sdk==0.1.0
pydantic==2.5.0
python-jose==3.3.0
passlib==1.7.4
```

---

## 3. 核心流程

### 3.1 AI 决策流程

```
[Celery定时任务] (每5-15分钟)
        ↓
[获取市场数据]
  - K线数据 (最近24根1小时)
  - 订单簿深度 (前20档)
  - 账户状态 (余额/持仓/PnL)
        ↓
[数据标准化]
  - 格式化为Prompt输入
  - 计算技术指标
        ↓
[LLM决策] (DeepSeek API)
  - 调用API
  - 重试机制 (3次)
  - 超时控制 (5秒)
        ↓
[解析决策输出]
  - JSON Schema验证
  - 异常处理
        ↓
[风控验证]
  - 仓位限制检查
  - 止损检查
  - 日亏损检查
        ↓
    通过? ←─┐
      │     │
    是│   否│
      ↓     ↓
[执行订单]  [拒绝订单]
      │         │
      ↓         ↓
[记录日志] [记录拒绝原因]
      │         │
      └────┬────┘
           ↓
   [推送前端更新]
```

### 3.2 订单执行流程

```
[接收AI决策]
      ↓
[订单签名]
  - 使用私钥签名
  - 生成订单ID
      ↓
[提交API] (Hyperliquid)
  - POST /exchange/order
  - 超时: 3秒
      ↓
[等待回执]
      ↓
   成功? ←─┐
     │     │
   是│   否│
     ↓     ↓
[更新数据库] [重试/告警]
  - 订单记录   - 最多3次
  - 持仓更新   - 失败告警
     ↓         │
     └────┬────┘
          ↓
  [计算PnL更新]
          ↓
  [WebSocket推送]
```

### 3.3 实时数据流

```
[Hyperliquid WebSocket]
         ↓
    [接收消息]
    - 实时成交
    - 订单更新
    - 持仓变化
         ↓
   [数据处理]
    - 解析JSON
    - 数据验证
         ↓
   [Redis缓存]
    - 更新缓存
    - 设置TTL
         ↓
 [WebSocket广播]
    - 推送给所有连接的前端
         ↓
   [前端UI更新]
```

---

## 4. 数据流设计

### 4.1 读流程

```
前端请求
    ↓
API网关 (身份验证)
    ↓
业务逻辑层
    ↓
先查Redis缓存
    ↓
  命中? ←─┐
    │     │
  是│   否│
    ↓     ↓
返回缓存  查PostgreSQL
    │         ↓
    │     写入缓存
    │         │
    └────┬────┘
         ↓
    返回前端
```

### 4.2 写流程

```
业务逻辑层
    ↓
写PostgreSQL (事务)
    ↓
  成功?
    │
  是│
    ↓
更新Redis缓存
    ↓
WebSocket推送
    ↓
返回成功响应
```

---

## 5. 安全设计

### 5.1 认证授权

```python
# JWT Token认证
@app.get("/api/v1/protected")
async def protected_route(
    current_user: User = Depends(get_current_user)
):
    return {"user": current_user}
```

### 5.2 私钥管理

```
硬件钱包 (推荐)
    ↓
环境变量 (开发)
    ↓
加密存储 (AES-256)
    ↓
仅在内存中解密
    ↓
用完立即清除
```

### 5.3 API安全

- **速率限制**: 100请求/分钟/IP
- **HTTPS强制**: 生产环境必须
- **CORS**: 仅允许前端域名
- **输入验证**: Pydantic Schema

---

## 6. 性能优化

### 6.1 数据库优化

```sql
-- 索引策略
CREATE INDEX idx_trades_timestamp ON trades(timestamp DESC);
CREATE INDEX idx_trades_symbol ON trades(symbol);
CREATE INDEX idx_ai_decisions_timestamp ON ai_decisions(timestamp DESC);

-- 分区表 (未来)
CREATE TABLE trades_2025_10 PARTITION OF trades
    FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');
```

### 6.2 缓存策略

| 数据类型 | 缓存时长 | 缓存键 |
|---------|---------|--------|
| K线数据 | 60秒 | `kline:{symbol}:{interval}` |
| 订单簿 | 10秒 | `orderbook:{symbol}` |
| 账户余额 | 5秒 | `account:{user_id}` |
| 性能指标 | 60分钟 | `metrics:performance` |

### 6.3 异步处理

```python
# 所有I/O操作异步化
async def get_market_data():
    async with aiohttp.ClientSession() as session:
        tasks = [
            fetch_kline(session, "BTC-PERP"),
            fetch_orderbook(session, "BTC-PERP"),
        ]
        results = await asyncio.gather(*tasks)
        return results
```

---

## 7. 可扩展性设计

### 7.1 水平扩展

```
负载均衡 (Nginx)
    │
    ├─> API实例1 (Docker)
    ├─> API实例2 (Docker)
    └─> API实例3 (Docker)
         │
         └─> PostgreSQL (主从复制)
              └─> Redis (集群)
```

### 7.2 模块化设计

```python
# 插件式AI模型
class BaseAITrader(ABC):
    @abstractmethod
    async def make_decision(self, market_data):
        pass

class DeepSeekTrader(BaseAITrader):
    async def make_decision(self, market_data):
        # DeepSeek实现
        pass

class ClaudeTrader(BaseAITrader):
    async def make_decision(self, market_data):
        # Claude实现
        pass

# 工厂模式切换
def get_trader(model_name: str):
    traders = {
        "deepseek": DeepSeekTrader(),
        "claude": ClaudeTrader(),
    }
    return traders[model_name]
```

---

## 8. 监控与日志

### 8.1 日志策略

```python
import logging

# 日志配置
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)

# 结构化日志
logger.info("AI决策", extra={
    "symbol": "BTC-PERP",
    "action": "BUY",
    "confidence": 0.85,
    "timestamp": datetime.now()
})
```

### 8.2 监控指标

| 指标类型 | 指标名称 | 告警阈值 |
|---------|---------|---------|
| 性能 | API响应时间 | P95 > 200ms |
| 性能 | 数据库查询时间 | P95 > 100ms |
| 可用性 | 服务健康检查 | 失败 |
| 业务 | AI调用成功率 | < 99% |
| 业务 | 订单执行成功率 | < 99% |

---

## 9. 部署架构

### 9.1 Docker Compose

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: aicoin
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  backend:
    build: ./backend
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    environment:
      DATABASE_URL: postgresql://admin:${DB_PASSWORD}@postgres:5432/aicoin
      REDIS_URL: redis://redis:6379
    depends_on:
      - postgres
      - redis
    ports:
      - "8000:8000"

  celery_worker:
    build: ./backend
    command: celery -A app.core.celery_app worker -l info
    depends_on:
      - redis
      - postgres

  celery_beat:
    build: ./backend
    command: celery -A app.core.celery_app beat -l info
    depends_on:
      - redis

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend

volumes:
  postgres_data:
  redis_data:
```

### 9.2 生产环境

```
[Cloudflare CDN]
       ↓
[Nginx反向代理]
       │
       ├─> Next.js (3000)
       └─> FastAPI (8000)
              ↓
       [Docker Swarm / K8s]
              ↓
       [PostgreSQL + Redis]
```

---

## 10. 附录

### A. 技术决策记录

| 决策ID | 决策内容 | 理由 | 日期 |
|--------|---------|------|------|
| TD-001 | 选择FastAPI而非Django | 异步性能更好，适合实时系统 | 2025-10-22 |
| TD-002 | 选择PostgreSQL而非MongoDB | 金融数据需要事务保证 | 2025-10-22 |
| TD-003 | 前端使用Next.js SSR | SEO友好，首屏加载快 | 2025-10-22 |

### B. 相关文档

| 文档编号 | 文档名称 |
|---------|---------|
| ARCH-002 | 数据库设计 |
| ARCH-003 | API设计规范 |
| ARCH-005 | AI决策引擎设计 |

### C. 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.0.0 | 2025-10-22 | 初始版本 | 技术负责人 |

---

**文档结束**

> 📌 下一步：请阅读 [数据库设计 (AICOIN-ARCH-002)](./02-数据库设计.md)

