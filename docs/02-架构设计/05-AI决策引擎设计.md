# AI决策引擎设计

**文档编号**: AICOIN-ARCH-005  
**文档版本**: v1.0.0  
**文档状态**: ✅ 已批准  
**创建日期**: 2025-10-22  
**最后更新**: 2025-10-22  
**文档所有者**: 技术负责人  
**密级**: 内部公开

---

## 1. 架构设计

```
市场数据 → 数据标准化 → Prompt构建 → LLM调用 → 决策解析 → 风控验证
```

---

## 2. Prompt模板

```python
TRADING_PROMPT = """
你是专业的加密货币交易AI，目标是最大化夏普比率。

当前市场数据:
- 交易对: {symbol}
- 当前价格: ${current_price}
- 24小时K线: {kline_summary}
- 订单簿压力: 买盘{bid_strength}% vs 卖盘{ask_strength}%

账户状态:
- 可用余额: ${available_balance} USDC
- 当前持仓: {position_size} {symbol} @ ${entry_price}
- 未实现盈亏: ${unrealized_pnl} ({unrealized_pnl_pct}%)

交易规则:
1. 单笔仓位 ≤ 20%总资金
2. 单日最大亏损 ≤ 5%
3. 优先低频高胜率策略（参考DeepSeek: 18笔/月，胜率70%）
4. 避免频繁交易，关注关键价格发现机会

请分析市场并做出决策，返回JSON格式:
{{
    "action": "BUY" | "SELL" | "HOLD",
    "size": 交易数量（0表示不交易）,
    "confidence": 0-1的信心水平,
    "reasoning": "简明决策理由（50字内）"
}}
"""
```

---

## 3. LLM集成

### 3.1 DeepSeek API
```python
from openai import AsyncOpenAI

client = AsyncOpenAI(
    api_key=DEEPSEEK_API_KEY,
    base_url="https://api.deepseek.com"
)

async def call_deepseek(prompt: str):
    response = await client.chat.completions.create(
        model="deepseek-chat",
        messages=[
            {"role": "system", "content": "你是专业交易AI"},
            {"role": "user", "content": prompt}
        ],
        temperature=0.7,
        max_tokens=500
    )
    return response.choices[0].message.content
```

### 3.2 重试机制
```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10)
)
async def call_llm_with_retry(prompt):
    return await call_deepseek(prompt)
```

---

## 4. 决策解析

```python
from pydantic import BaseModel

class TradingDecision(BaseModel):
    action: Literal["BUY", "SELL", "HOLD"]
    size: float
    confidence: float
    reasoning: str

def parse_decision(llm_output: str) -> TradingDecision:
    import json
    data = json.loads(llm_output)
    return TradingDecision(**data)
```

---

## 5. 性能优化

### 5.1 缓存策略
- 相似市场状态缓存决策（5分钟TTL）
- 减少30-50%API调用

### 5.2 批量处理
- 同时决策多个交易对
- 合并Prompt减少token消耗

---

**文档结束**

