# 数据库设计

**文档编号**: AICOIN-ARCH-002  
**文档版本**: v1.0.0  
**文档状态**: ✅ 已批准  
**创建日期**: 2025-10-22  
**最后更新**: 2025-10-22  
**文档所有者**: 技术负责人  
**审阅人**: 产品经理  
**密级**: 内部公开

---

## 1. ER图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   trades    │       │   orders    │       │ai_decisions │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id (PK)     │◄──────│ id (PK)     │       │ id (PK)     │
│ order_id(FK)│       │ trade_id    │       │ timestamp   │
│ symbol      │       │ symbol      │       │ market_data │
│ side        │       │ side        │       │ decision    │
│ price       │       │ type        │       │ executed    │
│ size        │       │ price       │       └─────────────┘
│ pnl         │       │ size        │
│ timestamp   │       │ status      │
└─────────────┘       │ created_at  │
                      └─────────────┘
        ↓
┌─────────────────┐
│account_snapshots│
├─────────────────┤
│ id (PK)         │
│ timestamp       │
│ balance         │
│ equity          │
│ sharpe_ratio    │
└─────────────────┘
```

---

## 2. 表结构

### 2.1 trades (交易记录表)

```sql
CREATE TABLE trades (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id),
    symbol VARCHAR(20) NOT NULL,
    side VARCHAR(10) NOT NULL CHECK (side IN ('BUY', 'SELL')),
    price DECIMAL(18, 8) NOT NULL,
    size DECIMAL(18, 8) NOT NULL,
    pnl DECIMAL(18, 8),
    fee DECIMAL(18, 8),
    ai_reasoning TEXT,
    confidence DECIMAL(3, 2),
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_trades_timestamp (timestamp DESC),
    INDEX idx_trades_symbol (symbol),
    INDEX idx_trades_side (side)
);
```

### 2.2 orders (订单表)

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    trade_id INTEGER,
    symbol VARCHAR(20) NOT NULL,
    side VARCHAR(10) NOT NULL,
    type VARCHAR(10) NOT NULL CHECK (type IN ('MARKET', 'LIMIT')),
    price DECIMAL(18, 8),
    size DECIMAL(18, 8) NOT NULL,
    filled_size DECIMAL(18, 8) DEFAULT 0,
    status VARCHAR(20) NOT NULL CHECK (status IN ('PENDING', 'FILLED', 'CANCELLED', 'FAILED')),
    exchange_order_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_orders_status (status),
    INDEX idx_orders_created (created_at DESC)
);
```

### 2.3 ai_decisions (AI决策日志表)

```sql
CREATE TABLE ai_decisions (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    symbol VARCHAR(20) NOT NULL,
    market_data JSONB NOT NULL,
    decision JSONB NOT NULL,
    executed BOOLEAN DEFAULT FALSE,
    reject_reason TEXT,
    model_name VARCHAR(50) DEFAULT 'deepseek',
    latency_ms INTEGER,
    created_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_ai_timestamp (timestamp DESC),
    INDEX idx_ai_executed (executed),
    INDEX idx_ai_symbol (symbol)
);
```

### 2.4 account_snapshots (账户快照表)

```sql
CREATE TABLE account_snapshots (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    balance DECIMAL(18, 8) NOT NULL,
    equity DECIMAL(18, 8) NOT NULL,
    unrealized_pnl DECIMAL(18, 8),
    realized_pnl DECIMAL(18, 8),
    sharpe_ratio DECIMAL(10, 4),
    max_drawdown DECIMAL(5, 4),
    total_trades INTEGER DEFAULT 0,
    win_rate DECIMAL(5, 4),
    created_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_account_timestamp (timestamp DESC)
);
```

### 2.5 market_data_kline (K线数据表)

```sql
CREATE TABLE market_data_kline (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    interval VARCHAR(10) NOT NULL,
    open_time TIMESTAMP NOT NULL,
    close_time TIMESTAMP NOT NULL,
    open DECIMAL(18, 8) NOT NULL,
    high DECIMAL(18, 8) NOT NULL,
    low DECIMAL(18, 8) NOT NULL,
    close DECIMAL(18, 8) NOT NULL,
    volume DECIMAL(18, 8) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(symbol, interval, open_time),
    INDEX idx_kline_symbol_interval_time (symbol, interval, open_time DESC)
);
```

### 2.6 risk_events (风控事件表)

```sql
CREATE TABLE risk_events (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
    event_type VARCHAR(50) NOT NULL,
    severity VARCHAR(20) NOT NULL CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    description TEXT NOT NULL,
    related_trade_id INTEGER REFERENCES trades(id),
    action_taken TEXT,
    resolved BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_risk_timestamp (timestamp DESC),
    INDEX idx_risk_severity (severity)
);
```

---

## 3. 索引策略

| 表名 | 索引名 | 索引列 | 索引类型 | 目的 |
|------|--------|--------|---------|------|
| trades | idx_trades_timestamp | timestamp DESC | B-Tree | 按时间查询 |
| trades | idx_trades_symbol | symbol | B-Tree | 按品种查询 |
| orders | idx_orders_status | status | B-Tree | 按状态查询 |
| ai_decisions | idx_ai_timestamp | timestamp DESC | B-Tree | 最近决策 |
| market_data_kline | idx_kline_unique | symbol,interval,open_time | B-Tree | 唯一约束 |

---

## 4. 数据保留策略

| 表名 | 保留时长 | 归档策略 |
|------|---------|---------|
| trades | 永久 | 无 |
| orders | 永久 | 无 |
| ai_decisions | 永久 | 无 |
| account_snapshots | 永久 | 无 |
| market_data_kline | 永久 | 分区表（未来） |
| risk_events | 1年 | 自动归档 |

---

## 5. 备份策略

- **全量备份**: 每日凌晨3点
- **增量备份**: 每6小时
- **保留周期**: 30天
- **备份存储**: 本地 + 云端

---

**文档结束**

