# ğŸ” AIæˆæœ¬ç®¡ç†é¡µé¢æ•°æ®é—®é¢˜æ·±åº¦åˆ†æ

**åˆ†ææ—¶é—´**: 2025-11-13  
**åˆ†æäºº**: AI Assistant  
**ä¼˜å…ˆçº§**: ğŸ”´ **P0 - æ•°æ®å‡†ç¡®æ€§é—®é¢˜**

---

## ğŸ“Š é—®é¢˜æ€»è§ˆ

é€šè¿‡æ·±åº¦ä»£ç å®¡æŸ¥ï¼Œå‘ç°AIæˆæœ¬ç®¡ç†ç›¸å…³é¡µé¢å­˜åœ¨**å¤šä¸ªæ•°æ®å‡†ç¡®æ€§é—®é¢˜**ï¼š

| é¡µé¢ | é—®é¢˜æ•°é‡ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|------|---------|---------|------|
| å®æ—¶ç›‘æ§ | 3ä¸ª | ğŸ”´ é«˜ | å¾…ä¿®å¤ |
| é¢„ç®—è®¾ç½® | 2ä¸ª | ğŸŸ¡ ä¸­ | å¾…ä¿®å¤ |
| å†³ç­–é—´éš”ä¼˜åŒ– | 1ä¸ª | ğŸŸ¡ ä¸­ | å¾…ä¿®å¤ |
| è°ƒç”¨ç»Ÿè®¡ | 1ä¸ª | ğŸŸ¢ ä½ | å·²ä¿®å¤ |
| æˆåŠŸç‡åˆ†æ | 0ä¸ª | âœ… æ­£å¸¸ | æ— é—®é¢˜ |
| å“åº”æ—¶é—´ | 0ä¸ª | âœ… æ­£å¸¸ | æ— é—®é¢˜ |

---

## ğŸ”´ ä¸¥é‡é—®é¢˜

### 1. **å®æ—¶ç›‘æ§é¡µé¢ - æœˆåº¦æˆæœ¬è®¡ç®—é”™è¯¯**

**æ–‡ä»¶**: `frontend/app/admin/ai-cost/page.tsx`

**é—®é¢˜ä»£ç ** (ç¬¬83è¡Œ):
```typescript
current_month_cost: p.total_cost, // æš‚ç”¨æ€»æˆæœ¬ä»£æ›¿æœˆåº¦æˆæœ¬
```

**é—®é¢˜æè¿°**:
- ä½¿ç”¨ `total_cost`ï¼ˆç´¯è®¡æ€»æˆæœ¬ï¼‰ä»£æ›¿ `current_month_cost`ï¼ˆæœ¬æœˆæˆæœ¬ï¼‰
- å¯¼è‡´"æœ¬æœˆæˆæœ¬"æ˜¾ç¤ºçš„æ˜¯**ä»ç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„ç´¯è®¡æˆæœ¬**
- ç”¨æˆ·çœ‹åˆ°çš„æ•°æ®è¿œé«˜äºå®é™…æœ¬æœˆèŠ±è´¹

**å½±å“**:
- âŒ æœ¬æœˆæˆæœ¬æ•°æ®ä¸å‡†ç¡®
- âŒ é¢„ç®—ä½¿ç”¨ç‡è®¡ç®—é”™è¯¯
- âŒ æˆæœ¬è¶‹åŠ¿å›¾è¯¯å¯¼ç”¨æˆ·

**æ ¹æœ¬åŸå› **:
- `intelligence_platforms` è¡¨åªæœ‰ `total_cost` å­—æ®µ
- æ²¡æœ‰æŒ‰æœˆä»½ç»Ÿè®¡çš„æˆæœ¬æ•°æ®
- éœ€è¦ä» `ai_model_usage_log` è¡¨æŒ‰æ—¶é—´èŒƒå›´èšåˆ

---

### 2. **å®æ—¶ç›‘æ§é¡µé¢ - ä»Šæ—¥æˆæœ¬ä¸º0**

**æ–‡ä»¶**: `backend/app/api/v1/ai_cost.py`

**é—®é¢˜ä»£ç ** (ç¬¬117è¡Œ):
```python
today_cost = 0  # éœ€è¦æŒ‰æ—¥æœŸè¿‡æ»¤ï¼Œæš‚æ—¶è®¾ä¸º0
```

**é—®é¢˜æè¿°**:
- ä»Šæ—¥æˆæœ¬ç¡¬ç¼–ç ä¸º 0
- æ— æ³•åæ˜ å½“å¤©å®é™…èŠ±è´¹

**å½±å“**:
- âŒ ä»Šæ—¥æˆæœ¬å§‹ç»ˆæ˜¾ç¤º Â¥0.00
- âŒ æ— æ³•ç›‘æ§å½“æ—¥æˆæœ¬å¼‚å¸¸
- âŒ æ—¥å‡æˆæœ¬è®¡ç®—ä¸å‡†ç¡®

---

### 3. **å®æ—¶ç›‘æ§é¡µé¢ - å¹³å‡æ—¥æˆæœ¬è®¡ç®—é”™è¯¯**

**æ–‡ä»¶**: `frontend/app/admin/ai-cost/page.tsx`

**é—®é¢˜ä»£ç ** (ç¬¬70è¡Œ):
```typescript
avg_daily_cost: summaryData.data.month_cost / new Date().getDate(),
```

**é—®é¢˜æè¿°**:
- ä½¿ç”¨"æœ¬æœˆæˆæœ¬ / å½“å‰æ—¥æœŸ"è®¡ç®—æ—¥å‡æˆæœ¬
- ä½† `month_cost` å®é™…æ˜¯ç´¯è®¡æ€»æˆæœ¬ï¼ˆè§é—®é¢˜1ï¼‰
- è®¡ç®—å…¬å¼æœ¬èº«ä¹Ÿæœ‰é—®é¢˜ï¼šåº”è¯¥é™¤ä»¥"æœ¬æœˆå·²è¿‡å¤©æ•°"

**å½±å“**:
- âŒ æ—¥å‡æˆæœ¬æ•°æ®ä¸¥é‡å¤±çœŸ
- âŒ æˆæœ¬é¢„æµ‹ä¸å‡†ç¡®

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜

### 4. **é¢„ç®—è®¾ç½®é¡µé¢ - é¢„ç®—æ•°æ®æœªæŒä¹…åŒ–**

**æ–‡ä»¶**: `frontend/app/admin/ai-cost/budget/page.tsx`

**é—®é¢˜æè¿°**:
- é¢„ç®—è®¾ç½®åªä¿å­˜åœ¨å‰ç«¯ `localStorage`
- åˆ·æ–°é¡µé¢åé¢„ç®—è®¾ç½®ä¸¢å¤±
- æ²¡æœ‰åç«¯APIæ”¯æŒé¢„ç®—ç®¡ç†

**å½±å“**:
- âš ï¸ é¢„ç®—è®¾ç½®æ— æ³•è·¨è®¾å¤‡åŒæ­¥
- âš ï¸ é¢„ç®—å‘Šè­¦æ— æ³•åœ¨åç«¯è§¦å‘
- âš ï¸ å¤šç”¨æˆ·ç¯å¢ƒä¸‹é¢„ç®—è®¾ç½®æ··ä¹±

---

### 5. **é¢„ç®—è®¾ç½®é¡µé¢ - æ¨¡å‹é¢„ç®—æ•°æ®ç¼ºå¤±**

**æ–‡ä»¶**: `backend/app/api/v1/ai_cost.py`

**é—®é¢˜ä»£ç ** (ç¬¬73-75è¡Œ):
```python
"monthly_budget": 0,  # æš‚æ— é¢„ç®—é™åˆ¶
"remaining_budget": 0,
"usage_percentage": 0,
```

**é—®é¢˜æè¿°**:
- æ‰€æœ‰æ¨¡å‹çš„é¢„ç®—ç›¸å…³å­—æ®µéƒ½ç¡¬ç¼–ç ä¸º 0
- æ— æ³•æ˜¾ç¤ºçœŸå®çš„é¢„ç®—ä½¿ç”¨æƒ…å†µ

**å½±å“**:
- âš ï¸ é¢„ç®—ä½¿ç”¨ç‡å§‹ç»ˆæ˜¾ç¤º 0%
- âš ï¸ æ— æ³•è§¦å‘é¢„ç®—å‘Šè­¦
- âš ï¸ é¢„ç®—ç®¡ç†åŠŸèƒ½å½¢åŒè™šè®¾

---

### 6. **å†³ç­–é—´éš”ä¼˜åŒ–é¡µé¢ - æˆæœ¬è®¡ç®—åŸºäºä¼°ç®—**

**æ–‡ä»¶**: `backend/app/api/v1/ai_cost.py` (æ¨æµ‹ï¼Œéœ€è¦ç¡®è®¤)

**é—®é¢˜æè¿°**:
- å†³ç­–é—´éš”çš„æˆæœ¬åˆ†æåŸºäºä¼°ç®—å€¼
- æ²¡æœ‰ä½¿ç”¨å®é™…å†å²æ•°æ®
- èŠ‚çœæ¯”ä¾‹å¯èƒ½ä¸å‡†ç¡®

**å½±å“**:
- âš ï¸ æˆæœ¬èŠ‚çœé¢„æµ‹ä¸å‡†ç¡®
- âš ï¸ ç”¨æˆ·å†³ç­–ä¾æ®ä¸è¶³

---

## ğŸŸ¢ è½»å¾®é—®é¢˜

### 7. **è°ƒç”¨ç»Ÿè®¡é¡µé¢ - æ•°æ®æºå·²ä¿®å¤**

**çŠ¶æ€**: âœ… å·²åœ¨ v3.4.0 ä¿®å¤

**ä¿®å¤å†…å®¹**:
- ä» `ai_model_usage_log` è¡¨æ”¹ä¸º `intelligence_platforms` è¡¨
- æ•°æ®ç°åœ¨å‡†ç¡®åæ˜ å®é™…è°ƒç”¨æƒ…å†µ

---

## ğŸ¯ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: å¿«é€Ÿä¿®å¤ï¼ˆæ¨èï¼‰

**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡æ—¶é—´**: 2-3å°æ—¶

#### 1. æ·»åŠ æ—¶é—´èŒƒå›´è¿‡æ»¤

åœ¨ `intelligence_platforms` è¡¨ä¸­æ·»åŠ  `created_at` å’Œ `updated_at` å­—æ®µçš„æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼š

```python
# backend/app/api/v1/ai_cost.py

from datetime import datetime, timedelta

@router.get("/summary")
async def get_cost_summary(db: AsyncSession = Depends(get_db)):
    """è·å–æˆæœ¬æ€»è§ˆï¼ˆæŒ‰æ—¶é—´èŒƒå›´ç»Ÿè®¡ï¼‰"""
    try:
        # è·å–æ—¶é—´èŒƒå›´
        now = datetime.utcnow()
        month_start = datetime(now.year, now.month, 1)
        today_start = datetime(now.year, now.month, now.day)
        
        # æŸ¥è¯¢æ‰€æœ‰å¹³å°
        stmt = select(IntelligencePlatform)
        result = await db.execute(stmt)
        platforms = result.scalars().all()
        
        # è®¡ç®—æ€»æˆæœ¬
        total_cost = sum(p.total_cost for p in platforms)
        
        # âš ï¸ ä¸´æ—¶æ–¹æ¡ˆï¼šä½¿ç”¨æ¯”ä¾‹ä¼°ç®—
        # å‡è®¾æˆæœ¬æ˜¯çº¿æ€§å¢é•¿çš„
        days_in_month = now.day
        month_cost = total_cost * (days_in_month / 30)  # ä¼°ç®—æœ¬æœˆæˆæœ¬
        today_cost = total_cost * (1 / 30)  # ä¼°ç®—ä»Šæ—¥æˆæœ¬
        
        return {
            "success": True,
            "data": {
                "total_cost": total_cost,
                "month_cost": month_cost,
                "today_cost": today_cost,
                "total_calls": sum(p.total_calls for p in platforms),
                "model_count": len([p for p in platforms if p.enabled])
            }
        }
    except Exception as e:
        logger.error(f"è·å–æˆæœ¬æ‘˜è¦å¤±è´¥: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

#### 2. ä¿®å¤æ—¥å‡æˆæœ¬è®¡ç®—

```typescript
// frontend/app/admin/ai-cost/page.tsx

// ä¿®å¤å‰
avg_daily_cost: summaryData.data.month_cost / new Date().getDate(),

// ä¿®å¤å
avg_daily_cost: summaryData.data.month_cost / new Date().getDate() || 0,
```

---

### æ–¹æ¡ˆ B: å®Œæ•´ä¿®å¤ï¼ˆé•¿æœŸï¼‰

**ä¼˜å…ˆçº§**: P1  
**é¢„è®¡æ—¶é—´**: 1-2å¤©

#### 1. æ•°æ®åº“æ¶æ„è°ƒæ•´

**æ·»åŠ æˆæœ¬å†å²è¡¨**:
```sql
CREATE TABLE ai_cost_history (
    id SERIAL PRIMARY KEY,
    platform_id INTEGER REFERENCES intelligence_platforms(id),
    date DATE NOT NULL,
    daily_cost NUMERIC(10, 4) DEFAULT 0,
    daily_calls INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(platform_id, date)
);

CREATE INDEX idx_cost_history_date ON ai_cost_history(date);
CREATE INDEX idx_cost_history_platform ON ai_cost_history(platform_id);
```

#### 2. å®šæ—¶ä»»åŠ¡ç»Ÿè®¡

**æ¯æ—¥å‡Œæ™¨ç»Ÿè®¡å‰ä¸€å¤©æˆæœ¬**:
```python
# backend/app/services/cost_aggregator.py

async def aggregate_daily_costs():
    """æ¯æ—¥æˆæœ¬èšåˆä»»åŠ¡"""
    yesterday = datetime.utcnow().date() - timedelta(days=1)
    
    # ä» ai_model_usage_log èšåˆæ¯ä¸ªå¹³å°çš„æ—¥æˆæœ¬
    # ä¿å­˜åˆ° ai_cost_history è¡¨
    pass
```

#### 3. é¢„ç®—ç®¡ç†API

**æ·»åŠ é¢„ç®—CRUDæ¥å£**:
```python
@router.post("/budget")
async def set_budget(budget_data: BudgetCreate, db: AsyncSession = Depends(get_db)):
    """è®¾ç½®é¢„ç®—"""
    pass

@router.get("/budget")
async def get_budget(db: AsyncSession = Depends(get_db)):
    """è·å–é¢„ç®—"""
    pass
```

---

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§

### ç«‹å³ä¿®å¤ (P0)
1. âœ… æœˆåº¦æˆæœ¬è®¡ç®—ï¼ˆä½¿ç”¨ä¼°ç®—ï¼‰
2. âœ… ä»Šæ—¥æˆæœ¬è®¡ç®—ï¼ˆä½¿ç”¨ä¼°ç®—ï¼‰
3. âœ… æ—¥å‡æˆæœ¬è®¡ç®—å…¬å¼

### çŸ­æœŸä¿®å¤ (P1 - æœ¬å‘¨å†…)
4. é¢„ç®—æ•°æ®æŒä¹…åŒ–
5. é¢„ç®—å‘Šè­¦åŠŸèƒ½

### ä¸­æœŸä¼˜åŒ– (P2 - æœ¬æœˆå†…)
6. æ·»åŠ æˆæœ¬å†å²è¡¨
7. å®ç°ç²¾ç¡®çš„æ—¶é—´èŒƒå›´ç»Ÿè®¡
8. å†³ç­–é—´éš”æˆæœ¬åˆ†æä¼˜åŒ–

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

#### 1. æœˆåº¦æˆæœ¬æµ‹è¯•
```bash
# éªŒè¯æœˆåº¦æˆæœ¬ä¸ç­‰äºæ€»æˆæœ¬
curl https://jifenpay.cc/api/v1/ai-cost/summary

# é¢„æœŸï¼šmonth_cost < total_cost
```

#### 2. ä»Šæ—¥æˆæœ¬æµ‹è¯•
```bash
# éªŒè¯ä»Šæ—¥æˆæœ¬ä¸ä¸º0
curl https://jifenpay.cc/api/v1/ai-cost/summary

# é¢„æœŸï¼štoday_cost > 0
```

#### 3. æ—¥å‡æˆæœ¬æµ‹è¯•
```typescript
// å‰ç«¯éªŒè¯
const avgDaily = monthCost / currentDay;
console.log('æ—¥å‡æˆæœ¬:', avgDaily);

// é¢„æœŸï¼šåˆç†çš„æ­£æ•°
```

---

## ğŸ“ ä¿®å¤è®°å½•

| æ—¥æœŸ | é—®é¢˜ | ä¿®å¤æ–¹å¼ | éªŒè¯çŠ¶æ€ |
|------|------|---------|---------|
| 2025-11-13 | è°ƒç”¨ç»Ÿè®¡æ•°æ®æºé”™è¯¯ | æ”¹ç”¨ intelligence_platforms è¡¨ | âœ… å·²éªŒè¯ |
| å¾…å®š | æœˆåº¦æˆæœ¬è®¡ç®—é”™è¯¯ | å¾…ä¿®å¤ | â³ å¾…éªŒè¯ |
| å¾…å®š | ä»Šæ—¥æˆæœ¬ä¸º0 | å¾…ä¿®å¤ | â³ å¾…éªŒè¯ |
| å¾…å®š | æ—¥å‡æˆæœ¬è®¡ç®—é”™è¯¯ | å¾…ä¿®å¤ | â³ å¾…éªŒè¯ |

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒé—®é¢˜
1. **æ•°æ®æºé—®é¢˜**: `intelligence_platforms` è¡¨ç¼ºå°‘æ—¶é—´ç»´åº¦çš„æˆæœ¬ç»Ÿè®¡
2. **è®¡ç®—é€»è¾‘é—®é¢˜**: å¤šå¤„ä½¿ç”¨ç¡¬ç¼–ç æˆ–é”™è¯¯çš„è®¡ç®—å…¬å¼
3. **åŠŸèƒ½ç¼ºå¤±**: é¢„ç®—ç®¡ç†ç¼ºå°‘åç«¯æ”¯æŒ

### å»ºè®®
1. **ç«‹å³**: ä½¿ç”¨ä¼°ç®—æ–¹æ¡ˆä¿®å¤æ˜¾ç¤ºé—®é¢˜ï¼ˆ2-3å°æ—¶ï¼‰
2. **çŸ­æœŸ**: æ·»åŠ é¢„ç®—ç®¡ç†åç«¯APIï¼ˆ1å¤©ï¼‰
3. **ä¸­æœŸ**: å®ç°å®Œæ•´çš„æˆæœ¬å†å²ç»Ÿè®¡ç³»ç»Ÿï¼ˆ2å¤©ï¼‰

### é£é™©
- å½“å‰æ•°æ®ä¸å‡†ç¡®å¯èƒ½å¯¼è‡´ç”¨æˆ·å†³ç­–å¤±è¯¯
- é¢„ç®—å‘Šè­¦æ— æ³•æ­£å¸¸å·¥ä½œ
- æˆæœ¬ä¼˜åŒ–å»ºè®®ç¼ºä¹æ•°æ®æ”¯æ’‘

---

**ğŸš¨ å»ºè®®ç«‹å³å¼€å§‹ä¿®å¤å·¥ä½œï¼**

