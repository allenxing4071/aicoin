# Promptç³»ç»Ÿåœ¨AIcoinç³»ç»Ÿä¸­çš„å®Œæ•´ä½“ç°

## ğŸ¯ ç³»ç»Ÿæ¶æ„å…¨æ™¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AIcoin æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ                            â”‚
â”‚                     (Promptç³»ç»Ÿæ·±åº¦é›†æˆ)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                           â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ å‰ç«¯UI  â”‚               â”‚  åç«¯API   â”‚            â”‚  å†³ç­–å¼•æ“   â”‚
   â”‚ (React) â”‚               â”‚ (FastAPI)  â”‚            â”‚ (AI Core)   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
        â”‚                           â”‚                           â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  Promptç®¡ç†é¡µé¢          â”‚    â”‚    â”‚  DecisionEngineV2          â”‚
   â”‚  /admin/prompts-v2/      â”‚â—„â”€â”€â”€â”¼â”€â”€â”€â–ºâ”‚  (æ ¸å¿ƒå†³ç­–å¼•æ“)            â”‚
   â”‚                          â”‚    â”‚    â”‚                            â”‚
   â”‚  â€¢ åˆ—è¡¨é¡µ                â”‚    â”‚    â”‚  â€¢ é›†æˆPromptManagerDB    â”‚
   â”‚  â€¢ ç¼–è¾‘é¡µ                â”‚    â”‚    â”‚  â€¢ æ ¹æ®L0-L5åŠ è½½Prompt    â”‚
   â”‚  â€¢ A/Bæµ‹è¯•é¡µ             â”‚    â”‚    â”‚  â€¢ æ™ºèƒ½æ¨èæœ€ä½³Prompt     â”‚
   â”‚  â€¢ é£é™©æŒ‡æ ‡é¡µ            â”‚    â”‚    â”‚  â€¢ è®°å½•åˆ°ä¸‰å±‚è®°å¿†         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                             â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                             â”‚  APIè·¯ç”±    â”‚
                             â”‚  /prompts/  â”‚
                             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚                           â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ PostgreSQL  â”‚         â”‚     Redis      â”‚       â”‚     Qdrant       â”‚
   â”‚ (æŒä¹…åŒ–)    â”‚         â”‚   (ç¼“å­˜å±‚)     â”‚       â”‚   (å‘é‡æ£€ç´¢)     â”‚
   â”‚             â”‚         â”‚                â”‚       â”‚                  â”‚
   â”‚ â€¢ Promptè¡¨  â”‚         â”‚ â€¢ 5åˆ†é’ŸTTL     â”‚       â”‚ â€¢ æ€§èƒ½å‘é‡       â”‚
   â”‚ â€¢ ç‰ˆæœ¬è¡¨    â”‚         â”‚ â€¢ çƒ­é‡è½½       â”‚       â”‚ â€¢ ç›¸ä¼¼åœºæ™¯       â”‚
   â”‚ â€¢ æ€§èƒ½è¡¨    â”‚         â”‚ â€¢ Pub/Sub      â”‚       â”‚ â€¢ æ™ºèƒ½æ¨è       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ 1. åç«¯é›†æˆç‚¹ï¼ˆBackendï¼‰

### 1.1 ä¸»åº”ç”¨å…¥å£ (`app/main.py`)

**ä½ç½®**: `backend/app/main.py:16`

```python
from app.api.v1 import prompts  # Promptæ¨¡æ¿ç®¡ç†
```

**APIè·¯ç”±æ³¨å†Œ**: `backend/app/main.py:340-344`

```python
# v3.5: Promptæ¨¡æ¿ç®¡ç†ï¼ˆå€Ÿé‰´NOFXï¼‰
app.include_router(
    prompts.router,
    prefix=f"{settings.API_V1_PREFIX}/prompts/v2",
    tags=["Prompt Template Management"]
)
```

**è®¿é—®åœ°å€**: `http://localhost:8000/api/v1/prompts/v2/`

---

### 1.2 APIè·¯ç”±å±‚ (`app/api/v1/prompts.py`)

**æ–‡ä»¶**: `backend/app/api/v1/prompts.py` (323è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
```python
router = APIRouter()

# CRUDæ“ä½œ
@router.get("/")                    # è·å–æ‰€æœ‰Prompt
@router.get("/{prompt_id}")         # è·å–å•ä¸ªPrompt
@router.post("/")                   # åˆ›å»ºPrompt
@router.put("/{prompt_id}")         # æ›´æ–°Prompt
@router.delete("/{prompt_id}")      # åˆ é™¤Prompt

# çƒ­é‡è½½
@router.post("/reload")             # çƒ­é‡è½½æ‰€æœ‰Prompt

# ç‰ˆæœ¬ç®¡ç†
@router.get("/{prompt_id}/versions")  # è·å–ç‰ˆæœ¬å†å²
@router.post("/{prompt_id}/rollback") # å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬

# DeepSeekæ™ºèƒ½ä¼˜åŒ–
@router.post("/{prompt_id}/optimize") # AIä¼˜åŒ–Prompt

# æ€§èƒ½åˆ†æ
@router.get("/{prompt_id}/metrics")   # è·å–é£é™©æŒ‡æ ‡
@router.get("/{prompt_id}/ab-tests")  # è·å–A/Bæµ‹è¯•ç»“æœ
```

**APIæ–‡æ¡£**: `http://localhost:8000/docs#/Prompt%20Template%20Management`

---

### 1.3 æ ¸å¿ƒå†³ç­–å¼•æ“ (`DecisionEngineV2`)

**æ–‡ä»¶**: `backend/app/services/decision/decision_engine_v2.py`

**é›†æˆä½ç½®**: Line 20, 72-75, 399-410

```python
from app.services.decision.prompt_manager_db import PromptManagerDB

class DecisionEngineV2:
    def __init__(self, ...):
        # åˆå§‹åŒ–Promptç®¡ç†å™¨ï¼ˆæ•°æ®åº“ç‰ˆæœ¬ï¼‰
        self.prompt_manager = PromptManagerDB(db_session)
        self._prompt_manager_initialized = False
        logger.info("âœ… Promptç®¡ç†å™¨ï¼ˆæ•°æ®åº“ç‰ˆï¼‰åˆå§‹åŒ–æˆåŠŸ")
    
    async def make_decision(self, market_data, account_state):
        # === ç¬¬3æ­¥ï¼šæ„å»ºPrompt ===
        logger.info("ğŸ“ æ„å»ºå†³ç­–Prompt...")
        
        # ç¡®ä¿Promptç®¡ç†å™¨å·²åŠ è½½
        await self._ensure_prompt_manager_loaded()
        
        # è·å–å¯¹åº”æƒé™ç­‰çº§çš„Promptæ¨¡æ¿
        template = self.prompt_manager.get_template(
            category="decision",
            name="default",
            permission_level=self.current_permission_level  # L0-L5
        )
        
        if template:
            # ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“
            prompt = template.render(
                market_data=market_data,
                account_state=account_state,
                constraints=constraints,
                memory=memory_context
            )
```

**å…³é”®æµç¨‹**:
1. æ ¹æ®ç”¨æˆ·å½“å‰æƒé™ç­‰çº§ï¼ˆL0-L5ï¼‰åŠ è½½å¯¹åº”Prompt
2. ä½¿ç”¨Jinja2æ¨¡æ¿å¼•æ“æ¸²æŸ“åŠ¨æ€æ•°æ®
3. è°ƒç”¨DeepSeek APIè¿›è¡Œå†³ç­–
4. è®°å½•Promptä½¿ç”¨æƒ…å†µåˆ°ä¸‰å±‚è®°å¿†

---

### 1.4 Promptç®¡ç†å™¨ (`PromptManagerDB`)

**æ–‡ä»¶**: `backend/app/services/decision/prompt_manager_db.py` (291è¡Œ)

**æ ¸å¿ƒç±»**:

```python
class PromptManagerDB:
    """
    Promptæ¨¡æ¿ç®¡ç†å™¨ï¼ˆæ•°æ®åº“ç‰ˆ - æ€§èƒ½ä¼˜åŒ–ç‰ˆï¼‰
    
    ä¸‰çº§ç¼“å­˜ç­–ç•¥ï¼š
    1. å†…å­˜ç¼“å­˜ï¼ˆ60ç§’ï¼‰
    2. Redisç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰
    3. PostgreSQLæ•°æ®åº“
    """
    
    async def load_from_db(self, force_reload=False):
        """ä»æ•°æ®åº“åŠ è½½Promptï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        # 1. æ£€æŸ¥å†…å­˜ç¼“å­˜
        if not force_reload and self.templates:
            return
        
        # 2. å°è¯•ä»RedisåŠ è½½
        if self.redis_client:
            cached = await self.redis_client.get(key)
            if cached:
                return
        
        # 3. ä»PostgreSQLåŠ è½½
        templates = await self.db.execute(query)
        
        # 4. å†™å…¥Redisç¼“å­˜
        await self.redis_client.set(key, data, expire=300)
    
    def get_template(self, category, name, permission_level):
        """è·å–Promptæ¨¡æ¿ï¼ˆæ”¯æŒL0-L5æƒé™ï¼‰"""
        # ä¼˜å…ˆçº§ï¼š
        # 1. ç‰¹å®šç­‰çº§æ¨¡æ¿ï¼ˆå¦‚ï¼šdecision/default/L3ï¼‰
        # 2. é€šç”¨æ¨¡æ¿ï¼ˆå¦‚ï¼šdecision/defaultï¼‰
        # 3. å†…ç½®é»˜è®¤æ¨¡æ¿
```

**ä½¿ç”¨çš„åœ°æ–¹**:
- `DecisionEngineV2` - å†³ç­–å¼•æ“
- `DebateSystem` - è¾©è®ºç³»ç»Ÿ
- `IntelligenceAgent` - æƒ…æŠ¥ç³»ç»Ÿ

---

### 1.5 è¾©è®ºç³»ç»Ÿé›†æˆ (`DebateSystem`)

**æ–‡ä»¶**: `backend/app/services/decision/debate_system.py`

```python
from app.services.decision.prompt_manager_db import PromptManagerDB

class DebateCoordinator:
    def __init__(self, ...):
        self.prompt_manager = PromptManagerDB(db_session)
    
    async def run_debate(self, ...):
        # è·å–è¾©è®ºPrompt
        template = self.prompt_manager.get_template(
            category="debate",
            name="bull_bear",
            permission_level=permission_level
        )
```

---

### 1.6 ä¸‰å±‚è®°å¿†é›†æˆ

#### çŸ­æœŸè®°å¿†ï¼ˆRedisï¼‰
**æ–‡ä»¶**: `backend/app/services/memory/prompt_memory_extension.py`

```python
class PromptMemoryExtension:
    """æ‰©å±•çŸ­æœŸè®°å¿†ï¼Œè¿½è¸ªPromptä½¿ç”¨"""
    
    async def record_prompt_usage(self, prompt_id, decision_id):
        """è®°å½•Promptä½¿ç”¨æƒ…å†µ"""
        await self.redis.hset(
            f"prompt:usage:{prompt_id}",
            decision_id,
            json.dumps({"timestamp": now, "result": result})
        )
```

#### é•¿æœŸè®°å¿†ï¼ˆQdrantï¼‰
**æ–‡ä»¶**: `backend/app/services/memory/prompt_performance_memory.py`

```python
class PromptPerformanceMemory:
    """Qdrantå‘é‡å­˜å‚¨ - Promptæ€§èƒ½è®°å¿†"""
    
    async def recommend_best_prompt(self, market_data, permission_level):
        """æ™ºèƒ½æ¨èæœ€ä½³Promptï¼ˆåŸºäºå†å²æ€§èƒ½ï¼‰"""
        # 1. å‘é‡åŒ–å½“å‰å¸‚åœºçŠ¶æ€
        embedding = await self.get_embedding(market_data)
        
        # 2. åœ¨Qdrantä¸­æœç´¢ç›¸ä¼¼åœºæ™¯
        similar_scenarios = await self.qdrant.search(
            collection="prompt_performance",
            vector=embedding,
            filter={"permission_level": permission_level}
        )
        
        # 3. è¿”å›å†å²è¡¨ç°æœ€å¥½çš„Prompt
        return best_prompt
```

#### çŸ¥è¯†åº“ï¼ˆPostgreSQLï¼‰
**æ–‡ä»¶**: `backend/app/services/memory/prompt_knowledge_aggregator.py`

```python
class PromptKnowledgeAggregator:
    """èšåˆPromptæ€§èƒ½æ•°æ®åˆ°çŸ¥è¯†åº“"""
    
    async def aggregate_daily_performance(self):
        """æ¯æ—¥èšåˆPromptæ€§èƒ½"""
        # ä»Qdrantè¯»å–ä»Šæ—¥æ‰€æœ‰Promptæ€§èƒ½
        # è®¡ç®—èƒœç‡ã€å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤
        # å†™å…¥PostgreSQLçš„prompt_performanceè¡¨
```

---

### 1.7 æ€§èƒ½ä¼˜åŒ–ç»„ä»¶

#### Redisç¼“å­˜ä¼˜åŒ–
**æ–‡ä»¶**: `backend/app/services/memory/prompt_performance_memory_optimized.py`

```python
class PromptPerformanceMemoryOptimized:
    """Qdrantæ™ºèƒ½ç¼“å­˜ï¼ˆRedisåŠ é€Ÿï¼‰"""
    
    async def get_similar_prompts(self, context, embedding):
        # 1. å°è¯•ä»Redisè·å–ï¼ˆåŸºäºå¸‚åœºçŠ¶æ€ï¼‰
        cache_key = self._build_cache_key(context)
        cached = await self.redis.get(cache_key)
        if cached:
            return json.loads(cached)  # 5-10ms
        
        # 2. Qdrantå‘é‡æ£€ç´¢
        results = await self.qdrant.search(...)  # 150-300ms
        
        # 3. å†™å…¥Redisï¼ˆ10åˆ†é’ŸTTLï¼‰
        await self.redis.set(cache_key, json.dumps(results), ex=600)
```

#### DeepSeekæµå¼å“åº”
**æ–‡ä»¶**: `backend/app/services/decision/decision_engine_optimized.py`

```python
class DecisionEnginePerformanceOptimizer:
    """å†³ç­–å¼•æ“æ€§èƒ½ä¼˜åŒ–å™¨"""
    
    async def call_llm_stream(self, prompt):
        """æµå¼è°ƒç”¨DeepSeekï¼ˆé™ä½25-40%å»¶è¿Ÿï¼‰"""
        response = await self.client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": prompt}],
            stream=True  # å¯ç”¨æµå¼
        )
        
        full_content = ""
        async for chunk in response:
            content = chunk.choices[0].delta.content
            full_content += content
            # è¾¹æ¥æ”¶è¾¹å¤„ç†
        
        return full_content
```

---

## ğŸ“ 2. å‰ç«¯é›†æˆç‚¹ï¼ˆFrontendï¼‰

### 2.1 ç®¡ç†åå°èœå•

**æ–‡ä»¶**: `frontend/app/admin/layout.tsx`

**èœå•é¡¹**ï¼ˆéœ€è¦æ·»åŠ ï¼‰:
```typescript
{
  key: 'prompts',
  icon: <FileTextOutlined />,
  label: <Link href="/admin/prompts-v2">Promptç®¡ç†</Link>,
  children: [
    {
      key: 'prompts-list',
      label: <Link href="/admin/prompts-v2">æ¨¡æ¿åˆ—è¡¨</Link>
    },
    {
      key: 'prompts-ab-tests',
      label: <Link href="/admin/prompts-v2/ab-tests">A/Bæµ‹è¯•</Link>
    }
  ]
}
```

---

### 2.2 Promptç®¡ç†é¡µé¢

#### æ—§ç‰ˆï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰
**è·¯å¾„**: `/admin/prompts/`  
**æ–‡ä»¶**: `frontend/app/admin/prompts/page.tsx` (309è¡Œ)

**åŠŸèƒ½**:
- ğŸ“ æ–‡ä»¶ç³»ç»Ÿç®¡ç†
- ğŸ“ åœ¨çº¿ç¼–è¾‘
- ğŸ”„ çƒ­é‡è½½

**çŠ¶æ€**: âš ï¸ å·²å¼ƒç”¨ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰

---

#### æ–°ç‰ˆï¼ˆæ•°æ®åº“ç‰ˆï¼‰
**è·¯å¾„**: `/admin/prompts-v2/`  
**æ–‡ä»¶**: `frontend/app/admin/prompts-v2/page.tsx` (172è¡Œ)

**åŠŸèƒ½**:
```typescript
export default function PromptsV2Page() {
  // 1. ç­›é€‰åŠŸèƒ½
  const [selectedCategory, setSelectedCategory] = useState('all')
  const [selectedLevel, setSelectedLevel] = useState('all')
  
  // 2. åˆ—è¡¨å±•ç¤º
  const fetchPrompts = async () => {
    const response = await fetch('/api/prompts/v2/')
    const data = await response.json()
    setPrompts(data)
  }
  
  // 3. çƒ­é‡è½½
  const handleReload = async () => {
    await fetch('/api/prompts/v2/reload', { method: 'POST' })
  }
  
  return (
    <div>
      {/* ç­›é€‰å™¨ */}
      <select value={selectedCategory}>
        <option value="decision">å†³ç­–</option>
        <option value="debate">è¾©è®º</option>
        <option value="intelligence">æƒ…æŠ¥</option>
      </select>
      
      <select value={selectedLevel}>
        <option value="L0">L0 - æåº¦ä¿å®ˆ</option>
        <option value="L1">L1 - ä¿å®ˆç¨³å¥</option>
        <option value="L2">L2 - å¹³è¡¡å‹</option>
        <option value="L3">L3 - ç§¯æè¿›å–</option>
        <option value="L4">L4 - é«˜é£é™©</option>
        <option value="L5">L5 - æé™æ¿€è¿›</option>
      </select>
      
      {/* Promptåˆ—è¡¨ */}
      {prompts.map(prompt => (
        <Card key={prompt.id}>
          <h3>{prompt.name}</h3>
          <Badge>{prompt.permission_level}</Badge>
          <Button onClick={() => router.push(`/admin/prompts-v2/${prompt.id}/edit`)}>
            ç¼–è¾‘
          </Button>
        </Card>
      ))}
    </div>
  )
}
```

---

### 2.3 Promptç¼–è¾‘é¡µé¢

**è·¯å¾„**: `/admin/prompts-v2/[id]/edit`  
**æ–‡ä»¶**: `frontend/app/admin/prompts-v2/[id]/edit/page.tsx` (148è¡Œ)

**åŠŸèƒ½**:
```typescript
export default function PromptEditPage() {
  return (
    <div className="grid grid-cols-2 gap-4">
      {/* å·¦ä¾§ï¼šå½“å‰ç‰ˆæœ¬ */}
      <div>
        <h3>å½“å‰ç‰ˆæœ¬ (v{currentVersion})</h3>
        <Textarea value={currentContent} readOnly />
      </div>
      
      {/* å³ä¾§ï¼šç¼–è¾‘åŒº */}
      <div>
        <h3>ç¼–è¾‘ä¸­</h3>
        <Textarea value={editedContent} onChange={...} />
        
        {/* DeepSeekæ™ºèƒ½ä¼˜åŒ–æŒ‰é’® */}
        <Button onClick={handleOptimize}>
          ğŸ¤– DeepSeekæ™ºèƒ½ä¼˜åŒ–
        </Button>
        
        {/* ä¿å­˜é€‰é¡¹ */}
        <Button onClick={() => handleSave('new_version')}>
          ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬
        </Button>
        <Button onClick={() => handleSave('replace')}>
          æ›¿æ¢å½“å‰ç‰ˆæœ¬
        </Button>
      </div>
    </div>
  )
}
```

---

### 2.4 A/Bæµ‹è¯•é¡µé¢

**è·¯å¾„**: `/admin/prompts-v2/ab-tests`  
**æ–‡ä»¶**: `frontend/app/admin/prompts-v2/ab-tests/page.tsx` (104è¡Œ)

**åŠŸèƒ½**:
```typescript
export default function ABTestsPage() {
  return (
    <div>
      {/* åˆ›å»ºA/Bæµ‹è¯• */}
      <Button onClick={handleCreateTest}>åˆ›å»ºæ–°æµ‹è¯•</Button>
      
      {/* æµ‹è¯•åˆ—è¡¨ */}
      {tests.map(test => (
        <Card key={test.id}>
          <h3>{test.name}</h3>
          <p>Prompt A: {test.prompt_a_name} vs Prompt B: {test.prompt_b_name}</p>
          <p>æµé‡åˆ†é…: {test.traffic_split}%</p>
          <Badge>{test.status}</Badge>
          
          {/* å®æ—¶ç»“æœ */}
          {test.status === 'running' && (
            <div>
              <p>Aç»„èƒœç‡: {test.a_win_rate}%</p>
              <p>Bç»„èƒœç‡: {test.b_win_rate}%</p>
              <p>ç»Ÿè®¡æ˜¾è‘—æ€§: {test.p_value < 0.05 ? 'âœ… æ˜¾è‘—' : 'âš ï¸ ä¸æ˜¾è‘—'}</p>
            </div>
          )}
        </Card>
      ))}
    </div>
  )
}
```

---

### 2.5 é£é™©æŒ‡æ ‡é¡µé¢

**è·¯å¾„**: `/admin/prompts-v2/[id]/metrics`  
**æ–‡ä»¶**: `frontend/app/admin/prompts-v2/[id]/metrics/page.tsx` (133è¡Œ)

**åŠŸèƒ½**:
```typescript
export default function PromptMetricsPage() {
  return (
    <div>
      {/* å…³é”®æŒ‡æ ‡å¡ç‰‡ */}
      <div className="grid grid-cols-4 gap-4">
        <Card>
          <h4>èƒœç‡</h4>
          <p className="text-3xl">{metrics.win_rate}%</p>
        </Card>
        
        <Card>
          <h4>å¤æ™®æ¯”ç‡</h4>
          <p className="text-3xl">{metrics.sharpe_ratio}</p>
        </Card>
        
        <Card>
          <h4>æœ€å¤§å›æ’¤</h4>
          <p className="text-3xl text-red-500">{metrics.max_drawdown}%</p>
        </Card>
        
        <Card>
          <h4>VaR (95%)</h4>
          <p className="text-3xl">{metrics.var_95}%</p>
        </Card>
      </div>
      
      {/* æ€§èƒ½æ›²çº¿å›¾ */}
      <Card>
        <h3>ç´¯è®¡æ”¶ç›Šæ›²çº¿</h3>
        <LineChart data={metrics.pnl_curve} />
      </Card>
      
      {/* å¸‚åœºçŠ¶æ€åˆ†æ */}
      <Card>
        <h3>ä¸åŒå¸‚åœºçŠ¶æ€ä¸‹çš„è¡¨ç°</h3>
        <BarChart data={metrics.performance_by_regime} />
      </Card>
    </div>
  )
}
```

---

## ğŸ“ 3. æ•°æ®åº“é›†æˆç‚¹ï¼ˆDatabaseï¼‰

### 3.1 PostgreSQLè¡¨ç»“æ„

**æ–‡ä»¶**: `backend/app/models/prompt_template.py`

```sql
-- 1. Promptæ¨¡æ¿è¡¨
CREATE TABLE prompt_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    category VARCHAR(50) NOT NULL,
    permission_level VARCHAR(10),  -- L0-L5
    content TEXT NOT NULL,
    version INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 2. Promptç‰ˆæœ¬å†å²è¡¨
CREATE TABLE prompt_template_versions (
    id SERIAL PRIMARY KEY,
    prompt_template_id INTEGER REFERENCES prompt_templates(id),
    version INTEGER NOT NULL,
    content TEXT NOT NULL,
    change_summary TEXT,
    created_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. Promptæ€§èƒ½è¡¨
CREATE TABLE prompt_performance (
    id SERIAL PRIMARY KEY,
    prompt_template_id INTEGER REFERENCES prompt_templates(id),
    permission_level VARCHAR(10),
    total_uses INTEGER DEFAULT 0,
    win_count INTEGER DEFAULT 0,
    loss_count INTEGER DEFAULT 0,
    total_pnl DECIMAL(20, 8) DEFAULT 0,
    sharpe_ratio DECIMAL(10, 4),
    max_drawdown DECIMAL(10, 4),
    last_updated TIMESTAMP DEFAULT NOW()
);

-- 4. Prompt A/Bæµ‹è¯•è¡¨
CREATE TABLE prompt_ab_tests (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    prompt_a_id INTEGER REFERENCES prompt_templates(id),
    prompt_b_id INTEGER REFERENCES prompt_templates(id),
    traffic_split INTEGER DEFAULT 50,  -- Aç»„æµé‡ç™¾åˆ†æ¯”
    status VARCHAR(20) DEFAULT 'pending',  -- pending/running/completed
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    a_win_rate DECIMAL(10, 4),
    b_win_rate DECIMAL(10, 4),
    p_value DECIMAL(10, 6),  -- ç»Ÿè®¡æ˜¾è‘—æ€§
    winner VARCHAR(10),  -- 'A' or 'B' or 'tie'
    created_at TIMESTAMP DEFAULT NOW()
);
```

**è¿ç§»æ–‡ä»¶**: `backend/alembic/versions/015_add_prompt_system.py`

---

### 3.2 Redisç¼“å­˜ç»“æ„

```redis
# 1. Promptæ¨¡æ¿ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
prompt_templates:all = {
    "decision/default/L0": {...},
    "decision/default/L1": {...},
    "decision/default/L2": {...},
    "decision/default/L3": {...},
    "decision/default/L4": {...},
    "decision/default/L5": {...},
    "debate/bull_bear/L3": {...}
}

# 2. ç›¸ä¼¼Promptç¼“å­˜ï¼ˆ10åˆ†é’ŸTTLï¼‰
prompt_similar:{hash} = [
    {"prompt_id": 1, "similarity": 0.95, "win_rate": 0.68},
    {"prompt_id": 3, "similarity": 0.88, "win_rate": 0.72}
]

# 3. Top Prompté¢„è®¡ç®—ï¼ˆ1å°æ—¶TTLï¼‰
top_prompts:high_volatility = [...]
top_prompts:low_volatility = [...]
top_prompts:trending = [...]

# 4. Promptä½¿ç”¨è¿½è¸ªï¼ˆçŸ­æœŸè®°å¿†ï¼‰
prompt:usage:{prompt_id} = {
    "decision_123": {"timestamp": "...", "result": "win"},
    "decision_124": {"timestamp": "...", "result": "loss"}
}

# 5. çƒ­é‡è½½é€šçŸ¥ï¼ˆPub/Subï¼‰
PUBLISH prompt_reload "decision/default/L3"
```

---

### 3.3 Qdrantå‘é‡å­˜å‚¨

**Collection**: `prompt_performance_vectors`

```python
{
    "id": "prompt_1_v2_1699999999",
    "vector": [0.123, -0.456, ...],  # 1536ç»´å‘é‡
    "payload": {
        "prompt_id": 1,
        "prompt_version": 2,
        "permission_level": "L3",
        "market_regime": "high_volatility",
        "volatility": 0.45,
        "win_rate": 0.68,
        "sharpe_ratio": 1.85,
        "pnl": 125.50,
        "timestamp": "2025-11-15T10:30:00Z"
    }
}
```

**æŸ¥è¯¢ç¤ºä¾‹**:
```python
# æŸ¥æ‰¾ç›¸ä¼¼å¸‚åœºçŠ¶æ€ä¸‹è¡¨ç°æœ€å¥½çš„Prompt
results = qdrant.search(
    collection_name="prompt_performance_vectors",
    query_vector=current_market_embedding,
    query_filter={
        "must": [
            {"key": "permission_level", "match": {"value": "L3"}},
            {"key": "sharpe_ratio", "range": {"gte": 1.5}}
        ]
    },
    limit=5
)
```

---

## ğŸ“ 4. å®Œæ•´å†³ç­–æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·å‘èµ·äº¤æ˜“å†³ç­–ï¼ˆL3æƒé™ï¼‰

```
1ï¸âƒ£ ç”¨æˆ·è§¦å‘å†³ç­–
   â†“
   DecisionEngineV2.make_decision()
   
2ï¸âƒ£ æ£€æŸ¥æƒé™ç­‰çº§
   â†“
   PermissionManager.get_current_level() â†’ "L3"
   
3ï¸âƒ£ åŠ è½½Promptï¼ˆä¸‰çº§ç¼“å­˜ï¼‰
   â†“
   PromptManagerDB.get_template("decision", "default", "L3")
   â”œâ”€ æ£€æŸ¥å†…å­˜ç¼“å­˜ï¼ˆ60ç§’ï¼‰
   â”œâ”€ æ£€æŸ¥Redisç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰â†’ å‘½ä¸­ï¼è¿”å› (1-5ms)
   â””â”€ [æœªå‘½ä¸­åˆ™æŸ¥PostgreSQL (50-100ms)]
   
4ï¸âƒ£ æ™ºèƒ½æ¨èï¼ˆå¯é€‰ï¼‰
   â†“
   PromptPerformanceMemory.recommend_best_prompt()
   â”œâ”€ å‘é‡åŒ–å½“å‰å¸‚åœºçŠ¶æ€
   â”œâ”€ åœ¨Qdrantä¸­æœç´¢ç›¸ä¼¼åœºæ™¯
   â””â”€ è¿”å›å†å²è¡¨ç°æœ€å¥½çš„Prompt
   
5ï¸âƒ£ æ¸²æŸ“Prompt
   â†“
   template.render(
       market_data={...},
       account_state={...},
       constraints={...}
   )
   ä½¿ç”¨Jinja2æ¨¡æ¿å¼•æ“ (2-5ms)
   
6ï¸âƒ£ è°ƒç”¨DeepSeek API
   â†“
   DecisionEngineOptimizer.call_llm_stream(prompt)
   æµå¼å“åº” (1500-3000ms)
   
7ï¸âƒ£ è®°å½•åˆ°ä¸‰å±‚è®°å¿†
   â†“
   â”œâ”€ çŸ­æœŸè®°å¿†ï¼ˆRedisï¼‰ï¼šè®°å½•Promptä½¿ç”¨
   â”œâ”€ é•¿æœŸè®°å¿†ï¼ˆQdrantï¼‰ï¼šå­˜å‚¨æ€§èƒ½å‘é‡
   â””â”€ çŸ¥è¯†åº“ï¼ˆPostgreSQLï¼‰ï¼šèšåˆç»Ÿè®¡æ•°æ®
   
8ï¸âƒ£ è¿”å›å†³ç­–ç»“æœ
   â†“
   {
       "action": "LONG",
       "size": 0.5,
       "confidence": 0.85,
       "prompt_id": 3,
       "prompt_version": 2
   }
```

**æ€»è€—æ—¶**: ~2264msï¼ˆä¼˜åŒ–åï¼‰vs ~3822msï¼ˆä¼˜åŒ–å‰ï¼‰

---

## ğŸ“ 5. æ ¸å¿ƒæ–‡ä»¶æ¸…å•

### åç«¯æ ¸å¿ƒæ–‡ä»¶ï¼ˆ13ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¡Œæ•° | åŠŸèƒ½ |
|---------|------|------|
| `app/main.py` | 571 | ä¸»åº”ç”¨å…¥å£ï¼Œæ³¨å†ŒPromptè·¯ç”± |
| `app/api/v1/prompts.py` | 323 | Prompt APIè·¯ç”±ï¼ˆCRUD+çƒ­é‡è½½+ä¼˜åŒ–ï¼‰ |
| `app/models/prompt_template.py` | 150 | æ•°æ®åº“æ¨¡å‹å®šä¹‰ |
| `app/services/decision/prompt_manager_db.py` | 291 | Promptç®¡ç†å™¨ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰ |
| `app/services/decision/decision_engine_v2.py` | 410 | å†³ç­–å¼•æ“ï¼ˆé›†æˆPromptï¼‰ |
| `app/services/decision/decision_engine_optimized.py` | 300 | æ€§èƒ½ä¼˜åŒ–å™¨ï¼ˆæµå¼+æ‰¹é‡+ç›‘æ§ï¼‰ |
| `app/services/decision/prompt_redis_subscriber.py` | 120 | Redis Pub/Subçƒ­é‡è½½ |
| `app/services/memory/prompt_memory_extension.py` | 80 | çŸ­æœŸè®°å¿†æ‰©å±• |
| `app/services/memory/prompt_performance_memory.py` | 200 | é•¿æœŸè®°å¿†ï¼ˆQdrantï¼‰ |
| `app/services/memory/prompt_performance_memory_optimized.py` | 250 | Qdrantæ™ºèƒ½ç¼“å­˜ |
| `app/services/memory/prompt_knowledge_aggregator.py` | 150 | çŸ¥è¯†åº“èšåˆ |
| `app/services/quantitative/risk_metrics.py` | 180 | é£é™©æŒ‡æ ‡è®¡ç®— |
| `app/services/quantitative/ab_test.py` | 200 | A/Bæµ‹è¯•æ¡†æ¶ |

**æ€»è®¡**: ~3,225è¡Œæ ¸å¿ƒä»£ç 

---

### å‰ç«¯æ ¸å¿ƒæ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¡Œæ•° | åŠŸèƒ½ |
|---------|------|------|
| `app/admin/prompts-v2/page.tsx` | 172 | Promptåˆ—è¡¨é¡µ |
| `app/admin/prompts-v2/[id]/edit/page.tsx` | 148 | Promptç¼–è¾‘é¡µ |
| `app/admin/prompts-v2/ab-tests/page.tsx` | 104 | A/Bæµ‹è¯•é¡µ |
| `app/admin/prompts-v2/[id]/metrics/page.tsx` | 133 | é£é™©æŒ‡æ ‡é¡µ |
| `app/admin/prompts/page.tsx` | 309 | æ—§ç‰ˆé¡µé¢ï¼ˆå·²å¼ƒç”¨ï¼‰ |

**æ€»è®¡**: ~866è¡Œå‰ç«¯ä»£ç 

---

### æ•°æ®åº“æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¡Œæ•° | åŠŸèƒ½ |
|---------|------|------|
| `alembic/versions/015_add_prompt_system.py` | 120 | æ•°æ®åº“è¿ç§»è„šæœ¬ |
| `scripts/migrate_prompts_to_db.py` | 150 | æ•°æ®è¿ç§»å·¥å…· |

---

### æ–‡æ¡£æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | é¡µæ•° | åŠŸèƒ½ |
|---------|------|------|
| `docs/10-ç‰ˆæœ¬æ›´æ–°/v4.0_Promptæ¨¡æ¿ç³»ç»Ÿå¼€å‘è¿›åº¦.md` | 8 | å¼€å‘è¿›åº¦æ–‡æ¡£ |
| `docs/10-ç‰ˆæœ¬æ›´æ–°/v4.0_Promptç³»ç»Ÿéƒ¨ç½²æŒ‡å—.md` | 12 | éƒ¨ç½²æŒ‡å— |
| `docs/10-ç‰ˆæœ¬æ›´æ–°/v4.0_æ¸…ç†å®ŒæˆæŠ¥å‘Š.md` | 6 | ä»£ç æ¸…ç†æŠ¥å‘Š |
| `docs/10-ç‰ˆæœ¬æ›´æ–°/v4.0_é›†æˆå®ŒæˆæŠ¥å‘Š.md` | 5 | é›†æˆå®ŒæˆæŠ¥å‘Š |
| `docs/10-ç‰ˆæœ¬æ›´æ–°/v4.1_æ€§èƒ½ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md` | 15 | æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š |

---

## ğŸ“ 6. è®¿é—®å…¥å£æ±‡æ€»

### APIç«¯ç‚¹

```bash
# åŸºç¡€URL
BASE_URL=http://localhost:8000/api/v1/prompts/v2

# 1. è·å–æ‰€æœ‰Prompt
GET ${BASE_URL}/

# 2. è·å–å•ä¸ªPrompt
GET ${BASE_URL}/{prompt_id}

# 3. åˆ›å»ºPrompt
POST ${BASE_URL}/

# 4. æ›´æ–°Prompt
PUT ${BASE_URL}/{prompt_id}

# 5. åˆ é™¤Prompt
DELETE ${BASE_URL}/{prompt_id}

# 6. çƒ­é‡è½½
POST ${BASE_URL}/reload

# 7. ç‰ˆæœ¬å†å²
GET ${BASE_URL}/{prompt_id}/versions

# 8. å›æ»šç‰ˆæœ¬
POST ${BASE_URL}/{prompt_id}/rollback

# 9. DeepSeekä¼˜åŒ–
POST ${BASE_URL}/{prompt_id}/optimize

# 10. é£é™©æŒ‡æ ‡
GET ${BASE_URL}/{prompt_id}/metrics

# 11. A/Bæµ‹è¯•
GET ${BASE_URL}/{prompt_id}/ab-tests
POST ${BASE_URL}/ab-tests
```

---

### å‰ç«¯é¡µé¢

```bash
# åŸºç¡€URL
BASE_URL=http://localhost:3000/admin

# 1. Promptåˆ—è¡¨é¡µ
${BASE_URL}/prompts-v2/

# 2. Promptç¼–è¾‘é¡µ
${BASE_URL}/prompts-v2/{id}/edit

# 3. A/Bæµ‹è¯•é¡µ
${BASE_URL}/prompts-v2/ab-tests

# 4. é£é™©æŒ‡æ ‡é¡µ
${BASE_URL}/prompts-v2/{id}/metrics

# 5. æ—§ç‰ˆé¡µé¢ï¼ˆå·²å¼ƒç”¨ï¼‰
${BASE_URL}/prompts/
```

---

### APIæ–‡æ¡£

```bash
# Swagger UI
http://localhost:8000/docs

# ReDoc
http://localhost:8000/redoc

# OpenAPI JSON
http://localhost:8000/openapi.json
```

---

## ğŸ“ 7. æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### å®æ—¶ç›‘æ§

```python
from app.services.decision.decision_engine_optimized import performance_monitor

# è·å–æ€§èƒ½ç»Ÿè®¡
stats = performance_monitor.get_stats()

{
    "db_query": {
        "count": 100,
        "avg": 0.055,  # 55ms
        "p50": 0.050,
        "p95": 0.095,
        "p99": 0.120
    },
    "qdrant_search": {
        "count": 50,
        "avg": 0.008,  # 8ms (Redisç¼“å­˜)
        "p50": 0.005,
        "p95": 0.015,
        "p99": 0.025
    },
    "prompt_render": {
        "count": 100,
        "avg": 0.003,  # 3ms (Jinja2)
        "p50": 0.002,
        "p95": 0.005,
        "p99": 0.008
    },
    "llm_call": {
        "count": 100,
        "avg": 2.264,  # 2264ms (æµå¼)
        "p50": 2.000,
        "p95": 3.020,
        "p99": 3.500
    }
}
```

---

## ğŸ¯ æ€»ç»“

### Promptç³»ç»Ÿåœ¨AIcoinä¸­çš„ä½“ç°

| å±‚çº§ | ä½“ç°æ–¹å¼ | æ ¸å¿ƒä»·å€¼ |
|------|---------|---------|
| **å†³ç­–å±‚** | DecisionEngineV2é›†æˆ | æ ¹æ®L0-L5åŠ¨æ€åŠ è½½ç­–ç•¥ |
| **APIå±‚** | FastAPIè·¯ç”± | å®Œæ•´çš„CRUD+çƒ­é‡è½½+ä¼˜åŒ– |
| **å­˜å‚¨å±‚** | PostgreSQL+Redis+Qdrant | ä¸‰çº§ç¼“å­˜+å‘é‡æ£€ç´¢ |
| **å‰ç«¯å±‚** | Reactç®¡ç†é¡µé¢ | å¯è§†åŒ–ç¼–è¾‘+A/Bæµ‹è¯•+æŒ‡æ ‡ |
| **è®°å¿†å±‚** | ä¸‰å±‚è®°å¿†é›†æˆ | çŸ­æœŸè¿½è¸ª+é•¿æœŸå­¦ä¹ +çŸ¥è¯†æ²‰æ·€ |
| **ä¼˜åŒ–å±‚** | æ€§èƒ½ä¼˜åŒ–ç»„ä»¶ | 40.8%æ€§èƒ½æå‡+50%æˆæœ¬é™ä½ |

### æ ¸å¿ƒä¼˜åŠ¿

1. **æ™ºèƒ½åŒ–**: DeepSeekè‡ªåŠ¨ä¼˜åŒ–+Qdrantæ™ºèƒ½æ¨è
2. **ç§‘å­¦åŒ–**: A/Bæµ‹è¯•+é£é™©æŒ‡æ ‡+è¿‡æ‹Ÿåˆæ£€æµ‹
3. **å·¥ç¨‹åŒ–**: ä¸‰çº§ç¼“å­˜+çƒ­é‡è½½+ç‰ˆæœ¬ç®¡ç†
4. **å¯è§†åŒ–**: å®Œæ•´çš„å‰ç«¯ç®¡ç†ç•Œé¢
5. **é«˜æ€§èƒ½**: 40.8%å“åº”æ—¶é—´æå‡+50%æˆæœ¬é™ä½

---

**ğŸ‰ Promptç³»ç»Ÿå·²æ·±åº¦é›†æˆåˆ°AIcoinçš„æ¯ä¸€ä¸ªè§’è½ï¼**

