# Promptæ¨¡æ¿ç³»ç»Ÿ v4.0 - éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### 1. ç¯å¢ƒè¦æ±‚
- âœ… PostgreSQL 14+
- âœ… Redis 6+
- âœ… Qdrant 1.7+
- âœ… Python 3.10+
- âœ… Node.js 18+

### 2. ä¾èµ–æ£€æŸ¥
```bash
# Pythonä¾èµ–
pip install scipy numpy qdrant-client

# ç¡®è®¤å·²å®‰è£…
python -c "import scipy; import numpy; import qdrant_client; print('âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡')"
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### Step 1: æ•°æ®åº“è¿ç§»

```bash
cd /Users/xinghailong/Documents/soft/AIcoin/backend

# 1. æ‰§è¡ŒAlembicè¿ç§»
alembic upgrade head

# 2. éªŒè¯è¡¨åˆ›å»º
psql -U postgres -d aicoin -c "\dt prompt*"

# é¢„æœŸè¾“å‡ºï¼š
# - prompt_templates
# - prompt_template_versions
# - prompt_performance
# - prompt_ab_tests
```

### Step 2: æ•°æ®è¿ç§»ï¼ˆ.txt â†’ æ•°æ®åº“ï¼‰

```bash
# æ‰§è¡ŒPromptæ•°æ®è¿ç§»è„šæœ¬
python scripts/migrate_prompts_to_db.py

# é¢„æœŸè¾“å‡ºï¼š
# âœ… è¿ç§»å®Œæˆï¼å…±è¿ç§» 6 ä¸ªPromptæ¨¡æ¿
# ğŸ“Š Promptç»Ÿè®¡ï¼š
#   - decision (L0): 1ä¸ª
#   - decision (L1): 1ä¸ª
#   - decision (L2): 1ä¸ª
#   - decision (L3): 1ä¸ª
#   - decision (L4): 1ä¸ª
#   - decision (L5): 1ä¸ª
```

### Step 3: Qdrantåˆå§‹åŒ–

```bash
# å¯åŠ¨Qdrantï¼ˆå¦‚æœæœªå¯åŠ¨ï¼‰
docker run -d -p 6333:6333 qdrant/qdrant

# éªŒè¯Qdrantè¿æ¥
curl http://localhost:6333/collections

# é¢„æœŸï¼šCollectionä¼šåœ¨é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»º
```

### Step 4: Redisé…ç½®

```bash
# ç¡®è®¤Redisè¿è¡Œ
redis-cli ping
# é¢„æœŸè¾“å‡ºï¼šPONG

# æ¸…ç©ºæ—§çš„Promptç¼“å­˜ï¼ˆå¯é€‰ï¼‰
redis-cli KEYS "prompt:*" | xargs redis-cli DEL
```

### Step 5: åç«¯æœåŠ¡é‡å¯

```bash
# 1. åœæ­¢ç°æœ‰æœåŠ¡
pkill -f "uvicorn app.main"

# 2. å¯åŠ¨åç«¯ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 3. éªŒè¯API
curl http://localhost:8000/api/prompts/v2/

# é¢„æœŸï¼šè¿”å›Promptåˆ—è¡¨JSON
```

### Step 6: å‰ç«¯æ„å»ºä¸éƒ¨ç½²

```bash
cd /Users/xinghailong/Documents/soft/AIcoin/frontend

# 1. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœ‰æ–°å¢ï¼‰
npm install

# 2. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# 3. å¯åŠ¨å‰ç«¯
npm run start

# 4. éªŒè¯å‰ç«¯
open http://localhost:3000/admin/prompts-v2
```

### Step 7: Celeryå®šæ—¶ä»»åŠ¡é…ç½®

```bash
# 1. å¯åŠ¨Celery Worker
celery -A app.core.celery_app worker -l info

# 2. å¯åŠ¨Celery Beatï¼ˆå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼‰
celery -A app.core.celery_app beat -l info

# 3. éªŒè¯å®šæ—¶ä»»åŠ¡
celery -A app.core.celery_app inspect scheduled
```

---

## âœ… åŠŸèƒ½éªŒè¯

### 1. Promptç®¡ç†åŠŸèƒ½

```bash
# æµ‹è¯•åˆ—è¡¨API
curl http://localhost:8000/api/prompts/v2/

# æµ‹è¯•çƒ­é‡è½½
curl -X POST http://localhost:8000/api/prompts/v2/reload

# æµ‹è¯•åˆ›å»ºPrompt
curl -X POST http://localhost:8000/api/prompts/v2/ \
  -H "Content-Type: application/json" \
  -d '{
    "name": "test_prompt",
    "category": "decision",
    "permission_level": "L0",
    "content": "Test content"
  }'
```

### 2. é£é™©æŒ‡æ ‡API

```bash
# è·å–Prompté£é™©æŒ‡æ ‡
curl http://localhost:8000/api/prompts/v2/1/risk-metrics
```

### 3. A/Bæµ‹è¯•åŠŸèƒ½

```bash
# åˆ›å»ºA/Bæµ‹è¯•
curl -X POST http://localhost:8000/api/prompts/v2/ab-tests \
  -H "Content-Type: application/json" \
  -d '{
    "test_name": "test_l0_vs_l1",
    "prompt_a_id": 1,
    "prompt_b_id": 2,
    "traffic_split": 0.5,
    "duration_days": 7
  }'
```

### 4. å‰ç«¯é¡µé¢éªŒè¯

è®¿é—®ä»¥ä¸‹é¡µé¢ç¡®è®¤åŠŸèƒ½æ­£å¸¸ï¼š

- âœ… http://localhost:3000/admin/prompts-v2 ï¼ˆç®¡ç†é¡µé¢ï¼‰
- âœ… http://localhost:3000/admin/prompts-v2/1/edit ï¼ˆæ™ºèƒ½ç¼–è¾‘ï¼‰
- âœ… http://localhost:3000/admin/prompts-v2/1/metrics ï¼ˆé£é™©æŒ‡æ ‡ï¼‰
- âœ… http://localhost:3000/admin/prompts-v2/ab-tests ï¼ˆA/Bæµ‹è¯•ï¼‰

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæ•°æ®åº“è¿ç§»å¤±è´¥

```bash
# æ£€æŸ¥Alembicç‰ˆæœ¬
alembic current

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
alembic downgrade -1

# é‡æ–°è¿ç§»
alembic upgrade head
```

### é—®é¢˜2ï¼šRedisè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥RedisçŠ¶æ€
systemctl status redis

# é‡å¯Redis
systemctl restart redis

# æ£€æŸ¥Redisé…ç½®
redis-cli CONFIG GET bind
```

### é—®é¢˜3ï¼šQdrant Collectionæœªåˆ›å»º

```python
# æ‰‹åŠ¨åˆ›å»ºCollection
from qdrant_client import QdrantClient
from qdrant_client.models import Distance, VectorParams

client = QdrantClient(host="localhost", port=6333)
client.create_collection(
    collection_name="prompt_performance_vectors",
    vectors_config=VectorParams(size=384, distance=Distance.COSINE)
)
```

### é—®é¢˜4ï¼šå‰ç«¯é¡µé¢404

```bash
# æ£€æŸ¥Next.jsè·¯ç”±
ls -la frontend/app/admin/prompts-v2/

# é‡æ–°æ„å»º
cd frontend
rm -rf .next
npm run build
npm run start
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### 1. æ•°æ®åº“ç›‘æ§

```sql
-- æ£€æŸ¥Promptæ•°é‡
SELECT category, permission_level, COUNT(*) 
FROM prompt_templates 
WHERE is_active = TRUE 
GROUP BY category, permission_level;

-- æ£€æŸ¥æ€§èƒ½è®°å½•
SELECT COUNT(*) FROM prompt_performance;

-- æ£€æŸ¥A/Bæµ‹è¯•
SELECT status, COUNT(*) FROM prompt_ab_tests GROUP BY status;
```

### 2. Redisç›‘æ§

```bash
# æ£€æŸ¥Promptä½¿ç”¨æ¬¡æ•°
redis-cli KEYS "prompt:usage_count:*"

# æ£€æŸ¥æœ€è¿‘å†³ç­–
redis-cli LLEN "prompt:recent_decisions:1"
```

### 3. Qdrantç›‘æ§

```bash
# æ£€æŸ¥Collectionä¿¡æ¯
curl http://localhost:6333/collections/prompt_performance_vectors

# æ£€æŸ¥å‘é‡æ•°é‡
curl http://localhost:6333/collections/prompt_performance_vectors/points/count
```

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```sql
-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
EXPLAIN ANALYZE SELECT * FROM prompt_templates WHERE category = 'decision' AND permission_level = 'L0';

-- å¦‚éœ€é¢å¤–ç´¢å¼•
CREATE INDEX idx_prompt_category_level_active ON prompt_templates(category, permission_level) WHERE is_active = TRUE;
```

### 2. Redisç¼“å­˜ç­–ç•¥

- Promptä½¿ç”¨æ¬¡æ•°ï¼š7å¤©TTL
- æœ€è¿‘å†³ç­–åˆ—è¡¨ï¼šä¿ç•™æœ€è¿‘100æ¡
- æ€§èƒ½æŒ‡æ ‡ï¼š1å¤©TTLï¼ˆæ¯æ—¥é‡ç½®ï¼‰

### 3. Qdrantæ€§èƒ½è°ƒä¼˜

```python
# æ‰¹é‡æ’å…¥ä¼˜åŒ–
client.upsert(
    collection_name="prompt_performance_vectors",
    points=points_batch,  # æ‰¹é‡æ’å…¥
    wait=False  # å¼‚æ­¥å†™å…¥
)
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

### å¦‚éœ€å›æ»šåˆ°æ—§ç‰ˆæœ¬ï¼š

```bash
# 1. æ•°æ®åº“å›æ»š
alembic downgrade -1

# 2. æ¢å¤.txtæ–‡ä»¶ï¼ˆå¦‚å·²å¤‡ä»½ï¼‰
cp -r backups/prompts/* backend/prompts/

# 3. åˆ‡æ¢åˆ°æ—§ä»£ç åˆ†æ”¯
git checkout <previous_commit>

# 4. é‡å¯æœåŠ¡
./scripts/restart_services.sh
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥è¡¨

- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
- [ ] Promptæ•°æ®å¯¼å…¥å®Œæˆï¼ˆ6ä¸ªL0-L5æ¨¡æ¿ï¼‰
- [ ] Qdrant Collectionåˆ›å»ºæˆåŠŸ
- [ ] Redisè¿æ¥æ­£å¸¸
- [ ] åç«¯APIå“åº”æ­£å¸¸
- [ ] å‰ç«¯é¡µé¢è®¿é—®æ­£å¸¸
- [ ] Celeryå®šæ—¶ä»»åŠ¡è¿è¡Œæ­£å¸¸
- [ ] çƒ­é‡è½½åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] é£é™©æŒ‡æ ‡APIæµ‹è¯•é€šè¿‡
- [ ] A/Bæµ‹è¯•åŠŸèƒ½æµ‹è¯•é€šè¿‡

---

## ğŸ‰ éƒ¨ç½²å®Œæˆ

æ­å–œï¼Promptæ¨¡æ¿ç³»ç»Ÿ v4.0 å·²æˆåŠŸéƒ¨ç½²ã€‚

**ä¸‹ä¸€æ­¥ï¼š**
1. ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
2. æ”¶é›†ç”¨æˆ·åé¦ˆ
3. ä¼˜åŒ–Promptå†…å®¹
4. å¯åŠ¨A/Bæµ‹è¯•éªŒè¯æ•ˆæœ

**æŠ€æœ¯æ”¯æŒï¼š**
- æ–‡æ¡£ï¼š`docs/10-ç‰ˆæœ¬æ›´æ–°/v4.0_Promptæ¨¡æ¿ç³»ç»Ÿå¼€å‘è¿›åº¦.md`
- é—®é¢˜åé¦ˆï¼šGitHub Issues

