# 🏗️ AIcoin 系统架构设计

> **版本**: v2.0 | **状态**: Active | **更新**: 2025-10-31

---

## 📋 目录

1. [整体架构](#整体架构)
2. [核心模块](#核心模块)
3. [数据流转](#数据流转)
4. [技术选型](#技术选型)
5. [部署架构](#部署架构)

---

## 1. 整体架构

### 1.1 分层架构图

```mermaid
graph TB
    subgraph "前端层 Frontend"
        WEB[Web Dashboard]
        MOBILE[Mobile App]
    end
    
    subgraph "API层 API Gateway"
        API[FastAPI Gateway]
        AUTH[Authentication]
        RATE[Rate Limiter]
    end
    
    subgraph "核心服务层 Core Services"
        AI[AI Trading Service]
        MARKET[Market Data Service]
        TRADE[Trade Execution Service]
        PERM[Permission Manager]
        CONST[Constraint Validator]
    end
    
    subgraph "AI决策层 AI Decision"
        PROMPT[Prompt Builder]
        DEEPSEEK[DeepSeek API]
        MEMORY[Memory Retrieval]
    end
    
    subgraph "数据层 Data Layer"
        PG[(PostgreSQL)]
        REDIS[(Redis)]
        QDRANT[(Qdrant)]
    end
    
    subgraph "外部服务 External"
        HYPER[Hyperliquid API]
        ALERT[Alert System]
    end
    
    WEB --> API
    MOBILE --> API
    API --> AUTH
    API --> RATE
    API --> AI
    API --> MARKET
    API --> TRADE
    
    AI --> PROMPT
    AI --> PERM
    AI --> CONST
    PROMPT --> DEEPSEEK
    PROMPT --> MEMORY
    
    AI --> PG
    AI --> REDIS
    MEMORY --> QDRANT
    
    TRADE --> HYPER
    AI --> ALERT
    
    style AI fill:#f96,stroke:#333,stroke-width:4px
    style DEEPSEEK fill:#9cf,stroke:#333,stroke-width:2px
    style PERM fill:#fc9,stroke:#333,stroke-width:2px
    style CONST fill:#fc9,stroke:#333,stroke-width:2px
```

---

## 2. 核心模块

### 2.1 AI Trading Service（核心大脑）

```mermaid
graph LR
    subgraph "AI Trading Service"
        INIT[Initialize] --> PERM[Check Permission]
        PERM --> DATA[Get Market Data]
        DATA --> MEM[Retrieve Memory]
        MEM --> BUILD[Build Prompt]
        BUILD --> CALL[Call DeepSeek]
        CALL --> SOFT[Apply Soft Constraints]
        SOFT --> HARD[Validate Hard Constraints]
        HARD --> EXEC{Execute?}
        EXEC -->|Yes| TRADE[Execute Trade]
        EXEC -->|No| REJECT[Reject]
        TRADE --> RECORD[Record Decision]
        REJECT --> RECORD
        RECORD --> EVAL[Evaluate Performance]
        EVAL --> UPDATE[Update Permission]
    end
    
    style CALL fill:#9cf
    style HARD fill:#f96
    style TRADE fill:#9f9
```

**职责**：
- 协调所有AI交易流程
- 整合权限、约束、记忆系统
- 执行交易决策
- 记录和评估

---

### 2.2 Permission Manager（权限管理）

```mermaid
stateDiagram-v2
    [*] --> L1: 系统启动
    L1 --> L2: 7天+50%胜率
    L2 --> L3: 30天+夏普1.0
    L3 --> L4: 60%胜率+夏普1.5
    L4 --> L5: 70%胜率+20天连盈
    
    L5 --> L4: 胜率<65%
    L4 --> L3: 胜率<55%
    L3 --> L2: 胜率<45%
    L2 --> L1: 连续3次亏损
    
    L5 --> L0: 触发风控
    L4 --> L0: 触发风控
    L3 --> L0: 触发风控
    L2 --> L0: 触发风控
    L1 --> L0: 触发风控
    
    L0 --> L1: 人工审核通过
    
    note right of L0
        保护模式
        禁止交易
    end note
    
    note right of L5
        专家级
        最高权限
    end note
```

**职责**：
- 动态评估AI表现
- 自动升降权限等级
- 提供权限配置给决策流程

---

### 2.3 Constraint Validator（约束验证）

```mermaid
graph TD
    START[Proposed Trade] --> CHECK1{保证金率 ≥ 20%?}
    CHECK1 -->|No| REJECT1[拒绝: 保证金不足]
    CHECK1 -->|Yes| CHECK2{总回撤 < 10%?}
    CHECK2 -->|No| REJECT2[拒绝: 回撤超限]
    CHECK2 -->|Yes| CHECK3{单日亏损 < 5%?}
    CHECK3 -->|No| REJECT3[拒绝: 单日亏损超限]
    CHECK3 -->|Yes| CHECK4{杠杆 ≤ 5x?}
    CHECK4 -->|No| REJECT4[拒绝: 杠杆超限]
    CHECK4 -->|Yes| CHECK5{现金储备 ≥ 10%?}
    CHECK5 -->|No| REJECT5[拒绝: 流动性不足]
    CHECK5 -->|Yes| CHECK6{单资产敞口 ≤ 30%?}
    CHECK6 -->|No| REJECT6[拒绝: 集中度过高]
    CHECK6 -->|Yes| APPROVE[✅ 批准交易]
    
    REJECT1 --> ALERT[触发告警]
    REJECT2 --> ALERT
    REJECT3 --> ALERT
    REJECT4 --> ALERT
    REJECT5 --> ALERT
    REJECT6 --> ALERT
    
    style APPROVE fill:#9f9
    style REJECT1 fill:#f96
    style REJECT2 fill:#f96
    style REJECT3 fill:#f96
    style REJECT4 fill:#f96
    style REJECT5 fill:#f96
    style REJECT6 fill:#f96
```

**职责**：
- 验证所有硬性约束
- 拒绝违规交易
- 触发风控告警

---

### 2.4 Memory System（三层记忆）

```mermaid
graph TB
    subgraph "短期记忆 Redis"
        R1[最近10笔决策]
        R2[今日交易次数]
        R3[实时性能指标]
        R4[账户状态缓存]
    end
    
    subgraph "长期记忆 Qdrant"
        Q1[历史决策向量]
        Q2[市场状态向量]
        Q3[相似情况检索]
        Q4[模式统计]
    end
    
    subgraph "知识库 PostgreSQL"
        P1[经验教训]
        P2[策略评估]
        P3[性能历史]
        P4[交易记录]
    end
    
    AI[AI Trading Service] --> R1
    AI --> Q3
    AI --> P1
    
    R1 -->|30分钟后| Q1
    Q4 -->|周度汇总| P2
    R3 -->|每日归档| P3
    
    style AI fill:#f96
    style Q3 fill:#9cf
    style P1 fill:#fc9
```

**职责**：
- 短期：快速访问最近数据（Redis）
- 长期：向量相似度检索（Qdrant）
- 知识：结构化经验教训（PostgreSQL）

---

## 3. 数据流转

### 3.1 完整决策流程

```mermaid
sequenceDiagram
    participant User
    participant API
    participant AI as AI Service
    participant Perm as Permission Manager
    participant Const as Constraint Validator
    participant Deep as DeepSeek API
    participant Mem as Memory System
    participant Hyper as Hyperliquid

    User->>API: 启动自动交易
    API->>AI: make_decision()
    
    AI->>Perm: 获取当前权限等级
    Perm-->>AI: L2 (成长级)
    
    AI->>Mem: 获取最近10次相似情况
    Mem-->>AI: 历史决策列表
    
    AI->>AI: 构建Prompt（含权限+记忆）
    AI->>Deep: 调用AI决策
    Deep-->>AI: AI决策JSON
    
    AI->>AI: 应用软约束（置信度/频率/仓位）
    AI->>Const: 验证硬约束
    Const-->>AI: ✅ 通过
    
    AI->>Hyper: 执行交易
    Hyper-->>AI: 交易成功
    
    AI->>Mem: 记录决策到三层记忆
    AI->>Perm: 评估并更新权限
    Perm-->>AI: 保持L2
    
    AI-->>API: 决策完成
    API-->>User: 交易执行成功
```

---

### 3.2 风控触发流程

```mermaid
sequenceDiagram
    participant Monitor as 监控服务
    participant AI as AI Service
    participant Const as Constraint Validator
    participant Perm as Permission Manager
    participant Hyper as Hyperliquid
    participant Alert as Alert System

    Monitor->>AI: 每10秒检查账户状态
    AI->>AI: 计算当前回撤
    
    AI->>Const: check_forced_liquidation()
    Const->>Const: 检查触发条件
    
    alt 回撤 ≥ 10%
        Const->>Hyper: 强制平掉所有仓位
        Const->>Perm: 降级到L0
        Const->>Alert: 发送紧急告警
        Alert-->>Alert: Email + SMS + Telegram
    else 单日亏损 ≥ 5%
        Const->>AI: 停止自动交易
        Const->>Perm: 降级到L0
        Const->>Alert: 发送告警
    else 正常
        Const-->>AI: 继续运行
    end
```

---

## 4. 技术选型

### 4.1 技术栈总览

| 层次 | 技术 | 选型理由 |
|------|------|---------|
| **前端** | Next.js 14 + React 18 | SSR + 现代React |
| **API** | FastAPI | 高性能 + 异步 + 自动文档 |
| **AI** | DeepSeek V3.1 | 性价比高 + 中文友好 |
| **数据库** | PostgreSQL 15 | 可靠 + JSON支持 |
| **缓存** | Redis 7 | 快速 + 数据结构丰富 |
| **向量库** | Qdrant | Rust高性能 + Docker部署简单 |
| **交易所** | Hyperliquid | 去中心化 + API完善 |

### 4.2 关键库依赖

**后端 Python**:
```python
fastapi==0.104.1
sqlalchemy==2.0.23
redis==5.0.1
qdrant-client==1.7.0
hyperliquid-python-sdk==0.3.0
openai==1.3.5  # for DeepSeek
pydantic==2.5.0
celery==5.3.4
```

**前端 TypeScript**:
```json
{
  "next": "14.0.3",
  "react": "18.2.0",
  "tailwindcss": "3.3.5",
  "lightweight-charts": "4.1.0",
  "axios": "1.6.2"
}
```

---

## 5. 部署架构

### 5.1 Docker Compose 架构

```mermaid
graph TB
    subgraph "Docker Compose"
        subgraph "应用容器"
            BACKEND[backend:8000]
            FRONTEND[frontend:3000]
            CELERY[celery-worker]
        end
        
        subgraph "数据容器"
            PG[postgres:5432]
            REDIS_C[redis:6379]
            QDRANT_C[qdrant:6333]
        end
        
        subgraph "监控容器"
            GRAFANA[grafana:3001]
            PROMETHEUS[prometheus:9090]
        end
    end
    
    NGINX[Nginx Reverse Proxy] --> BACKEND
    NGINX --> FRONTEND
    
    BACKEND --> PG
    BACKEND --> REDIS_C
    BACKEND --> QDRANT_C
    CELERY --> REDIS_C
    
    PROMETHEUS --> BACKEND
    GRAFANA --> PROMETHEUS
    
    BACKEND -->|API| HYPER[Hyperliquid API]
    BACKEND -->|API| DEEP[DeepSeek API]
    
    style BACKEND fill:#f96
    style PG fill:#9cf
    style REDIS_C fill:#fc9
    style QDRANT_C fill:#c9f
```

### 5.2 生产环境部署

**阿里云 ECS 推荐配置**：

| 组件 | 规格 | 说明 |
|------|------|------|
| **ECS** | 4C8G | 运行Docker Compose |
| **磁盘** | 100GB SSD | 存储数据库和日志 |
| **网络** | 5Mbps | 足够API调用 |
| **PostgreSQL** | RDS基础版 | 或自建在ECS |
| **Redis** | 云数据库Redis | 或自建在ECS |

**Phase 1-2**: 单机Docker Compose部署  
**Phase 3**: 考虑微服务拆分（Kubernetes）

### 5.3 监控告警

```mermaid
graph LR
    subgraph "数据采集"
        APP[应用日志]
        SYS[系统指标]
        DB[数据库指标]
    end
    
    subgraph "监控系统"
        PROM[Prometheus]
        LOKI[Loki日志]
    end
    
    subgraph "可视化"
        GRAFANA[Grafana Dashboard]
    end
    
    subgraph "告警"
        ALERT[Alert Manager]
        EMAIL[Email]
        SMS[SMS]
        TG[Telegram]
    end
    
    APP --> LOKI
    SYS --> PROM
    DB --> PROM
    
    PROM --> GRAFANA
    LOKI --> GRAFANA
    
    PROM --> ALERT
    ALERT --> EMAIL
    ALERT --> SMS
    ALERT --> TG
    
    style GRAFANA fill:#fc9
    style ALERT fill:#f96
```

---

## 6. 性能指标

### 6.1 系统性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **AI决策延迟** | < 5秒 | 从数据获取到决策完成 |
| **交易执行延迟** | < 2秒 | 从决策到订单提交 |
| **API响应时间** | < 200ms | 95分位 |
| **数据库查询** | < 50ms | 95分位 |
| **Redis查询** | < 10ms | 99分位 |
| **向量检索** | < 500ms | Top 10相似度 |

### 6.2 可扩展性设计

**水平扩展能力**：
```
Phase 1-2: 单实例（100 QPS）
   ↓
Phase 3: 多实例 + 负载均衡（500 QPS）
   ↓
未来: K8s集群（5000+ QPS）
```

---

## 7. 安全设计

### 7.1 安全层级

```mermaid
graph TD
    subgraph "网络安全"
        HTTPS[HTTPS加密]
        FIREWALL[防火墙规则]
        VPC[VPC隔离]
    end
    
    subgraph "应用安全"
        AUTH[JWT认证]
        RBAC[权限控制]
        RATE_LIMIT[速率限制]
        INPUT[输入验证]
    end
    
    subgraph "数据安全"
        ENCRYPT[敏感数据加密]
        BACKUP[定期备份]
        AUDIT[审计日志]
    end
    
    subgraph "API安全"
        KEY[API密钥管理]
        IP[IP白名单]
        SIGN[请求签名]
    end
    
    style AUTH fill:#f96
    style ENCRYPT fill:#9cf
    style KEY fill:#fc9
```

### 7.2 敏感信息保护

```python
# 环境变量管理
SENSITIVE_DATA = {
    "HYPERLIQUID_API_KEY": "环境变量",
    "HYPERLIQUID_SECRET_KEY": "环境变量",
    "DEEPSEEK_API_KEY": "环境变量",
    "DATABASE_PASSWORD": "环境变量 + 加密",
    "JWT_SECRET": "环境变量",
}

# 不在代码中硬编码
# 不提交到Git
# 使用.env文件（.gitignore）
```

---

## 8. 灾难恢复

### 8.1 备份策略

| 类型 | 频率 | 保留时间 | 存储位置 |
|------|------|---------|---------|
| **数据库** | 每日 | 30天 | 阿里云OSS |
| **配置文件** | 每次修改 | 永久 | Git |
| **交易日志** | 实时 | 90天 | 本地+OSS |
| **系统快照** | 每周 | 4周 | ECS快照 |

### 8.2 故障恢复流程

```mermaid
graph LR
    FAIL[系统故障] --> DETECT[告警检测]
    DETECT --> STOP[停止交易]
    STOP --> CLOSE[平掉仓位]
    CLOSE --> DIAG[诊断问题]
    DIAG --> FIX{可修复?}
    FIX -->|Yes| REPAIR[修复]
    FIX -->|No| RESTORE[恢复备份]
    REPAIR --> TEST[测试验证]
    RESTORE --> TEST
    TEST --> OK{正常?}
    OK -->|Yes| RESUME[恢复交易]
    OK -->|No| DIAG
    
    style STOP fill:#f96
    style CLOSE fill:#f96
    style RESUME fill:#9f9
```

---

## 9. 开发与部署

### 9.1 开发环境

```bash
# 1. 克隆代码
git clone https://github.com/allenxing4071/aicoin.git
cd aicoin

# 2. 配置环境变量
cp .env.example .env
# 编辑.env填入API密钥

# 3. 启动开发环境
docker-compose -f docker-compose.dev.yml up -d

# 4. 访问
# Backend: http://localhost:8000/docs
# Frontend: http://localhost:3000
```

### 9.2 生产部署

```bash
# 1. 在阿里云ECS上
ssh user@your-server-ip

# 2. 安装Docker
curl -fsSL https://get.docker.com | sh

# 3. 部署应用
git clone https://github.com/allenxing4071/aicoin.git
cd aicoin
cp .env.production .env
# 填入生产环境配置

# 4. 启动
docker-compose up -d

# 5. 配置Nginx反向代理
# (参考nginx.conf)
```

---

## 📚 相关文档

- [智能约束框架](./01-智能约束框架.md) - 权限和约束系统
- [记忆学习系统](./02-记忆学习系统.md) - 三层记忆架构
- [自建模型方案](./03-自建模型方案.md) - Phase 3模型微调
- [监控评估系统](./04-监控评估系统.md) - KPI和监控

---

**文档版本**: v2.0  
**最后更新**: 2025-10-31  
**维护状态**: ✅ Active

