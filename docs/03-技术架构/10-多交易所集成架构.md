# 多交易所集成架构

> **版本**: v3.1  
> **更新时间**: 2025-11-05  
> **状态**: ✅ 已实现

## 概述

AIcoin v3.1 实现了多交易所统一抽象层,支持灵活切换不同交易所(Binance、Hyperliquid等),并提供统一的交易接口。

## 架构设计

### 核心设计模式

```
┌─────────────────────────────────────────────┐
│         Trading Strategy Layer              │
│      (决策引擎、风控系统、AI分析)             │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│        Exchange Abstraction Layer           │
│          (BaseExchangeAdapter)              │
└──────────────────┬──────────────────────────┘
                   │
        ┌──────────┴──────────┐
        ▼                     ▼
┌──────────────┐      ┌──────────────┐
│   Binance    │      │ Hyperliquid  │
│   Adapter    │      │   Adapter    │
└──────────────┘      └──────────────┘
        │                     │
        ▼                     ▼
┌──────────────┐      ┌──────────────┐
│ Binance API  │      │Hyperliquid   │
│ (现货+合约)   │      │    SDK       │
└──────────────┘      └──────────────┘
```

### 1. Adapter Pattern (适配器模式)

**目的**: 统一不同交易所的API差异

**实现**: `BaseExchangeAdapter` 抽象基类

```python
class BaseExchangeAdapter(ABC):
    """交易所适配器基类"""
    
    @abstractmethod
    async def initialize(self):
        """初始化交易所连接"""
        pass
    
    @abstractmethod
    async def get_klines(self, symbol: str, interval: str, 
                         limit: int, market_type: str) -> List[Dict]:
        """获取K线数据"""
        pass
    
    @abstractmethod
    async def place_order(self, symbol: str, side: str, 
                          size: Decimal, price: Optional[Decimal], 
                          order_type: str, market_type: str) -> Dict:
        """下单"""
        pass
    
    @abstractmethod
    async def get_positions(self, market_type: str) -> List[Dict]:
        """获取持仓"""
        pass
    
    # ... 其他统一接口
```

**支持的接口**:
- ✅ `initialize()` - 初始化连接
- ✅ `get_klines()` - K线数据
- ✅ `get_account_balance()` - 账户余额
- ✅ `place_order()` - 下单
- ✅ `cancel_order()` - 撤单
- ✅ `get_positions()` - 持仓查询
- ✅ `get_ticker()` - 实时价格
- ✅ `get_open_orders()` - 挂单查询
- ✅ `get_exchange_info()` - 交易所信息

### 2. Factory Pattern (工厂模式)

**目的**: 动态创建和管理交易所实例

**实现**: `ExchangeFactory` 单例工厂

```python
class ExchangeFactory:
    """交易所工厂 - 单例模式"""
    
    _instance = None
    _current_adapter: Optional[BaseExchangeAdapter] = None
    _active_exchange_name: Optional[str] = None
    _active_market_type: Optional[str] = None
    
    @classmethod
    async def get_active_exchange(cls) -> BaseExchangeAdapter:
        """获取当前激活的交易所适配器"""
        if cls._current_adapter:
            return cls._current_adapter
        
        # 从数据库读取配置
        async with AsyncSessionLocal() as db:
            result = await db.execute(
                select(ExchangeConfig).filter_by(is_active=True)
            )
            config = result.scalar_one_or_none()
            
            if config.name == "binance":
                adapter = await cls._create_binance_adapter(config)
            elif config.name == "hyperliquid":
                adapter = await cls._create_hyperliquid_adapter(config)
            
            cls._current_adapter = adapter
            return adapter
    
    @classmethod
    async def switch_exchange(cls, exchange_name: str, 
                               market_type: str, 
                               db: AsyncSession) -> bool:
        """切换交易所"""
        # 1. 更新数据库配置
        # 2. 关闭当前适配器
        # 3. 创建新适配器
        # 4. 更新缓存
        pass
```

**功能特性**:
- ✅ 单例模式,全局唯一实例
- ✅ 缓存当前适配器,避免重复创建
- ✅ 数据库持久化配置
- ✅ 热切换支持(无需重启)

### 3. Strategy Pattern (策略模式)

**现货 vs 合约策略隔离**

```python
# 现货交易
await adapter.place_order(
    symbol="BTCUSDT",
    side="BUY",
    size=Decimal("0.001"),
    market_type="spot"
)

# 合约交易
await adapter.place_order(
    symbol="BTCUSDT",
    side="BUY",
    size=Decimal("0.01"),
    market_type="futures",
    leverage=3
)
```

## 数据库设计

### ExchangeConfig 表

```sql
CREATE TABLE exchange_configs (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,           -- 交易所标识
    display_name VARCHAR(100) NOT NULL,         -- 显示名称
    is_active BOOLEAN DEFAULT FALSE,            -- 是否激活
    market_type VARCHAR(20) DEFAULT 'perpetual', -- 市场类型
    api_key_encrypted TEXT,                     -- 加密的API Key
    api_secret_encrypted TEXT,                  -- 加密的API Secret
    testnet BOOLEAN DEFAULT TRUE,               -- 是否测试网
    config_json JSONB,                          -- 额外配置
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- 确保同时只有一个激活的交易所
    CONSTRAINT uq_active_exchange UNIQUE (is_active) 
        DEFERRABLE INITIALLY DEFERRED
);

-- 优化查询索引
CREATE UNIQUE INDEX idx_active_exchange 
    ON exchange_configs(is_active) 
    WHERE is_active = TRUE;
```

### MarketDataKline 表扩展

```sql
ALTER TABLE market_data_kline
    ADD COLUMN exchange VARCHAR(50) DEFAULT 'hyperliquid',
    ADD COLUMN market_type VARCHAR(20) DEFAULT 'perpetual',
    ADD COLUMN funding_rate NUMERIC(10, 6),
    ADD COLUMN open_interest NUMERIC(18, 2);

-- 更新唯一约束
ALTER TABLE market_data_kline
    DROP CONSTRAINT uq_kline_symbol_interval_time,
    ADD CONSTRAINT uq_kline_symbol_interval_time 
        UNIQUE (symbol, interval, open_time, exchange, market_type);
```

## 实现细节

### BinanceAdapter

**文件**: `backend/app/services/exchange/binance_adapter.py`  
**代码行数**: 568行

**特性**:
- ✅ 支持现货交易 (Spot)
- ✅ 支持合约交易 (Futures/Perpetual)
- ✅ 异步客户端 (`AsyncClient`)
- ✅ 自动重连机制
- ✅ 速率限制处理
- ✅ 完整错误处理

**关键方法**:
```python
async def get_klines(self, symbol: str, interval: str, 
                     limit: int, market_type: str = 'spot'):
    """获取K线数据"""
    client = (self.spot_client if market_type == 'spot' 
              else self.futures_client)
    
    klines = await client.get_klines(
        symbol=symbol,
        interval=interval,
        limit=limit
    )
    
    return self._format_klines(klines)
```

### HyperliquidAdapter

**文件**: `backend/app/services/exchange/hyperliquid_adapter.py`  
**代码行数**: 456行

**特性**:
- ✅ 永续合约专用
- ✅ Vault地址支持
- ✅ 原生SDK封装
- ✅ 订单簿深度查询
- ✅ 资金费率查询

**特殊实现**:
```python
async def place_order(self, symbol: str, side: str, 
                      size: Decimal, price: Optional[Decimal] = None,
                      order_type: str = "market", 
                      market_type: str = 'perpetual'):
    """Hyperliquid下单"""
    order_request = {
        "coin": symbol,
        "is_buy": (side.upper() == "BUY"),
        "sz": float(size),
        "limit_px": float(price) if price else None,
        "order_type": {"limit": order_type == "limit"},
        "reduce_only": False
    }
    
    if self.vault_address:
        order_request["vaultAddress"] = self.vault_address
    
    result = self.exchange.order(order_request)
    return self._format_order_result(result)
```

## 多时间周期分析

### KlineAggregator

**文件**: `backend/app/services/market/kline_aggregator.py`  
**代码行数**: 234行

**功能**:
```python
async def get_multi_timeframe_klines(
    self, 
    symbol: str, 
    intervals: List[str] = None
) -> Dict[str, List[Dict]]:
    """获取多时间周期K线"""
    if intervals is None:
        intervals = settings.KLINE_INTERVALS  # [1m, 5m, 15m, 1h, 4h, 1d]
    
    adapter = await exchange_factory.get_active_exchange()
    
    tasks = []
    for interval in intervals:
        tasks.append(
            adapter.get_klines(
                symbol=symbol,
                interval=interval,
                limit=100,
                market_type=exchange_factory._active_market_type
            )
        )
    
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    return {
        interval: data 
        for interval, data in zip(intervals, results)
        if not isinstance(data, Exception)
    }
```

**分析能力**:
- ✅ 同时获取多个时间周期
- ✅ 并发请求优化
- ✅ 现货/合约对比分析
- ✅ 异常隔离处理

## 配置管理

### 环境变量

```bash
# Binance配置
BINANCE_API_KEY=your_api_key
BINANCE_API_SECRET=your_api_secret
BINANCE_TESTNET=false

# Hyperliquid配置
HYPERLIQUID_WALLET_ADDRESS=0x...
HYPERLIQUID_PRIVATE_KEY=0x...
HYPERLIQUID_VAULT_ADDRESS=0x...
HYPERLIQUID_TESTNET=false

# 交易所选择
ACTIVE_EXCHANGE=hyperliquid        # hyperliquid | binance
ACTIVE_MARKET_TYPE=perpetual       # spot | futures | perpetual

# K线周期
KLINE_INTERVALS=["1m", "5m", "15m", "1h", "4h", "1d"]
```

### 风控参数

```python
# Binance风控
BINANCE_MAX_LEVERAGE: int = 3
BINANCE_MIN_NOTIONAL: float = 10.0
BINANCE_MAX_POSITION_SPOT: float = 0.15      # 15%
BINANCE_MAX_POSITION_FUTURES: float = 0.20   # 20%
BINANCE_RATE_LIMIT_PER_MINUTE: int = 1200

# Hyperliquid风控
HYPERLIQUID_MAX_LEVERAGE: int = 5
HYPERLIQUID_MAX_POSITION: float = 0.25       # 25%
```

## 扩展性

### 添加新交易所

**步骤**:

1. **创建Adapter类**
```python
# backend/app/services/exchange/okx_adapter.py
class OKXAdapter(BaseExchangeAdapter):
    async def initialize(self):
        # OKX初始化逻辑
        pass
    
    # 实现所有抽象方法...
```

2. **注册到Factory**
```python
# backend/app/services/exchange/exchange_factory.py
@classmethod
async def _create_okx_adapter(cls, config):
    return OKXAdapter(...)

@classmethod
async def get_active_exchange(cls):
    # ...
    elif config.name == 'okx':
        adapter = await cls._create_okx_adapter(config)
```

3. **添加到支持列表**
```python
@classmethod
def list_supported_exchanges(cls):
    return [
        {'name': 'binance', ...},
        {'name': 'hyperliquid', ...},
        {'name': 'okx', ...},  # 新增
    ]
```

## 最佳实践

### 1. 交易所切换

```python
# 推荐: 使用API切换
POST /api/v1/exchanges/switch?exchange_name=binance&market_type=spot

# 不推荐: 直接修改环境变量(需重启)
```

### 2. 错误处理

```python
try:
    adapter = await exchange_factory.get_active_exchange()
    result = await adapter.place_order(...)
except ValueError as e:
    # 配置错误(如缺少API密钥)
    logger.error(f"配置错误: {e}")
except BinanceAPIException as e:
    # Binance API错误
    logger.error(f"Binance错误: {e}")
except Exception as e:
    # 其他未知错误
    logger.error(f"未知错误: {e}")
```

### 3. 异步优化

```python
# 推荐: 并发请求
tasks = [
    adapter.get_klines(symbol, "1m", 100),
    adapter.get_klines(symbol, "5m", 100),
    adapter.get_ticker(symbol)
]
results = await asyncio.gather(*tasks)

# 不推荐: 串行请求
klines_1m = await adapter.get_klines(symbol, "1m", 100)
klines_5m = await adapter.get_klines(symbol, "5m", 100)
ticker = await adapter.get_ticker(symbol)
```

## 性能指标

| 操作 | 响应时间 | 并发支持 |
|------|----------|----------|
| 交易所切换 | <2s | ✅ |
| K线查询(单周期) | <100ms | ✅ |
| 多周期K线(6个) | <300ms | ✅ 并发 |
| 下单 | <200ms | ✅ |
| 持仓查询 | <150ms | ✅ |

## 相关文档

- [API接口文档](../09-API接口文档/交易所管理API.md)
- [前端组件文档](../08-前端系统/05-交易所组件.md)
- [部署配置指南](../07-部署运维/交易所配置指南.md)
- [快速上手](../06-快速参考/v3.1快速上手指南.md)

## 更新记录

- **2025-11-05**: v3.1 初始版本
  - 实现Adapter + Factory架构
  - 集成Binance和Hyperliquid
  - 支持多时间周期分析
  - 完成异步改造

