# âš™ï¸ æ™ºèƒ½çº¦æŸæ¡†æ¶æŠ€æœ¯æ–‡æ¡£

> **æå–è‡ª**: AIäº¤æ˜“è§„åˆ™æ–‡æ¡£ ç¬¬äºŒéƒ¨åˆ†  
> **ç‰ˆæœ¬**: v2.0  
> **çŠ¶æ€**: Phase 1æ ¸å¿ƒå®ç°

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
2. [åŠ¨æ€æƒé™ç³»ç»Ÿï¼ˆL0-L5ï¼‰](#åŠ¨æ€æƒé™ç³»ç»Ÿ)
3. [ä¿æŠ¤æ€§çº¦æŸï¼ˆç¡¬é™åˆ¶ï¼‰](#ä¿æŠ¤æ€§çº¦æŸ)
4. [æŒ‡å¯¼æ€§çº¦æŸï¼ˆè½¯é™åˆ¶ï¼‰](#æŒ‡å¯¼æ€§çº¦æŸ)
5. [Promptè®¾è®¡](#promptè®¾è®¡)
6. [æŠ€æœ¯å®ç°è·¯çº¿](#æŠ€æœ¯å®ç°è·¯çº¿)

---

## 1. æ ¸å¿ƒæ¦‚å¿µ

### 1.1 è®¾è®¡ç†å¿µ

**é—®é¢˜å›é¡¾**ï¼šåˆå§‹æµ‹è¯•(-48.8%äºæŸ)æš´éœ²çš„é—®é¢˜
- âŒ AIé™·å…¥"ç–¯ç‹‚åŠ ä»“"æ­»å¾ªç¯
- âŒ ç¼ºå°‘é£æ§çº¦æŸ
- âŒ Promptè®¾è®¡è¿‡äºæ¿€è¿›

**è§£å†³æ–¹æ¡ˆ**ï¼šæ™ºèƒ½çº¦æŸæ¡†æ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AIè‡ªä¸»å†³ç­–ç©ºé—´                  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   æŒ‡å¯¼æ€§çº¦æŸï¼ˆè½¯é™åˆ¶ï¼‰     â”‚      â”‚
â”‚  â”‚   - ç½®ä¿¡åº¦é—¨æ§›            â”‚      â”‚
â”‚  â”‚   - é¢‘ç‡å»ºè®®              â”‚      â”‚
â”‚  â”‚   - ä»“ä½æŒ‡å¯¼              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   ä¿æŠ¤æ€§çº¦æŸï¼ˆç¡¬é™åˆ¶ï¼‰     â”‚      â”‚
â”‚  â”‚   - ç»å¯¹çº¢çº¿              â”‚      â”‚
â”‚  â”‚   - ä¸å¯çªç ´              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”‚  åº•å±‚ï¼šL0-L5åŠ¨æ€æƒé™ç³»ç»Ÿ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
1. **åŠ¨æ€æ¼”è¿›** - æƒé™éšè¡¨ç°è‡ªåŠ¨è°ƒæ•´
2. **è½¯ç¡¬ç»“åˆ** - ç¡¬çº¦æŸä¿æŠ¤+è½¯çº¦æŸæŒ‡å¯¼
3. **AIå‹å¥½** - åœ¨Promptä¸­é€æ˜å‘ŠçŸ¥è§„åˆ™
4. **äººå·¥å…œåº•** - æç«¯æƒ…å†µäººå·¥ä»‹å…¥

---

## 2. åŠ¨æ€æƒé™ç³»ç»Ÿ

### 2.1 æƒé™ç­‰çº§å®šä¹‰

| ç­‰çº§ | åç§° | å•ä»“ä½ | æ æ† | ç½®ä¿¡åº¦é—¨æ§› | æ—¥é¢‘ç‡ | å‡çº§æ¡ä»¶ |
|------|------|--------|------|-----------|--------|---------|
| **L0** | ä¿æŠ¤æ¨¡å¼ | 0% | 1x | 100% | 0 | äººå·¥å®¡æ ¸ |
| **L1** | æ–°æ‰‹çº§ | 10% | 2x | 80% | 1 | 7å¤©+50%èƒœç‡ |
| **L2** | æˆé•¿çº§ | 12% | 2x | 75% | 2 | 30å¤©+å¤æ™®1.0 |
| **L3** | ç¨³å®šçº§ | 15% | 3x | 70% | 4 | 60%èƒœç‡+å¤æ™®1.5 |
| **L4** | ç†Ÿç»ƒçº§ | 20% | 4x | 65% | 6 | 70%èƒœç‡+20å¤©è¿ç›ˆ |
| **L5** | ä¸“å®¶çº§ | 25% | 5x | 60% | æ— é™ | æœ€é«˜ç­‰çº§ |

### 2.2 æƒé™ç®¡ç†å®ç°

#### 2.2.1 æƒé™è¯„ä¼°é€»è¾‘

```python
# backend/app/services/permission_manager.py

from dataclasses import dataclass
from datetime import datetime, timedelta
from typing import Optional

@dataclass
class PerformanceData:
    """æ€§èƒ½æ•°æ®ç»“æ„"""
    win_rate_7d: float
    win_rate_30d: float
    sharpe_ratio: float
    max_drawdown: float
    consecutive_losses: int
    total_trades: int
    profitable_trades: int
    days_active: int
    profit_consistency: float = 0.0
    consecutive_profitable_days: int = 0

class PermissionManager:
    """
    æƒé™ç®¡ç†å™¨
    è´Ÿè´£è¯„ä¼°AIè¡¨ç°å¹¶åŠ¨æ€è°ƒæ•´æƒé™ç­‰çº§
    """
    
    def __init__(self, db_session):
        self.db = db_session
    
    async def evaluate_permission_level(
        self,
        current_level: str,
        performance_data: PerformanceData
    ) -> tuple[str, str]:
        """
        è¯„ä¼°å½“å‰æƒé™ç­‰çº§æ˜¯å¦éœ€è¦è°ƒæ•´
        
        Returns:
            (new_level, reason)
        """
        
        # 1. æ£€æŸ¥é™çº§è§¦å‘å™¨ï¼ˆä¼˜å…ˆï¼‰
        downgrade_result = self._check_downgrade_triggers(
            current_level, 
            performance_data
        )
        if downgrade_result:
            return downgrade_result
        
        # 2. æ£€æŸ¥å‡çº§æ¡ä»¶
        upgrade_result = self._check_upgrade_conditions(
            current_level,
            performance_data
        )
        if upgrade_result:
            return upgrade_result
        
        # 3. ä¿æŒå½“å‰ç­‰çº§
        return current_level, "ä¿æŒå½“å‰ç­‰çº§"
    
    def _check_downgrade_triggers(
        self,
        current_level: str,
        performance_data: PerformanceData
    ) -> Optional[tuple[str, str]]:
        """
        æ£€æŸ¥æ˜¯å¦è§¦å‘é™çº§ï¼ˆé£æ§ä¼˜å…ˆï¼‰
        """
        
        # è§¦å‘L0ï¼ˆä¿æŠ¤æ¨¡å¼ï¼‰çš„æ¡ä»¶
        if any([
            performance_data.max_drawdown >= 0.10,  # æœ€å¤§å›æ’¤â‰¥10%
            performance_data.consecutive_losses >= 5,  # è¿ç»­5æ¬¡äºæŸ
        ]):
            return "L0", "è§¦å‘é£æ§ä¿æŠ¤"
        
        # å„ç­‰çº§é™çº§é€»è¾‘
        if current_level == "L5":
            if performance_data.win_rate_30d < 0.65:
                return "L4", "è¿‘æœŸè¡¨ç°ä¸‹é™"
        
        elif current_level == "L4":
            if performance_data.win_rate_30d < 0.55:
                return "L3", "è¿‘æœŸè¡¨ç°ä¸‹é™"
        
        elif current_level == "L3":
            if performance_data.win_rate_7d < 0.45:
                return "L3", "è¿‘æœŸè¡¨ç°ä¸‹é™"
        
        elif current_level == "L2":
            if performance_data.consecutive_losses >= 3:
                return "L1", "è¿ç»­äºæŸï¼Œå›åˆ°æ–°æ‰‹æ¨¡å¼"
        
        return None
    
    def _check_upgrade_conditions(
        self,
        current_level: str,
        performance_data: PerformanceData
    ) -> Optional[tuple[str, str]]:
        """
        æ£€æŸ¥æ˜¯å¦æ»¡è¶³å‡çº§æ¡ä»¶
        """
        
        # L0 â†’ L1: éœ€è¦äººå·¥å®¡æ ¸
        if current_level == "L0":
            return None  # ä¸è‡ªåŠ¨å‡çº§
        
        # L1 â†’ L2
        elif current_level == "L1":
            if (performance_data.days_active >= 7 and
                performance_data.win_rate_7d >= 0.50 and
                performance_data.max_drawdown < 0.15):
                return "L2", "æ–°æ‰‹æœŸè¡¨ç°åˆæ ¼"
        
        # L2 â†’ L3
        elif current_level == "L2":
            if (performance_data.days_active >= 30 and
                performance_data.win_rate_30d >= 0.50 and
                performance_data.sharpe_ratio >= 1.0 and
                performance_data.max_drawdown < 0.10):
                return "L3", "æˆé•¿æœŸè¡¨ç°ä¼˜ç§€"
        
        # L3 â†’ L4
        elif current_level == "L3":
            if (performance_data.win_rate_30d >= 0.60 and
                performance_data.sharpe_ratio >= 1.5 and
                performance_data.max_drawdown < 0.08 and
                performance_data.profit_consistency >= 0.7):
                return "L4", "ç¨³å®šæœŸè¡¨ç°å“è¶Š"
        
        # L4 â†’ L5
        elif current_level == "L4":
            if (performance_data.win_rate_30d >= 0.70 and
                performance_data.sharpe_ratio >= 2.0 and
                performance_data.max_drawdown < 0.05 and
                performance_data.consecutive_profitable_days >= 20):
                return "L5", "è¾¾åˆ°ä¸“å®¶æ°´å¹³"
        
        return None
    
    async def get_current_permission_config(self, level: str) -> dict:
        """
        è·å–å½“å‰æƒé™ç­‰çº§çš„é…ç½®
        """
        return PERMISSION_LEVELS.get(level, PERMISSION_LEVELS["L1"])
```

#### 2.2.2 æƒé™å‚æ•°é…ç½®

```python
# backend/app/config/permissions.py

PERMISSION_LEVELS = {
    "L0": {
        "name": "ä¿æŠ¤æ¨¡å¼",
        "max_position_pct": 0.0,        # ä¸å…è®¸å¼€ä»“
        "max_leverage": 1,
        "confidence_threshold": 1.0,     # å®é™…ä¸Šç¦æ­¢äº¤æ˜“
        "max_daily_trades": 0,           # åªèƒ½å¹³ä»“
        "allow_new_positions": False,
        "description": "è§¦å‘é£æ§ï¼Œéœ€è¦äººå·¥å®¡æ ¸"
    },
    "L1": {
        "name": "æ–°æ‰‹çº§",
        "max_position_pct": 0.10,        # å•ä»“ä½æœ€å¤§10%
        "max_leverage": 2,
        "confidence_threshold": 0.80,
        "max_daily_trades": 1,
        "allow_new_positions": True,
        "upgrade_conditions": {
            "min_days": 7,
            "min_win_rate_7d": 0.50,
            "max_drawdown": 0.15
        }
    },
    "L2": {
        "name": "æˆé•¿çº§",
        "max_position_pct": 0.12,
        "max_leverage": 2,
        "confidence_threshold": 0.75,
        "max_daily_trades": 2,
        "allow_new_positions": True,
        "upgrade_conditions": {
            "min_days": 30,
            "min_win_rate_30d": 0.50,
            "min_sharpe_ratio": 1.0,
            "max_drawdown": 0.10
        }
    },
    "L3": {
        "name": "ç¨³å®šçº§",
        "max_position_pct": 0.15,
        "max_leverage": 3,
        "confidence_threshold": 0.70,
        "max_daily_trades": 4,
        "allow_new_positions": True,
        "upgrade_conditions": {
            "min_win_rate_30d": 0.60,
            "min_sharpe_ratio": 1.5,
            "max_drawdown": 0.08,
            "min_profit_consistency": 0.7
        }
    },
    "L4": {
        "name": "ç†Ÿç»ƒçº§",
        "max_position_pct": 0.20,
        "max_leverage": 4,
        "confidence_threshold": 0.65,
        "max_daily_trades": 6,
        "allow_new_positions": True,
        "upgrade_conditions": {
            "min_win_rate_30d": 0.70,
            "min_sharpe_ratio": 2.0,
            "max_drawdown": 0.05,
            "min_consecutive_profitable_days": 20
        }
    },
    "L5": {
        "name": "ä¸“å®¶çº§",
        "max_position_pct": 0.25,
        "max_leverage": 5,
        "confidence_threshold": 0.60,
        "max_daily_trades": 999,         # æ— é™åˆ¶
        "allow_new_positions": True,
        "upgrade_conditions": None       # æœ€é«˜ç­‰çº§
    }
}
```

---

## 3. ä¿æŠ¤æ€§çº¦æŸ

### 3.1 è´¦æˆ·å®‰å…¨çº¦æŸ

**ç»å¯¹çº¢çº¿ï¼Œä»»ä½•æƒé™ç­‰çº§éƒ½ä¸å¯çªç ´**ï¼š

```python
# backend/app/config/constraints.py

HARD_CONSTRAINTS = {
    # 1. çˆ†ä»“ä¿æŠ¤
    "min_margin_ratio": 0.20,           # æœ€ä½ä¿è¯é‡‘ç‡20%
    "forced_liquidation_threshold": 0.15,  # 15%å¼ºåˆ¶å¹³ä»“
    
    # 2. æœ€å¤§å›æ’¤ä¿æŠ¤
    "max_total_drawdown": 0.10,         # æ€»è´¦æˆ·æœ€å¤§å›æ’¤10%
    "max_single_trade_loss": 0.03,      # å•ç¬”æœ€å¤§äºæŸ3%
    
    # 3. å•æ—¥äºæŸä¿æŠ¤
    "max_daily_loss": 0.05,             # å•æ—¥æœ€å¤§äºæŸ5%
    "daily_loss_action": "STOP_TRADING", # è§¦å‘ååœæ­¢äº¤æ˜“
    
    # 4. æ æ†ç¡¬ä¸Šé™
    "absolute_max_leverage": 5,         # ç»å¯¹æœ€å¤§æ æ†5x
    
    # 5. æµåŠ¨æ€§ä¿æŠ¤
    "min_cash_reserve": 0.10,           # è‡³å°‘ä¿ç•™10%ç°é‡‘
    
    # 6. å•ä¸€èµ„äº§é›†ä¸­åº¦
    "max_single_asset_exposure": 0.30,  # å•ä¸€èµ„äº§æœ€å¤§30%
}
```

### 3.2 ç¡¬çº¦æŸéªŒè¯

```python
# backend/app/services/constraint_validator.py

async def validate_hard_constraints(
    account_state: dict,
    proposed_trade: dict
) -> tuple[bool, str]:
    """
    éªŒè¯ç¡¬æ€§çº¦æŸï¼Œä»»ä½•è¿åéƒ½æ‹’ç»äº¤æ˜“
    
    Returns:
        (is_valid, reason)
    """
    
    # 1. æ£€æŸ¥ä¿è¯é‡‘ç‡
    if account_state["margin_ratio"] < HARD_CONSTRAINTS["min_margin_ratio"]:
        return False, "ä¿è¯é‡‘ç‡ä¸è¶³ï¼Œç¦æ­¢å¼€æ–°ä»“"
    
    # 2. æ£€æŸ¥æ€»å›æ’¤
    if account_state["total_drawdown"] >= HARD_CONSTRAINTS["max_total_drawdown"]:
        return False, "è¾¾åˆ°æœ€å¤§å›æ’¤é™åˆ¶ï¼Œè§¦å‘ä¿æŠ¤"
    
    # 3. æ£€æŸ¥å•æ—¥äºæŸ
    if account_state["daily_loss"] >= HARD_CONSTRAINTS["max_daily_loss"]:
        return False, "è¶…è¿‡å•æ—¥äºæŸé™åˆ¶"
    
    # 4. æ£€æŸ¥æ æ†
    if proposed_trade["leverage"] > HARD_CONSTRAINTS["absolute_max_leverage"]:
        return False, f"æ æ†è¶…é™ï¼š{proposed_trade['leverage']}x > 5x"
    
    # 5. æ£€æŸ¥æµåŠ¨æ€§
    available_cash = account_state["cash_balance"]
    required_reserve = account_state["total_value"] * HARD_CONSTRAINTS["min_cash_reserve"]
    if available_cash - proposed_trade["required_margin"] < required_reserve:
        return False, "ç°é‡‘å‚¨å¤‡ä¸è¶³"
    
    # 6. æ£€æŸ¥å•ä¸€èµ„äº§é›†ä¸­åº¦
    asset = proposed_trade["symbol"]
    current_exposure = account_state["asset_exposure"].get(asset, 0)
    new_exposure = current_exposure + proposed_trade["position_value"]
    if new_exposure / account_state["total_value"] > HARD_CONSTRAINTS["max_single_asset_exposure"]:
        return False, f"{asset}æ•å£è¿‡å¤§"
    
    return True, "é€šè¿‡ç¡¬æ€§çº¦æŸæ£€æŸ¥"
```

### 3.3 å¼ºåˆ¶å¹³ä»“æœºåˆ¶

```python
async def check_forced_liquidation(account_state: dict):
    """
    æŒç»­ç›‘æ§ï¼Œè§¦å‘æ¡ä»¶æ—¶å¼ºåˆ¶å¹³ä»“
    """
    
    # è§¦å‘æ¡ä»¶
    force_close_triggers = [
        # 1. ä¿è¯é‡‘ç‡è¿‡ä½
        account_state["margin_ratio"] < HARD_CONSTRAINTS["forced_liquidation_threshold"],
        
        # 2. å•æ—¥äºæŸè¶…é™
        account_state["daily_loss"] >= HARD_CONSTRAINTS["max_daily_loss"],
        
        # 3. æ€»å›æ’¤è¶…é™
        account_state["total_drawdown"] >= HARD_CONSTRAINTS["max_total_drawdown"],
    ]
    
    if any(force_close_triggers):
        logger.critical("ğŸš¨ è§¦å‘å¼ºåˆ¶å¹³ä»“æ¡ä»¶")
        
        # æ‰§è¡Œå¼ºåˆ¶å¹³ä»“
        positions = await get_all_positions()
        for position in positions:
            await force_close_position(
                position_id=position["id"],
                reason="è§¦å‘é£æ§ä¿æŠ¤",
                priority="URGENT"
            )
        
        # é™çº§åˆ°L0
        await set_permission_level("L0")
        
        # å‘é€å‘Šè­¦
        await send_alert(
            level="CRITICAL",
            message="è§¦å‘å¼ºåˆ¶å¹³ä»“ï¼Œç³»ç»Ÿå·²è¿›å…¥ä¿æŠ¤æ¨¡å¼",
            channels=["email", "sms", "telegram"]
        )
```

---

## 4. æŒ‡å¯¼æ€§çº¦æŸ

### 4.1 ç½®ä¿¡åº¦åŠ¨æ€é—¨æ§›

**æ ¸å¿ƒæ€æƒ³**ï¼šç½®ä¿¡åº¦ä¸æ˜¯ç¡¬æ€§æ‹’ç»ï¼Œè€Œæ˜¯å½±å“å†³ç­–æƒé‡

```python
def apply_confidence_threshold(
    ai_decision: dict,
    current_level: str
) -> dict:
    """
    æ ¹æ®ç½®ä¿¡åº¦å’Œæƒé™ç­‰çº§è°ƒæ•´å†³ç­–
    """
    
    confidence = ai_decision["confidence"]
    threshold = PERMISSION_LEVELS[current_level]["confidence_threshold"]
    
    # é«˜äºé—¨æ§›ï¼šæ­£å¸¸æ‰§è¡Œ
    if confidence >= threshold:
        ai_decision["status"] = "APPROVED"
        ai_decision["notes"] = "ç½®ä¿¡åº¦è¾¾æ ‡"
        return ai_decision
    
    # ç•¥ä½äºé—¨æ§›ï¼ˆ-0.05å†…ï¼‰ï¼šé™ä½ä»“ä½æ‰§è¡Œ
    elif confidence >= (threshold - 0.05):
        ai_decision["status"] = "APPROVED_REDUCED"
        ai_decision["size_usd"] *= 0.5  # å‡åŠä»“ä½
        ai_decision["notes"] = "ç½®ä¿¡åº¦ç•¥ä½ï¼Œå‡åŠä»“ä½"
        return ai_decision
    
    # æ˜æ˜¾ä½äºé—¨æ§›ï¼šæ‹’ç»
    else:
        ai_decision["status"] = "REJECTED"
        ai_decision["notes"] = f"ç½®ä¿¡åº¦ä¸è¶³ï¼š{confidence} < {threshold}"
        return ai_decision
```

### 4.2 äº¤æ˜“é¢‘ç‡æŒ‡å¯¼

```python
def apply_frequency_guidance(
    ai_decision: dict,
    current_level: str,
    today_trade_count: int
) -> dict:
    """
    é¢‘ç‡ä¸æ˜¯å¼ºåˆ¶ï¼Œä½†è¶…å‡ºå»ºè®®éœ€è¦æ›´é«˜ç½®ä¿¡åº¦
    """
    
    max_daily = PERMISSION_LEVELS[current_level]["max_daily_trades"]
    
    # åœ¨å»ºè®®èŒƒå›´å†…ï¼šæ­£å¸¸
    if today_trade_count < max_daily:
        return ai_decision
    
    # è¶…å‡ºå»ºè®®ï¼šéœ€è¦æ›´é«˜ç½®ä¿¡åº¦
    else:
        required_confidence = 0.85  # éœ€è¦85%ä»¥ä¸Šç½®ä¿¡åº¦
        
        if ai_decision["confidence"] >= required_confidence:
            ai_decision["notes"] = f"è¶…å‡ºæ—¥é¢‘ç‡å»ºè®®({max_daily}æ¬¡)ï¼Œä½†ç½®ä¿¡åº¦è¶³å¤Ÿé«˜"
            return ai_decision
        else:
            ai_decision["status"] = "REJECTED"
            ai_decision["notes"] = f"è¶…å‡ºæ—¥é¢‘ç‡ä¸”ç½®ä¿¡åº¦ä¸è¶³"
            return ai_decision
```

### 4.3 ä»“ä½å¤§å°æŒ‡å¯¼

```python
def apply_position_size_guidance(
    ai_decision: dict,
    current_level: str,
    account_balance: float
) -> dict:
    """
    æ ¹æ®æƒé™ç­‰çº§å’Œç½®ä¿¡åº¦è°ƒæ•´ä»“ä½
    """
    
    max_pct = PERMISSION_LEVELS[current_level]["max_position_pct"]
    max_size = account_balance * max_pct
    
    proposed_size = ai_decision["size_usd"]
    
    # åœ¨å»ºè®®èŒƒå›´å†…ï¼šæ­£å¸¸
    if proposed_size <= max_size:
        return ai_decision
    
    # è¶…å‡ºå»ºè®®ï¼šè‡ªåŠ¨è°ƒæ•´
    else:
        logger.warning(
            f"AIå»ºè®®ä»“ä½${proposed_size}è¶…å‡ºæƒé™${max_size}ï¼Œ"
            f"è‡ªåŠ¨è°ƒæ•´ä¸ºæƒé™ä¸Šé™"
        )
        ai_decision["size_usd"] = max_size
        ai_decision["size_adjusted"] = True
        ai_decision["original_size"] = proposed_size
        ai_decision["notes"] = f"ä»“ä½è°ƒæ•´ï¼š{proposed_size} â†’ {max_size}"
        
        return ai_decision
```

---

## 5. Promptè®¾è®¡

### 5.1 æ”¹è¿›åçš„Promptæ¨¡æ¿

**æ ¸å¿ƒå˜åŒ–**ï¼š
- âŒ åˆ é™¤ï¼šè¿‡åº¦æ¿€è¿›çš„ç«äº‰è¯­è¨€
- âœ… å¢åŠ ï¼šåŠ¨æ€æƒé™ä¿¡æ¯å’Œå†å²ç»éªŒ
- âœ… å¼ºè°ƒï¼šé£é™©ç®¡ç†å’Œé•¿æœŸä¸»ä¹‰

```python
def build_trading_prompt_v2(
    market_data: dict,
    account_state: dict,
    permission_level: str,
    recent_memory: list
) -> str:
    """
    æ”¹è¿›åçš„Promptï¼Œå¹³è¡¡çº¦æŸä¸è‡ªä¸»æ€§
    """
    
    level_config = PERMISSION_LEVELS[permission_level]
    
    prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŠ å¯†è´§å¸é‡åŒ–äº¤æ˜“AIï¼Œä½¿ç”¨DeepSeek V3æ¨¡å‹ã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å½“å‰çŠ¶æ€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è´¦æˆ·ä¿¡æ¯ï¼š
â€¢ ä½™é¢ï¼š${account_state['balance']:.2f}
â€¢ æƒé™ç­‰çº§ï¼š{level_config['name']} ({permission_level})
â€¢ å¯ç”¨ä»“ä½ï¼šå•ç¬”æœ€å¤§ {level_config['max_position_pct']*100}%
â€¢ ç½®ä¿¡åº¦é—¨æ§›ï¼š{level_config['confidence_threshold']}
â€¢ ä»Šæ—¥å·²äº¤æ˜“ï¼š{account_state['today_trades']}/{level_config['max_daily_trades']}æ¬¡

å¸‚åœºæ•°æ®ï¼š
{format_market_data(market_data)}

å½“å‰æŒä»“ï¼š
{format_positions(account_state['positions'])}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å†å²ç»éªŒï¼ˆæœ€è¿‘10æ¬¡ç±»ä¼¼æƒ…å†µï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{format_recent_memory(recent_memory)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ä½ çš„ä»»åŠ¡
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åŸºäºå½“å‰å¸‚åœºçŠ¶æ€å’Œå†å²ç»éªŒï¼Œåšå‡ºäº¤æ˜“å†³ç­–ã€‚

æ ¸å¿ƒåŸåˆ™ï¼š
1. **æœ¬é‡‘ä¿æŠ¤ç¬¬ä¸€**ï¼šä»»ä½•æ—¶å€™éƒ½è¦è€ƒè™‘æœ€åæƒ…å†µ
2. **é•¿æœŸä¸»ä¹‰**ï¼šè¿½æ±‚ç¨³å®šæ”¶ç›Šï¼Œä¸è¿½æ±‚æš´åˆ©
3. **é£é™©æ”¶ç›Šå¹³è¡¡**ï¼šåªåœ¨é£é™©å¯æ§æ—¶æ‰äº¤æ˜“
4. **ä»å†å²ä¸­å­¦ä¹ **ï¼šå‚è€ƒä¹‹å‰ç±»ä¼¼æƒ…å†µçš„æˆè´¥

ä½ çš„æƒé™è¯´æ˜ï¼š
â€¢ ä½ å¤„äº{level_config['name']}ï¼Œè¿™æ˜¯åŸºäºä½ çš„å†å²è¡¨ç°
â€¢ å•ç¬”ä»“ä½æœ€å¤§{level_config['max_position_pct']*100}%
â€¢ å¦‚æœè¡¨ç°å¥½ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æå‡ä½ çš„æƒé™
â€¢ å¦‚æœè¡¨ç°å·®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é™ä½ä½ çš„æƒé™ä»¥ä¿æŠ¤è´¦æˆ·

å†³ç­–å»ºè®®ï¼š
â€¢ ä¼˜å…ˆè€ƒè™‘ä½é¢‘é«˜èƒœç‡ç­–ç•¥
â€¢ å»ºè®®æ¯å¤©ä¸è¶…è¿‡{level_config['max_daily_trades']}æ¬¡äº¤æ˜“ï¼ˆéå¼ºåˆ¶ï¼‰
â€¢ å¼€ä»“æ—¶åŒæ—¶è®¾ç½®æ­¢æŸå’Œæ­¢ç›ˆ
â€¢ ç½®ä¿¡åº¦ä¸è¶³æ—¶é€‰æ‹©"hold"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¿”å›æ ¼å¼ï¼ˆJSONï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{{
    "action": "open_long" | "open_short" | "close" | "hold",
    "symbol": "BTC" | "ETH" | "SOL",
    "size_usd": 123.45,
    "leverage": 2,
    "confidence": 0.85,
    "stop_loss_pct": 0.03,
    "take_profit_pct": 0.05,
    "reasoning": "ä½ çš„å†³ç­–ç†ç”±ï¼ˆ100å­—ä»¥å†…ï¼‰"
}}

**é‡è¦æç¤º**ï¼š
- confidenceå¿…é¡»æ˜¯ä½ çš„çœŸå®ä¿¡å¿ƒæ°´å¹³ï¼ˆ0-1ä¹‹é—´ï¼‰
- stop_losså’Œtake_profitå¿…é¡»è®¾ç½®
- å¦‚æœä¸ç¡®å®šï¼Œé€‰æ‹©"hold"æ˜¯æœ€å®‰å…¨çš„å†³ç­–
"""
    
    return prompt
```

---

## 6. æŠ€æœ¯å®ç°è·¯çº¿

### 6.1 Phase 1 å®ç°æ¸…å•

**æ ¸å¿ƒç»„ä»¶**ï¼š

```
âœ… å¿…é¡»å®ç°ï¼š
â”œâ”€â”€ PermissionManagerï¼ˆæƒé™ç®¡ç†å™¨ï¼‰
â”œâ”€â”€ ConstraintValidatorï¼ˆçº¦æŸéªŒè¯å™¨ï¼‰
â”œâ”€â”€ PromptBuilderï¼ˆPromptæ„å»ºå™¨ï¼‰
â””â”€â”€ AlertSystemï¼ˆå‘Šè­¦ç³»ç»Ÿï¼‰

âš ï¸ é›†æˆè¦æ±‚ï¼š
â”œâ”€â”€ æ¯æ¬¡äº¤æ˜“å‰éªŒè¯ç¡¬çº¦æŸ
â”œâ”€â”€ æ¯æ¬¡äº¤æ˜“åè¯„ä¼°æƒé™ç­‰çº§
â”œâ”€â”€ è§¦å‘é£æ§æ—¶ç«‹å³å‘Šè­¦
â””â”€â”€ æ—¥å¿—è®°å½•æ‰€æœ‰å†³ç­–å’Œçº¦æŸæ£€æŸ¥
```

### 6.2 é›†æˆæµç¨‹

```python
# backend/app/services/ai_trading_service.py

class AITradingService:
    """
    AIäº¤æ˜“æœåŠ¡ï¼ˆé›†æˆçº¦æŸæ¡†æ¶ï¼‰
    """
    
    def __init__(self):
        self.permission_manager = PermissionManager(db)
        self.constraint_validator = ConstraintValidator()
        self.prompt_builder = PromptBuilder()
    
    async def make_trading_decision(self):
        """
        å®Œæ•´çš„å†³ç­–æµç¨‹
        """
        # 1. è·å–å½“å‰æƒé™ç­‰çº§
        current_level = await self.permission_manager.get_current_level()
        
        # 2. è·å–è´¦æˆ·çŠ¶æ€
        account_state = await self.get_account_state()
        
        # 3. æ£€æŸ¥æ˜¯å¦è§¦å‘å¼ºåˆ¶å¹³ä»“
        await check_forced_liquidation(account_state)
        
        # 4. æ„å»ºPromptï¼ˆåŒ…å«æƒé™ä¿¡æ¯ï¼‰
        market_data = await self.get_market_data()
        recent_memory = await self.get_recent_memory()
        
        prompt = self.prompt_builder.build(
            market_data=market_data,
            account_state=account_state,
            permission_level=current_level,
            recent_memory=recent_memory
        )
        
        # 5. AIå†³ç­–
        ai_decision = await self.call_deepseek(prompt)
        
        # 6. åº”ç”¨æŒ‡å¯¼æ€§çº¦æŸ
        ai_decision = apply_confidence_threshold(ai_decision, current_level)
        ai_decision = apply_frequency_guidance(ai_decision, current_level, account_state["today_trades"])
        ai_decision = apply_position_size_guidance(ai_decision, current_level, account_state["balance"])
        
        # 7. éªŒè¯ç¡¬æ€§çº¦æŸ
        if ai_decision["action"] in ["open_long", "open_short"]:
            is_valid, reason = await self.constraint_validator.validate(
                account_state, 
                ai_decision
            )
            
            if not is_valid:
                logger.warning(f"âŒ äº¤æ˜“è¢«ç¡¬çº¦æŸæ‹’ç»: {reason}")
                ai_decision["status"] = "REJECTED"
                ai_decision["notes"] = reason
                return ai_decision
        
        # 8. æ‰§è¡Œäº¤æ˜“
        if ai_decision["status"] == "APPROVED":
            result = await self.execute_trade(ai_decision)
            
            # 9. è¯„ä¼°æƒé™ç­‰çº§ï¼ˆäº¤æ˜“åï¼‰
            await self.permission_manager.evaluate_and_update()
        
        return ai_decision
```

---

## 7. æµ‹è¯•éªŒè¯

### 7.1 å•å…ƒæµ‹è¯•

```python
# tests/test_constraint_framework.py

import pytest

def test_permission_downgrade():
    """æµ‹è¯•æƒé™é™çº§é€»è¾‘"""
    manager = PermissionManager(mock_db)
    
    # æ¨¡æ‹Ÿè¿ç»­äºæŸ
    performance = PerformanceData(
        consecutive_losses=5,
        max_drawdown=0.12,
        win_rate_7d=0.30
    )
    
    new_level, reason = manager._check_downgrade_triggers("L3", performance)
    
    assert new_level == "L0"
    assert "é£æ§ä¿æŠ¤" in reason

def test_hard_constraints():
    """æµ‹è¯•ç¡¬çº¦æŸéªŒè¯"""
    validator = ConstraintValidator()
    
    # æ¨¡æ‹Ÿè´¦æˆ·çŠ¶æ€
    account_state = {
        "margin_ratio": 0.18,  # ä½äº20%
        "total_drawdown": 0.08,
        "daily_loss": 0.03
    }
    
    proposed_trade = {
        "symbol": "BTC",
        "size_usd": 100,
        "leverage": 3
    }
    
    is_valid, reason = validator.validate(account_state, proposed_trade)
    
    assert not is_valid
    assert "ä¿è¯é‡‘ç‡ä¸è¶³" in reason
```

### 7.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. âœ… L1æƒé™ä¸‹ï¼ŒAIå°è¯•è¶…å‡º10%ä»“ä½ â†’ è‡ªåŠ¨è°ƒæ•´
2. âœ… å•æ—¥äºæŸè¾¾åˆ°5% â†’ è§¦å‘å¼ºåˆ¶å¹³ä»“+é™çº§L0
3. âœ… è¿ç»­7å¤©50%+èƒœç‡ â†’ è‡ªåŠ¨å‡çº§L1â†’L2
4. âœ… ç½®ä¿¡åº¦ç•¥ä½äºé—¨æ§› â†’ å‡åŠä»“ä½æ‰§è¡Œ

---

## 8. ç›‘æ§ä¸ä¼˜åŒ–

### 8.1 å…³é”®æŒ‡æ ‡

```python
# çº¦æŸæ¡†æ¶ç›‘æ§æŒ‡æ ‡
CONSTRAINT_METRICS = {
    "æƒé™ç­‰çº§åˆ†å¸ƒ": "å„ç­‰çº§åœç•™æ—¶é—´",
    "ç¡¬çº¦æŸæ‹’ç»ç‡": "è¢«ç¡¬çº¦æŸæ‹¦æˆªçš„äº¤æ˜“æ¯”ä¾‹",
    "è½¯çº¦æŸè°ƒæ•´ç‡": "ä»“ä½/é¢‘ç‡è¢«è°ƒæ•´çš„æ¯”ä¾‹",
    "å¼ºåˆ¶å¹³ä»“æ¬¡æ•°": "è§¦å‘å¼ºåˆ¶å¹³ä»“çš„æ¬¡æ•°",
    "æƒé™å‡é™é¢‘ç‡": "å‡çº§å’Œé™çº§çš„é¢‘ç‡"
}
```

### 8.2 æŒç»­ä¼˜åŒ–

**Phase 1å®Œæˆåè¯„ä¼°**ï¼š
- çº¦æŸæ˜¯å¦è¿‡æ¾/è¿‡ç´§ï¼Ÿ
- æƒé™å‡é™é€»è¾‘æ˜¯å¦åˆç†ï¼Ÿ
- AIæ˜¯å¦èƒ½åœ¨çº¦æŸä¸‹æ­£å¸¸è¿ä½œï¼Ÿ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [AIäº¤æ˜“è§„åˆ™æ–‡æ¡£](../01-æ ¸å¿ƒè§„åˆ™/AIäº¤æ˜“è§„åˆ™æ–‡æ¡£.md) - å®Œæ•´è§„åˆ™
- [è®°å¿†å­¦ä¹ ç³»ç»Ÿ](./02-è®°å¿†å­¦ä¹ ç³»ç»Ÿ.md) - è®°å¿†ç³»ç»ŸæŠ€æœ¯ç»†èŠ‚
- [ç›‘æ§è¯„ä¼°ç³»ç»Ÿ](./04-ç›‘æ§è¯„ä¼°ç³»ç»Ÿ.md) - KPIæŒ‡æ ‡ä½“ç³»

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-10-31  
**ç»´æŠ¤çŠ¶æ€**: âœ… Active  
**PhaseçŠ¶æ€**: Phase 1æ ¸å¿ƒå®ç°

