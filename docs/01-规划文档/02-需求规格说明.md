# 需求规格说明

**文档编号**: AICOIN-PLAN-002  
**文档版本**: v1.0.0  
**文档状态**: ✅ 已批准  
**创建日期**: 2025-10-22  
**最后更新**: 2025-10-22  
**文档所有者**: 产品经理  
**审阅人**: 技术负责人  
**密级**: 内部公开

---

## 文档修订历史

| 版本 | 日期 | 修订人 | 修订说明 | 审批人 |
|------|------|--------|---------|--------|
| v1.0.0 | 2025-10-22 | 产品经理 | 初始版本创建 | 技术负责人 |

---

## 1. 引言

### 1.1 文档目的

本文档详细描述 AIcoin Alpha Arena 项目的功能需求和非功能需求，为系统设计、开发、测试提供依据。

### 1.2 项目范围

参考 [AICOIN-PLAN-001 项目概述](./01-项目概述.md)

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| LLM | Large Language Model，大语言模型 |
| Hyperliquid | 去中心化衍生品交易所 |
| 永续合约 | 无到期日的期货合约 |
| 夏普比率 | 风险调整后收益 = (收益-无风险利率)/波动率 |
| PnL | Profit and Loss，盈亏 |
| 订单簿 | Order Book，买卖挂单深度数据 |

---

## 2. 功能需求

### FR-001: AI决策引擎

#### FR-001-01: LLM集成
**优先级**: P0  
**需求描述**: 系统必须能够集成第三方LLM API（DeepSeek/Claude/GPT-4）

**详细功能**:
- 支持多个LLM提供商切换
- API密钥安全管理
- 请求重试机制
- 响应缓存优化

**验收标准**:
- API调用成功率 ≥ 99%
- 单次调用响应时间 ≤ 3秒
- 支持至少3个LLM提供商

#### FR-001-02: Prompt工程
**优先级**: P0  
**需求描述**: 设计并维护交易决策Prompt模板

**Prompt输入数据**:
```json
{
  "symbol": "BTC-PERP",
  "current_price": 67500.00,
  "timestamp": "2025-10-22T10:00:00Z",
  "market_data": {
    "kline_1h": [...],  // 最近24根1小时K线
    "orderbook": {
      "bids": [[67490, 10.5], ...],  // 前20档买单
      "asks": [[67510, 8.3], ...]    // 前20档卖单
    }
  },
  "account": {
    "balance": 10000.00,
    "position": {
      "size": 0.5,
      "entry_price": 67000.00,
      "unrealized_pnl": 250.00
    }
  }
}
```

**Prompt输出格式**:
```json
{
  "action": "BUY" | "SELL" | "HOLD",
  "size": 0.05,
  "confidence": 0.85,
  "reasoning": "市场出现上涨趋势，订单簿买压增强..."
}
```

**验收标准**:
- 决策合理性人工评分 ≥ 4/5
- 输出格式解析成功率 100%

#### FR-001-03: 决策解析器
**优先级**: P0  
**需求描述**: 解析LLM输出为标准交易指令

**功能**:
- JSON Schema验证
- 异常处理（格式错误、不合法值）
- 决策日志记录

**验收标准**:
- 解析成功率 100%
- 异常时触发人工审核告警

---

### FR-002: 交易执行系统

#### FR-002-01: Hyperliquid API集成
**优先级**: P0  
**需求描述**: 接入Hyperliquid交易所API

**支持功能**:
- 账户认证
- 市场数据获取（K线、订单簿、实时成交）
- 订单管理（下单、撤单、查询）
- 资产查询（余额、持仓、保证金）

**验收标准**:
- API连接稳定性 ≥ 99.5%
- 所有API端点测试通过

#### FR-002-02: 订单执行
**优先级**: P0  
**需求描述**: 执行AI决策的交易订单

**订单类型**:
- 市价单（Market Order）
- 限价单（Limit Order）

**执行流程**:
```
AI决策 → 风控验证 → 订单签名 → 提交API → 确认回执 → 记录日志
```

**验收标准**:
- 订单执行成功率 ≥ 99%
- 滑点 ≤ 0.1%
- 执行延迟 ≤ 1秒

#### FR-002-03: 持仓管理
**优先级**: P0  
**需求描述**: 实时管理交易持仓

**功能**:
- 持仓查询
- 未实现盈亏计算
- 保证金使用率监控
- 自动平仓（风控触发）

**验收标准**:
- 数据准确性 100%
- 更新延迟 ≤ 500ms

---

### FR-003: 风险控制系统

#### FR-003-01: 预执行风控
**优先级**: P0  
**需求描述**: 订单执行前的风险检查

**风控规则**:

| 规则编号 | 规则名称 | 限制条件 | 触发动作 |
|---------|---------|---------|---------|
| RC-001 | 单笔仓位限制 | ≤ 20%总资金 | 拒绝订单 |
| RC-002 | 单日亏损限制 | ≤ 5% | 拒绝新开仓 |
| RC-003 | 最大回撤限制 | ≤ 10% | 全部平仓 |
| RC-004 | 连续亏损限制 | ≤ 3笔 | 人工审核 |

**验收标准**:
- 所有风控规则100%生效
- 风控检查延迟 ≤ 100ms

#### FR-003-02: 实时监控
**优先级**: P0  
**需求描述**: 实时监控账户风险指标

**监控指标**:
- 当前持仓占比
- 未实现盈亏
- 已实现盈亏（日/周/月）
- 最大回撤
- 保证金使用率

**告警机制**:
- 风险等级：绿色（安全）、黄色（警告）、红色（危险）
- 告警方式：系统日志 + 前端提示

**验收标准**:
- 监控数据更新频率 ≥ 1次/秒
- 告警触发延迟 ≤ 1秒

---

### FR-004: 数据管理

#### FR-004-01: 市场数据采集
**优先级**: P0  
**需求描述**: 采集并存储市场数据

**数据类型**:
- K线数据（1分钟、5分钟、1小时）
- 订单簿快照（每分钟）
- 实时成交流（WebSocket）

**存储策略**:
- K线：PostgreSQL永久存储
- 订单簿：Redis缓存24小时
- 成交流：Redis缓存1小时

**验收标准**:
- 数据完整性 100%
- 数据延迟 ≤ 500ms

#### FR-004-02: 交易记录
**优先级**: P0  
**需求描述**: 记录所有交易相关数据

**记录内容**:
- 订单详情（时间、品种、方向、价格、数量）
- AI决策日志（输入数据、决策输出、置信度）
- 执行结果（成交价、滑点、手续费）
- 盈亏数据（已实现PnL、未实现PnL）

**验收标准**:
- 所有交易100%记录
- 支持按时间/品种/策略查询

#### FR-004-03: 性能指标计算
**优先级**: P1  
**需求描述**: 实时计算交易性能指标

**指标列表**:
- 收益率（日/周/月/总）
- 夏普比率
- 最大回撤
- 胜率
- 盈亏比
- 交易频率

**计算频率**:
- 实时指标：每笔交易后更新
- 统计指标：每小时计算一次

**验收标准**:
- 计算准确性 100%
- 历史数据可追溯

---

### FR-005: 可视化监控

#### FR-005-01: 主仪表盘
**优先级**: P0  
**需求描述**: 实时展示关键交易数据

**页面组件**:
```
┌─────────────────────────────────────┐
│   总览卡片（总资产、PnL、今日收益）    │
├─────────────────────────────────────┤
│   K线图（TradingView式交互）         │
├──────────────┬──────────────────────┤
│ 持仓面板      │  性能指标面板         │
├──────────────┼──────────────────────┤
│ 交易历史      │  AI思考过程          │
└──────────────┴──────────────────────┘
```

**验收标准**:
- 首屏加载时间 ≤ 2秒
- 数据刷新频率 1秒/次

#### FR-005-02: K线图表
**优先级**: P0  
**需求描述**: 展示价格K线图

**功能要求**:
- 支持1分钟/5分钟/1小时/4小时切换
- 显示技术指标（MA、MACD、RSI、BOLL）
- 标注交易点位（买入/卖出）
- 可缩放、平移、十字光标

**验收标准**:
- 图表流畅性 ≥ 30 FPS
- 数据点数 ≥ 1000根K线

#### FR-005-03: 实时数据推送
**优先级**: P0  
**需求描述**: 通过WebSocket实时推送数据

**推送数据类型**:
- 最新成交价
- 账户资产变化
- 新交易记录
- AI决策日志
- 风险告警

**验收标准**:
- WebSocket连接稳定性 ≥ 99%
- 推送延迟 ≤ 500ms
- 断线自动重连

---

## 3. 非功能需求

### NFR-001: 性能要求

| 性能指标 | 要求值 | 测量方式 |
|---------|--------|---------|
| 系统可用性 | ≥ 99.5% | 月度统计 |
| API响应时间(P95) | ≤ 200ms | APM监控 |
| AI决策延迟 | ≤ 5秒 | 端到端追踪 |
| 前端加载时间 | ≤ 2秒 | Lighthouse |
| 数据库查询时间 | ≤ 50ms | pg_stat |
| WebSocket延迟 | ≤ 500ms | 自定义监控 |
| 并发用户支持 | ≥ 100 | 压力测试 |

### NFR-002: 安全要求

**身份认证**:
- 后台管理界面需要用户名密码登录
- API密钥加密存储
- Session超时时间：30分钟

**私钥管理**:
- 交易私钥本地硬件钱包管理
- 禁止上传到云端或Git
- 支持多签（未来版本）

**数据安全**:
- 敏感数据加密存储（API密钥、私钥）
- HTTPS强制加密传输
- SQL注入防护

**审计日志**:
- 所有交易操作记录
- 登录日志
- 配置变更日志

### NFR-003: 可靠性要求

**容错机制**:
- API调用失败自动重试（最多3次）
- WebSocket断线自动重连
- 数据库连接池管理

**数据备份**:
- 数据库每日自动备份
- 备份保留30天
- 支持一键恢复

**故障恢复**:
- 服务崩溃自动重启（Docker）
- 交易异常时自动停止
- 人工介入机制

### NFR-004: 可维护性要求

**代码质量**:
- 测试覆盖率 ≥ 80%
- 代码注释覆盖率 ≥ 30%
- 遵循PEP8（Python）和Airbnb（TypeScript）规范

**文档完整性**:
- API文档 100%覆盖
- 部署文档详细可执行
- 故障排查手册

**监控告警**:
- 系统资源监控（CPU、内存、磁盘）
- 应用性能监控（APM）
- 异常告警（邮件/钉钉）

### NFR-005: 可扩展性要求

**水平扩展**:
- 支持多实例部署（未来）
- 无状态API设计
- 数据库读写分离（未来）

**功能扩展**:
- 支持新增AI模型
- 支持新增交易所
- 支持新增交易品种

---

## 4. 用户故事

### US-001: 查看实时行情
**作为** 交易监控人员  
**我想要** 查看BTC/ETH/SOL的实时价格和K线图  
**以便于** 了解当前市场状况

**验收标准**:
- 价格更新频率 ≥ 1次/秒
- K线图支持多时间周期切换
- 可标注历史交易点位

### US-002: 监控AI交易
**作为** 系统管理员  
**我想要** 实时查看AI的决策过程和交易执行情况  
**以便于** 确保AI按预期运行

**验收标准**:
- 展示AI决策理由
- 显示每笔交易的盈亏
- 可查询历史决策记录

### US-003: 设置风控规则
**作为** 风控管理员  
**我想要** 配置风控参数（止损比例、最大仓位等）  
**以便于** 控制交易风险

**验收标准**:
- 支持在线修改风控参数
- 参数变更立即生效
- 保留历史配置记录

### US-004: 查看性能报告
**作为** 项目负责人  
**我想要** 查看周度/月度的交易性能报告  
**以便于** 评估AI交易的效果

**验收标准**:
- 显示夏普比率、最大回撤、胜率等指标
- 支持导出Excel报告
- 与基准（买入持有）对比

---

## 5. 接口需求

### 5.1 后端API接口

详见 [AICOIN-API-001 后端API参考](../04-API文档/01-后端API参考.md)

**核心端点**:
- `POST /api/v1/trading/decision` - AI决策
- `POST /api/v1/trading/order` - 下单
- `GET /api/v1/market/kline` - 获取K线
- `GET /api/v1/account/info` - 账户信息
- `GET /api/v1/performance/metrics` - 性能指标

### 5.2 WebSocket接口

详见 [AICOIN-API-002 WebSocket协议](../04-API文档/02-WebSocket协议.md)

**订阅频道**:
- `ticker` - 实时价格
- `trades` - 交易记录推送
- `account` - 账户变化推送
- `ai_decision` - AI决策推送

### 5.3 第三方接口依赖

| 接口名称 | 提供方 | 用途 | 文档 |
|---------|--------|------|------|
| Hyperliquid API | Hyperliquid | 交易执行 | [集成文档](../04-API文档/03-Hyperliquid集成.md) |
| DeepSeek API | DeepSeek | AI决策 | [集成文档](../04-API文档/04-LLM接口集成.md) |
| Claude API | Anthropic | AI决策（备选） | [集成文档](../04-API文档/04-LLM接口集成.md) |

---

## 6. 数据需求

### 6.1 数据库设计

详见 [AICOIN-ARCH-002 数据库设计](../02-架构设计/02-数据库设计.md)

**核心数据表**:
- `trades` - 交易记录表
- `orders` - 订单表
- `account_snapshots` - 账户快照表
- `ai_decisions` - AI决策日志表
- `market_data_kline` - K线数据表
- `risk_events` - 风控事件表

### 6.2 数据保留策略

| 数据类型 | 保留时长 | 归档策略 |
|---------|---------|---------|
| 交易记录 | 永久 | 无 |
| K线数据 | 永久 | 无 |
| AI决策日志 | 永久 | 无 |
| 实时行情缓存 | 24小时 | 自动删除 |
| 订单簿快照 | 7天 | 自动删除 |
| 系统日志 | 30天 | 压缩归档 |

---

## 7. 约束条件

### 7.1 技术约束
- 必须使用第三方LLM API（不自训模型）
- 必须支持Docker容器化部署
- 数据库必须使用PostgreSQL
- 前端必须使用Next.js

### 7.2 业务约束
- MVP阶段仅支持单一AI模型
- 仅支持BTC/ETH/SOL三个交易品种
- 仅支持Hyperliquid交易所
- 测试资金上限5,000 USDC

### 7.3 合规约束
- 使用个人账户，符合KYC要求
- 私钥本地管理，不上传云端
- 交易数据仅内部使用

---

## 8. 验收标准

### 8.1 功能验收

| 功能模块 | 验收标准 | 验收方法 |
|---------|---------|---------|
| AI决策引擎 | API调用成功率>99%，决策合理性>4/5 | 自动化测试+人工评审 |
| 交易执行 | 订单成功率>99%，滑点<0.1% | 集成测试 |
| 风控系统 | 所有规则100%生效 | 边界测试 |
| 可视化 | 所有页面正常显示，数据准确 | 手工测试 |

### 8.2 性能验收

所有性能指标达到NFR-001要求

### 8.3 安全验收

通过安全审计检查清单（详见安全架构文档）

---

## 9. 附录

### A. 需求优先级定义

| 优先级 | 定义 | 处理策略 |
|--------|------|---------|
| P0 | MVP必须 | 必须完成 |
| P1 | 重要但非必须 | 优先完成 |
| P2 | 增强功能 | 时间允许 |
| P3 | 未来版本 | 暂不实现 |

### B. 需求变更流程

```
需求变更申请 → 影响评估 → 团队评审 → PM决策 → 更新文档
```

### C. 相关文档

| 文档编号 | 文档名称 |
|---------|---------|
| PLAN-001 | 项目概述 |
| PLAN-003 | 开发路线图 |
| ARCH-001 | 系统架构设计 |
| ARCH-002 | 数据库设计 |

### D. 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.0.0 | 2025-10-22 | 初始版本 | 产品经理 |

---

**文档结束**

> 📌 下一步：请阅读 [开发路线图 (AICOIN-PLAN-003)](./03-开发路线图.md)

