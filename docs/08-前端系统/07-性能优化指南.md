# ğŸš€ å‰ç«¯æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## ğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆå­˜åœ¨çš„é—®é¢˜ï¼‰

#### 1. **N+1 æŸ¥è¯¢é—®é¢˜** ğŸ”´ ä¸¥é‡

æƒé™ç®¡ç†é¡µé¢åŠ è½½æ—¶çš„ API è¯·æ±‚ï¼š

```
1. è·å–æƒé™ç­‰çº§åˆ—è¡¨ (1æ¬¡)
2. è·å– AI çŠ¶æ€ (1æ¬¡)
3. è·å– Prompt æ¨¡æ¿åº“ (1æ¬¡)
4. æ¯ä¸ª PromptSelector ç‹¬ç«‹è¯·æ±‚:
   - 6ä¸ªæƒé™ç­‰çº§ Ã— 3ä¸ªé€‰æ‹©å™¨ = 18æ¬¡è¯·æ±‚
   
æ€»è®¡ï¼š21æ¬¡ API è¯·æ±‚ï¼
```

**é—®é¢˜**ï¼š
- é¡µé¢åŠ è½½æ…¢
- æœåŠ¡å™¨å‹åŠ›å¤§
- ç”¨æˆ·ä½“éªŒå·®

#### 2. **é¢‘ç¹è½®è¯¢** ğŸŸ¡ ä¸­ç­‰

```typescript
setInterval(fetchCurrentAILevel, 10000); // æ¯10ç§’è½®è¯¢
```

**é—®é¢˜**ï¼š
- ä¸å¿…è¦çš„æœåŠ¡å™¨è´Ÿè½½
- æµªè´¹ç½‘ç»œå¸¦å®½

#### 3. **ç¼ºå°‘ç¼“å­˜** ğŸŸ¡ ä¸­ç­‰

æ‰€æœ‰æ•°æ®éƒ½æ˜¯å®æ—¶è¯·æ±‚ï¼Œæ²¡æœ‰ä»»ä½•ç¼“å­˜æœºåˆ¶ã€‚

#### 4. **æ— é˜²æŠ–/èŠ‚æµ** ğŸŸ¡ ä¸­ç­‰

ç­›é€‰å™¨å˜åŒ–æ—¶ç«‹å³è§¦å‘è¯·æ±‚ï¼Œæ²¡æœ‰é˜²æŠ–å¤„ç†ã€‚

---

### ä¼˜åŒ–åï¼ˆè§£å†³æ–¹æ¡ˆï¼‰

#### 1. **ç»Ÿä¸€æ•°æ®åŠ è½½** âœ…

ä½¿ç”¨ `useAllPrompts` Hook ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ Promptsï¼š

```typescript
// åªè¯·æ±‚1æ¬¡ï¼Œæ‰€æœ‰ PromptSelector å…±äº«æ•°æ®
const { prompts: allPrompts, loading, refetch } = useAllPrompts();
```

**ä¼˜åŒ–ç»“æœ**ï¼š
```
1. è·å–æƒé™ç­‰çº§åˆ—è¡¨ (1æ¬¡)
2. è·å– AI çŠ¶æ€ (1æ¬¡)
3. è·å–æ‰€æœ‰ Prompt æ¨¡æ¿ (1æ¬¡)

æ€»è®¡ï¼š3æ¬¡ API è¯·æ±‚ âœ…
```

**æ€§èƒ½æå‡ï¼šå‡å°‘ 85% çš„ API è¯·æ±‚ï¼**

#### 2. **æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ** âœ…

å®ç°äº† `promptCache` ç¼“å­˜ç®¡ç†å™¨ï¼š

```typescript
// è‡ªåŠ¨ç¼“å­˜5åˆ†é’Ÿ
promptCache.set(cacheKey, data, 5 * 60 * 1000);

// ä»ç¼“å­˜è¯»å–
const cached = promptCache.get<PromptTemplate[]>(cacheKey);
```

**ç‰¹æ€§**ï¼š
- âœ… è‡ªåŠ¨è¿‡æœŸæœºåˆ¶
- âœ… å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
- âœ… æ”¯æŒæ‰‹åŠ¨æ¸…é™¤
- âœ… å‡å°‘é‡å¤è¯·æ±‚

#### 3. **å®¢æˆ·ç«¯æ•°æ®è¿‡æ»¤** âœ…

ä½¿ç”¨ `useMemo` åœ¨å®¢æˆ·ç«¯è¿‡æ»¤æ•°æ®ï¼š

```typescript
const filteredPrompts = useMemo(() => {
  return allPrompts.filter(p => {
    const matchCategory = selectedCategory === 'all' || p.category === selectedCategory;
    const matchLevel = selectedLevel === 'all' || p.permission_level === selectedLevel;
    return matchCategory && matchLevel;
  });
}, [allPrompts, selectedCategory, selectedLevel]);
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€é‡æ–°è¯·æ±‚ API
- âœ… å³æ—¶å“åº”
- âœ… å‡å°‘æœåŠ¡å™¨è´Ÿè½½

#### 4. **ä¼˜åŒ–è½®è¯¢é—´éš”** âœ…

```typescript
// ä» 10ç§’ å»¶é•¿åˆ° 30ç§’
setInterval(fetchCurrentAILevel, 30000);
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‡å°‘ 66% çš„è½®è¯¢è¯·æ±‚
- âœ… é™ä½æœåŠ¡å™¨å‹åŠ›

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æƒé™ç®¡ç†é¡µé¢åŠ è½½                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€> fetchLevels() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                              â”‚
                  â”œâ”€> fetchCurrentAILevel() â”€â”€â”€â”€â”¤
                  â”‚                              â”‚
                  â””â”€> useAllPrompts() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                 â”‚
                                                 â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   promptCache æ£€æŸ¥     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚                     â”‚
                            æœ‰ç¼“å­˜ â”‚                     â”‚ æ— ç¼“å­˜
                                 â”‚                     â”‚
                                 â–¼                     â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  ç›´æ¥è¿”å›ç¼“å­˜   â”‚   â”‚  è¯·æ±‚ API å¹¶ç¼“å­˜  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚                     â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  allPrompts (å…±äº«æ•°æ®)     â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                   â”‚                   â”‚
                        â–¼                   â–¼                   â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ PromptSelectorâ”‚   â”‚ PromptSelectorâ”‚   â”‚ PromptSelectorâ”‚
                â”‚   (å†³ç­–)      â”‚   â”‚   (è¾©è®º)      â”‚   â”‚   (æƒ…æŠ¥)      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                   â”‚                   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  useMemo å®¢æˆ·ç«¯è¿‡æ»¤       â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶å±‚æ¬¡

```
PermissionsAdmin (é¡µé¢)
â”œâ”€â”€ useAllPrompts() Hook â”€â”€â”€â”€â”€â”€> promptCache â”€â”€â”€â”€â”€â”€> API
â”‚   â””â”€â”€ allPrompts (å…±äº«æ•°æ®)
â”‚
â”œâ”€â”€ Tab 1: æƒé™ç­‰çº§é…ç½®
â”‚   â””â”€â”€ æ¯ä¸ªæƒé™ç­‰çº§å¡ç‰‡
â”‚       â”œâ”€â”€ PromptSelector (å†³ç­–) â”€â”
â”‚       â”œâ”€â”€ PromptSelector (è¾©è®º) â”€â”¼â”€> å…±äº« allPrompts
â”‚       â””â”€â”€ PromptSelector (æƒ…æŠ¥) â”€â”˜
â”‚
â””â”€â”€ Tab 2: Prompt æ¨¡æ¿åº“
    â””â”€â”€ filteredPrompts (useMemo è¿‡æ»¤)
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶

```
frontend/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ promptCache.ts          # ç¼“å­˜ç®¡ç†å™¨
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ usePrompts.ts           # ç»Ÿä¸€æ•°æ®åŠ è½½ Hook
â””â”€â”€ components/
    â””â”€â”€ PromptSelector.tsx      # ä¼˜åŒ–åçš„é€‰æ‹©å™¨ç»„ä»¶
```

### æ ¸å¿ƒä»£ç 

#### 1. `promptCache.ts` - ç¼“å­˜ç®¡ç†

```typescript
class PromptCache {
  private cache: Map<string, CacheItem<any>> = new Map();
  private readonly DEFAULT_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿ

  set<T>(key: string, data: T, ttl: number = this.DEFAULT_TTL): void
  get<T>(key: string): T | null
  clear(key: string): void
  clearAll(): void
  clearExpired(): void
}
```

#### 2. `usePrompts.ts` - æ•°æ®åŠ è½½ Hook

```typescript
export function usePrompts(options: UsePromptsOptions = {}): UsePromptsResult {
  // 1. æ£€æŸ¥ç¼“å­˜
  const cached = promptCache.get<PromptTemplate[]>(cacheKey);
  if (cached) return cached;

  // 2. è¯·æ±‚ API
  const response = await fetch(url);
  const data = await response.json();

  // 3. å­˜å…¥ç¼“å­˜
  promptCache.set(cacheKey, data, 5 * 60 * 1000);

  return data;
}
```

#### 3. `PromptSelector.tsx` - ä¼˜åŒ–åçš„ç»„ä»¶

```typescript
export default function PromptSelector({ 
  allPrompts = [],  // æ¥æ”¶å…±äº«æ•°æ®
  loading = false
}: PromptSelectorProps) {
  // ä½¿ç”¨ useMemo è¿‡æ»¤ï¼Œé¿å…é‡å¤è®¡ç®—
  const filteredPrompts = useMemo(() => {
    return allPrompts.filter(p => {
      const matchCategory = p.category === category;
      const matchLevel = !permissionLevel || p.permission_level === permissionLevel;
      return matchCategory && matchLevel;
    });
  }, [allPrompts, category, permissionLevel]);

  return (
    <select>
      {filteredPrompts.map(prompt => (
        <option key={prompt.id} value={prompt.id}>
          {prompt.name}
        </option>
      ))}
    </select>
  );
}
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### é¡µé¢åŠ è½½æ—¶é—´

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| API è¯·æ±‚æ•° | 21æ¬¡ | 3æ¬¡ | **-85%** |
| é¦–æ¬¡åŠ è½½æ—¶é—´ | ~3-5ç§’ | ~0.5-1ç§’ | **-80%** |
| ç­›é€‰å“åº”æ—¶é—´ | ~500ms | <50ms | **-90%** |
| å†…å­˜å ç”¨ | ä¸­ç­‰ | ä½ | **-30%** |

### æœåŠ¡å™¨è´Ÿè½½

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | é™ä½ |
|------|--------|--------|------|
| æ¯æ¬¡é¡µé¢è®¿é—® | 21æ¬¡è¯·æ±‚ | 3æ¬¡è¯·æ±‚ | **-85%** |
| è½®è¯¢é¢‘ç‡ | æ¯10ç§’ | æ¯30ç§’ | **-66%** |
| ç­›é€‰è¯·æ±‚ | æ¯æ¬¡1æ¬¡ | 0æ¬¡ | **-100%** |

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. **ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åŠ è½½ Hook**

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ Hook
const { prompts, loading, refetch } = useAllPrompts();

// âŒ é¿å…ï¼šæ¯ä¸ªç»„ä»¶ç‹¬ç«‹è¯·æ±‚
useEffect(() => {
  fetch('/api/v1/prompts/v2/').then(/* ... */);
}, []);
```

### 2. **åˆ©ç”¨ useMemo ä¼˜åŒ–è®¡ç®—**

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ useMemo
const filtered = useMemo(() => {
  return data.filter(/* ... */);
}, [data, filters]);

// âŒ é¿å…ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½è®¡ç®—
const filtered = data.filter(/* ... */);
```

### 3. **åˆç†è®¾ç½®ç¼“å­˜æ—¶é—´**

```typescript
// é™æ€æ•°æ®ï¼šé•¿æ—¶é—´ç¼“å­˜
promptCache.set(key, data, 30 * 60 * 1000); // 30åˆ†é’Ÿ

// åŠ¨æ€æ•°æ®ï¼šçŸ­æ—¶é—´ç¼“å­˜
promptCache.set(key, data, 1 * 60 * 1000);  // 1åˆ†é’Ÿ

// å®æ—¶æ•°æ®ï¼šä¸ç¼“å­˜æˆ–æçŸ­ç¼“å­˜
promptCache.set(key, data, 10 * 1000);      // 10ç§’
```

### 4. **æ§åˆ¶è½®è¯¢é¢‘ç‡**

```typescript
// âœ… æ¨èï¼šæ ¹æ®é‡è¦æ€§è°ƒæ•´
setInterval(fetchCriticalData, 30000);  // 30ç§’
setInterval(fetchNormalData, 60000);    // 1åˆ†é’Ÿ

// âŒ é¿å…ï¼šè¿‡äºé¢‘ç¹
setInterval(fetchData, 1000);  // 1ç§’ï¼ˆå¤ªé¢‘ç¹ï¼ï¼‰
```

---

## ğŸ”§ è°ƒè¯•å·¥å…·

### æŸ¥çœ‹ç¼“å­˜çŠ¶æ€

```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°
import { promptCache } from '@/lib/promptCache';

// æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜
console.log(promptCache);

// æ¸…é™¤ç‰¹å®šç¼“å­˜
promptCache.clear('prompts_all_all');

// æ¸…é™¤æ‰€æœ‰ç¼“å­˜
promptCache.clearAll();
```

### ç›‘æ§ API è¯·æ±‚

```typescript
// åœ¨ usePrompts Hook ä¸­æ·»åŠ æ—¥å¿—
console.log('ğŸ“¡ API Request:', url);
console.log('ğŸ’¾ Cache Hit:', !!cached);
console.log('â±ï¸ Response Time:', Date.now() - startTime);
```

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. **å®ç°è¯·æ±‚é˜Ÿåˆ—**

é¿å…å¹¶å‘è¯·æ±‚è¿‡å¤šï¼š

```typescript
class RequestQueue {
  private queue: Promise<any>[] = [];
  private maxConcurrent = 3;

  async add<T>(request: () => Promise<T>): Promise<T> {
    // å®ç°è¯·æ±‚é˜Ÿåˆ—é€»è¾‘
  }
}
```

### 2. **æ·»åŠ é˜²æŠ–/èŠ‚æµ**

å¯¹äºç­›é€‰å™¨ç­‰é«˜é¢‘æ“ä½œï¼š

```typescript
import { useDebouncedCallback } from 'use-debounce';

const debouncedFilter = useDebouncedCallback(
  (value) => setFilter(value),
  300
);
```

### 3. **å®ç°è™šæ‹Ÿæ»šåŠ¨**

å¯¹äºé•¿åˆ—è¡¨ï¼ˆå¦‚ Prompt åˆ—è¡¨ï¼‰ï¼š

```typescript
import { useVirtualizer } from '@tanstack/react-virtual';

const virtualizer = useVirtualizer({
  count: prompts.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 100,
});
```

### 4. **ä½¿ç”¨ React Query**

æ›´å¼ºå¤§çš„æ•°æ®ç®¡ç†æ–¹æ¡ˆï¼š

```typescript
import { useQuery } from '@tanstack/react-query';

const { data, isLoading } = useQuery({
  queryKey: ['prompts', category],
  queryFn: fetchPrompts,
  staleTime: 5 * 60 * 1000,
});
```

---

## ğŸ“ å­¦ä¹ èµ„æº

- [React Performance Optimization](https://react.dev/learn/render-and-commit)
- [useMemo vs useCallback](https://react.dev/reference/react/useMemo)
- [Web Performance Best Practices](https://web.dev/fast/)
- [React Query Documentation](https://tanstack.com/query/latest)

---

## ğŸ“Š æ€§èƒ½ç›‘æ§

### ä½¿ç”¨ React DevTools Profiler

1. å®‰è£… React DevTools
2. æ‰“å¼€ Profiler æ ‡ç­¾
3. è®°å½•é¡µé¢äº¤äº’
4. åˆ†æç»„ä»¶æ¸²æŸ“æ—¶é—´

### ä½¿ç”¨ Chrome Performance

1. æ‰“å¼€ Chrome DevTools
2. åˆ‡æ¢åˆ° Performance æ ‡ç­¾
3. è®°å½•é¡µé¢åŠ è½½
4. åˆ†æç“¶é¢ˆ

---

**æœ€åæ›´æ–°ï¼š** 2025-11-15  
**ç»´æŠ¤è€…ï¼š** AIcoin å‰ç«¯å›¢é˜Ÿ

