# 故障排查手册

**文档编号**: AICOIN-OPS-004  
**文档版本**: v1.0.0  
**创建日期**: 2025-10-22

---

## 1. 常见问题

### 1.1 服务无法启动

**现象**: `docker-compose up -d` 失败

**排查步骤**:
```bash
# 1. 查看日志
docker-compose logs backend

# 2. 检查端口占用
sudo lsof -i :8000

# 3. 检查环境变量
cat .env

# 4. 测试数据库连接
docker-compose exec backend python -c "from app.core.database import engine; engine.connect()"
```

---

### 1.2 AI决策失败

**现象**: 日志显示 "AI decision failed"

**排查步骤**:
```bash
# 1. 检查API密钥
echo $DEEPSEEK_API_KEY

# 2. 测试API连接
curl https://api.deepseek.com

# 3. 查看具体错误
docker-compose logs backend | grep "AI decision"

# 4. 检查余额
# 登录DeepSeek控制台查看
```

---

### 1.3 订单执行失败

**现象**: 订单状态为 FAILED

**排查步骤**:
```bash
# 1. 查看风控日志
SELECT * FROM risk_events WHERE resolved = false;

# 2. 检查账户余额
SELECT * FROM account_snapshots ORDER BY timestamp DESC LIMIT 1;

# 3. 验证Hyperliquid连接
docker-compose exec backend python -c "from app.services.hyperliquid import client; print(client.get_balance())"

# 4. 检查仓位限制
# 查看风控配置是否过于严格
```

---

### 1.4 数据库连接错误

**现象**: `connection refused` 或 `timeout`

**排查步骤**:
```bash
# 1. 检查PostgreSQL状态
docker-compose ps postgres

# 2. 测试连接
docker-compose exec postgres psql -U admin -d aicoin

# 3. 检查连接数
SELECT count(*) FROM pg_stat_activity;

# 4. 重启数据库
docker-compose restart postgres
```

---

### 1.5 WebSocket断连

**现象**: 前端无法接收实时数据

**排查步骤**:
```bash
# 1. 检查WebSocket连接
wscat -c ws://localhost:8000/ws

# 2. 查看Nginx配置
cat /etc/nginx/sites-available/aicoin | grep ws

# 3. 检查防火墙
sudo ufw status

# 4. 查看后端日志
docker-compose logs backend | grep WebSocket
```

---

## 2. 性能问题

### 2.1 API响应慢

**排查步骤**:
```bash
# 1. 查看慢查询
SELECT query, mean_exec_time, calls 
FROM pg_stat_statements 
ORDER BY mean_exec_time DESC 
LIMIT 10;

# 2. 检查Redis缓存命中率
redis-cli INFO stats | grep keyspace_hits

# 3. 分析日志
docker-compose logs backend | grep "latency"

# 4. 优化措施
# - 添加数据库索引
# - 增加缓存
# - 优化SQL查询
```

---

## 3. 应急预案

### 3.1 系统崩溃

```bash
# 1. 停止所有交易
docker-compose exec backend python -c "from app.tasks import pause_trading; pause_trading()"

# 2. 平仓所有持仓
docker-compose exec backend python -c "from app.services import close_all_positions; close_all_positions()"

# 3. 备份数据
./backup.sh

# 4. 重启服务
docker-compose restart
```

### 3.2 爆仓风险

```bash
# 1. 检查账户状态
SELECT * FROM account_snapshots ORDER BY timestamp DESC LIMIT 1;

# 2. 立即止损
# 手动平仓或调用API

# 3. 暂停自动交易
# 停止Celery Beat

# 4. 分析原因
# 查看最近交易记录和决策日志
```

---

## 4. 诊断工具

```bash
# 健康检查
curl http://localhost:8000/api/v1/health

# 数据库状态
docker-compose exec postgres pg_isready

# Redis状态
docker-compose exec redis redis-cli PING

# 磁盘空间
df -h

# 内存使用
free -m

# CPU负载
top
```

---

**文档结束**

