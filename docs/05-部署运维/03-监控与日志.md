# 监控与日志

**文档编号**: AICOIN-OPS-003  
**文档版本**: v1.0.0  
**创建日期**: 2025-10-22

---

## 1. 日志管理

### 1.1 日志配置
```python
import logging
from logging.handlers import RotatingFileHandler

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        RotatingFileHandler(
            'logs/app.log',
            maxBytes=10485760,  # 10MB
            backupCount=10
        ),
        logging.StreamHandler()
    ]
)
```

### 1.2 日志级别
- **DEBUG**: 详细调试信息
- **INFO**: 常规操作记录
- **WARNING**: 警告信息
- **ERROR**: 错误信息
- **CRITICAL**: 严重错误

### 1.3 结构化日志
```python
logger.info("AI决策完成", extra={
    "symbol": "BTC-PERP",
    "action": "BUY",
    "size": 0.05,
    "confidence": 0.85,
    "latency_ms": 2300
})
```

---

## 2. 监控指标

### 2.1 系统指标
```bash
# 使用Prometheus + Grafana

# 安装node_exporter
docker run -d -p 9100:9100 prom/node-exporter

# prometheus.yml
scrape_configs:
  - job_name: 'aicoin'
    static_configs:
      - targets: ['localhost:9100', 'localhost:8000']
```

### 2.2 应用指标
```python
from prometheus_client import Counter, Histogram, Gauge

# 定义指标
ai_decision_count = Counter('ai_decisions_total', 'AI决策次数')
ai_decision_latency = Histogram('ai_decision_latency_seconds', 'AI决策延迟')
active_positions = Gauge('active_positions', '活跃持仓数量')

# 使用
ai_decision_count.inc()
ai_decision_latency.observe(2.3)
active_positions.set(5)
```

### 2.3 Grafana仪表盘
- API响应时间
- 数据库查询时间
- AI决策成功率
- 订单执行成功率
- 系统资源使用率

---

## 3. 告警配置

### 3.1 AlertManager配置
```yaml
route:
  receiver: 'team-email'
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h

receivers:
  - name: 'team-email'
    email_configs:
      - to: 'team@example.com'
        from: 'alert@aicoin.ai'
```

### 3.2 告警规则
```yaml
groups:
  - name: aicoin-alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        annotations:
          summary: "高错误率 {{ $value }}"
          
      - alert: APISlowResponse
        expr: http_request_duration_seconds{quantile="0.95"} > 0.5
        for: 5m
        annotations:
          summary: "API响应慢 {{ $value }}s"
```

---

## 4. 日志查询

```bash
# 查看最近100条日志
docker-compose logs --tail=100 backend

# 实时日志
docker-compose logs -f backend

# 错误日志
docker-compose logs backend | grep ERROR

# 特定时间范围
docker-compose logs --since "2025-10-22T10:00:00" backend
```

---

**文档结束**

