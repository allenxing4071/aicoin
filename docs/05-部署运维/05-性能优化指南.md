# 性能优化指南

**文档编号**: AICOIN-OPS-005  
**文档版本**: v1.0.0  
**创建日期**: 2025-10-22

---

## 1. 数据库优化

### 1.1 索引优化
```sql
-- 分析慢查询
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 添加索引
CREATE INDEX idx_trades_timestamp ON trades(timestamp DESC);
CREATE INDEX idx_trades_symbol ON trades(symbol);
```

### 1.2 连接池配置
```python
from sqlalchemy.ext.asyncio import create_async_engine

engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,      # 连接池大小
    max_overflow=10,   # 最大溢出连接
    pool_pre_ping=True # 连接前ping测试
)
```

---

## 2. 缓存策略

### 2.1 Redis缓存
```python
import redis.asyncio as redis

# 缓存K线数据
async def get_kline_cached(symbol: str, interval: str):
    cache_key = f"kline:{symbol}:{interval}"
    cached = await redis_client.get(cache_key)
    
    if cached:
        return json.loads(cached)
    
    data = await fetch_kline(symbol, interval)
    await redis_client.setex(cache_key, 60, json.dumps(data))
    return data
```

### 2.2 缓存预热
```python
@celery_app.task
def warmup_cache():
    """启动时预热常用数据"""
    for symbol in ["BTC-PERP", "ETH-PERP"]:
        get_kline_cached(symbol, "1h")
        get_orderbook_cached(symbol)
```

---

## 3. API优化

### 3.1 异步处理
```python
import asyncio

async def fetch_all_data():
    tasks = [
        fetch_kline("BTC-PERP"),
        fetch_orderbook("BTC-PERP"),
        fetch_account_info()
    ]
    results = await asyncio.gather(*tasks)
    return results
```

### 3.2 批量查询
```python
# Bad
for trade in trades:
    user = db.query(User).get(trade.user_id)

# Good
user_ids = [trade.user_id for trade in trades]
users = db.query(User).filter(User.id.in_(user_ids)).all()
```

---

## 4. 前端优化

### 4.1 代码分割
```typescript
// next.config.js
module.exports = {
  experimental: {
    optimizePackageImports: ['recharts'],
  },
}
```

### 4.2 虚拟滚动
```typescript
import { useVirtualizer } from '@tanstack/react-virtual';

function TradeList({ trades }) {
  const virtualizer = useVirtualizer({
    count: trades.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 50,
  });
  
  return virtualizer.getVirtualItems().map(item => (
    <TradeItem trade={trades[item.index]} />
  ));
}
```

---

## 5. 监控指标

| 指标 | 目标值 | 当前值 | 优化措施 |
|------|--------|--------|---------|
| API P95延迟 | <200ms | - | 添加缓存 |
| 数据库查询时间 | <50ms | - | 索引优化 |
| Redis命中率 | >90% | - | 调整TTL |
| WebSocket延迟 | <500ms | - | 优化推送逻辑 |

---

**文档结束**

