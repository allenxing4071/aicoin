# 后端开发指南

**文档编号**: AICOIN-DEV-006  
**文档版本**: v1.0.0  
**创建日期**: 2025-10-22

---

## 1. FastAPI应用结构

```python
# app/main.py
from fastapi import FastAPI
from app.api.v1 import trading, market, account

app = FastAPI(title="AIcoin API", version="1.0.0")

app.include_router(trading.router, prefix="/api/v1/trading")
app.include_router(market.router, prefix="/api/v1/market")
app.include_router(account.router, prefix="/api/v1/account")
```

---

## 2. 创建新API端点

```python
# app/api/v1/trading.py
from fastapi import APIRouter, Depends
from app.schemas.trade import TradeResponse
from app.services.trading import TradingService

router = APIRouter()

@router.get("/trades", response_model=List[TradeResponse])
async def get_trades(
    limit: int = 20,
    service: TradingService = Depends()
):
    """获取交易记录"""
    trades = await service.get_trades(limit=limit)
    return trades
```

---

## 3. 数据库操作

```python
# app/models/trade.py
from sqlalchemy import Column, Integer, String, Numeric, DateTime
from app.core.database import Base

class Trade(Base):
    __tablename__ = "trades"
    
    id = Column(Integer, primary_key=True)
    symbol = Column(String(20), nullable=False)
    price = Column(Numeric(18, 8), nullable=False)
    timestamp = Column(DateTime, nullable=False)
```

```python
# app/services/trading.py
from sqlalchemy.ext.asyncio import AsyncSession

class TradingService:
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def get_trades(self, limit: int):
        result = await self.db.execute(
            select(Trade).order_by(Trade.timestamp.desc()).limit(limit)
        )
        return result.scalars().all()
```

---

## 4. Celery定时任务

```python
# app/tasks/trading_loop.py
from app.core.celery_app import celery_app

@celery_app.task
def trading_loop():
    """每5分钟执行一次AI决策"""
    # 1. 获取市场数据
    # 2. AI决策
    # 3. 风控验证
    # 4. 执行订单
    pass
```

```python
# app/core/celery_app.py
from celery import Celery
from celery.schedules import crontab

celery_app = Celery('aicoin')

celery_app.conf.beat_schedule = {
    'trading-loop': {
        'task': 'app.tasks.trading_loop.trading_loop',
        'schedule': 300.0,  # 5分钟
    },
}
```

---

**文档结束**

