# 504 Gateway Timeout é—®é¢˜è¯Šæ–­ä¸è§£å†³

## ğŸ“‹ é—®é¢˜æè¿°

**æ—¶é—´**: 2025-11-16  
**ç—‡çŠ¶**: å¤šä¸ª API ç«¯ç‚¹è¿”å› 504 Gateway Timeout é”™è¯¯

### å—å½±å“çš„ç«¯ç‚¹

```
âŒ GET /api/v1/intelligence/platforms
âŒ GET /api/v1/ai-platforms/response-time-percentiles
âŒ GET /api/v1/ai-platforms/response-time-trend  
âŒ GET /api/v1/admin/verify
âŒ GET /api/v1/intelligence/debated-report
```

## ğŸ” é—®é¢˜åˆ†æ

### 504 é”™è¯¯å«ä¹‰

**504 Gateway Timeout** = Nginx ç­‰å¾…åç«¯å“åº”è¶…æ—¶ï¼ˆå½“å‰é…ç½®ï¼š60ç§’ï¼‰

### å¯èƒ½åŸå› 

| åŸå›  | æ¦‚ç‡ | æ£€æŸ¥æ–¹æ³• |
|------|------|---------|
| ğŸ”¥ åç«¯æœåŠ¡å´©æºƒ/æœªå¯åŠ¨ | â­â­â­â­â­ | `docker ps` æ£€æŸ¥å®¹å™¨çŠ¶æ€ |
| ğŸ—„ï¸ æ•°æ®åº“è¿æ¥æ± è€—å°½ | â­â­â­â­ | æ£€æŸ¥æ•°æ®åº“æ´»è·ƒè¿æ¥æ•° |
| âš¡ æŸäº›æŸ¥è¯¢æ‰§è¡Œè¿‡æ…¢ | â­â­â­â­ | æŸ¥çœ‹åç«¯æ—¥å¿— + æ…¢æŸ¥è¯¢æ—¥å¿— |
| ğŸ’¾ æœåŠ¡å™¨èµ„æºä¸è¶³ | â­â­â­ | æ£€æŸ¥ CPU/å†…å­˜/ç£ç›˜ |
| ğŸ”‘ API å¯†é’¥å¤±æ•ˆ | â­â­ | æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½® |
| ğŸŒ ç½‘ç»œé—®é¢˜ | â­ | ping/telnet æµ‹è¯•è¿é€šæ€§ |

## ğŸš€ å¿«é€Ÿè¯Šæ–­

### æ–¹æ³• 1: ä½¿ç”¨è¯Šæ–­è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
cd /path/to/AIcoin
./scripts/diagnose_504.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ï¼š
- âœ… Docker å®¹å™¨çŠ¶æ€
- âœ… åç«¯ API å¥åº·çŠ¶æ€
- âœ… æ•°æ®åº“è¿æ¥
- âœ… Redis ç¼“å­˜
- âœ… æœåŠ¡å™¨èµ„æº
- âœ… é”™è¯¯æ—¥å¿—
- âœ… æµ‹è¯•é—®é¢˜ API

### æ–¹æ³• 2: æ‰‹åŠ¨è¯Šæ–­

#### æ­¥éª¤ 1: æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
docker ps --filter "name=aicoin"
```

**é¢„æœŸè¾“å‡º**: æ‰€æœ‰å®¹å™¨çŠ¶æ€åº”ä¸º `Up`

```
aicoin-backend    Up 2 hours    0.0.0.0:8000->8000/tcp
aicoin-frontend   Up 2 hours    0.0.0.0:3000->3000/tcp  
aicoin-nginx      Up 2 hours    0.0.0.0:80->80/tcp
aicoin-postgres   Up 2 hours    5432/tcp
aicoin-redis      Up 2 hours    6379/tcp
```

#### æ­¥éª¤ 2: æµ‹è¯•åç«¯å¥åº·æ¥å£

```bash
curl -v http://localhost:8000/api/v1/status
```

**é¢„æœŸ**: åº”åœ¨ 1 ç§’å†…è¿”å› `200 OK`

#### æ­¥éª¤ 3: æŸ¥çœ‹åç«¯æ—¥å¿—

```bash
# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
docker logs aicoin-backend --since 10m | grep -i "error\|exception\|traceback"

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker logs aicoin-backend -f --tail 100
```

#### æ­¥éª¤ 4: æ£€æŸ¥æ•°æ®åº“è¿æ¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec aicoin-postgres pg_isready -U aicoin

# æŸ¥çœ‹æ´»è·ƒè¿æ¥æ•°
docker exec aicoin-postgres psql -U aicoin -d aicoin -c \
  "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"

# æŸ¥çœ‹æ…¢æŸ¥è¯¢ï¼ˆæ‰§è¡Œæ—¶é—´>1ç§’ï¼‰
docker exec aicoin-postgres psql -U aicoin -d aicoin -c \
  "SELECT query, calls, total_time/1000 as total_sec 
   FROM pg_stat_statements 
   WHERE mean_time > 1000 
   ORDER BY total_time DESC LIMIT 10;"
```

#### æ­¥éª¤ 5: æ£€æŸ¥æœåŠ¡å™¨èµ„æº

```bash
# å†…å­˜
free -h

# CPU è´Ÿè½½
top -bn1 | head -20

# ç£ç›˜
df -h
```

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: é‡å¯åç«¯æœåŠ¡

```bash
cd /path/to/AIcoin
docker-compose restart backend
```

**é€‚ç”¨äº**: 
- åç«¯æœåŠ¡å‡æ­»
- å†…å­˜æ³„æ¼
- è¿æ¥æ± è€—å°½

### æ–¹æ¡ˆ 2: å®Œæ•´é‡å¯æ‰€æœ‰æœåŠ¡

```bash
cd /path/to/AIcoin
docker-compose down
docker-compose up -d
```

**é€‚ç”¨äº**:
- å¤šä¸ªæœåŠ¡å¼‚å¸¸
- ç½‘ç»œé—®é¢˜
- é…ç½®æ›´æ–°å

### æ–¹æ¡ˆ 3: å¢åŠ  Nginx è¶…æ—¶æ—¶é—´

å¦‚æœç¡®è®¤æŸäº›æŸ¥è¯¢ç¡®å®éœ€è¦æ›´é•¿æ—¶é—´ï¼š

```nginx
# ç¼–è¾‘ deploy/nginx/nginx.conf
location /api/ {
    proxy_pass http://backend;
    
    # å¢åŠ è¶…æ—¶æ—¶é—´åˆ° 120 ç§’
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
}
```

**æ³¨æ„**: è¿™åªæ˜¯æ²»æ ‡ä¸æ²»æœ¬ï¼Œåº”è¯¥ä¼˜åŒ–æ…¢æŸ¥è¯¢

### æ–¹æ¡ˆ 4: ä¼˜åŒ–æ…¢æŸ¥è¯¢

å¦‚æœå‘ç°æ…¢æŸ¥è¯¢ï¼Œéœ€è¦ï¼š

1. **æ·»åŠ æ•°æ®åº“ç´¢å¼•**

```sql
-- ç¤ºä¾‹ï¼šä¸º intelligence_reports è¡¨æ·»åŠ ç´¢å¼•
CREATE INDEX idx_intelligence_reports_created 
  ON intelligence_reports(created_at DESC);
```

2. **ä¼˜åŒ– ORM æŸ¥è¯¢**
   - å‡å°‘ N+1 æŸ¥è¯¢
   - ä½¿ç”¨ `selectinload` é¢„åŠ è½½å…³è”æ•°æ®
   - æ·»åŠ åˆ†é¡µé™åˆ¶

3. **ä½¿ç”¨ç¼“å­˜**
   - ä¸ºé¢‘ç¹è®¿é—®çš„æ•°æ®æ·»åŠ  Redis ç¼“å­˜
   - è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

### æ–¹æ¡ˆ 5: å¢åŠ æ•°æ®åº“è¿æ¥æ± å¤§å°

ç¼–è¾‘ `backend/app/core/database.py`:

```python
engine = create_async_engine(
    settings.DATABASE_URL,
    echo=settings.DEBUG,
    pool_size=20,        # å¢åŠ åˆ° 20ï¼ˆé»˜è®¤ 5ï¼‰
    max_overflow=40,     # å¢åŠ åˆ° 40ï¼ˆé»˜è®¤ 10ï¼‰
    pool_timeout=30,
    pool_recycle=3600,
)
```

ç„¶åé‡å¯åç«¯ï¼š

```bash
docker-compose restart backend
```

## ğŸ“Š ç›‘æ§å»ºè®®

### 1. è®¾ç½®å‘Šè­¦

ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ç›‘æ§ 504 é”™è¯¯ï¼š

```bash
#!/bin/bash
# ç›‘æ§ Nginx é”™è¯¯æ—¥å¿—
tail -f /path/to/deploy/logs/error.log | \
  grep --line-buffered "504\|upstream timed out" | \
  while read line; do
    echo "[ALERT] $(date): $line"
    # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘Šè­¦é€šçŸ¥ï¼ˆé‚®ä»¶ã€Slackç­‰ï¼‰
  done
```

### 2. å®šæœŸæ£€æŸ¥

æ¯å¤©æ£€æŸ¥å…³é”®æŒ‡æ ‡ï¼š

```bash
# åç«¯å“åº”æ—¶é—´
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:8000/api/v1/status

# æ•°æ®åº“è¿æ¥æ•°
docker exec aicoin-postgres psql -U aicoin -d aicoin -c \
  "SELECT count(*) FROM pg_stat_activity;"

# å†…å­˜ä½¿ç”¨
docker stats --no-stream aicoin-backend
```

### 3. æ—¥å¿—è½®è½¬

ç¡®ä¿æ—¥å¿—ä¸ä¼šå æ»¡ç£ç›˜ï¼š

```bash
# ç¼–è¾‘ /etc/logrotate.d/aicoin
/path/to/AIcoin/deploy/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 root root
    sharedscripts
}
```

## ğŸ¯ é¢„é˜²æªæ–½

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

æ‰€æœ‰æŸ¥è¯¢åº”ï¼š
- âœ… ä½¿ç”¨ç´¢å¼•
- âœ… é™åˆ¶è¿”å›æ•°é‡ï¼ˆLIMITï¼‰
- âœ… é¿å… SELECT *
- âœ… ä½¿ç”¨åˆ†é¡µ
- âœ… åˆç†ä½¿ç”¨ JOIN

### 2. æ¥å£å“åº”æ—¶é—´æ ‡å‡†

| æ¥å£ç±»å‹ | ç›®æ ‡å“åº”æ—¶é—´ | æœ€å¤§å®¹å¿ |
|---------|------------|---------|
| åˆ—è¡¨æŸ¥è¯¢ | < 200ms | < 1s |
| è¯¦æƒ…æŸ¥è¯¢ | < 100ms | < 500ms |
| ç»Ÿè®¡åˆ†æ | < 1s | < 5s |
| æŠ¥å‘Šç”Ÿæˆ | < 3s | < 10s |

### 3. ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹

- [ ] æ˜¯å¦æœ‰ N+1 æŸ¥è¯¢ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•ï¼Ÿ
- [ ] æ˜¯å¦é™åˆ¶äº†æŸ¥è¯¢æ•°é‡ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦ç¼“å­˜ï¼Ÿ
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦å®Œå–„ï¼Ÿ

## ğŸ“ é—®é¢˜è®°å½•æ¨¡æ¿

å½“å†æ¬¡é‡åˆ° 504 é—®é¢˜æ—¶ï¼Œè¯·è®°å½•ï¼š

```markdown
### é—®é¢˜è®°å½•

**æ—¶é—´**: YYYY-MM-DD HH:MM  
**ç«¯ç‚¹**: /api/v1/xxx  
**ç¯å¢ƒ**: ç”Ÿäº§ç¯å¢ƒ / æµ‹è¯•ç¯å¢ƒ  

**ç—‡çŠ¶**:
- [ ] å®Œå…¨æ— å“åº”
- [ ] é—´æ­‡æ€§è¶…æ—¶
- [ ] åªæœ‰ç‰¹å®šç”¨æˆ·é‡åˆ°

**å·²æ£€æŸ¥é¡¹**:
- [ ] å®¹å™¨çŠ¶æ€
- [ ] åç«¯æ—¥å¿—
- [ ] æ•°æ®åº“è¿æ¥
- [ ] æœåŠ¡å™¨èµ„æº

**æ ¹æœ¬åŸå› **:
ï¼ˆå¡«å†™åˆ†æç»“æœï¼‰

**è§£å†³æ–¹æ¡ˆ**:
ï¼ˆå¡«å†™é‡‡å–çš„æªæ–½ï¼‰

**é¢„é˜²æªæ–½**:
ï¼ˆå¡«å†™åç»­æ”¹è¿›ï¼‰
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Docker éƒ¨ç½²æŒ‡å—](../02-éƒ¨ç½²è¿ç»´/Dockeréƒ¨ç½²æŒ‡å—.md)
- [æ•°æ®åº“ä¼˜åŒ–](./æ•°æ®åº“ä¼˜åŒ–æŒ‡å—.md)
- [æ€§èƒ½ç›‘æ§](./æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ.md)

## ğŸ“ ç´§æ€¥è”ç³»

å¦‚æœé—®é¢˜æ— æ³•è§£å†³ï¼š

1. è”ç³»æŠ€æœ¯è´Ÿè´£äºº
2. æŸ¥çœ‹ GitHub Issues
3. å‚è€ƒç”Ÿäº§ç¯å¢ƒæ—¥å¿—

---

**æœ€åæ›´æ–°**: 2025-11-16  
**ç»´æŠ¤è€…**: äº§å“ç»ç† + æŠ€æœ¯å›¢é˜Ÿ

