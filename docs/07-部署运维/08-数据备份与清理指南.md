# 📦 数据备份与清理指南

## 📋 目录

- [功能概述](#功能概述)
- [Web界面操作](#web界面操作)
- [命令行操作](#命令行操作)
- [自动化备份](#自动化备份)
- [数据恢复](#数据恢复)
- [最佳实践](#最佳实践)

---

## 功能概述

AIcoin系统提供完整的数据备份和清理功能：

### ✅ 已实现功能

1. **Web界面备份管理** (`/admin/backup`)
   - 创建全量/增量备份
   - 查看备份列表
   - 数据统计查看
   - 旧数据清理

2. **API接口**
   - `POST /api/v1/admin/backup/backup` - 创建备份
   - `GET /api/v1/admin/backup/backups` - 列出备份
   - `POST /api/v1/admin/backup/cleanup` - 清理旧数据
   - `GET /api/v1/admin/backup/stats` - 数据统计

3. **命令行脚本**
   - `scripts/sync_local_to_prod.sh` - 本地数据同步到生产

---

## Web界面操作

### 1. 访问备份管理页面

```
https://jifenpay.cc/admin/backup
```

登录信息：
- 用户名: `admin`
- 密码: `admin123`

### 2. 创建备份

1. 选择要备份的表（或选择"全部表"）
2. 勾选"压缩备份文件"（推荐）
3. 点击"立即创建备份"
4. 等待备份完成

**备份文件位置**: `/app/backups/aicoin_backup_YYYYMMDD_HHMMSS.sql.gz`

### 3. 查看数据统计

页面顶部显示各表的数据统计：
- 总记录数
- 最早记录时间
- 最新记录时间
- 时间跨度

### 4. 清理旧数据

⚠️ **危险操作！请先创建备份！**

1. 选择要清理的表
2. 设置保留天数（例如：保留最近30天）
3. 勾选"我已了解风险，确认要清理数据"
4. 点击"执行清理"
5. 再次确认

---

## 命令行操作

### 本地数据同步到生产

```bash
cd /Users/xinghailong/Documents/soft/AIcoin
./scripts/sync_local_to_prod.sh
```

这个脚本会：
1. 导出本地数据库
2. 上传到生产服务器
3. 在生产服务器导入数据

### 手动备份PostgreSQL

```bash
# 本地备份
docker compose exec -T postgres pg_dump -U aicoin aicoin > backup_$(date +%Y%m%d).sql

# 生产服务器备份
ssh -i ssh-configs/cloud-servers/AIcoin.pem root@47.250.132.166 \
  "docker exec aicoin-postgres-prod pg_dump -U aicoin aicoin" > backup_prod_$(date +%Y%m%d).sql
```

### 压缩备份

```bash
# 备份并压缩
docker compose exec -T postgres pg_dump -U aicoin aicoin | gzip > backup_$(date +%Y%m%d).sql.gz
```

### 备份特定表

```bash
# 只备份交易记录
docker compose exec -T postgres pg_dump -U aicoin aicoin -t trades > trades_backup.sql

# 备份多个表
docker compose exec -T postgres pg_dump -U aicoin aicoin \
  -t trades -t orders -t account_snapshots > trading_backup.sql
```

---

## 自动化备份

### 创建定时备份脚本

创建 `/root/backup_aicoin.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/root/AIcoin_backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份数据库
docker exec aicoin-postgres-prod pg_dump -U aicoin aicoin | \
  gzip > $BACKUP_DIR/aicoin_db_$DATE.sql.gz

# 保留最近 7 天的备份
find $BACKUP_DIR -name "aicoin_db_*.sql.gz" -mtime +7 -delete

echo "Backup completed: aicoin_db_$DATE.sql.gz"
```

### 设置Crontab

```bash
chmod +x /root/backup_aicoin.sh

# 添加到 crontab（每天凌晨 2 点备份）
crontab -e

# 添加以下行：
0 2 * * * /root/backup_aicoin.sh >> /root/backup.log 2>&1
```

### 备份到远程存储

```bash
#!/bin/bash
# 备份并上传到云存储（示例：阿里云OSS）

BACKUP_FILE="aicoin_backup_$(date +%Y%m%d_%H%M%S).sql.gz"

# 创建备份
docker exec aicoin-postgres-prod pg_dump -U aicoin aicoin | gzip > /tmp/$BACKUP_FILE

# 上传到OSS（需要安装ossutil）
ossutil cp /tmp/$BACKUP_FILE oss://your-bucket/backups/

# 清理本地临时文件
rm -f /tmp/$BACKUP_FILE
```

---

## 数据恢复

### 从备份恢复

```bash
# 1. 停止应用服务（避免数据冲突）
docker compose stop backend frontend

# 2. 恢复数据库
gunzip -c backup_20250112.sql.gz | docker exec -i aicoin-postgres-prod psql -U aicoin aicoin

# 或者不解压直接恢复
gunzip -c backup_20250112.sql.gz | docker exec -i aicoin-postgres-prod psql -U aicoin aicoin

# 3. 重启服务
docker compose start backend frontend
```

### 恢复特定表

```bash
# 只恢复交易记录表
cat trades_backup.sql | docker exec -i aicoin-postgres-prod psql -U aicoin aicoin
```

### 从生产恢复到本地

```bash
# 1. 从生产服务器下载备份
scp -i ssh-configs/cloud-servers/AIcoin.pem \
  root@47.250.132.166:/root/AIcoin_backups/aicoin_db_20250112.sql.gz \
  ./

# 2. 恢复到本地
gunzip -c aicoin_db_20250112.sql.gz | docker compose exec -T postgres psql -U aicoin aicoin
```

---

## 最佳实践

### 1. 备份策略

- **每日备份**: 自动备份，保留7天
- **每周备份**: 手动备份，保留4周
- **每月备份**: 手动备份，永久保留
- **重大更新前**: 必须手动备份

### 2. 数据清理策略

| 表名 | 保留时间 | 清理频率 |
|------|---------|---------|
| trades | 90天 | 每月 |
| orders | 90天 | 每月 |
| account_snapshots | 180天 | 每季度 |
| ai_decisions | 30天 | 每周 |
| market_data_klines | 30天 | 每周 |
| risk_events | 永久 | 不清理 |

### 3. 安全建议

1. **备份前验证**
   ```bash
   # 检查数据库连接
   docker exec aicoin-postgres-prod psql -U aicoin -d aicoin -c "SELECT version();"
   
   # 检查表数量
   docker exec aicoin-postgres-prod psql -U aicoin -d aicoin -c "\dt"
   ```

2. **备份后验证**
   ```bash
   # 检查备份文件大小
   ls -lh backup_*.sql.gz
   
   # 测试备份文件完整性
   gunzip -t backup_20250112.sql.gz
   ```

3. **恢复前测试**
   - 先在测试环境恢复
   - 验证数据完整性
   - 确认应用正常运行

### 4. 监控告警

设置备份失败告警：

```bash
#!/bin/bash
# backup_with_alert.sh

BACKUP_FILE="aicoin_backup_$(date +%Y%m%d_%H%M%S).sql.gz"

if docker exec aicoin-postgres-prod pg_dump -U aicoin aicoin | gzip > /tmp/$BACKUP_FILE; then
    echo "✅ 备份成功: $BACKUP_FILE"
else
    echo "❌ 备份失败！" | mail -s "AIcoin备份失败告警" admin@example.com
    exit 1
fi
```

---

## 故障排查

### 问题1: 备份文件过大

**解决方案**：
```bash
# 1. 只备份必要的表
pg_dump -U aicoin aicoin -t trades -t orders | gzip > backup.sql.gz

# 2. 清理旧数据后再备份
# 使用Web界面清理功能
```

### 问题2: 恢复失败

**可能原因**：
- 数据库版本不匹配
- 备份文件损坏
- 权限不足

**解决方案**：
```bash
# 1. 检查PostgreSQL版本
docker exec aicoin-postgres-prod psql -U aicoin -c "SELECT version();"

# 2. 验证备份文件
gunzip -t backup.sql.gz

# 3. 使用verbose模式查看详细错误
gunzip -c backup.sql.gz | docker exec -i aicoin-postgres-prod psql -U aicoin aicoin -v ON_ERROR_STOP=1
```

### 问题3: 清理数据后性能下降

**解决方案**：
```bash
# 运行VACUUM和ANALYZE优化数据库
docker exec aicoin-postgres-prod psql -U aicoin -d aicoin -c "VACUUM ANALYZE;"
```

---

## 相关文档

- [部署指南](01-部署指南.md)
- [远程服务器部署手册](06-远程服务器部署手册.md)
- [敏感信息管理规范](00-敏感信息管理规范.md)

---

## 技术支持

如有问题，请查看：
- 系统日志: `docker logs aicoin-backend-prod-v2`
- 数据库日志: `docker logs aicoin-postgres-prod`
- 备份日志: `/root/backup.log`

---

**最后更新**: 2025-11-12  
**版本**: v2.0

