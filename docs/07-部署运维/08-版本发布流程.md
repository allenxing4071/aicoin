# 版本发布流程（成熟方案）

## 📋 概述

本文档描述 AIcoin 项目的标准版本发布流程。该方案已经过实践验证，可以确保版本号在所有位置保持一致。

---

## 🏗️ 版本号架构

### 单一真实来源 (Single Source of Truth)

```
backend/app/core/config.py
    ↓ (FastAPI 读取)
OpenAPI 规范 (/openapi.json)
    ↓ (前端动态获取)
管理后台、API 文档等所有前端页面
```

**优势**：
- ✅ 只需修改一个地方
- ✅ 前端自动同步
- ✅ 不存在硬编码
- ✅ 版本号永远一致

---

## 🚀 标准发布流程

### 方法一：自动化脚本（推荐）

```bash
# 1. 更新版本号（自动更新所有位置）
./scripts/utils/update_version.sh 3.3.0

# 2. 更新 CHANGELOG（手动）
vim CHANGELOG.md

# 3. 提交变更
git add .
git commit -m "chore: bump version to 3.3.0"
git push origin main

# 4. 创建 Git 标签（可选，脚本会提示）
git tag -a v3.3.0 -m "Release version 3.3.0"
git push origin v3.3.0

# 5. 重新构建和部署
docker compose build
docker compose up -d

# 6. 验证版本号
curl http://localhost:8000/openapi.json | grep version
# 或访问: http://localhost:8000/docs
# 或访问: http://localhost:3000/admin
```

### 方法二：手动更新

如果自动脚本不可用，可以手动更新：

```bash
# 1. 更新版本号
echo "3.3.0" > VERSION
vim backend/app/core/config.py  # 修改 APP_VERSION = "3.3.0"
vim frontend/package.json        # 修改 "version": "3.3.0"

# 2. 更新 CHANGELOG
vim CHANGELOG.md

# 3. 提交和标签
git add .
git commit -m "chore: bump version to 3.3.0"
git tag -a v3.3.0 -m "Release version 3.3.0"
git push origin main v3.3.0

# 4. 重新构建和部署
docker compose build
docker compose up -d
```

---

## 📝 CHANGELOG 模板

每次发布都应该更新 `CHANGELOG.md`：

```markdown
## [3.3.0] - 2025-11-15

### Added
- 新增功能 A
- 新增功能 B

### Changed
- 优化功能 C
- 改进功能 D

### Fixed
- 修复 Bug E
- 修复 Bug F

### Removed
- 移除废弃功能 G
```

---

## ✅ 版本发布检查清单

### 发布前检查

- [ ] 所有功能已完成并测试通过
- [ ] 所有 linter 错误已修复
- [ ] 所有测试用例通过
- [ ] 文档已更新
- [ ] CHANGELOG 已更新
- [ ] 版本号符合语义化版本规范

### 发布步骤

- [ ] 运行版本更新脚本或手动更新版本号
- [ ] 更新 CHANGELOG.md
- [ ] 提交代码到 Git
- [ ] 创建 Git 标签
- [ ] 推送到远程仓库
- [ ] 重新构建 Docker 镜像
- [ ] 重启服务
- [ ] 验证版本号显示正确

### 发布后验证

- [ ] API 文档显示新版本号
- [ ] 管理后台显示新版本号
- [ ] 所有服务正常运行
- [ ] 核心功能测试通过
- [ ] 创建发布说明（可选）

---

## 🔍 验证版本号

### 1. 命令行验证

```bash
# 查看 VERSION 文件
cat VERSION

# 查看后端配置
grep APP_VERSION backend/app/core/config.py

# 查看前端配置
grep version frontend/package.json | head -1

# 查看 API 返回
curl -s http://localhost:8000/openapi.json | python3 -c "import sys, json; print(json.load(sys.stdin)['info']['version'])"
```

### 2. 浏览器验证

访问以下页面检查版本号：

- **Swagger UI**: http://localhost:8000/docs
  - 标题应显示: "AIcoin Trading System 3.3.0"
  
- **ReDoc**: http://localhost:8000/redoc
  - 页面顶部应显示版本号
  
- **管理后台**: http://localhost:3000/admin
  - "API 文档" 卡片中应显示: "v3.3.0"

---

## 🎯 语义化版本规范

遵循 [Semantic Versioning 2.0.0](https://semver.org/)：

### 格式：MAJOR.MINOR.PATCH

- **MAJOR（主版本号）**: 不兼容的 API 变更
  - 例如：3.0.0 → 4.0.0
  - 重大架构变更
  - 破坏性更新

- **MINOR（次版本号）**: 向后兼容的功能新增
  - 例如：3.2.0 → 3.3.0
  - 新增功能
  - 新增 API 端点
  - 非破坏性改进

- **PATCH（修订号）**: 向后兼容的问题修正
  - 例如：3.2.0 → 3.2.1
  - Bug 修复
  - 性能优化
  - 文档更新

### 示例

```
3.2.0 → 3.2.1  # Bug 修复
3.2.1 → 3.3.0  # 新增功能
3.3.0 → 4.0.0  # 重大变更
```

---

## 📁 版本相关文件

### 核心文件

1. **VERSION** - 版本号文件（单一真实来源）
   ```
   3.2.0
   ```

2. **backend/app/core/config.py** - 后端配置
   ```python
   APP_VERSION: str = "3.2.0"
   ```

3. **frontend/package.json** - 前端配置
   ```json
   {
     "version": "3.2.0"
   }
   ```

4. **CHANGELOG.md** - 变更日志

### 工具和文档

1. **scripts/utils/update_version.sh** - 自动更新脚本
2. **docs/07-部署运维/07-版本管理指南.md** - 详细指南
3. **docs/07-部署运维/08-版本发布流程.md** - 本文档

---

## 🔄 回滚版本

如果发布后发现问题，可以快速回滚：

```bash
# 1. 检出旧版本标签
git checkout v3.2.0

# 2. 重新构建
docker compose build

# 3. 重启服务
docker compose up -d

# 或者直接回滚到上一个提交
git revert HEAD
git push origin main
docker compose build
docker compose up -d
```

---

## 🛠️ 故障排查

### 问题：版本号不一致

**症状**：不同位置显示不同的版本号

**解决**：
```bash
# 1. 检查所有位置
cat VERSION
grep APP_VERSION backend/app/core/config.py
grep version frontend/package.json | head -1

# 2. 使用脚本重新同步
./scripts/utils/update_version.sh 3.2.0

# 3. 重新构建
docker compose build
docker compose up -d
```

### 问题：前端显示旧版本

**症状**：管理后台显示旧版本号

**解决**：
```bash
# 1. 清除浏览器缓存（硬刷新）
# Chrome/Edge: Cmd + Shift + R
# Safari: Cmd + Option + R

# 2. 重启前端容器
docker compose restart frontend

# 3. 重新构建前端
docker compose build frontend
docker compose up -d frontend
```

### 问题：API 文档显示旧版本

**症状**：Swagger UI 显示旧版本号

**解决**：
```bash
# 1. 重启后端容器
docker compose restart backend

# 2. 验证配置文件
docker compose exec backend cat /app/app/core/config.py | grep APP_VERSION

# 3. 如果配置正确但仍显示旧版本，重新构建
docker compose build backend
docker compose up -d backend
```

---

## 📊 版本历史

### v3.2.0 (2025-11-10)

**重大改进**：
- ✅ 建立版本号单一真实来源架构
- ✅ 前端版本号动态获取（消除硬编码）
- ✅ 创建自动化版本更新脚本
- ✅ 完善版本管理文档
- ✅ 统一组件库和样式系统
- ✅ 性能优化（前端+后端+Docker）

**技术债务清理**：
- 🗑️ 移除硬编码版本号
- 🗑️ 归档过时文档
- 🗑️ 清理临时脚本

### v3.1.0 (2025-11-08)

**主要功能**：
- 新增交易所接入功能
- 完善 AI 决策系统
- 优化数据库结构

### v3.0.0 (2025-11-01)

**初始版本**：
- 项目初始化
- 核心功能实现

---

## 🎓 最佳实践

### 1. 频繁发布小版本

- ✅ 每个功能完成后发布 PATCH 版本
- ✅ 多个功能完成后发布 MINOR 版本
- ✅ 避免积累太多变更

### 2. 详细的 CHANGELOG

- ✅ 每个版本都要更新 CHANGELOG
- ✅ 分类记录变更（Added/Changed/Fixed/Removed）
- ✅ 包含重要的技术细节

### 3. Git 标签管理

- ✅ 每个版本都创建 Git 标签
- ✅ 标签格式：`v3.2.0`（带 v 前缀）
- ✅ 标签消息：`Release version 3.2.0`

### 4. 自动化优先

- ✅ 使用自动化脚本更新版本号
- ✅ 减少人为错误
- ✅ 提高发布效率

### 5. 验证验证再验证

- ✅ 发布后立即验证版本号
- ✅ 测试核心功能
- ✅ 检查所有服务状态

---

## 🚨 注意事项

### 禁止操作

- ❌ 不要跳过版本号
- ❌ 不要在生产环境直接修改代码
- ❌ 不要忘记更新 CHANGELOG
- ❌ 不要忘记创建 Git 标签
- ❌ 不要在未测试的情况下发布

### 必须操作

- ✅ 必须遵循语义化版本规范
- ✅ 必须更新 CHANGELOG
- ✅ 必须创建 Git 标签
- ✅ 必须验证版本号
- ✅ 必须测试核心功能

---

## 📞 支持

如有问题，请参考：

1. [版本管理指南](./07-版本管理指南.md) - 详细的版本管理说明
2. [部署指南](./01-部署指南.md) - 部署相关问题
3. [Docker 使用指南](./02-Docker使用指南.md) - Docker 相关问题

---

## 🎉 总结

现在的版本管理方案具有以下特点：

1. **自动化** - 一条命令完成所有更新
2. **一致性** - 版本号永远保持一致
3. **可追溯** - Git 标签记录所有版本
4. **易维护** - 清晰的流程和文档
5. **零硬编码** - 前端动态获取版本号

这是一个经过实践验证的成熟方案，可以放心使用！

---

*最后更新: 2025-11-10*  
*当前版本: v3.2.0*  
*方案状态: ✅ 生产就绪*

