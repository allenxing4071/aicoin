# è¾©è®ºç³»ç»Ÿé…ç½®åˆå§‹åŒ–

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åˆå§‹åŒ–è¾©è®ºç³»ç»Ÿçš„é…ç½®æ•°æ®ï¼Œç¡®ä¿å‰ç«¯é…ç½®é¡µé¢èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºå’Œå·¥ä½œã€‚

## ğŸ¯ é—®é¢˜èƒŒæ™¯

### ç°è±¡
- è®¿é—® `/admin/debate/config` é¡µé¢ä¸ºç©º
- æ²¡æœ‰æ˜¾ç¤ºä»»ä½•é…ç½®å‚æ•°
- æ— æ³•è¿›è¡Œé…ç½®ç®¡ç†

### åŸå› 
- æ•°æ®åº“ `debate_config` è¡¨ä¸ºç©º
- ç¼ºå°‘é»˜è®¤é…ç½®æ•°æ®
- å‰ç«¯ä» API è·å–ä¸åˆ°é…ç½®

### è§£å†³æ–¹æ¡ˆ
æ‰‹åŠ¨æ’å…¥é»˜è®¤é…ç½®æ•°æ®åˆ°æ•°æ®åº“

## ğŸ”§ åˆå§‹åŒ–æ­¥éª¤

### æ–¹æ³• 1: ä½¿ç”¨ SSH + psqlï¼ˆæ¨èï¼‰

#### 1. SSH è¿æ¥åˆ°æœåŠ¡å™¨

```bash
ssh -i /Users/xinghailong/Documents/soft/AIcoin/ssh-configs/cloud-servers/AIcoin.pem root@47.250.132.166
```

#### 2. è¿›å…¥ PostgreSQL å®¹å™¨

```bash
docker exec -i aicoin-postgres psql -U aicoin -d aicoin
```

#### 3. æ’å…¥é…ç½®æ•°æ®

```sql
INSERT INTO debate_config (config_key, config_value, description) VALUES
('debate_enabled', 'true', 'æ˜¯å¦å¯ç”¨è¾©è®ºæœºåˆ¶'),
('max_debate_rounds', '1', 'æœ€å¤§è¾©è®ºè½®æ¬¡ï¼ˆ1-3ï¼‰'),
('min_position_size', '1000', 'è§¦å‘è¾©è®ºçš„æœ€å°ä»“ä½é‡‘é¢ï¼ˆUSDï¼‰'),
('min_permission_level', 'L3', 'è§¦å‘è¾©è®ºçš„æœ€ä½æƒé™ç­‰çº§'),
('debate_timeout_seconds', '60', 'è¾©è®ºè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰'),
('use_memory', 'true', 'æ˜¯å¦ä½¿ç”¨å†å²è®°å¿†'),
('daily_limit', '100', 'æ¯æ—¥æœ€å¤§è¾©è®ºæ¬¡æ•°'),
('hourly_limit', '10', 'æ¯å°æ—¶æœ€å¤§è¾©è®ºæ¬¡æ•°')
ON CONFLICT (config_key) DO NOTHING;
```

#### 4. éªŒè¯é…ç½®

```sql
SELECT config_key, config_value, description FROM debate_config ORDER BY config_key;
```

**é¢„æœŸè¾“å‡º**ï¼š

```
      config_key       | config_value |              description
-----------------------+--------------+----------------------------------------
 daily_limit           | 100          | æ¯æ—¥æœ€å¤§è¾©è®ºæ¬¡æ•°
 debate_enabled        | true         | æ˜¯å¦å¯ç”¨è¾©è®ºæœºåˆ¶
 debate_timeout_seconds| 60           | è¾©è®ºè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
 hourly_limit          | 10           | æ¯å°æ—¶æœ€å¤§è¾©è®ºæ¬¡æ•°
 max_debate_rounds     | 1            | æœ€å¤§è¾©è®ºè½®æ¬¡ï¼ˆ1-3ï¼‰
 min_permission_level  | L3           | è§¦å‘è¾©è®ºçš„æœ€ä½æƒé™ç­‰çº§
 min_position_size     | 1000         | è§¦å‘è¾©è®ºçš„æœ€å°ä»“ä½é‡‘é¢ï¼ˆUSDï¼‰
 use_memory            | true         | æ˜¯å¦ä½¿ç”¨å†å²è®°å¿†
(8 rows)
```

#### 5. é€€å‡º

```sql
\q
```

```bash
exit
```

### æ–¹æ³• 2: ä½¿ç”¨ Python è„šæœ¬

#### 1. åˆ›å»ºåˆå§‹åŒ–è„šæœ¬

æ–‡ä»¶ä½ç½®ï¼š`backend/scripts/init_debate_config.py`

```python
import asyncio
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from sqlalchemy import select
from app.core.database import get_db_session
from app.models.debate import DebateConfig

# é»˜è®¤é…ç½®
default_configs = [
    {
        "config_key": "debate_enabled",
        "config_value": "true",
        "description": "æ˜¯å¦å¯ç”¨è¾©è®ºæœºåˆ¶"
    },
    {
        "config_key": "max_debate_rounds",
        "config_value": "1",
        "description": "æœ€å¤§è¾©è®ºè½®æ¬¡ï¼ˆ1-3ï¼‰"
    },
    {
        "config_key": "min_position_size",
        "config_value": "1000",
        "description": "è§¦å‘è¾©è®ºçš„æœ€å°ä»“ä½é‡‘é¢ï¼ˆUSDï¼‰"
    },
    {
        "config_key": "min_permission_level",
        "config_value": "L3",
        "description": "è§¦å‘è¾©è®ºçš„æœ€ä½æƒé™ç­‰çº§"
    },
    {
        "config_key": "debate_timeout_seconds",
        "config_value": "60",
        "description": "è¾©è®ºè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰"
    },
    {
        "config_key": "use_memory",
        "config_value": "true",
        "description": "æ˜¯å¦ä½¿ç”¨å†å²è®°å¿†"
    },
    {
        "config_key": "daily_limit",
        "config_value": "100",
        "description": "æ¯æ—¥æœ€å¤§è¾©è®ºæ¬¡æ•°"
    },
    {
        "config_key": "hourly_limit",
        "config_value": "10",
        "description": "æ¯å°æ—¶æœ€å¤§è¾©è®ºæ¬¡æ•°"
    }
]

async def init_debate_config():
    """åˆå§‹åŒ–è¾©è®ºé…ç½®"""
    async with get_db_session() as db:
        for config_data in default_configs:
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            stmt = select(DebateConfig).where(
                DebateConfig.config_key == config_data["config_key"]
            )
            result = await db.execute(stmt)
            existing = result.scalar_one_or_none()
            
            if existing:
                print(f"â­ï¸  é…ç½®å·²å­˜åœ¨: {config_data['config_key']}")
                continue
            
            # åˆ›å»ºæ–°é…ç½®
            config = DebateConfig(**config_data)
            db.add(config)
            print(f"âœ… åˆ›å»ºé…ç½®: {config_data['config_key']} = {config_data['config_value']}")
        
        await db.commit()
        print("\nğŸ‰ è¾©è®ºé…ç½®åˆå§‹åŒ–å®Œæˆï¼")

if __name__ == "__main__":
    asyncio.run(init_debate_config())
```

#### 2. æ‰§è¡Œè„šæœ¬

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /root/AIcoin/backend
python3 scripts/init_debate_config.py
```

## âœ… éªŒè¯åˆå§‹åŒ–

### 1. æ£€æŸ¥æ•°æ®åº“

```bash
# è¿›å…¥æ•°æ®åº“
docker exec -i aicoin-postgres psql -U aicoin -d aicoin

# æŸ¥è¯¢é…ç½®
SELECT config_key, config_value FROM debate_config;

# é€€å‡º
\q
```

### 2. æ£€æŸ¥ API

```bash
# æµ‹è¯• API æ¥å£
curl http://localhost:8000/api/v1/debate/config
```

**é¢„æœŸå“åº”**ï¼š

```json
[
  {
    "id": 1,
    "config_key": "debate_enabled",
    "config_value": "true",
    "description": "æ˜¯å¦å¯ç”¨è¾©è®ºæœºåˆ¶",
    "updated_at": "2025-11-14T12:00:00Z"
  },
  {
    "id": 2,
    "config_key": "max_debate_rounds",
    "config_value": "1",
    "description": "æœ€å¤§è¾©è®ºè½®æ¬¡ï¼ˆ1-3ï¼‰",
    "updated_at": "2025-11-14T12:00:00Z"
  },
  ...
]
```

### 3. æ£€æŸ¥å‰ç«¯é¡µé¢

è®¿é—®ï¼šhttps://jifenpay.cc/admin/debate/config

**é¢„æœŸæ˜¾ç¤º**ï¼š
- âœ… åŸºç¡€é…ç½®åŒºåŸŸï¼ˆå¯ç”¨è¾©è®ºã€æœ€å¤§è½®æ¬¡ã€è¶…æ—¶æ—¶é—´ã€ä½¿ç”¨è®°å¿†ï¼‰
- âœ… è§¦å‘æ¡ä»¶åŒºåŸŸï¼ˆæœ€å°ä»“ä½ã€æœ€ä½æƒé™ï¼‰
- âœ… é™æµé…ç½®åŒºåŸŸï¼ˆæ¯æ—¥é™åˆ¶ã€æ¯å°æ—¶é™åˆ¶ï¼‰

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: SSH è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Connection refused
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æœåŠ¡å™¨ IP æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ SSH å¯†é’¥è·¯å¾„æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®

### é—®é¢˜ 2: PostgreSQL å®¹å™¨ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error: No such container: aicoin-postgres
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker ps -a

# æ‰¾åˆ° PostgreSQL å®¹å™¨åç§°
docker ps | grep postgres

# ä½¿ç”¨æ­£ç¡®çš„å®¹å™¨åç§°
docker exec -i <æ­£ç¡®çš„å®¹å™¨å> psql -U aicoin -d aicoin
```

### é—®é¢˜ 3: æ•°æ®åº“è¡¨ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: relation "debate_config" does not exist
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# è¿è¡Œæ•°æ®åº“è¿ç§»
cd /root/AIcoin/backend
alembic upgrade head
```

### é—®é¢˜ 4: æ’å…¥å¤±è´¥ï¼ˆåˆ—ä¸å­˜åœ¨ï¼‰

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: column "created_at" of relation "debate_config" does not exist
```

**åŸå› **ï¼šè¡¨ç»“æ„ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ­£ç¡®çš„ SQLï¼ˆä¸åŒ…å« `created_at`ï¼‰ï¼š

```sql
INSERT INTO debate_config (config_key, config_value, description) VALUES
('debate_enabled', 'true', 'æ˜¯å¦å¯ç”¨è¾©è®ºæœºåˆ¶')
ON CONFLICT (config_key) DO NOTHING;
```

### é—®é¢˜ 5: å‰ç«¯ä»ç„¶ä¸ºç©º

**å¯èƒ½åŸå› **ï¼š
1. åç«¯æœåŠ¡æœªé‡å¯
2. API è·¯ç”±é”™è¯¯
3. å‰ç«¯ç¼“å­˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. é‡å¯åç«¯æœåŠ¡
docker restart aicoin-backend

# 2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# åœ¨æµè§ˆå™¨ä¸­æŒ‰ Cmd+Shift+R (Mac) æˆ– Ctrl+Shift+R (Windows)

# 3. æ£€æŸ¥åç«¯æ—¥å¿—
docker logs aicoin-backend --tail 50 | grep -i debate
```

## ğŸ“Š é…ç½®è¯´æ˜

### å®Œæ•´é…ç½®åˆ—è¡¨

| é…ç½®é”® | é»˜è®¤å€¼ | ç±»å‹ | è¯´æ˜ |
|--------|--------|------|------|
| `debate_enabled` | true | boolean | æ˜¯å¦å¯ç”¨è¾©è®ºæœºåˆ¶ |
| `max_debate_rounds` | 1 | integer | æœ€å¤§è¾©è®ºè½®æ¬¡ï¼ˆ1-3ï¼‰ |
| `min_position_size` | 1000 | integer | è§¦å‘è¾©è®ºçš„æœ€å°ä»“ä½é‡‘é¢ï¼ˆUSDï¼‰ |
| `min_permission_level` | L3 | string | è§¦å‘è¾©è®ºçš„æœ€ä½æƒé™ç­‰çº§ |
| `debate_timeout_seconds` | 60 | integer | è¾©è®ºè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `use_memory` | true | boolean | æ˜¯å¦ä½¿ç”¨å†å²è®°å¿† |
| `daily_limit` | 100 | integer | æ¯æ—¥æœ€å¤§è¾©è®ºæ¬¡æ•° |
| `hourly_limit` | 10 | integer | æ¯å°æ—¶æœ€å¤§è¾©è®ºæ¬¡æ•° |

### é…ç½®è°ƒæ•´å»ºè®®

#### æ–°ç³»ç»Ÿï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰
```sql
UPDATE debate_config SET config_value = 'true' WHERE config_key = 'debate_enabled';
UPDATE debate_config SET config_value = '1' WHERE config_key = 'max_debate_rounds';
UPDATE debate_config SET config_value = '1000' WHERE config_key = 'min_position_size';
UPDATE debate_config SET config_value = 'L3' WHERE config_key = 'min_permission_level';
```

#### æˆç†Ÿç³»ç»Ÿï¼ˆè¿è¡Œ 1 ä¸ªæœˆ+ï¼‰
```sql
UPDATE debate_config SET config_value = '2' WHERE config_key = 'max_debate_rounds';
UPDATE debate_config SET config_value = '500' WHERE config_key = 'min_position_size';
UPDATE debate_config SET config_value = 'L2' WHERE config_key = 'min_permission_level';
UPDATE debate_config SET config_value = '200' WHERE config_key = 'daily_limit';
```

#### ä½æˆæœ¬æ¨¡å¼
```sql
UPDATE debate_config SET config_value = '1' WHERE config_key = 'max_debate_rounds';
UPDATE debate_config SET config_value = '2000' WHERE config_key = 'min_position_size';
UPDATE debate_config SET config_value = '30' WHERE config_key = 'daily_limit';
UPDATE debate_config SET config_value = '3' WHERE config_key = 'hourly_limit';
```

## ğŸ”„ æ›´æ–°é…ç½®

### æ–¹æ³• 1: é€šè¿‡å‰ç«¯ç•Œé¢ï¼ˆæ¨èï¼‰

1. è®¿é—®ï¼šhttps://jifenpay.cc/admin/debate/config
2. ä¿®æ”¹é…ç½®å€¼
3. å¤±ç„¦è‡ªåŠ¨ä¿å­˜

### æ–¹æ³• 2: é€šè¿‡ SQL

```bash
# è¿›å…¥æ•°æ®åº“
docker exec -i aicoin-postgres psql -U aicoin -d aicoin

# æ›´æ–°é…ç½®
UPDATE debate_config 
SET config_value = 'new_value' 
WHERE config_key = 'config_key_name';

# é€€å‡º
\q
```

### æ–¹æ³• 3: é€šè¿‡ API

```bash
curl -X PUT http://localhost:8000/api/v1/debate/config/debate_enabled \
  -H "Content-Type: application/json" \
  -d '{"config_value": "false"}'
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¾©è®ºç³»ç»Ÿå¿«é€ŸæŒ‡å—](../06-å¿«é€Ÿå‚è€ƒ/07-è¾©è®ºç³»ç»Ÿå¿«é€ŸæŒ‡å—.md)
- [è¾©è®ºç³»ç»ŸæŠ€æœ¯æ–‡æ¡£](../03-æŠ€æœ¯æ¶æ„/09-è¾©è®ºç³»ç»Ÿ.md)
- [æ•°æ®åº“è¡¨æ³¨é‡Šå®Œå–„è¯´æ˜](./13-æ•°æ®åº“è¡¨æ³¨é‡Šå®Œå–„è¯´æ˜.md)

## ğŸ¯ æ£€æŸ¥æ¸…å•

åˆå§‹åŒ–å®Œæˆåï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æ•°æ®åº“ä¸­æœ‰ 8 æ¡é…ç½®è®°å½•
- [ ] API æ¥å£è¿”å›é…ç½®æ•°æ®
- [ ] å‰ç«¯é…ç½®é¡µé¢æ˜¾ç¤ºæ‰€æœ‰å‚æ•°
- [ ] å¯ä»¥é€šè¿‡å‰ç«¯ä¿®æ”¹é…ç½®
- [ ] ä¿®æ”¹åé…ç½®ç«‹å³ç”Ÿæ•ˆ

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡éƒ¨ç½²å¿…é¡»æ‰§è¡Œ**ï¼šæ–°éƒ¨ç½²çš„ç³»ç»Ÿå¿…é¡»æ‰§è¡Œåˆå§‹åŒ–
2. **å¹‚ç­‰æ€§**ï¼šä½¿ç”¨ `ON CONFLICT DO NOTHING` ç¡®ä¿é‡å¤æ‰§è¡Œä¸ä¼šæŠ¥é”™
3. **é…ç½®ç”Ÿæ•ˆ**ï¼šé…ç½®æ›´æ”¹ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡
4. **å¤‡ä»½å»ºè®®**ï¼šä¿®æ”¹é…ç½®å‰å»ºè®®å¤‡ä»½å½“å‰é…ç½®

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚é‡é—®é¢˜ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„"æ•…éšœæ’æŸ¥"éƒ¨åˆ†
2. æ£€æŸ¥åç«¯æ—¥å¿—ï¼š`docker logs aicoin-backend --tail 100`
3. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€ï¼š`docker ps | grep postgres`
4. è”ç³»æŠ€æœ¯æ”¯æŒ

---

**æœ€åæ›´æ–°**: 2025-11-14
**ç‰ˆæœ¬**: v3.4.0

