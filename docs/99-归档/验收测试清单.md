# ✅ 验收测试清单

## 📋 测试前准备

- [ ] 确认Docker Desktop已启动并运行
- [ ] 运行 `./start_all.sh` 启动系统
- [ ] 等待20秒让所有服务完全启动
- [ ] 打开浏览器访问 http://localhost:3000

---

## 🎯 核心功能测试

### 测试1: 数据库默认权限等级验证

**目标**: 确认数据库中L3是默认权限等级

```bash
# 在终端运行
docker exec aicoin-postgres-prod psql -U aicoin -d aicoin -c "SELECT level, name, is_default FROM permission_level_configs WHERE is_active = true ORDER BY level;"
```

**期望结果**:
```
 level |   name   | is_default 
-------+----------+------------
 L0    | 保护模式 | f
 L1    | 新手级   | f
 L2    | 成长级   | f
 L3    | 稳定级   | t          ← 这行应该是 true
 L4    | 熟练级   | f
 L5    | 专家级   | f
```

- [ ] ✅ L3的 `is_default` 列显示为 `t`（true）

---

### 测试2: 后端API返回正确权限等级

**目标**: 确认后端API返回L3权限等级

```bash
# 在终端运行
curl -s http://localhost:8000/api/v1/ai/status | python3 -c "import sys, json; data=json.load(sys.stdin); print('权限等级:', data['orchestrator']['permission_level']); print('权限名称:', data['orchestrator']['permission_name'])"
```

**期望结果**:
```
权限等级: L3
权限名称: 稳定级
```

- [ ] ✅ 显示 "权限等级: L3"
- [ ] ✅ 显示 "权限名称: 稳定级"

---

### 测试3: 交易控制中心显示正确

**目标**: 验证交易控制中心的权限等级选择器和当前等级显示

1. 访问 http://localhost:3000/admin
2. 找到"🎮 交易控制中心"区域

**检查项**:
- [ ] ✅ 看到权限等级下拉框（"🔑 权限等级:"）
- [ ] ✅ 下拉框当前选中 "L3 - 稳定级"
- [ ] ✅ 下拉框旁边显示 **(当前: L3)**
- [ ] ✅ 下拉框包含所有选项（L0到L5）
- [ ] ✅ 看到"启动交易"和"停止交易"按钮

---

### 测试4: 权限管理页面顶部显示正确

**目标**: 验证权限管理页面顶部的AI当前权限等级显示

1. 访问 http://localhost:3000/admin/permissions
2. 查看页面顶部的蓝色框区域

**检查项**:
- [ ] ✅ 看到 "🤖" 图标
- [ ] ✅ 看到标题 "AI当前使用的权限等级"
- [ ] ✅ 显示 **"L3 稳定级"**（大号字体）
- [ ] ✅ 显示参数：
  - 最大仓位: **15%**
  - 最大杠杆: **3x**
  - 置信度阈值: **70%**
  - 每日最大交易: **4**

---

### 测试5: 权限等级卡片高亮正确

**目标**: 验证L3卡片有正确的标签

1. 在权限管理页面向下滚动
2. 找到所有权限等级卡片

**检查项**:
- [ ] ✅ L0卡片：**不显示**"⚡ 当前使用"标签，**不显示**"默认等级"标签
- [ ] ✅ L1卡片：**不显示**"⚡ 当前使用"标签，**不显示**"默认等级"标签
- [ ] ✅ L2卡片：**不显示**"⚡ 当前使用"标签，**不显示**"默认等级"标签
- [ ] ✅ **L3卡片**：**显示**"⚡ 当前使用"标签，**显示**"默认等级"标签
- [ ] ✅ L4卡片：**不显示**"⚡ 当前使用"标签，**不显示**"默认等级"标签
- [ ] ✅ L5卡片：**不显示**"⚡ 当前使用"标签，**不显示**"默认等级"标签

---

## 🔄 权限等级切换测试

### 测试6: 从交易控制中心切换权限等级

**目标**: 验证从admin页面切换权限等级的完整流程

**步骤**:
1. 访问 http://localhost:3000/admin
2. 在"交易控制中心"，从下拉框选择 **"L4 - 熟练级"**
3. 如果交易已启用，先点击"停止交易"
4. 再次选择L4（确保下拉框显示L4）
5. 点击"启动交易"按钮
6. 等待2秒

**检查项**:
- [ ] ✅ 下拉框旁边显示 **(当前: L4)**
- [ ] ✅ 没有错误提示

**后续验证**:
7. 点击左侧导航的"权限管理"
8. 等待页面加载（最多10秒）

**检查项**:
- [ ] ✅ 顶部显示 "L4 熟练级"
- [ ] ✅ 显示L4的参数（最大仓位: 20%, 最大杠杆: 4x等）
- [ ] ✅ 向下滚动，L4卡片显示"⚡ 当前使用"和"默认等级"标签
- [ ] ✅ L3卡片**不再显示**"⚡ 当前使用"标签（但可能仍显示"默认等级"，这是旧数据）

---

### 测试7: 从权限管理页面切换权限等级

**目标**: 验证从权限管理页面设置默认等级

**步骤**:
1. 访问 http://localhost:3000/admin/permissions
2. 找到 **"L2 - 成长级"** 卡片
3. 点击"设为默认"按钮
4. 等待10秒（页面会自动刷新）

**检查项**:
- [ ] ✅ 页面顶部显示 "L2 成长级"
- [ ] ✅ L2卡片显示"⚡ 当前使用"和"默认等级"标签
- [ ] ✅ 其他卡片不显示"⚡ 当前使用"标签

**后续验证**:
5. 点击左侧导航的"概览"回到admin页面

**检查项**:
- [ ] ✅ "交易控制中心"显示 **(当前: L2)**
- [ ] ✅ 下拉框选中 "L2 - 成长级"

---

## 🎨 UI/UX检查

### 测试8: 界面一致性和美观度

**交易控制中心（/admin）**:
- [ ] ✅ 权限等级下拉框和按钮对齐良好
- [ ] ✅ "(当前: LX)" 文本清晰可见
- [ ] ✅ 说明文字易于理解

**权限管理页面（/admin/permissions）**:
- [ ] ✅ 顶部AI当前权限等级框有明显的视觉区分（蓝色边框或背景）
- [ ] ✅ 当前使用的卡片有明显的视觉高亮
- [ ] ✅ "⚡ 当前使用"和"默认等级"标签容易识别
- [ ] ✅ 所有卡片布局整齐，信息清晰

---

## 🐛 边界情况测试

### 测试9: 快速切换权限等级

**目标**: 验证快速连续切换权限等级不会出错

**步骤**:
1. 在交易控制中心，快速切换：L1 → L2 → L3 → L4 → L5
2. 每次切换后点击"启动交易"
3. 检查是否有任何错误或显示异常

**检查项**:
- [ ] ✅ 没有JavaScript错误（打开浏览器控制台查看）
- [ ] ✅ "(当前: LX)" 总是显示最后设置的等级
- [ ] ✅ 权限管理页面最终显示L5为当前等级

---

### 测试10: 页面刷新后数据保持

**目标**: 验证刷新页面后权限等级信息不丢失

**步骤**:
1. 在交易控制中心设置权限等级为L3
2. 按 **F5** 刷新页面
3. 再次查看权限等级

**检查项**:
- [ ] ✅ 刷新后仍显示 "(当前: L3)"
- [ ] ✅ 下拉框仍选中L3
- [ ] ✅ 访问权限管理页面，L3仍标记为当前使用

---

### 测试11: 多标签页同步（可选）

**目标**: 验证多个浏览器标签页是否能同步显示权限等级

**步骤**:
1. 打开两个标签页，都访问 http://localhost:3000/admin/permissions
2. 在第一个标签页设置L4为默认
3. 等待10秒
4. 在第二个标签页按F5刷新

**检查项**:
- [ ] ✅ 第二个标签页刷新后显示L4为当前等级

---

## 📊 性能检查

### 测试12: API响应时间

**目标**: 确认API响应速度正常

```bash
# 测试AI状态API
time curl -s http://localhost:8000/api/v1/ai/status > /dev/null
```

**期望结果**:
- [ ] ✅ 响应时间 < 2秒

```bash
# 测试权限等级列表API
time curl -s http://localhost:8000/api/v1/admin/permissions/levels > /dev/null
```

**期望结果**:
- [ ] ✅ 响应时间 < 1秒

---

### 测试13: 前端加载速度

**目标**: 确认页面加载流畅

1. 访问 http://localhost:3000/admin
2. 观察页面加载过程

**检查项**:
- [ ] ✅ 页面在3秒内完全加载
- [ ] ✅ 没有明显的布局跳动（layout shift）
- [ ] ✅ 数据加载有合理的loading状态提示

---

## 🔍 后端日志检查

### 测试14: 后端日志无错误

**目标**: 确认后端没有权限相关的错误

```bash
# 查看最近的后端日志
docker logs --tail 50 aicoin-backend-prod-v2 | grep -E "(ERROR|WARNING|权限|permission)"
```

**检查项**:
- [ ] ✅ 没有 "获取默认权限等级失败" 错误
- [ ] ✅ 没有 "coroutine object has no attribute" 错误
- [ ] ✅ 没有 "password authentication failed" 错误
- [ ] ✅ 看到 "从数据库读取的默认权限等级: LX" 日志（X是当前等级）

---

## 📝 回归测试

### 测试15: 其他功能未受影响

**目标**: 确认权限功能不影响其他模块

**快速检查以下页面是否正常加载**:
- [ ] ✅ 主页（http://localhost:3000）
- [ ] ✅ 三层记忆（http://localhost:3000/admin/memory）
- [ ] ✅ 交易记录（http://localhost:3000/admin/trades）
- [ ] ✅ AI决策（http://localhost:3000/admin/ai-decisions）
- [ ] ✅ 数据库管理（http://localhost:3000/admin/database）

---

## ✅ 最终验收

### 必须通过的测试（P0）

- [ ] ✅ 测试1: 数据库默认权限等级验证
- [ ] ✅ 测试2: 后端API返回正确权限等级
- [ ] ✅ 测试3: 交易控制中心显示正确
- [ ] ✅ 测试4: 权限管理页面顶部显示正确
- [ ] ✅ 测试5: 权限等级卡片高亮正确
- [ ] ✅ 测试6: 从交易控制中心切换权限等级
- [ ] ✅ 测试7: 从权限管理页面切换权限等级

### 重要的测试（P1）

- [ ] ✅ 测试8: UI/UX检查
- [ ] ✅ 测试10: 页面刷新后数据保持
- [ ] ✅ 测试14: 后端日志无错误
- [ ] ✅ 测试15: 其他功能未受影响

### 可选的测试（P2）

- [ ] ✅ 测试9: 快速切换权限等级
- [ ] ✅ 测试11: 多标签页同步
- [ ] ✅ 测试12: API响应时间
- [ ] ✅ 测试13: 前端加载速度

---

## 🎉 验收结果

**总测试项**: 15项  
**P0核心测试**: 7项  
**P1重要测试**: 4项  
**P2可选测试**: 4项

**通过标准**:
- ✅ 所有P0测试必须通过
- ✅ 至少3项P1测试通过
- ⚠️  P2测试可以有部分不通过

---

## 📞 问题反馈

如果任何测试未通过，请：

1. 截图错误信息
2. 复制浏览器控制台的错误（按F12打开）
3. 运行以下命令收集日志：
```bash
# 收集所有相关日志
docker logs aicoin-backend-prod-v2 > backend_logs.txt
cat /tmp/frontend.log > frontend_logs.txt
docker exec aicoin-postgres-prod psql -U aicoin -d aicoin -c "SELECT * FROM permission_level_configs WHERE is_active = true;" > db_config.txt
```

---

**测试准备时间**: 2025年11月3日  
**预计测试时长**: 15-20分钟  
**测试难度**: ⭐⭐☆☆☆ (简单)

🎯 **准备好了吗？开始测试吧！**

