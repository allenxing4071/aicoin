# 🚀 AIcoin 部署脚本工具集

## 📋 脚本清单

| 脚本名称 | 功能 | 使用频率 | 执行时间 |
|---------|------|---------|---------|
| `deploy-rsync.sh` | rsync 快速部署 | ⭐⭐⭐⭐⭐ | ~5-10秒 |
| `deploy-git.sh` | Git 标准部署 | ⭐⭐⭐⭐ | ~15-20秒 |
| `deploy-quick.sh` | 快速重启服务 | ⭐⭐⭐ | ~3-5秒 |
| `check-deployment.sh` | 检查部署状态 | ⭐⭐⭐⭐ | ~2秒 |

---

## 🎯 快速使用指南

### 1. 开发阶段（推荐）

```bash
# 修改代码后
cd /Users/xinghailong/Documents/soft/AIcoin
./scripts/deploy-rsync.sh

# 优势：
# ✅ 速度最快（增量传输）
# ✅ 无需 git commit
# ✅ 适合快速迭代
```

### 2. 功能完成（推荐）

```bash
# 提交代码
git add .
git commit -m "feat: 新功能描述"

# 部署
./scripts/deploy-git.sh

# 优势：
# ✅ 有版本记录
# ✅ 可以回滚
# ✅ 便于追踪
```

### 3. 配置修改

```bash
# 仅修改了 .env 或 docker-compose.yml
./scripts/deploy-quick.sh

# 优势：
# ✅ 极速（仅重启）
# ✅ 不重新构建镜像
```

### 4. 检查状态

```bash
# 随时检查服务器状态
./scripts/check-deployment.sh

# 输出：
# - Docker 构建进程
# - 容器运行状态
# - 最新日志
```

---

## 📊 三种部署方式对比

### 方式 A：rsync 部署

**工作流程：**
```
本地修改代码
    ↓
rsync 增量传输到服务器（5-10秒）
    ↓
服务器重新构建镜像（2-3分钟）
    ↓
重启服务（15秒）
```

**适用场景：**
- ✅ 开发阶段快速迭代
- ✅ Bug 修复快速验证
- ✅ 前端页面调整
- ✅ 后端逻辑修改

**不适用场景：**
- ❌ 正式版本发布
- ❌ 需要版本追踪
- ❌ 多人协作开发

---

### 方式 B：Git 部署

**工作流程：**
```
本地修改代码
    ↓
git add/commit（本地）
    ↓
git push（推送到远程仓库）
    ↓
服务器 git pull（拉取最新代码）
    ↓
服务器重新构建镜像（2-3分钟）
    ↓
重启服务（15秒）
```

**适用场景：**
- ✅ 正式版本发布
- ✅ 功能开发完成
- ✅ 需要打 tag
- ✅ 需要回滚能力

**不适用场景：**
- ❌ 频繁小改动
- ❌ 未完成的实验性代码

---

### 方式 C：快速重启

**工作流程：**
```
修改配置文件（.env）
    ↓
docker compose restart（3-5秒）
    ↓
服务重新加载配置
```

**适用场景：**
- ✅ 环境变量修改
- ✅ docker-compose.yml 修改
- ✅ 服务异常重启

**不适用场景：**
- ❌ 代码修改
- ❌ 依赖包更新

---

## 🔄 Git vs rsync 深度对比

### 速度对比

| 操作 | rsync | Git | 差异 |
|------|-------|-----|------|
| 传输 1 个小文件 | 1秒 | 3秒 | rsync 快 3倍 |
| 传输 10 个文件 | 3秒 | 5秒 | rsync 快 66% |
| 传输 100 个文件 | 10秒 | 15秒 | rsync 快 50% |
| 首次部署 | 30秒 | 45秒 | rsync 快 50% |

### 安全性对比

| 维度 | rsync | Git |
|------|-------|-----|
| 传输加密 | ✅ SSH | ✅ SSH/HTTPS |
| 版本追踪 | ❌ 无 | ✅ 有 |
| 可回滚 | ❌ 无 | ✅ 有 |
| 审计日志 | ❌ 无 | ✅ 有 |
| 多人协作 | ⚠️ 一般 | ✅ 优秀 |

### 适用场景

| 场景 | rsync | Git |
|------|-------|-----|
| 个人开发 | ✅ 推荐 | ⚠️ 可选 |
| 团队协作 | ❌ 不推荐 | ✅ 必须 |
| 快速迭代 | ✅ 推荐 | ❌ 不推荐 |
| 正式发布 | ❌ 不推荐 | ✅ 推荐 |
| 版本管理 | ❌ 不适合 | ✅ 最佳 |

---

## 💡 最佳实践

### 实践 1：混合使用

```bash
# 开发阶段（80% 的时间）
修改代码 → deploy-rsync.sh → 测试 → 继续修改

# 功能完成（20% 的时间）
git commit → 本地测试 → deploy-git.sh → 线上验证
```

### 实践 2：版本管理

```bash
# 每完成一个功能
git commit -m "feat: 功能描述"

# 每天结束前
git push origin main

# 正式发布时
git tag -a v3.3.x -m "Release: 版本说明"
git push origin --tags
```

### 实践 3：快速回滚

```bash
# 如果线上出现问题
ssh -i ssh-configs/cloud-servers/AIcoin.pem root@47.250.132.166

cd /root/AIcoin
git log --oneline  # 查看历史版本
git checkout v3.3.0  # 回滚到上一个稳定版本
docker compose build --no-cache
docker compose up -d
```

---

## 🛠️ 脚本内部实现

### deploy-rsync.sh 核心逻辑

```bash
# 1. 环境检查
检查 SSH 密钥
检查项目目录
测试服务器连接

# 2. 增量传输
rsync -avz --delete \
    --exclude='node_modules/' \
    --exclude='.next/' \
    --exclude='logs/' \
    本地目录/ 服务器目录/

# 3. 远程构建
ssh 服务器 << 'ENDSSH'
cd /root/AIcoin
docker compose down
docker compose build --no-cache
docker compose up -d
ENDSSH
```

### deploy-git.sh 核心逻辑

```bash
# 1. Git 状态检查
if ! git diff-index --quiet HEAD --; then
    read -p "是否提交更改?"
    git add -A
    git commit -m "$commit_msg"
fi

# 2. 推送到远程
git push origin main

# 3. 服务器拉取
ssh 服务器 << 'ENDSSH'
cd /root/AIcoin
git pull origin main
docker compose build --no-cache
docker compose up -d
ENDSSH
```

---

## 📈 实际使用数据

### 使用频率统计（开发阶段）

```
deploy-rsync.sh    ████████████████████ 75%
deploy-git.sh      ██████ 20%
deploy-quick.sh    ██ 5%
```

### 时间成本统计

| 阶段 | rsync | Git | 节省时间 |
|------|-------|-----|---------|
| 每次部署 | 5秒 | 15秒 | 10秒 |
| 每天 20 次 | 100秒 | 300秒 | 200秒 |
| 每周 100 次 | 500秒 | 1500秒 | 1000秒 |
| 每月 400 次 | 2000秒 | 6000秒 | 4000秒 ≈ 1小时 |

---

## ⚙️ 自定义配置

### 修改服务器地址

编辑每个脚本开头：

```bash
SERVER_USER="root"
SERVER_HOST="47.250.132.166"
SERVER_PATH="/root/AIcoin"
SSH_KEY="/path/to/your/ssh-key.pem"
```

### 添加 rsync 排除规则

在 `deploy-rsync.sh` 中：

```bash
rsync -avz --delete \
    --exclude='node_modules/' \
    --exclude='.next/' \
    --exclude='logs/' \
    --exclude='backups/' \       # 添加
    --exclude='*.pyc' \          # 添加
    --exclude='.DS_Store' \      # 添加
    ...
```

### 修改 Git 分支

在 `deploy-git.sh` 中：

```bash
GIT_BRANCH="main"        # 改为 "develop"
GIT_REMOTE="origin"      # 改为 "upstream"
```

---

## 🔍 故障排查

### 问题 1：SSH 连接失败

**症状：**
```
Permission denied (publickey)
```

**解决：**
```bash
# 检查密钥权限
chmod 400 ssh-configs/cloud-servers/AIcoin.pem

# 测试连接
ssh -i ssh-configs/cloud-servers/AIcoin.pem root@47.250.132.166
```

---

### 问题 2：rsync 传输失败

**症状：**
```
rsync: failed to connect to 47.250.132.166
```

**解决：**
```bash
# 1. 检查网络
ping 47.250.132.166

# 2. 检查 SSH
ssh -i ssh-configs/cloud-servers/AIcoin.pem root@47.250.132.166 echo "OK"

# 3. 手动 rsync
rsync -avz --dry-run \
    -e "ssh -i ssh-configs/cloud-servers/AIcoin.pem" \
    ./ root@47.250.132.166:/root/AIcoin/
```

---

### 问题 3：Docker 构建失败

**症状：**
```
ERROR: failed to solve: process "/bin/sh -c npm run build"
```

**解决：**
```bash
# SSH 到服务器
ssh -i ssh-configs/cloud-servers/AIcoin.pem root@47.250.132.166

# 查看详细日志
cd /root/AIcoin
docker compose build frontend 2>&1 | tee build.log

# 检查磁盘空间
df -h

# 清理旧镜像
docker system prune -a
```

---

### 问题 4：服务启动失败

**症状：**
```
docker compose ps  # 显示 Exited
```

**解决：**
```bash
# 查看日志
docker compose logs backend --tail=100
docker compose logs frontend --tail=100

# 检查端口占用
docker compose ps
netstat -tlnp | grep 8000
netstat -tlnp | grep 3000

# 重启服务
docker compose restart
```

---

## 📞 技术支持

### 脚本位置

```
scripts/
├── deploy-rsync.sh      # rsync 快速部署
├── deploy-git.sh        # Git 标准部署
├── deploy-quick.sh      # 快速重启
├── check-deployment.sh  # 状态检查
└── 部署脚本使用说明.md    # 详细文档
```

### 相关文档

- `scripts/README.md` - 脚本总览
- `scripts/部署脚本使用说明.md` - 详细使用指南
- `docs/07-部署运维/` - 部署文档目录

---

**最后更新：** 2025-11-12

**版本：** v1.0.0

**维护者：** AIcoin 技术团队

