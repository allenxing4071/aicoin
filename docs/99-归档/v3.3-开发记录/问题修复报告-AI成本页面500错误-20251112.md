# ğŸ”§ é—®é¢˜ä¿®å¤æŠ¥å‘Šï¼šAIæˆæœ¬é¡µé¢ 500 é”™è¯¯

**ä¿®å¤æ—¶é—´**: 2025-11-12  
**ä¿®å¤äºº**: AI Assistant  
**é—®é¢˜çº§åˆ«**: ğŸ”´ ä¸¥é‡ (P0)  
**çŠ¶æ€**: âœ… å·²è§£å†³

---

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·è®¿é—® `https://jifenpay.cc/admin/ai-cost` é¡µé¢æ—¶ï¼Œå‡ºç° API è°ƒç”¨å¤±è´¥ï¼š

```
âŒ /api/v1/ai-platforms/stats?time_range=all
   â†’ 500 Internal Server Error

âŒ /api/v1/ai-platforms/cost-trend-daily?days=7
   â†’ 500 Internal Server Error
```

## ğŸ” é—®é¢˜å®šä½è¿‡ç¨‹

### 1. åˆæ­¥æ£€æŸ¥

- âœ… æœ¬åœ°ç¯å¢ƒ API æ­£å¸¸å·¥ä½œ
- âŒ ç”Ÿäº§ç¯å¢ƒ API è¿”å› 500 é”™è¯¯
- ğŸ” éœ€è¦æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒåç«¯æ—¥å¿—

### 2. æŸ¥çœ‹ç”Ÿäº§æ—¥å¿—

```bash
docker logs aicoin-backend --tail=100
```

å‘ç°å…³é”®é”™è¯¯ï¼š

```python
sqlalchemy.exc.ProgrammingError: 
<class 'asyncpg.exceptions.UndefinedTableError'>: 
relation "ai_model_usage_log" does not exist
```

### 3. æ ¹æœ¬åŸå› ç¡®è®¤

- ç”Ÿäº§æ•°æ®åº“ç¼ºå°‘ `ai_model_usage_log` è¡¨åŠç›¸å…³è¡¨
- Alembic è¿ç§»ç‰ˆæœ¬æ˜¾ç¤ºä¸º `014`ï¼ˆå·²æ‰§è¡Œï¼‰
- ä½†å®é™…è¡¨æœªåˆ›å»ºï¼ˆå¯èƒ½è¿ç§»å¤±è´¥ä½†æœªå›æ»šï¼‰

### 4. éªŒè¯è¡¨ä¸å­˜åœ¨

```bash
\dt ai_model*
# Did not find any relation named "ai_model*"
```

ç¡®è®¤ä»¥ä¸‹ä¸‰å¼ è¡¨éƒ½ä¸å­˜åœ¨ï¼š
- `ai_model_pricing` - AIæ¨¡å‹å®šä»·é…ç½®è¡¨
- `ai_model_usage_log` - AIæ¨¡å‹ä½¿ç”¨æ—¥å¿—è¡¨
- `ai_budget_alerts` - AIé¢„ç®—å‘Šè­¦è¡¨

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ‰§è¡Œæ­¥éª¤

#### 1. åˆ›å»º SQL è„šæœ¬

åˆ›å»ºå®Œæ•´çš„è¡¨ç»“æ„å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼š
- è¡¨å®šä¹‰
- å­—æ®µæ³¨é‡Š
- ç´¢å¼•åˆ›å»º
- åˆå§‹æ•°æ®æ’å…¥

#### 2. åœ¨ç”Ÿäº§æ•°æ®åº“æ‰§è¡Œ

```bash
# ä¸Šä¼ å¹¶æ‰§è¡Œ SQL
ssh -i "$SSH_KEY" root@47.250.132.166 \
  "docker-compose exec -T postgres psql -U aicoin -d aicoin" \
  < create_ai_tables.sql
```

#### 3. éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ

```sql
SELECT 'ai_model_pricing' as table_name, COUNT(*) FROM ai_model_pricing
UNION ALL
SELECT 'ai_model_usage_log', COUNT(*) FROM ai_model_usage_log
UNION ALL
SELECT 'ai_budget_alerts', COUNT(*) FROM ai_budget_alerts;
```

ç»“æœï¼š
```
     table_name     | row_count 
--------------------+-----------
 ai_model_pricing   |         9  â† åˆå§‹æ•°æ®å·²æ’å…¥
 ai_model_usage_log |         0  â† è¡¨å·²åˆ›å»º
 ai_budget_alerts   |         0  â† è¡¨å·²åˆ›å»º
```

---

## âœ… ä¿®å¤éªŒè¯

### API æµ‹è¯•ç»“æœ

#### 1. `/api/v1/ai-platforms/stats?time_range=all`

```bash
curl -s 'https://jifenpay.cc/api/v1/ai-platforms/stats?time_range=all' | jq .
```

âœ… **çŠ¶æ€**: 200 OK
```json
{
  "success": true,
  "data": {
    "time_range": "all",
    "time_label": "å…¨éƒ¨",
    "summary": {
      "total_calls": 0,
      "successful_calls": 0,
      "failed_calls": 0,
      "success_rate": 0,
      "total_cost": 0.0
    },
    "platforms": [...]
  }
}
```

#### 2. `/api/v1/ai-platforms/cost-trend-daily?days=7`

```bash
curl -s 'https://jifenpay.cc/api/v1/ai-platforms/cost-trend-daily?days=7' | jq .
```

âœ… **çŠ¶æ€**: 200 OK
```json
{
  "success": true,
  "data": {
    "days": 7,
    "daily_trend": [],
    "summary": {
      "total_cost": 0,
      "avg_daily_cost": 0,
      "max_daily_cost": 0,
      "min_daily_cost": 0
    }
  }
}
```

#### 3. é¡µé¢è®¿é—®æµ‹è¯•

```bash
curl -o /dev/null -w "Status: %{http_code}\n" \
  'https://jifenpay.cc/admin/ai-cost'
```

âœ… **çŠ¶æ€**: 200 OK

---

## ğŸ“Š åˆ›å»ºçš„è¡¨ç»“æ„

### 1. ai_model_pricing (AIæ¨¡å‹å®šä»·é…ç½®è¡¨)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | SERIAL | ä¸»é”®ID |
| model_name | VARCHAR(100) | æ¨¡å‹åç§°ï¼ˆå”¯ä¸€ï¼‰ |
| provider | VARCHAR(50) | æä¾›å•† |
| display_name | VARCHAR(100) | æ˜¾ç¤ºåç§° |
| model_type | VARCHAR(50) | æ¨¡å‹ç±»å‹ |
| input_price_per_million | FLOAT | è¾“å…¥tokenä»·æ ¼ï¼ˆæ¯ç™¾ä¸‡ï¼‰ |
| output_price_per_million | FLOAT | è¾“å‡ºtokenä»·æ ¼ï¼ˆæ¯ç™¾ä¸‡ï¼‰ |
| total_calls | INTEGER | æ€»è°ƒç”¨æ¬¡æ•° |
| total_cost | FLOAT | æ€»èŠ±è´¹ |
| monthly_budget | FLOAT | æœˆåº¦é¢„ç®— |
| current_month_cost | FLOAT | å½“æœˆèŠ±è´¹ |
| enabled | BOOLEAN | æ˜¯å¦å¯ç”¨ |
| is_free | BOOLEAN | æ˜¯å¦å…è´¹ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ |

**åˆå§‹æ•°æ®**: 9æ¡æ¨¡å‹é…ç½®ï¼ˆDeepSeekã€Qwenã€GPT-4oã€Claudeç­‰ï¼‰

### 2. ai_model_usage_log (AIæ¨¡å‹ä½¿ç”¨æ—¥å¿—è¡¨)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | SERIAL | ä¸»é”®ID |
| model_name | VARCHAR(100) | æ¨¡å‹åç§° |
| decision_id | VARCHAR(100) | å†³ç­–IDï¼ˆç”¨äºè¿½è¸ªï¼‰ |
| user_id | INTEGER | ç”¨æˆ·ID |
| prompt_tokens | INTEGER | è¾“å…¥tokensæ•°é‡ |
| completion_tokens | INTEGER | è¾“å‡ºtokensæ•°é‡ |
| cost | FLOAT | æœ¬æ¬¡èŠ±è´¹ï¼ˆå…ƒï¼‰ |
| response_time | FLOAT | å“åº”æ—¶é—´ï¼ˆç§’ï¼‰ |
| success | BOOLEAN | æ˜¯å¦æˆåŠŸ |
| error_message | TEXT | é”™è¯¯ä¿¡æ¯ |
| purpose | VARCHAR(100) | è°ƒç”¨ç›®çš„ |
| timestamp | TIMESTAMP | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- model_name (æŸ¥è¯¢ä¼˜åŒ–)
- decision_id (è¿½è¸ªå…³è”)
- timestamp (æ—¶é—´èŒƒå›´æŸ¥è¯¢)

### 3. ai_budget_alerts (AIé¢„ç®—å‘Šè­¦è¡¨)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | SERIAL | ä¸»é”®ID |
| model_name | VARCHAR(100) | æ¨¡å‹åç§° |
| alert_type | VARCHAR(50) | å‘Šè­¦ç±»å‹ |
| alert_level | VARCHAR(20) | å‘Šè­¦çº§åˆ« |
| current_cost | FLOAT | å½“å‰èŠ±è´¹ |
| budget_limit | FLOAT | é¢„ç®—é™åˆ¶ |
| usage_percentage | FLOAT | ä½¿ç”¨ç™¾åˆ†æ¯” |
| message | TEXT | å‘Šè­¦æ¶ˆæ¯ |
| is_resolved | BOOLEAN | æ˜¯å¦å·²è§£å†³ |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ |

---

## ğŸ“ ç»éªŒæ€»ç»“

### é—®é¢˜æ ¹æº

1. **Alembic è¿ç§»è®°å½•ä¸å‡†ç¡®**: 
   - æ•°æ®åº“è®°å½•æ˜¾ç¤ºå·²æ‰§è¡Œè¿ç§» `014`
   - ä½†å®é™…è¡¨æœªåˆ›å»º
   - å¯èƒ½åŸå› ï¼šè¿ç§»è¿‡ç¨‹å¼‚å¸¸ä½†æœªæ­£ç¡®å›æ»š

2. **ç¼ºå°‘è¿ç§»éªŒè¯æœºåˆ¶**:
   - éƒ¨ç½²åæœªéªŒè¯è¡¨æ˜¯å¦çœŸæ­£åˆ›å»º
   - éœ€è¦å¢åŠ éƒ¨ç½²åçš„å¥åº·æ£€æŸ¥

### é¢„é˜²æªæ–½

1. **éƒ¨ç½²æ£€æŸ¥æ¸…å•**:
   ```bash
   # è¿ç§»åéªŒè¯è¡¨å­˜åœ¨
   docker-compose exec -T postgres psql -U aicoin -d aicoin \
     -c "SELECT table_name FROM information_schema.tables 
         WHERE table_schema='public' AND table_name LIKE 'ai_%';"
   ```

2. **æ·»åŠ å¥åº·æ£€æŸ¥æ¥å£**:
   ```python
   @router.get("/health/database")
   async def check_database_health():
       # æ£€æŸ¥å…³é”®è¡¨æ˜¯å¦å­˜åœ¨
       required_tables = [
           'ai_model_pricing',
           'ai_model_usage_log',
           'ai_budget_alerts'
       ]
       # ... éªŒè¯é€»è¾‘
   ```

3. **ç›‘æ§å‘Šè­¦**:
   - å¯¹ 500 é”™è¯¯è®¾ç½®å‘Šè­¦
   - å®šæœŸæ£€æŸ¥æ•°æ®åº“è¡¨å®Œæ•´æ€§

---

## ğŸ¯ åç»­å»ºè®®

### ç«‹å³æ‰§è¡Œ

1. âœ… é—®é¢˜å·²ä¿®å¤ï¼Œæ— éœ€é¢å¤–æ“ä½œ
2. ğŸ“ å»ºè®®è®°å½•åˆ°è¿ç»´æ—¥å¿—

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰

1. **æ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥æ¥å£**
   - ä½ç½®ï¼š`/api/v1/admin/health/database`
   - åŠŸèƒ½ï¼šæ£€æŸ¥æ‰€æœ‰å…³é”®è¡¨æ˜¯å¦å­˜åœ¨

2. **å®Œå–„éƒ¨ç½²è„šæœ¬**
   - åœ¨ `deploy_singapore.sh` ä¸­æ·»åŠ è¡¨éªŒè¯æ­¥éª¤
   - è¿ç§»åè‡ªåŠ¨æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ

### ä¸­æœŸï¼ˆæœ¬æœˆï¼‰

1. **ç»Ÿä¸€è¿ç§»ç®¡ç†**
   - è€ƒè™‘ä½¿ç”¨ Alembic çš„ `check` å‘½ä»¤
   - å»ºç«‹è¿ç§»å‰åçš„éªŒè¯æµç¨‹

2. **ç›‘æ§ç³»ç»Ÿå¢å¼º**
   - æ·»åŠ æ•°æ®åº“è¡¨å­˜åœ¨æ€§ç›‘æ§
   - è®¾ç½® API é”™è¯¯ç‡å‘Šè­¦

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- è¿ç§»è„šæœ¬ï¼š`backend/alembic/versions/013_add_ai_cost_management.py`
- API å®ç°ï¼š`backend/app/api/v1/endpoints/platform_stats.py`
- å‰ç«¯é¡µé¢ï¼š`frontend/app/admin/ai-cost/page.tsx`
- æ•°æ®æ¨¡å‹ï¼š`backend/app/models/ai_model_pricing.py`

---

## âœ¨ ä¿®å¤æ€»ç»“

| é¡¹ç›® | ç»“æœ |
|------|------|
| **é—®é¢˜å®šä½æ—¶é—´** | ~5åˆ†é’Ÿ |
| **ä¿®å¤æ‰§è¡Œæ—¶é—´** | ~3åˆ†é’Ÿ |
| **å½±å“èŒƒå›´** | AIæˆæœ¬ç®¡ç†é¡µé¢ |
| **æ•°æ®ä¸¢å¤±** | æ—  |
| **æœåŠ¡ä¸­æ–­** | æ— ï¼ˆä»…åŠŸèƒ½ä¸å¯ç”¨ï¼‰ |
| **ä¿®å¤æ–¹å¼** | æ‰‹åŠ¨åˆ›å»ºç¼ºå¤±è¡¨ |
| **éªŒè¯ç»“æœ** | âœ… å®Œå…¨æ¢å¤æ­£å¸¸ |

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-12 17:52 CST  
**é¡µé¢çŠ¶æ€**: âœ… æ­£å¸¸è®¿é—®  
**APIçŠ¶æ€**: âœ… æ­£å¸¸å“åº”  
**æ•°æ®å®Œæ•´æ€§**: âœ… æ— ä¸¢å¤±

ğŸ‰ **é—®é¢˜å·²å®Œå…¨è§£å†³ï¼**

