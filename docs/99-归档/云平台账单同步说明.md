# 云平台账单同步说明

## 问题分析

### 当前情况

**显示的 ¥3.65 数据来源**:
1. 每次调用 AI API 时，从响应中获取 `usage.prompt_tokens` 和 `usage.completion_tokens`
2. 使用固定的价格表计算成本（例如：输入 ¥0.001/1K tokens）
3. 累加到 `intelligence_platforms.total_cost` 字段

**问题**:
- ❌ 价格表可能不准确（各平台价格经常调整）
- ❌ 没有考虑折扣、套餐等因素
- ❌ 无法与云平台账单核对

### 理想方案

**直接从云平台获取真实账单**:
```
云平台账单 API → 真实消费金额 → 数据库 → 前端显示
```

## 各云平台账单 API 调研

### 1. 阿里云

**API**: BSS OpenAPI
- **查询账户余额**: `QueryAccountBalance`
- **查询账单总览**: `QueryBillOverview`
- **查询实例账单**: `QueryInstanceBill`

**认证方式**:
```python
# 需要:
# - AccessKeyId
# - AccessKeySecret
# - 签名机制（HMAC-SHA1）

# 使用 SDK:
from alibabacloud_bssopenapi20171214.client import Client
from alibabacloud_tea_openapi import models as open_api_models

config = open_api_models.Config(
    access_key_id='YOUR_ACCESS_KEY_ID',
    access_key_secret='YOUR_ACCESS_KEY_SECRET'
)
client = Client(config)
```

**返回数据**:
- 账户余额
- 消费金额（按时间范围）
- 产品维度消费明细

**文档**: https://help.aliyun.com/document_detail/100392.html

### 2. 百度智能云

**API**: 费用中心 API
- **查询账户余额**: `/api/v1/finance/balance`
- **查询消费明细**: `/api/v1/finance/bill`

**认证方式**:
```python
# 需要:
# - API Key
# - Secret Key
# - 签名机制

# 使用 SDK:
from baidubce.auth.bce_credentials import BceCredentials
from baidubce.bce_client_configuration import BceClientConfiguration
```

**返回数据**:
- 账户余额
- 消费金额
- 按产品分类的消费

**文档**: https://cloud.baidu.com/doc/Finance/index.html

### 3. 腾讯云

**API**: 账单管理 API
- **查询账户余额**: `DescribeAccountBalance`
- **获取账单资源汇总**: `DescribeBillResourceSummary`
- **获取账单明细**: `DescribeBillDetail`

**认证方式**:
```python
# 需要:
# - SecretId
# - SecretKey
# - 签名机制（TC3-HMAC-SHA256）

# 使用 SDK:
from tencentcloud.common import credential
from tencentcloud.billing.v20180709 import billing_client
```

**返回数据**:
- 账户余额
- 资源消费汇总
- 详细账单

**文档**: https://cloud.tencent.com/document/product/555

### 4. 火山引擎

**API**: 账单查询 API
- **查询账户余额**: `/api/v1/account/balance`
- **查询消费明细**: `/api/v1/billing/detail`

**认证方式**:
```python
# 需要:
# - Access Key
# - Secret Key
# - 签名机制
```

**返回数据**:
- 账户余额
- 消费金额
- 按服务分类的消费

**文档**: https://www.volcengine.com/docs/

### 5. DeepSeek

**API**: 用户余额 API
- **查询余额**: `GET https://api.deepseek.com/user/balance`

**认证方式**:
```python
# 简单的 Bearer Token 认证
headers = {
    "Authorization": f"Bearer {api_key}",
    "Content-Type": "application/json"
}
```

**返回数据**:
```json
{
  "balance": 100.50,
  "currency": "CNY"
}
```

**问题**: 只返回余额，不返回消费金额

**文档**: https://platform.deepseek.com/api-docs/

## 实施方案

### 方案 A: 完整账单 API 集成（推荐但复杂）

**优点**:
- ✅ 100% 准确的账单数据
- ✅ 可以核对云平台账单
- ✅ 包含折扣、套餐等信息

**缺点**:
- ❌ 需要为每个平台实现复杂的认证和签名
- ❌ 需要安装多个云平台 SDK
- ❌ 需要额外的 API 权限申请
- ❌ 开发工作量大

**实施步骤**:
1. 为每个云平台配置 AccessKey/SecretKey
2. 安装对应的 SDK
3. 实现账单查询逻辑
4. 定期同步（每小时或每天）

### 方案 B: 优化现有计算逻辑（快速实用）

**优点**:
- ✅ 无需额外 API 权限
- ✅ 实时计算，无延迟
- ✅ 实现简单

**缺点**:
- ⚠️  依赖价格表准确性
- ⚠️  无法反映折扣和套餐

**实施步骤**:
1. 更新价格表为最新官方价格
2. 从 API 响应的 `usage` 字段实时计算
3. 添加价格表更新机制

### 方案 C: 混合方案（平衡方案）

**实施**:
1. **短期**: 使用方案 B，优化价格表
2. **中期**: 实现 DeepSeek 余额查询（最简单）
3. **长期**: 逐步集成其他平台的账单 API

## 当前建议

### 立即可做的改进

1. **更新价格表**

创建 `backend/app/services/ai_pricing.py`:

```python
# 各平台最新价格（2025-11 更新）
PRICING = {
    "qwen": {
        "qwen-plus": {
            "input": 0.004,   # ¥0.004/1K tokens
            "output": 0.012   # ¥0.012/1K tokens
        }
    },
    "deepseek": {
        "deepseek-chat": {
            "input": 0.001,   # ¥0.001/1K tokens (缓存命中)
            "output": 0.002   # ¥0.002/1K tokens
        }
    },
    "baidu": {
        "qwen-plus": {
            "input": 0.008,   # ¥0.008/1K tokens
            "output": 0.016   # ¥0.016/1K tokens
        }
    }
}
```

2. **添加价格查询接口**

```python
@router.get("/pricing")
async def get_current_pricing():
    """获取当前价格表"""
    return {"success": True, "data": PRICING}
```

3. **添加手动校准功能**

前端添加「手动输入实际账单」功能:
- 用户从云平台查看实际账单
- 手动输入到系统
- 系统计算差异并调整价格表

### 下一步计划

1. **Week 1**: 实现 DeepSeek 余额查询（最简单）
2. **Week 2**: 添加手动账单校准功能
3. **Week 3**: 研究阿里云 SDK 集成
4. **Week 4**: 逐步集成其他平台

## 总结

**现状**:
- 当前的 ¥3.65 是基于 token 数量和价格表估算的
- 不是从云平台账单 API 获取的真实金额

**问题根源**:
- 价格表可能不准确
- 没有考虑折扣因素

**解决方案**:
1. **短期**: 更新价格表，添加手动校准
2. **中期**: 实现 DeepSeek 等简单平台的账单查询
3. **长期**: 完整集成所有平台的账单 API

**建议**:
- 先使用方案 B（优化价格表）快速改进
- 然后逐步实现方案 C（混合方案）
- 最终目标是方案 A（完整集成）

**重要**: 要获取 100% 准确的账单数据，必须配置各云平台的账单 API 凭证并实现完整的认证流程。这需要一定的开发工作量和 API 权限申请。

