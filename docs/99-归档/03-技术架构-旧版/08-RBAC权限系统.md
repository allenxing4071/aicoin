# RBACæƒé™ç³»ç»Ÿæ¶æ„æ–‡æ¡£

> ä¼ä¸šçº§è§’è‰²æƒé™ç®¡ç†ç³»ç»Ÿ | v3.3.0

---

## ğŸ“‹ æ¦‚è¿°

AIcoinçš„RBACï¼ˆRole-Based Access Controlï¼‰ç³»ç»Ÿæ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„æƒé™ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œæä¾›ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ã€çµæ´»çš„è§’è‰²ç®¡ç†å’Œå®Œæ•´çš„å®¡è®¡æ—¥å¿—åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ” **ç»†ç²’åº¦æƒé™æ§åˆ¶** - æ”¯æŒé¡µé¢ã€APIã€æŒ‰é’®ä¸‰ä¸ªçº§åˆ«çš„æƒé™
- ğŸ‘¥ **çµæ´»è§’è‰²ç®¡ç†** - æ”¯æŒè§’è‰²ç»§æ‰¿ã€åŠ¨æ€è§’è‰²åˆ›å»º
- ğŸ“Š **å®¡è®¡æ—¥å¿—** - å®Œæ•´è®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œ
- ğŸ¯ **åŠ¨æ€æƒé™åŠ è½½** - å‰ç«¯åŸºäºæƒé™åŠ¨æ€æ¸²æŸ“èœå•å’Œç»„ä»¶
- âš¡ **é«˜æ€§èƒ½** - æƒé™æ£€æŸ¥é€»è¾‘ä¼˜åŒ–ï¼Œæ”¯æŒæ‰¹é‡æŸ¥è¯¢

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•°æ®æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AdminUser  â”‚â”€â”€â”€â”€â”€â”€â”‚    Role     â”‚â”€â”€â”€â”€â”€â”€â”‚ Permission  â”‚
â”‚  (ç”¨æˆ·)     â”‚ n:1  â”‚   (è§’è‰²)    â”‚ n:m  â”‚  (æƒé™)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                      â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                           â”‚
       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                    â”‚ RolePermission  â”‚
       â”‚                    â”‚   (å…³è”è¡¨)       â”‚
       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ PermissionAudit  â”‚
                                        â”‚   (å®¡è®¡æ—¥å¿—)      â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®è¡¨ç»“æ„

#### 1. permissions (æƒé™è¡¨)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | Integer | ä¸»é”® |
| code | String(100) | æƒé™ä»£ç ï¼Œå¦‚ `users.view` |
| name | String(100) | æƒé™åç§° |
| description | Text | æƒé™æè¿° |
| resource_type | String(50) | èµ„æºç±»å‹ï¼špage/api/button |
| resource_path | String(200) | èµ„æºè·¯å¾„ |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ |

#### 2. roles (è§’è‰²è¡¨)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | Integer | ä¸»é”® |
| code | String(50) | è§’è‰²ä»£ç ï¼Œå¦‚ `admin` |
| name | String(100) | è§’è‰²åç§° |
| description | Text | è§’è‰²æè¿° |
| is_system | Boolean | æ˜¯å¦ç³»ç»Ÿè§’è‰²ï¼ˆä¸å¯åˆ é™¤ï¼‰ |
| parent_role_id | Integer | çˆ¶è§’è‰²IDï¼ˆæ”¯æŒç»§æ‰¿ï¼‰ |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ |
| updated_at | DateTime | æ›´æ–°æ—¶é—´ |

#### 3. role_permissions (è§’è‰²æƒé™å…³è”è¡¨)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | Integer | ä¸»é”® |
| role_id | Integer | è§’è‰²ID |
| permission_id | Integer | æƒé™ID |
| created_at | DateTime | åˆ›å»ºæ—¶é—´ |

#### 4. admin_users (ç”¨æˆ·è¡¨ - æ‰©å±•)

æ–°å¢å­—æ®µï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| role_id | Integer | è§’è‰²IDï¼ˆæ–°RBACç³»ç»Ÿï¼‰ |
| custom_permissions | JSON | ç”¨æˆ·çº§åˆ«çš„ç‰¹æ®Šæƒé™ |

#### 5. permission_audit_logs (å®¡è®¡æ—¥å¿—è¡¨)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | Integer | ä¸»é”® |
| operator_id | Integer | æ“ä½œäººID |
| action | String(50) | æ“ä½œç±»å‹ |
| target_type | String(50) | ç›®æ ‡ç±»å‹ï¼šrole/user/permission |
| target_id | Integer | ç›®æ ‡ID |
| details | JSON | è¯¦ç»†ä¿¡æ¯ |
| created_at | DateTime | æ“ä½œæ—¶é—´ |

---

## ğŸ” æƒé™ç±»å‹

### 1. é¡µé¢æƒé™ (page)

æ§åˆ¶ç”¨æˆ·èƒ½å¦è®¿é—®æŸä¸ªé¡µé¢ã€‚

**ç¤ºä¾‹ï¼š**
- `users.view` - æŸ¥çœ‹ç”¨æˆ·é¡µé¢
- `backup.view` - æŸ¥çœ‹å¤‡ä»½é¡µé¢
- `logs.view` - æŸ¥çœ‹æ—¥å¿—é¡µé¢

### 2. APIæƒé™ (api)

æ§åˆ¶ç”¨æˆ·èƒ½å¦è°ƒç”¨æŸä¸ªAPIæ¥å£ã€‚

**ç¤ºä¾‹ï¼š**
- `users.create` - åˆ›å»ºç”¨æˆ·API
- `users.update` - æ›´æ–°ç”¨æˆ·API
- `users.delete` - åˆ é™¤ç”¨æˆ·API

### 3. æŒ‰é’®æƒé™ (button)

æ§åˆ¶é¡µé¢ä¸­æŸä¸ªæ“ä½œæŒ‰é’®çš„æ˜¾ç¤ºå’Œå¯ç”¨æ€§ã€‚

**ç¤ºä¾‹ï¼š**
- `trades.export` - å¯¼å‡ºäº¤æ˜“æŒ‰é’®
- `backup.create` - åˆ›å»ºå¤‡ä»½æŒ‰é’®
- `logs.download` - ä¸‹è½½æ—¥å¿—æŒ‰é’®

---

## ğŸ‘¥ ç³»ç»Ÿè§’è‰²

### å†…ç½®è§’è‰²

| è§’è‰²ä»£ç  | è§’è‰²åç§° | è¯´æ˜ | æƒé™æ•°é‡ |
|---------|---------|------|---------|
| `super_admin` | è¶…çº§ç®¡ç†å‘˜ | æ‹¥æœ‰æ‰€æœ‰æƒé™ | âˆ (å…¨éƒ¨) |
| `admin` | ç®¡ç†å‘˜ | ç³»ç»Ÿç®¡ç†å’Œé…ç½® | 26 |
| `risk_manager` | é£æ§ç»ç† | é£æ§å’Œäº¤æ˜“ç›‘æ§ | 7 |
| `trader` | äº¤æ˜“å‘˜ | æ‰§è¡Œäº¤æ˜“æ“ä½œ | 4 |
| `analyst` | åˆ†æå¸ˆ | æ•°æ®åˆ†æå’ŒæŠ¥å‘Š | 8 |
| `viewer` | è§‚å¯Ÿè€… | åŸºç¡€æŸ¥çœ‹æƒé™ | 2 |

### è§’è‰²ç»§æ‰¿

æ”¯æŒè§’è‰²ç»§æ‰¿ï¼Œå­è§’è‰²è‡ªåŠ¨ç»§æ‰¿çˆ¶è§’è‰²çš„æ‰€æœ‰æƒé™ã€‚

**ç¤ºä¾‹ï¼š**
```
super_admin (æ‰€æœ‰æƒé™)
    â†“
admin (ç®¡ç†æƒé™)
    â†“
risk_manager (é£æ§æƒé™)
    â†“
trader (äº¤æ˜“æƒé™)
```

---

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### åç«¯API

#### 1. æƒé™ç®¡ç†

```bash
# è·å–æ‰€æœ‰æƒé™
GET /api/v1/admin/rbac/permissions

# åˆ›å»ºæƒé™ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
POST /api/v1/admin/rbac/permissions
{
  "code": "new.permission",
  "name": "æ–°æƒé™",
  "description": "æƒé™æè¿°",
  "resource_type": "page",
  "resource_path": "/admin/new-page"
}

# æ›´æ–°æƒé™
PUT /api/v1/admin/rbac/permissions/{id}

# åˆ é™¤æƒé™
DELETE /api/v1/admin/rbac/permissions/{id}
```

#### 2. è§’è‰²ç®¡ç†

```bash
# è·å–æ‰€æœ‰è§’è‰²
GET /api/v1/admin/rbac/roles?include_permissions=true

# åˆ›å»ºè§’è‰²ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
POST /api/v1/admin/rbac/roles
{
  "code": "custom_role",
  "name": "è‡ªå®šä¹‰è§’è‰²",
  "description": "è§’è‰²æè¿°",
  "parent_role_id": null
}

# æ›´æ–°è§’è‰²æƒé™
PUT /api/v1/admin/rbac/roles/{id}/permissions
{
  "permission_ids": [1, 2, 3, ...]
}

# åˆ é™¤è§’è‰²
DELETE /api/v1/admin/rbac/roles/{id}
```

#### 3. å®¡è®¡æ—¥å¿—

```bash
# è·å–å®¡è®¡æ—¥å¿—
GET /api/v1/admin/rbac/audit-logs?limit=100
```

### å‰ç«¯é›†æˆ

#### 1. ä½¿ç”¨æƒé™Hook

```typescript
import { usePermissions } from '@/app/admin/PermissionsProvider';

function MyComponent() {
  const { hasPermission, userRole } = usePermissions();
  
  // æ£€æŸ¥å•ä¸ªæƒé™
  if (hasPermission('users.create')) {
    // æ˜¾ç¤ºåˆ›å»ºç”¨æˆ·æŒ‰é’®
  }
  
  // æ£€æŸ¥ç”¨æˆ·è§’è‰²
  if (userRole === 'super_admin') {
    // æ˜¾ç¤ºç®¡ç†å‘˜ä¸“å±åŠŸèƒ½
  }
}
```

#### 2. ä½¿ç”¨æƒé™Guardç»„ä»¶

```typescript
import { PermissionGuard } from '@/app/components/auth/PermissionGuard';

<PermissionGuard permission="users.create" fallback={<div>æ— æƒé™</div>}>
  <button>åˆ›å»ºç”¨æˆ·</button>
</PermissionGuard>
```

#### 3. åŠ¨æ€èœå•æ¸²æŸ“

èœå•é¡¹ä¼šæ ¹æ®ç”¨æˆ·æƒé™è‡ªåŠ¨æ˜¾ç¤º/éšè—ï¼š

```typescript
// layout.tsx ä¸­çš„èœå•é…ç½®
if (checkPermission('users.view')) {
  menuItems.push({
    key: "/admin/users",
    label: <Link href="/admin/users">ç”¨æˆ·ç®¡ç†</Link>,
  });
}
```

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### 1. æœ€å°æƒé™åŸåˆ™

- ä»…æˆäºˆç”¨æˆ·å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æƒé™é›†
- å®šæœŸå®¡æŸ¥å’Œæ¸…ç†ä¸å¿…è¦çš„æƒé™

### 2. è§’è‰²åˆ†ç¦»

- å°†ä¸åŒèŒè´£åˆ†é…ç»™ä¸åŒè§’è‰²
- é¿å…å•ä¸€ç”¨æˆ·æ‹¥æœ‰è¿‡å¤šæƒé™

### 3. å®¡è®¡å’Œç›‘æ§

- å®šæœŸæ£€æŸ¥å®¡è®¡æ—¥å¿—
- ç›‘æ§å¼‚å¸¸çš„æƒé™å˜æ›´æ“ä½œ
- ä¿ç•™å®¡è®¡æ—¥å¿—è‡³å°‘6ä¸ªæœˆ

### 4. ç³»ç»Ÿè§’è‰²ä¿æŠ¤

- ç³»ç»Ÿå†…ç½®è§’è‰²ï¼ˆis_system=trueï¼‰ä¸å¯åˆ é™¤
- è¶…çº§ç®¡ç†å‘˜è´¦å·åº”ä¸¥æ ¼æ§åˆ¶æ•°é‡
- ä½¿ç”¨å¼ºå¯†ç å’ŒåŒå› ç´ è®¤è¯

### 5. å‰åç«¯åŒé‡éªŒè¯

- å‰ç«¯æƒé™æ£€æŸ¥ä»…ç”¨äºUIä¼˜åŒ–
- æ‰€æœ‰å…³é”®æ“ä½œå¿…é¡»åœ¨åç«¯å†æ¬¡éªŒè¯æƒé™
- APIæ¥å£å¿…é¡»ä½¿ç”¨æƒé™è£…é¥°å™¨ä¿æŠ¤

---

## ğŸ“Š æƒé™é…ç½®ç¤ºä¾‹

### åœºæ™¯1ï¼šæ·»åŠ æ–°çš„æ•°æ®å¯¼å‡ºåŠŸèƒ½

1. **åˆ›å»ºæƒé™**
```json
{
  "code": "data.export",
  "name": "å¯¼å‡ºæ•°æ®",
  "resource_type": "button",
  "resource_path": "",
  "description": "å…è®¸å¯¼å‡ºç³»ç»Ÿæ•°æ®"
}
```

2. **åˆ†é…ç»™è§’è‰²**
```json
// ç»™ admin å’Œ analyst è§’è‰²æ·»åŠ æ­¤æƒé™
PUT /api/v1/admin/rbac/roles/2/permissions
{
  "permission_ids": [...existing, new_permission_id]
}
```

3. **å‰ç«¯ä½¿ç”¨**
```typescript
<PermissionGuard permission="data.export">
  <button onClick={handleExport}>å¯¼å‡ºæ•°æ®</button>
</PermissionGuard>
```

### åœºæ™¯2ï¼šåˆ›å»ºå®¢æœè§’è‰²

1. **åˆ›å»ºè§’è‰²**
```json
{
  "code": "customer_service",
  "name": "å®¢æœ",
  "description": "å¤„ç†ç”¨æˆ·é—®é¢˜å’ŒæŸ¥è¯¢",
  "parent_role_id": null
}
```

2. **åˆ†é…æƒé™**
```json
{
  "permission_ids": [
    // åªåŒ…å«æŸ¥çœ‹ç›¸å…³çš„æƒé™
    "users.view",
    "trades.view",
    "orders.view"
  ]
}
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. æƒé™ç¼“å­˜

- ç”¨æˆ·æƒé™åœ¨ç™»å½•æ—¶åŠ è½½å¹¶ç¼“å­˜
- ä½¿ç”¨React Contexté¿å…é‡å¤APIè°ƒç”¨
- æƒé™å˜æ›´åè‡ªåŠ¨åˆ·æ–°ç¼“å­˜

### 2. æ‰¹é‡æŸ¥è¯¢

- ä½¿ç”¨JOINæŸ¥è¯¢ä¸€æ¬¡æ€§è·å–è§’è‰²å’Œæƒé™
- å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°

### 3. å‰ç«¯ä¼˜åŒ–

- ä½¿ç”¨`useMemo`ç¼“å­˜èœå•é…ç½®
- é¿å…ä¸å¿…è¦çš„æƒé™æ£€æŸ¥é‡å¤è®¡ç®—

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç”¨æˆ·æƒé™æ›´æ–°åæ²¡æœ‰ç«‹å³ç”Ÿæ•ˆï¼Ÿ

A: éœ€è¦ç”¨æˆ·é‡æ–°ç™»å½•ï¼Œæˆ–è€…è°ƒç”¨`refreshPermissions()`åˆ·æ–°æƒé™ã€‚

### Q2: å¦‚ä½•ç»™å•ä¸ªç”¨æˆ·ç‰¹æ®Šæƒé™ï¼Ÿ

A: ä½¿ç”¨`admin_users.custom_permissions`å­—æ®µï¼Œæ·»åŠ ç”¨æˆ·çº§åˆ«çš„æƒé™ä»£ç æ•°ç»„ã€‚

### Q3: ç³»ç»Ÿè§’è‰²èƒ½ä¿®æ”¹å—ï¼Ÿ

A: ç³»ç»Ÿè§’è‰²ï¼ˆis_system=trueï¼‰ä¸èƒ½åˆ é™¤ï¼Œä½†å¯ä»¥ä¿®æ”¹æè¿°ã€‚æƒé™åˆ†é…å¯ä»¥è°ƒæ•´ã€‚

### Q4: å®¡è®¡æ—¥å¿—ä¼šæ— é™å¢é•¿å—ï¼Ÿ

A: å»ºè®®å®šæœŸå½’æ¡£æˆ–æ¸…ç†è¶…è¿‡6ä¸ªæœˆçš„å®¡è®¡æ—¥å¿—ã€‚

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v3.3.0 (2025-11-12)
- âœ¨ é¦–æ¬¡å‘å¸ƒRBACç³»ç»Ÿ
- ğŸ” å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶
- ğŸ‘¥ æ”¯æŒè§’è‰²ç»§æ‰¿
- ğŸ“Š å®Œæ•´çš„å®¡è®¡æ—¥å¿—
- ğŸ¯ å‰ç«¯åŠ¨æ€æƒé™é›†æˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-12  
**ç»´æŠ¤è€…**: AIcoin Team

