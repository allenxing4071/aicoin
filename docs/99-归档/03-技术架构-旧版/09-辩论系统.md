# 辩论系统 (Debate System)

## 概述

辩论系统是 AIcoin v3.4 引入的多智能体决策增强机制，借鉴 TradingAgents 的成熟方案，通过多空分析师的对抗性辩论，提升决策质量和风险识别能力。

## 核心特性

### 1. 多智能体架构

```
┌─────────────────────────────────────────────────────────┐
│                    辩论协调器                            │
│               (DebateCoordinator)                       │
└─────────────────────────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
    ┌─────▼─────┐   ┌────▼────┐   ┌─────▼─────┐
    │ Bull      │   │ Bear    │   │ Research  │
    │ Analyst   │   │ Analyst │   │ Manager   │
    │ (多头)     │   │ (空头)   │   │ (经理)     │
    └───────────┘   └─────────┘   └───────────┘
          │               │               │
          └───────────────┼───────────────┘
                          │
                    ┌─────▼─────┐
                    │  记忆系统  │
                    │ (Qdrant)  │
                    └───────────┘
```

### 2. 辩论流程

1. **触发条件检查**
   - 仓位金额 ≥ $1000（可配置）
   - 权限等级 ≥ L3（可配置）
   - 限流检查（每日/每小时）

2. **多空辩论**
   - Round 1: Bull Analyst → Bear Analyst
   - Round 2: Bull Analyst → Bear Analyst（可选）
   - ...（最多 3 轮，可配置）

3. **综合判断**
   - Research Manager 综合双方论点
   - 生成最终推荐（BUY/SELL/HOLD）
   - 计算置信度和共识度

4. **结果集成**
   - 辩论结果注入决策 Prompt
   - 最终决策由 DecisionEngineV2 做出
   - 记录辩论历史到数据库

### 3. 记忆系统

使用 Qdrant 向量数据库存储历史辩论经验：

- **Bull Memory**: 多头分析师的历史论点和结果
- **Bear Memory**: 空头分析师的历史论点和结果
- **Manager Memory**: 研究经理的历史决策和结果

每次辩论时，系统会检索相似的历史情况，帮助分析师从过去的经验中学习。

## 技术实现

### 1. 核心组件

#### 1.1 辩论系统 (`debate_system.py`)

```python
class BullAnalyst:
    """多头分析师 - 强调增长潜力和积极因素"""
    async def analyze(market_data, intelligence_report, 
                     debate_state, past_memories)

class BearAnalyst:
    """空头分析师 - 强调风险和负面因素"""
    async def analyze(market_data, intelligence_report,
                     debate_state, past_memories)

class ResearchManager:
    """研究经理 - 综合辩论结果"""
    async def summarize_debate(debate_state, market_data,
                              intelligence_report)

class DebateCoordinator:
    """辩论协调器 - 流程控制"""
    async def conduct_debate(market_data, intelligence_report)
```

#### 1.2 记忆系统 (`debate_memory.py`)

```python
class DebateMemory:
    """单个记忆集合"""
    def add_memory(situation, recommendation)
    def search_memories(query, limit=2)

class DebateMemoryManager:
    """管理多个角色的记忆"""
    bull_memory: DebateMemory
    bear_memory: DebateMemory
    manager_memory: DebateMemory
```

#### 1.3 配置管理 (`debate_config.py`)

```python
class DebateConfigManager:
    """辩论配置管理"""
    async def is_debate_enabled() -> bool
    async def should_trigger_debate(account_state) -> bool
    async def get_max_debate_rounds() -> int
```

#### 1.4 限流保护 (`debate_rate_limiter.py`)

```python
class DebateRateLimiter:
    """防止 API 成本失控"""
    async def check_rate_limit() -> (bool, str)
    async def increment_count()
```

### 2. 数据库设计

#### 2.1 辩论历史表 (`debate_history`)

```sql
CREATE TABLE debate_history (
    id SERIAL PRIMARY KEY,
    decision_id VARCHAR(100) UNIQUE NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    debate_rounds INTEGER DEFAULT 1,
    bull_arguments TEXT,
    bear_arguments TEXT,
    debate_full_history TEXT,
    final_recommendation VARCHAR(20),
    confidence FLOAT,
    consensus_level FLOAT,
    debate_duration_seconds INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_debate_symbol_created ON debate_history(symbol, created_at);
CREATE INDEX idx_debate_recommendation ON debate_history(final_recommendation);
```

#### 2.2 辩论配置表 (`debate_config`)

```sql
CREATE TABLE debate_config (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    description TEXT,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 2.3 辩论统计表 (`debate_statistics`)

```sql
CREATE TABLE debate_statistics (
    id SERIAL PRIMARY KEY,
    date TIMESTAMP WITH TIME ZONE UNIQUE NOT NULL,
    total_debates INTEGER DEFAULT 0,
    bull_wins INTEGER DEFAULT 0,
    bear_wins INTEGER DEFAULT 0,
    holds INTEGER DEFAULT 0,
    avg_consensus FLOAT,
    avg_confidence FLOAT,
    avg_duration FLOAT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3. API 接口

```
GET    /api/v1/debate/history          # 获取辩论历史列表
GET    /api/v1/debate/history/{id}     # 获取辩论详情
GET    /api/v1/debate/config            # 获取辩论配置
PUT    /api/v1/debate/config/{key}     # 更新辩论配置
GET    /api/v1/debate/statistics        # 获取辩论统计
POST   /api/v1/debate/trigger           # 手动触发辩论（测试用）
GET    /api/v1/debate/memory/stats      # 获取记忆统计
DELETE /api/v1/debate/memory            # 清空辩论记忆
GET    /api/v1/debate/rate-limit        # 获取限流状态
POST   /api/v1/debate/rate-limit/reset  # 重置限流计数
```

### 4. 前端管理界面

- **辩论历史** (`/admin/debate`): 查看历史辩论记录
- **辩论配置** (`/admin/debate/config`): 配置辩论参数
- **辩论统计** (`/admin/debate/statistics`): 查看统计数据和趋势
- **记忆管理** (`/admin/debate/memory`): 管理辩论记忆和限流

## 配置说明

### 默认配置

```python
{
    "debate_enabled": "true",           # 是否启用辩论
    "max_debate_rounds": "1",           # 最大辩论轮次（1-3）
    "min_position_size": "1000",        # 最小仓位（USD）
    "min_permission_level": "L3",       # 最低权限等级
    "debate_timeout_seconds": "60",     # 超时时间（秒）
    "use_memory": "true",               # 是否使用历史记忆
    "daily_limit": "100",               # 每日最大辩论次数
    "hourly_limit": "10"                # 每小时最大辩论次数
}
```

### 触发条件

辩论系统在以下条件**同时满足**时触发：

1. ✅ 辩论功能已启用 (`debate_enabled = true`)
2. ✅ 仓位金额 ≥ 最小仓位 (`position_size >= min_position_size`)
3. ✅ 权限等级 ≥ 最低等级 (`permission_level >= min_permission_level`)
4. ✅ 未达到限流限制（每日/每小时）

### 成本控制

- **条件触发**: 仅对重要交易启用辩论
- **限流保护**: 严格的每日/每小时限制
- **超时保护**: 60 秒超时，防止长时间等待
- **错误容错**: 辩论失败不影响决策流程

## 性能指标

### 预期提升

- **决策质量**: 提升 15-20%
- **风险识别**: 提升 50%
- **平均延迟**: < 15 秒
- **月度成本**: < $2
- **ROI**: > 10,000%

### 监控指标

- **辩论次数**: 每日/每周辩论次数
- **共识度**: 平均共识度趋势
- **置信度**: 平均置信度趋势
- **辩论时长**: 平均辩论时长分布
- **推荐分布**: Bull/Bear/Hold 比例

## 使用指南

### 1. 启用辩论系统

1. 登录管理后台
2. 导航到 **辩论系统 → 辩论配置**
3. 开启"启用辩论机制"开关
4. 根据需要调整触发条件和限流参数

### 2. 查看辩论历史

1. 导航到 **辩论系统 → 辩论历史**
2. 使用筛选器按币种或推荐结果筛选
3. 点击"查看详情"查看完整辩论过程

### 3. 分析辩论统计

1. 导航到 **辩论系统 → 辩论统计**
2. 选择时间范围（7/14/30/90天）
3. 查看推荐分布、共识度趋势、辩论时长等指标

### 4. 管理记忆系统

1. 导航到 **辩论系统 → 记忆管理**
2. 查看各角色的记忆数量
3. 查看限流状态
4. 必要时清空记忆或重置限流

## 最佳实践

### 1. 配置建议

- **新系统**: 从保守配置开始（L3, $1000, 1轮）
- **成熟系统**: 逐步放宽条件（L2, $500, 2轮）
- **高频交易**: 提高限流限制（每日 200 次）

### 2. 监控建议

- 每日检查辩论统计
- 关注共识度趋势（< 0.5 说明市场分歧大）
- 监控辩论时长（> 30 秒需优化）
- 定期审查辩论历史，学习经验

### 3. 成本优化

- 仅对重要交易启用辩论
- 根据市场活跃度调整限流
- 定期清理无用记忆
- 监控 API 调用次数

## 故障排查

### 问题 1: 辩论未触发

**可能原因**:
- 辩论功能未启用
- 仓位金额不足
- 权限等级不够
- 达到限流限制

**解决方案**:
1. 检查辩论配置
2. 查看限流状态
3. 查看系统日志

### 问题 2: 辩论超时

**可能原因**:
- LLM 响应慢
- 网络延迟
- 超时时间设置过短

**解决方案**:
1. 增加超时时间（60 → 90 秒）
2. 检查 LLM API 状态
3. 减少辩论轮次

### 问题 3: 记忆检索失败

**可能原因**:
- Qdrant 服务未运行
- 记忆集合不存在
- Embedding 服务异常

**解决方案**:
1. 检查 Qdrant 服务状态
2. 重启 Qdrant 服务
3. 检查 Embedding API 配置

## 技术细节

### Prompt 模板

辩论系统使用 TradingAgents 验证过的 Prompt 模板：

- **Bull Analyst**: 强调增长潜力、竞争优势、积极指标
- **Bear Analyst**: 强调风险、挑战、负面指标
- **Research Manager**: 综合双方论点，做出明确决策

### 错误处理

```python
try:
    debate_result = await conduct_debate(...)
except DebateTimeoutError:
    logger.warning("辩论超时，跳过")
    debate_result = None
except DebateLimitExceededError:
    logger.warning("达到限流，跳过")
    debate_result = None
except Exception as e:
    logger.error(f"辩论异常: {e}")
    debate_result = None

# 确保即使辩论失败，决策流程也能继续
```

### JSON 解析容错

```python
def safe_parse_json(response: str) -> Dict:
    try:
        return json.loads(response)
    except:
        # 尝试提取 JSON 代码块
        match = re.search(r'```json\s*(.*?)\s*```', response, re.DOTALL)
        if match:
            return json.loads(match.group(1))
        # 返回默认值
        return {"recommendation": "HOLD", "confidence": 0.5}
```

## 版本历史

### v3.4.0 (2025-11-14)

- ✨ 新增多空辩论机制
- ✨ 集成 Qdrant 记忆系统
- ✨ 完整的前端管理界面
- ✨ 配置管理和限流保护
- ✨ 辩论历史和统计分析

## 参考资料

- [TradingAgents 项目](https://github.com/TauricResearch/TradingAgents)
- [系统架构设计](./00-系统架构设计.md)
- [智能约束框架](./01-智能约束框架.md)
- [记忆学习系统](./02-记忆学习系统.md)

