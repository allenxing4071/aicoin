# Promptç³»ç»Ÿ v4.0 - ä»£ç æ¸…ç†è®¡åˆ’

## ğŸ” å†—ä½™ä»£ç è¯†åˆ«

ç»è¿‡å…¨é¢æ£€æŸ¥ï¼Œå‘ç°ä»¥ä¸‹å†—ä½™å’Œæ— ç”¨æ¨¡å—ï¼š

---

## âŒ éœ€è¦åˆ é™¤çš„æ–‡ä»¶ï¼ˆå…±3ä¸ªï¼‰

### 1. **æ—§ç‰ˆPromptManagerï¼ˆæ–‡ä»¶ç‰ˆï¼‰** - å·²è¢«æ•°æ®åº“ç‰ˆå–ä»£
```
ğŸ“ backend/app/services/decision/prompt_manager.py
```

**åŸå› ï¼š**
- å·²è¢« `prompt_manager_db.py` å®Œå…¨å–ä»£
- æ–°ç³»ç»Ÿä½¿ç”¨æ•°æ®åº“å­˜å‚¨ï¼Œä¸å†ä½¿ç”¨ `.txt` æ–‡ä»¶
- ä¿ç•™ä¼šé€ æˆæ··æ·†

**å½±å“è¯„ä¼°ï¼š** âš ï¸ ä¸­ç­‰
- éœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ä»£ç å¼•ç”¨
- éœ€è¦æ›´æ–°å¯¼å…¥è¯­å¥

---

### 2. **æ—§ç‰ˆPromptTemplatesï¼ˆç¡¬ç¼–ç ç‰ˆï¼‰** - å·²è¢«æ¨¡æ¿ç³»ç»Ÿå–ä»£
```
ğŸ“ backend/app/services/decision/prompt_templates.py
```

**åŸå› ï¼š**
- æ–‡ä»¶æ³¨é‡Šå·²è¯´æ˜"ä¿ç•™ä½œä¸ºfallback"
- æ–°ç³»ç»Ÿä½¿ç”¨æ•°æ®åº“ + PromptManagerï¼Œä¸éœ€è¦fallback
- åŒ…å«å¤§é‡ç¡¬ç¼–ç çš„Promptï¼ˆ600+è¡Œï¼‰ï¼Œå·²è¿‡æ—¶

**å½±å“è¯„ä¼°ï¼š** âš ï¸ ä¸­ç­‰
- éœ€è¦æ£€æŸ¥ `decision_engine_v2.py` æ˜¯å¦å¼•ç”¨
- éœ€è¦ç¡®è®¤æ— å…¶ä»–æ¨¡å—ä¾èµ–

---

### 3. **æ–‡ä»¶ç›‘æ§å™¨ï¼ˆwatchdogç‰ˆï¼‰** - å·²è¢«Redis pub/subå–ä»£
```
ğŸ“ backend/app/services/decision/prompt_watcher.py
```

**åŸå› ï¼š**
- ä½¿ç”¨ `watchdog` åº“ç›‘æ§ `.txt` æ–‡ä»¶å˜åŒ–
- æ–°ç³»ç»Ÿä½¿ç”¨ Redis pub/sub çƒ­é‡è½½ï¼Œä¸éœ€è¦æ–‡ä»¶ç›‘æ§
- ä¾èµ–å¤–éƒ¨åº“ `watchdog`ï¼Œå¯ä»¥ç§»é™¤ä¾èµ–

**å½±å“è¯„ä¼°ï¼š** âœ… ä½
- ç‹¬ç«‹æ¨¡å—ï¼Œæ— å…¶ä»–ä¾èµ–
- å¯ä»¥å®‰å…¨åˆ é™¤

---

## âš ï¸ éœ€è¦æ£€æŸ¥çš„æ½œåœ¨å†—ä½™

### 4. **DecisionEngineV2é›†æˆç¤ºä¾‹** - å¯èƒ½æ˜¯ä¸´æ—¶æ–‡ä»¶
```
ğŸ“ backend/app/services/decision/decision_engine_v2_integration_example.py
```

**çŠ¶æ€ï¼š** ğŸ¤” å¾…ç¡®è®¤
- æ–‡ä»¶ååŒ…å« `_example`ï¼Œå¯èƒ½æ˜¯ç¤ºä¾‹ä»£ç 
- å¦‚æœ `decision_engine_v2.py` å·²é›†æˆï¼Œå¯ä»¥åˆ é™¤

**å»ºè®®ï¼š**
- å¦‚æœæ˜¯ç¤ºä¾‹ä»£ç ï¼Œç§»åŠ¨åˆ° `docs/examples/` æˆ– `tests/`
- å¦‚æœæ˜¯å®é™…ä½¿ç”¨çš„ä»£ç ï¼Œé‡å‘½åå»æ‰ `_example` åç¼€

---

## ğŸ“Š æ¸…ç†ç»Ÿè®¡

| ç±»å‹ | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° | ä¼˜å…ˆçº§ |
|------|--------|----------|--------|
| å¿…é¡»åˆ é™¤ | 3 | ~1000è¡Œ | é«˜ |
| å¾…ç¡®è®¤ | 1 | ~200è¡Œ | ä¸­ |
| **æ€»è®¡** | **4** | **~1200è¡Œ** | - |

---

## ğŸ› ï¸ æ¸…ç†æ­¥éª¤

### Step 1: ä¾èµ–æ£€æŸ¥

```bash
# æ£€æŸ¥æ—§ç‰ˆPromptManagerçš„å¼•ç”¨
cd backend
grep -r "from app.services.decision.prompt_manager import" --include="*.py"
grep -r "import prompt_manager" --include="*.py"

# æ£€æŸ¥PromptTemplatesçš„å¼•ç”¨
grep -r "from app.services.decision.prompt_templates import" --include="*.py"
grep -r "PromptTemplates" --include="*.py"

# æ£€æŸ¥PromptWatcherçš„å¼•ç”¨
grep -r "from app.services.decision.prompt_watcher import" --include="*.py"
grep -r "PromptFileHandler" --include="*.py"
```

### Step 2: æ›´æ–°å¯¼å…¥è¯­å¥

å¦‚æœå‘ç°å¼•ç”¨ï¼Œéœ€è¦æ›´æ–°ä¸ºæ–°çš„å¯¼å…¥ï¼š

```python
# âŒ æ—§ç‰ˆï¼ˆåˆ é™¤ï¼‰
from app.services.decision.prompt_manager import PromptManager, get_global_prompt_manager

# âœ… æ–°ç‰ˆï¼ˆä½¿ç”¨ï¼‰
from app.services.decision.prompt_manager_db import PromptManagerDB, get_global_prompt_manager_db
```

### Step 3: æ‰§è¡Œåˆ é™¤

```bash
cd /Users/xinghailong/Documents/soft/AIcoin/backend

# å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
mkdir -p ../backups/deprecated_code
cp app/services/decision/prompt_manager.py ../backups/deprecated_code/
cp app/services/decision/prompt_templates.py ../backups/deprecated_code/
cp app/services/decision/prompt_watcher.py ../backups/deprecated_code/

# åˆ é™¤æ–‡ä»¶
rm app/services/decision/prompt_manager.py
rm app/services/decision/prompt_templates.py
rm app/services/decision/prompt_watcher.py

# Gitæäº¤
git add -A
git commit -m "refactor: æ¸…ç†å†—ä½™ä»£ç  - åˆ é™¤æ—§ç‰ˆPromptç®¡ç†å™¨å’Œæ–‡ä»¶ç›‘æ§å™¨

- åˆ é™¤ prompt_manager.pyï¼ˆå·²è¢«prompt_manager_db.pyå–ä»£ï¼‰
- åˆ é™¤ prompt_templates.pyï¼ˆç¡¬ç¼–ç ç‰ˆæœ¬ï¼Œå·²è¿‡æ—¶ï¼‰
- åˆ é™¤ prompt_watcher.pyï¼ˆwatchdogæ–‡ä»¶ç›‘æ§ï¼Œå·²è¢«Redis pub/subå–ä»£ï¼‰

å‡å°‘ä»£ç é‡ï¼š~1000è¡Œ
"
```

### Step 4: éªŒè¯ç³»ç»Ÿæ­£å¸¸

```bash
# 1. è¿è¡Œæµ‹è¯•
pytest tests/

# 2. å¯åŠ¨æœåŠ¡
uvicorn app.main:app --reload

# 3. éªŒè¯API
curl http://localhost:8000/api/prompts/v2/

# 4. éªŒè¯çƒ­é‡è½½
curl -X POST http://localhost:8000/api/prompts/v2/reload
```

---

## ğŸ“ æ¸…ç†åçš„ç›®å½•ç»“æ„

```
backend/app/services/decision/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ debate_config.py
â”œâ”€â”€ debate_memory.py
â”œâ”€â”€ debate_rate_limiter.py
â”œâ”€â”€ debate_system.py
â”œâ”€â”€ decision_engine_v2.py                    # âœ… ä¿ç•™
â”œâ”€â”€ decision_engine_v2_integration_example.py # ğŸ¤” å¾…ç¡®è®¤
â”œâ”€â”€ model_clients.py
â”œâ”€â”€ prompt_manager_db.py                     # âœ… æ–°ç‰ˆï¼ˆä¿ç•™ï¼‰
â”œâ”€â”€ prompt_redis_subscriber.py               # âœ… æ–°ç‰ˆï¼ˆä¿ç•™ï¼‰
â””â”€â”€ smart_router.py
```

---

## âš¡ æ¸…ç†æ”¶ç›Š

### 1. **ä»£ç ç®€æ´æ€§**
- å‡å°‘ ~1000 è¡Œå†—ä½™ä»£ç 
- é™ä½ç»´æŠ¤æˆæœ¬
- æé«˜ä»£ç å¯è¯»æ€§

### 2. **é¿å…æ··æ·†**
- åªä¿ç•™ä¸€ä¸ªPromptManagerå®ç°
- æ¸…æ™°çš„æ¶æ„ï¼šæ•°æ®åº“ç‰ˆ + Redisçƒ­é‡è½½
- å‡å°‘å¼€å‘è€…å›°æƒ‘

### 3. **ä¾èµ–ä¼˜åŒ–**
- ç§»é™¤ `watchdog` ä¾èµ–ï¼ˆå¦‚æœæ²¡æœ‰å…¶ä»–ç”¨é€”ï¼‰
- å‡å°‘ `requirements.txt` ä½“ç§¯

### 4. **æ€§èƒ½æå‡**
- å‡å°‘æ¨¡å—åŠ è½½æ—¶é—´
- é™ä½å†…å­˜å ç”¨

---

## ğŸš¨ é£é™©æç¤º

### åˆ é™¤å‰å¿…é¡»ç¡®è®¤ï¼š

1. âœ… **æ— å…¶ä»–æ¨¡å—å¼•ç”¨æ—§ç‰ˆä»£ç **
   ```bash
   # è¿è¡Œä¾èµ–æ£€æŸ¥ï¼ˆStep 1ï¼‰
   ```

2. âœ… **æ–°ç‰ˆåŠŸèƒ½å·²å®Œå…¨è¦†ç›–æ—§ç‰ˆ**
   - PromptManagerDB æ”¯æŒæ‰€æœ‰æ—§ç‰ˆåŠŸèƒ½
   - Redis pub/sub æ›¿ä»£æ–‡ä»¶ç›‘æ§
   - æ•°æ®åº“å­˜å‚¨æ›¿ä»£ .txt æ–‡ä»¶

3. âœ… **å·²å¤‡ä»½æ—§ä»£ç **ï¼ˆå¯é€‰ï¼‰
   ```bash
   # å¤‡ä»½åˆ° backups/ ç›®å½•
   ```

4. âœ… **æµ‹è¯•é€šè¿‡**
   ```bash
   # åˆ é™¤åè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
   pytest tests/
   ```

---

## ğŸ“… æ‰§è¡Œæ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº |
|------|------|----------|--------|
| 1 | ä¾èµ–æ£€æŸ¥ | 15åˆ†é’Ÿ | å¼€å‘è€… |
| 2 | æ›´æ–°å¯¼å…¥ | 30åˆ†é’Ÿ | å¼€å‘è€… |
| 3 | æ‰§è¡Œåˆ é™¤ | 10åˆ†é’Ÿ | å¼€å‘è€… |
| 4 | æµ‹è¯•éªŒè¯ | 30åˆ†é’Ÿ | QA |
| **æ€»è®¡** | - | **~1.5å°æ—¶** | - |

---

## âœ… æ£€æŸ¥æ¸…å•

åˆ é™¤å‰ç¡®è®¤ï¼š

- [ ] è¿è¡Œä¾èµ–æ£€æŸ¥è„šæœ¬
- [ ] ç¡®è®¤æ— å…¶ä»–æ¨¡å—å¼•ç”¨
- [ ] æ›´æ–°æ‰€æœ‰å¯¼å…¥è¯­å¥
- [ ] å¤‡ä»½æ—§ä»£ç ï¼ˆå¯é€‰ï¼‰
- [ ] æ‰§è¡Œåˆ é™¤æ“ä½œ
- [ ] Gitæäº¤
- [ ] è¿è¡Œæµ‹è¯•å¥—ä»¶
- [ ] éªŒè¯APIæ­£å¸¸
- [ ] éªŒè¯çƒ­é‡è½½åŠŸèƒ½
- [ ] æ›´æ–°æ–‡æ¡£ï¼ˆå¦‚æœ‰å¼•ç”¨ï¼‰

---

## ğŸ’¡ å»ºè®®

### ç«‹å³æ‰§è¡Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼š
1. âœ… åˆ é™¤ `prompt_watcher.py`ï¼ˆæ— ä¾èµ–ï¼Œå®‰å…¨ï¼‰
2. âš ï¸ æ£€æŸ¥å¹¶åˆ é™¤ `prompt_manager.py`
3. âš ï¸ æ£€æŸ¥å¹¶åˆ é™¤ `prompt_templates.py`

### å»¶åå¤„ç†ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï¼š
4. ğŸ¤” ç¡®è®¤ `decision_engine_v2_integration_example.py` ç”¨é€”
5. ğŸ“ æ›´æ–°ç›¸å…³æ–‡æ¡£

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒï¼š
- æ–°ç³»ç»Ÿæ–‡æ¡£ï¼š`docs/10-ç‰ˆæœ¬æ›´æ–°/v4.0_Promptæ¨¡æ¿ç³»ç»Ÿå¼€å‘è¿›åº¦.md`
- éƒ¨ç½²æŒ‡å—ï¼š`docs/10-ç‰ˆæœ¬æ›´æ–°/v4.0_Promptç³»ç»Ÿéƒ¨ç½²æŒ‡å—.md`
- Gitå†å²ï¼šæŸ¥çœ‹æäº¤è®°å½•äº†è§£æ–°æ—§ç‰ˆæœ¬å·®å¼‚

