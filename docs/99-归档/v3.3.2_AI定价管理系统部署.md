# v3.3.2 AI定价管理系统 - 部署说明

## 📦 更新内容

### 1. 核心功能

**统一定价管理系统**:
- ✅ 创建了 `backend/app/services/ai_pricing.py` 定价管理器
- ✅ 各平台最新价格表（2025-11-13 更新）
- ✅ 自动成本计算（替换旧的估算逻辑）
- ✅ 支持缓存价格（DeepSeek）

**API 接口**:
- `GET /api/v1/ai-pricing/pricing-table` - 获取完整价格表
- `GET /api/v1/ai-pricing/model-info/{provider}/{model}` - 获取模型信息
- `POST /api/v1/ai-pricing/calculate-cost` - 计算成本
- `POST /api/v1/ai-pricing/update-price` - 更新价格（需管理员权限）
- `GET /api/v1/ai-pricing/compare-platforms` - 平台成本对比

**前端页面**:
- 新增 `/admin/ai-pricing` 价格表管理页面
- 实时价格查看
- 平台成本对比
- 支持自定义 token 数量对比

### 2. 价格覆盖范围

| 平台 | 模型 | 输入价格 | 输出价格 | 备注 |
|------|------|----------|----------|------|
| 阿里云 | qwen-plus | ¥0.004/1K | ¥0.012/1K | 高性能 |
| 阿里云 | qwen-turbo | ¥0.002/1K | ¥0.006/1K | 快速响应 |
| 阿里云 | qwen-max | ¥0.040/1K | ¥0.120/1K | 最强性能 |
| DeepSeek | deepseek-chat | ¥0.001/1K | ¥0.002/1K | 性价比之王 |
| DeepSeek | deepseek-chat (缓存) | ¥0.0001/1K | - | 缓存命中 |
| 百度云 | qwen-plus | ¥0.008/1K | ¥0.016/1K | - |
| 腾讯云 | qwen-plus | ¥0.008/1K | ¥0.016/1K | - |
| 火山引擎 | qwen-plus | ¥0.008/1K | ¥0.016/1K | - |
| OpenAI | gpt-3.5-turbo | ¥0.0035/1K | ¥0.0105/1K | - |
| OpenAI | gpt-4 | ¥0.210/1K | ¥0.420/1K | - |

### 3. 代码变更

**后端**:
```
backend/app/services/ai_pricing.py                    [新增] 定价管理器
backend/app/api/v1/ai_pricing.py                      [新增] API接口
backend/app/main.py                                   [修改] 注册路由
backend/app/services/intelligence/platforms/
  ├── qwen_deep_adapter.py                            [修改] 使用统一定价
  └── qwen_search_adapter.py                          [修改] 使用统一定价
```

**前端**:
```
frontend/app/admin/ai-pricing/page.tsx                [新增] 价格管理页面
frontend/app/admin/layout.tsx                         [修改] 添加菜单项
```

## 🚀 部署步骤

### 方式一：服务器手动部署

```bash
# 1. SSH 登录服务器
ssh root@jifenpay.cc

# 2. 进入项目目录
cd /root/aicoin

# 3. 拉取最新代码
git pull origin main

# 4. 重启服务
docker-compose restart backend frontend

# 5. 查看日志
docker-compose logs -f backend
```

### 方式二：Git 自动部署

如果配置了 Git Hooks:

```bash
# 本地推送后自动触发
git push origin main
```

## ✅ 验证部署

### 1. 检查后端 API

```bash
# 测试价格表 API
curl https://jifenpay.cc/api/v1/ai-pricing/pricing-table

# 预期返回:
{
  "success": true,
  "data": {
    "pricing_table": { ... },
    "currency": "CNY",
    "unit": "元/1K tokens"
  }
}
```

### 2. 检查前端页面

访问: https://jifenpay.cc/admin/ai-pricing

**预期看到**:
- ✅ 价格表概览（按平台分组）
- ✅ 平台成本对比表
- ✅ Token 数量输入框
- ✅ 实时成本计算

### 3. 检查菜单

在管理后台左侧菜单:
```
AI平台管理
  └── 成本管理
      ├── 实时监控
      ├── 价格表管理  ← 新增
      ├── 预算设置
      └── 决策间隔优化
```

## 📊 使用说明

### 查看价格表

1. 登录管理后台
2. 导航到 `AI平台管理 > 成本管理 > 价格表管理`
3. 查看各平台最新价格

### 对比平台成本

1. 在价格表管理页面下方
2. 输入预期的输入/输出 token 数量
3. 点击"重新计算"
4. 查看各平台成本排名

### API 调用示例

**计算成本**:
```bash
curl -X POST https://jifenpay.cc/api/v1/ai-pricing/calculate-cost \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "deepseek",
    "model": "deepseek-chat",
    "input_tokens": 1000,
    "output_tokens": 500
  }'
```

**对比平台**:
```bash
curl "https://jifenpay.cc/api/v1/ai-pricing/compare-platforms?input_tokens=1000&output_tokens=1000"
```

## 🔧 配置说明

### 更新价格（需管理员权限）

```bash
curl -X POST https://jifenpay.cc/api/v1/ai-pricing/update-price \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "provider": "qwen",
    "model": "qwen-plus",
    "input_price": 0.005,
    "output_price": 0.015
  }'
```

### 价格表维护

价格表位于 `backend/app/services/ai_pricing.py` 的 `PRICING_TABLE` 字典。

**更新步骤**:
1. 修改 `PRICING_TABLE`
2. 更新 `last_updated` 字段
3. 提交并部署

## 📈 效果对比

### 部署前

```
AI成本: ¥3.65
├── 数据来源: 内部估算
├── 价格表: 固定汇率转换
└── 准确性: ⚠️ 可能不准
```

### 部署后

```
AI成本: ¥3.65
├── 数据来源: 统一定价管理器
├── 价格表: 2025-11-13 最新官方价格
├── 准确性: ✅ 更准确
└── 可维护性: ✅ 集中管理，易于更新
```

## 🎯 下一步计划

### 短期（本周）
- [ ] 验证价格表准确性
- [ ] 对比实际云平台账单
- [ ] 调整不准确的价格

### 中期（下周）
- [ ] 添加价格历史记录
- [ ] 实现价格变动通知
- [ ] 添加手动账单校准功能

### 长期（下月）
- [ ] 集成云平台账单 API
- [ ] 自动同步真实账单
- [ ] 成本预测和预警

## ⚠️ 注意事项

1. **价格准确性**:
   - 当前价格为 2025-11-13 更新
   - 实际账单以云平台为准
   - 建议定期核对并更新

2. **缓存价格**:
   - DeepSeek 支持缓存
   - 缓存命中时成本降低 10 倍
   - 其他平台暂不支持

3. **汇率影响**:
   - OpenAI 价格已按 ¥7.0 汇率转换
   - 汇率波动可能影响实际成本

4. **折扣和套餐**:
   - 当前价格为标准价格
   - 不包含企业折扣
   - 不包含预付费套餐优惠

## 📞 问题反馈

如遇到问题:
1. 检查后端日志: `docker-compose logs -f backend`
2. 检查前端控制台
3. 验证 API 返回数据
4. 联系开发团队

## 📝 相关文档

- [云平台账单同步说明](./云平台账单同步说明.md)
- [v3.3.1 云平台账单同步功能](./v3.3.1_云平台账单同步功能.md)
- [Git 自动化部署指南](./10-Git自动化部署指南.md)

