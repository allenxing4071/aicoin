# 交易所配置指南

> **版本**: v3.1  
> **适用环境**: 开发/生产  
> **更新时间**: 2025-11-05

## 概述

本指南介绍如何配置和部署AIcoin v3.1的多交易所支持功能,包括Binance和Hyperliquid的API密钥配置、环境变量设置和数据库迁移。

## 前置条件

- ✅ Docker环境已安装
- ✅ PostgreSQL数据库已运行 (端口5433)
- ✅ Python 3.10+ 环境
- ✅ 已安装项目依赖

---

## 一、环境变量配置

### 1. 创建配置文件

```bash
cd /path/to/AIcoin/backend
cp .env.example .env  # 如果有示例文件
# 或直接创建
touch .env
```

### 2. 基础配置

```bash
# backend/.env

# ====================================
# 数据库配置
# ====================================
DATABASE_URL=postgresql://aicoin:aicoin_secure_password_2024@localhost:5433/aicoin

# ====================================
# Redis配置
# ====================================
REDIS_URL=redis://localhost:6379

# ====================================
# Qdrant配置 (向量数据库)
# ====================================
QDRANT_HOST=localhost
QDRANT_PORT=6333
QDRANT_COLLECTION_NAME=trading_memories
```

### 3. Hyperliquid配置

```bash
# ====================================
# Hyperliquid交易所 (永续合约)
# ====================================
HYPERLIQUID_WALLET_ADDRESS=0xYourWalletAddress
HYPERLIQUID_PRIVATE_KEY=0xYourPrivateKey
HYPERLIQUID_VAULT_ADDRESS=0xYourVaultAddress  # 可选,用于Vault交易
HYPERLIQUID_TESTNET=false  # true=测试网, false=主网

# 风控参数
HYPERLIQUID_MAX_LEVERAGE=5
HYPERLIQUID_MAX_POSITION=0.25  # 25%最大仓位
```

**获取Hyperliquid凭证**:
1. 访问 [https://app.hyperliquid.xyz](https://app.hyperliquid.xyz)
2. 连接钱包
3. 导出钱包地址和私钥
4. ⚠️ **切勿泄露私钥!**

### 4. Binance配置

```bash
# ====================================
# Binance交易所 (现货 + 合约)
# ====================================
BINANCE_API_KEY=YourBinanceApiKey
BINANCE_API_SECRET=YourBinanceApiSecret
BINANCE_TESTNET=false  # true=测试网, false=主网

# 风控参数
BINANCE_MAX_LEVERAGE=3
BINANCE_MIN_NOTIONAL=10.0
BINANCE_MAX_POSITION_SPOT=0.15       # 现货15%最大仓位
BINANCE_MAX_POSITION_FUTURES=0.20    # 合约20%最大仓位
BINANCE_RATE_LIMIT_PER_MINUTE=1200
```

**获取Binance API密钥**:
1. 登录 [Binance](https://www.binance.com)
2. 账户设置 → API管理
3. 创建API密钥
4. 配置权限:
   - ✅ 读取信息
   - ✅ 现货交易 (如需)
   - ✅ 合约交易 (如需)
   - ❌ 提现 (不建议)
5. 绑定IP白名单 (推荐)

**测试网配置** (可选):
```bash
# Binance测试网
BINANCE_API_KEY=TestnetApiKey
BINANCE_API_SECRET=TestnetApiSecret
BINANCE_TESTNET=true
```

测试网地址: [https://testnet.binance.vision](https://testnet.binance.vision)

### 5. 交易所选择配置

```bash
# ====================================
# 交易所选择 (默认激活)
# ====================================
ACTIVE_EXCHANGE=hyperliquid  # hyperliquid | binance
ACTIVE_MARKET_TYPE=perpetual # spot | futures | perpetual

# K线周期配置
KLINE_INTERVALS=["1m", "5m", "15m", "1h", "4h", "1d"]
```

### 6. AI平台配置 (可选)

```bash
# ====================================
# AI平台API (情报系统)
# ====================================
DEEPSEEK_API_KEY=your_deepseek_key
QWEN_API_KEY=your_qwen_key
GROK_API_KEY=your_grok_key
CLAUDE_API_KEY=your_claude_key
OPENAI_API_KEY=your_openai_key
```

### 完整配置模板

```bash
# ====================================
# AIcoin v3.1 环境配置
# ====================================

# 数据库
DATABASE_URL=postgresql://aicoin:aicoin_secure_password_2024@localhost:5433/aicoin

# Redis
REDIS_URL=redis://localhost:6379

# Qdrant
QDRANT_HOST=localhost
QDRANT_PORT=6333

# Hyperliquid
HYPERLIQUID_WALLET_ADDRESS=0x...
HYPERLIQUID_PRIVATE_KEY=0x...
HYPERLIQUID_VAULT_ADDRESS=0x...  # 可选
HYPERLIQUID_TESTNET=false
HYPERLIQUID_MAX_LEVERAGE=5

# Binance
BINANCE_API_KEY=your_api_key
BINANCE_API_SECRET=your_api_secret
BINANCE_TESTNET=false
BINANCE_MAX_LEVERAGE=3

# 交易所选择
ACTIVE_EXCHANGE=hyperliquid
ACTIVE_MARKET_TYPE=perpetual

# AI平台 (可选)
DEEPSEEK_API_KEY=...
QWEN_API_KEY=...
```

---

## 二、数据库迁移

### 1. 检查数据库连接

```bash
cd backend

# 测试数据库连接
python3 -c "
import asyncio
from app.core.database import AsyncSessionLocal
async def test():
    async with AsyncSessionLocal() as db:
        print('✅ 数据库连接成功!')
asyncio.run(test())
"
```

### 2. 运行Alembic迁移

```bash
# 查看当前迁移状态
alembic current

# 查看待应用的迁移
alembic history

# 应用v3.1迁移 (010_add_exchange_support)
alembic upgrade head

# 验证迁移
alembic current
# 应该显示: 010 (head)
```

### 3. 验证数据库表

```bash
# 连接数据库
docker exec -it aicoin-postgres psql -U aicoin -d aicoin

# 检查exchange_configs表
\d exchange_configs

# 检查market_data_kline表的新字段
\d market_data_kline

# 退出
\q
```

**预期结果**:
```sql
-- exchange_configs表应包含:
id, name, display_name, is_active, market_type,
api_key_encrypted, api_secret_encrypted, testnet, 
config_json, created_at, updated_at

-- market_data_kline表应包含新字段:
exchange, market_type, funding_rate, open_interest
```

---

## 三、服务启动

### 1. 后端服务

```bash
cd backend

# 开发模式 (热重载)
python3 -m uvicorn app.main:app --reload --port 8000

# 生产模式
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

# 后台运行
nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /var/log/aicoin.log 2>&1 &
```

### 2. 前端服务

```bash
cd frontend

# 开发模式
npm run dev

# 生产构建
npm run build
npm run start
```

### 3. Docker Compose (推荐)

```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://aicoin:password@postgres:5432/aicoin
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - HYPERLIQUID_WALLET_ADDRESS=${HYPERLIQUID_WALLET_ADDRESS}
      - HYPERLIQUID_PRIVATE_KEY=${HYPERLIQUID_PRIVATE_KEY}
    depends_on:
      - postgres
    volumes:
      - ./backend:/app

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend

  postgres:
    image: postgres:15-alpine
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: aicoin
      POSTGRES_PASSWORD: aicoin_secure_password_2024
      POSTGRES_DB: aicoin
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f backend

# 停止服务
docker-compose down
```

---

## 四、配置验证

### 1. 健康检查

```bash
# 后端健康检查
curl http://localhost:8000/health

# 预期响应
{
  "status": "healthy",
  "app": "AIcoin Trading System",
  "version": "1.0.0"
}
```

### 2. 交易所配置检查

```bash
# 获取所有交易所配置
curl http://localhost:8000/api/v1/exchanges

# 获取当前激活的交易所
curl http://localhost:8000/api/v1/exchanges/active

# 预期响应
{
  "success": true,
  "data": {
    "name": "hyperliquid",
    "market_type": "perpetual",
    "is_initialized": true
  }
}
```

### 3. 切换交易所测试

```bash
# 切换到Binance现货
curl -X POST "http://localhost:8000/api/v1/exchanges/switch?exchange_name=binance&market_type=spot"

# 预期响应
{
  "success": true,
  "message": "成功切换到 binance (spot)"
}
```

---

## 五、常见问题

### 1. 数据库连接失败

**错误**: `Connection refused (port 5432)`

**解决**:
```bash
# 检查config.py中的端口配置
grep DATABASE_URL backend/app/core/config.py
# 应该是: localhost:5433

# 检查Docker容器
docker ps | grep postgres
# 确认端口映射: 0.0.0.0:5433->5432/tcp
```

### 2. Binance API密钥错误

**错误**: `ValueError: 币安API密钥未配置`

**解决**:
```bash
# 1. 检查.env文件
cat backend/.env | grep BINANCE_API_KEY

# 2. 确认环境变量已加载
python3 -c "from app.core.config import settings; print(settings.BINANCE_API_KEY)"

# 3. 重启后端服务
```

### 3. Hyperliquid连接失败

**错误**: `Hyperliquid钱包凭证未配置`

**解决**:
```bash
# 检查钱包地址和私钥格式
# 应该以0x开头

# 测试连接
python3 -c "
from hyperliquid.info import Info
info = Info()
print(info.user_state('YOUR_WALLET_ADDRESS'))
"
```

### 4. 迁移失败

**错误**: `alembic.util.exc.CommandError`

**解决**:
```bash
# 1. 检查数据库连接
alembic current

# 2. 如果卡住,强制标记为当前版本
alembic stamp head

# 3. 或者回滚后重新迁移
alembic downgrade -1
alembic upgrade head
```

---

## 六、安全建议

### 1. API密钥保护

```bash
# 使用环境变量,不要硬编码
export BINANCE_API_KEY="your_key"

# 使用密钥管理服务 (生产环境)
# - AWS Secrets Manager
# - HashiCorp Vault
# - Kubernetes Secrets
```

### 2. 权限最小化

```yaml
# Binance API权限设置
- ✅ 读取信息
- ✅ 现货交易 (仅需要时)
- ✅ 合约交易 (仅需要时)
- ❌ 提现 (禁用)
- ❌ 内部转账 (禁用)
```

### 3. IP白名单

```bash
# Binance API管理
# 限制只有服务器IP可以调用API
API Key → IP访问限制 → 添加IP
```

### 4. 私钥加密存储

```python
# backend/app/models/exchange_config.py
from cryptography.fernet import Fernet

class ExchangeConfig(Base):
    api_key_encrypted = Column(Text)
    
    @staticmethod
    def encrypt_api_key(api_key: str) -> str:
        key = settings.ENCRYPTION_KEY
        f = Fernet(key)
        return f.encrypt(api_key.encode()).decode()
    
    @staticmethod
    def decrypt_api_key(encrypted: str) -> str:
        key = settings.ENCRYPTION_KEY
        f = Fernet(key)
        return f.decrypt(encrypted.encode()).decode()
```

---

## 七、监控和日志

### 1. 日志配置

```python
# backend/app/core/logging.py
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/var/log/aicoin/app.log'),
        logging.StreamHandler()
    ]
)
```

### 2. 关键日志

```bash
# 查看交易所切换日志
tail -f /var/log/aicoin/app.log | grep "切换交易所"

# 查看API错误
tail -f /var/log/aicoin/app.log | grep "ERROR"
```

### 3. 性能监控

```bash
# 数据库连接池状态
curl http://localhost:8000/admin/db-stats

# API响应时间
curl -w "@curl-format.txt" http://localhost:8000/api/v1/exchanges
```

---

## 八、更新和维护

### 1. 升级到新版本

```bash
# 1. 备份数据库
docker exec aicoin-postgres pg_dump -U aicoin aicoin > backup_$(date +%Y%m%d).sql

# 2. 拉取新代码
git pull origin main

# 3. 安装新依赖
cd backend && pip install -r requirements.txt

# 4. 运行迁移
alembic upgrade head

# 5. 重启服务
docker-compose restart
```

### 2. 回滚操作

```bash
# 回滚数据库迁移
alembic downgrade -1

# 恢复数据库备份
docker exec -i aicoin-postgres psql -U aicoin aicoin < backup_20251105.sql
```

---

## 相关文档

- [技术架构 - 多交易所集成](../03-技术架构/07-多交易所集成架构.md)
- [API接口文档 - 交易所管理](../09-API接口文档/交易所管理API.md)
- [快速上手指南](../06-快速参考/v3.1快速上手指南.md)
- [主网操作指南](./主网操作指南.md)

---

## 更新记录

- **2025-11-05**: v3.1 初始版本
  - Binance和Hyperliquid配置说明
  - 数据库迁移指南
  - 安全建议和最佳实践

