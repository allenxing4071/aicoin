# 📋 AIcoin 日志管理系统

## 📊 系统概述

AIcoin 交易系统采用分级、分类的日志管理策略，支持：
- ✅ 多级别日志（DEBUG/INFO/WARNING/ERROR/CRITICAL）
- ✅ 多输出目标（控制台 + 文件）
- ✅ 自动日志轮转（按天/按大小）
- ✅ 专用日志分类（AI决策、交易、错误）
- ✅ 彩色控制台输出
- ✅ 第三方库日志过滤

---

## 📁 日志文件结构

```
backend/logs/
├── aicoin_all.log          # 所有日志（按天轮转，保留30天）
├── aicoin_all.log.2025-11-11
├── aicoin_all.log.2025-11-10
├── aicoin_error.log        # 错误日志（按大小轮转10MB，保留10个）
├── aicoin_error.log.1
├── ai_decisions.log        # AI决策日志（按天轮转，保留90天）
├── ai_decisions.log.2025-11-11
├── trading.log             # 交易日志（按天轮转，保留90天）
└── trading.log.2025-11-11
```

---

## 🎯 日志级别说明

| 级别 | 用途 | 示例 |
|------|------|------|
| **DEBUG** | 详细调试信息 | 函数参数、中间变量、API响应 |
| **INFO** | 关键操作记录 | 服务启动、决策完成、交易执行 |
| **WARNING** | 警告信息 | 配置缺失、API限流、数据异常 |
| **ERROR** | 错误信息 | 异常捕获、API失败、数据库错误 |
| **CRITICAL** | 严重错误 | 系统崩溃、数据丢失、安全问题 |

---

## ⚙️ 配置方式

### 1. 环境变量配置

**docker-compose.yml**:
```yaml
services:
  backend:
    environment:
      - LOG_LEVEL=INFO  # 可选: DEBUG, INFO, WARNING, ERROR, CRITICAL
```

**或 .env 文件**:
```bash
LOG_LEVEL=INFO
```

### 2. 不同环境的推荐配置

| 环境 | LOG_LEVEL | 说明 |
|------|-----------|------|
| **开发环境** | DEBUG | 查看所有细节，方便调试 |
| **测试环境** | INFO | 记录关键操作，减少噪音 |
| **生产环境** | INFO | 平衡性能和可观测性 |
| **问题排查** | DEBUG | 临时开启，排查完毕后关闭 |

---

## 🔍 日志查看命令

### 实时查看日志

```bash
# 查看所有日志
tail -f backend/logs/aicoin_all.log

# 查看错误日志
tail -f backend/logs/aicoin_error.log

# 查看AI决策日志
tail -f backend/logs/ai_decisions.log

# 查看交易日志
tail -f backend/logs/trading.log
```

### 搜索和过滤

```bash
# 搜索错误
grep "ERROR" backend/logs/aicoin_all.log

# 搜索特定关键词
grep "决策" backend/logs/ai_decisions.log

# 统计错误数量
grep -c "ERROR" backend/logs/aicoin_all.log

# 查看最近100行
tail -n 100 backend/logs/aicoin_all.log

# 查看特定时间段
grep "2025-11-12 06:" backend/logs/aicoin_all.log
```

### Docker 容器日志

```bash
# 查看容器实时日志
docker logs -f aicoin-backend

# 查看最近100行
docker logs --tail 100 aicoin-backend

# 查看特定时间段
docker logs --since "2025-11-12T06:00:00" aicoin-backend
```

---

## 🗑️ 日志清理

### 自动清理（推荐）

日志文件会自动轮转：
- **aicoin_all.log**: 每天午夜轮转，保留30天
- **aicoin_error.log**: 超过10MB轮转，保留10个文件
- **ai_decisions.log**: 每天午夜轮转，保留90天
- **trading.log**: 每天午夜轮转，保留90天

### 手动清理

```bash
# 使用清理脚本
cd backend
python scripts/cleanup_logs.py

# 查看日志统计
python scripts/cleanup_logs.py --stats

# 手动删除过期日志
find backend/logs -name "*.log.*" -mtime +90 -delete
```

### 定时清理（Linux Crontab）

```bash
# 编辑 crontab
crontab -e

# 添加定时任务（每天凌晨2点清理）
0 2 * * * cd /root/AIcoin/backend && python scripts/cleanup_logs.py
```

---

## 📊 日志格式说明

### 控制台输出（彩色）

```
2025-11-12 06:41:00 - app.main - INFO - 🚀 AIcoin Trading System 启动
2025-11-12 06:41:03 - app.services.orchestrator_v2 - INFO - 📊 获取市场数据...
2025-11-12 06:41:25 - app.services.decision - INFO - ✅ 决策完成: hold BTC
```

### 文件输出（详细）

```
2025-11-12 06:41:00 | INFO     | app.main | startup:312 | 🚀 AIcoin Trading System 启动
2025-11-12 06:41:03 | INFO     | app.services.orchestrator_v2 | _decision_loop:185 | 📊 获取市场数据...
2025-11-12 06:41:25 | INFO     | app.services.decision | make_decision:89 | ✅ 决策完成: hold BTC
```

### AI决策日志（专用格式）

```
2025-11-12 06:41:06 | INFO | 🤖 AI决策 | 📝 构建决策Prompt...
2025-11-12 06:41:06 | INFO | 🤖 AI决策 | 🤖 调用AI模型进行决策...
2025-11-12 06:41:25 | INFO | 🤖 AI决策 | ✅ 决策完成: hold BTC
```

### 交易日志（专用格式）

```
2025-11-12 06:41:30 | INFO | 💰 交易 | 开仓: BTC, 数量: 0.001, 价格: $103,500
2025-11-12 06:42:00 | INFO | 💰 交易 | 平仓: BTC, 盈亏: +$50.00
```

---

## 🔧 在代码中使用日志

### 基本用法

```python
import logging

logger = logging.getLogger(__name__)

# 不同级别的日志
logger.debug("调试信息：变量值 = %s", value)
logger.info("✅ 操作成功")
logger.warning("⚠️ 配置缺失，使用默认值")
logger.error("❌ 操作失败: %s", error_msg)
logger.critical("🚨 严重错误！系统即将停止")
```

### 带异常堆栈

```python
try:
    # 业务逻辑
    result = risky_operation()
except Exception as e:
    logger.error("操作失败: %s", e, exc_info=True)  # 自动记录堆栈
```

### 格式化日志

```python
# 推荐：使用 % 格式化（性能更好）
logger.info("用户 %s 执行了 %s 操作", username, action)

# 避免：使用 f-string（即使日志级别不输出也会格式化）
logger.debug(f"详细信息: {expensive_operation()}")  # ❌ 不推荐

# 正确：使用延迟格式化
logger.debug("详细信息: %s", expensive_operation())  # ✅ 推荐
```

---

## 📈 日志监控和告警

### 1. 错误日志监控

```bash
# 实时监控错误日志
tail -f backend/logs/aicoin_error.log | grep -i "critical\|error"

# 统计错误数量
watch -n 10 'grep -c "ERROR" backend/logs/aicoin_error.log'
```

### 2. 日志大小监控

```bash
# 检查日志文件大小
du -sh backend/logs/*

# 监控日志增长速度
watch -n 60 'ls -lh backend/logs/*.log'
```

### 3. 告警脚本（可选）

```bash
#!/bin/bash
# 如果错误日志超过100条，发送告警
ERROR_COUNT=$(grep -c "ERROR" backend/logs/aicoin_error.log)
if [ $ERROR_COUNT -gt 100 ]; then
    echo "⚠️ 错误日志过多: $ERROR_COUNT 条" | mail -s "AIcoin告警" admin@example.com
fi
```

---

## 🎯 最佳实践

### ✅ 推荐做法

1. **生产环境使用 INFO 级别**：平衡性能和可观测性
2. **使用结构化日志**：包含时间、模块、函数、行号
3. **添加表情符号**：快速识别日志类型（🚀 启动、✅ 成功、❌ 失败）
4. **定期清理日志**：避免磁盘占满
5. **监控错误日志**：及时发现问题
6. **保留关键日志**：AI决策和交易日志保留90天

### ❌ 避免做法

1. **不要在循环中打印 DEBUG 日志**：会产生大量日志
2. **不要记录敏感信息**：API密钥、密码、私钥
3. **不要使用 print()**：使用 logger 代替
4. **不要忽略异常**：至少记录 ERROR 日志
5. **不要在生产环境使用 DEBUG**：影响性能

---

## 🔍 故障排查

### 问题：日志文件不存在

```bash
# 检查日志目录
ls -la backend/logs/

# 检查容器内日志目录
docker exec aicoin-backend ls -la /app/logs/

# 检查 docker-compose.yml 的 volumes 配置
grep -A 2 "volumes:" docker-compose.yml
```

### 问题：日志级别不生效

```bash
# 检查环境变量
docker exec aicoin-backend env | grep LOG_LEVEL

# 重启服务
docker compose restart backend
```

### 问题：日志文件过大

```bash
# 检查日志大小
du -sh backend/logs/*

# 手动清理
python backend/scripts/cleanup_logs.py

# 检查轮转配置
grep -A 5 "TimedRotatingFileHandler" backend/app/core/logging_config.py
```

---

## 📚 相关文档

- [部署指南](./01-部署指南.md)
- [监控告警](./02-监控告警.md)
- [数据备份](./08-数据备份与清理指南.md)

---

**最后更新**: 2025-11-12  
**维护者**: AIcoin 团队

