# 智能触发功能 - 待实现

## 📋 功能概述

**状态**：暂不实现，待后续需求确认

**目的**：通过事件驱动替代固定时间间隔，降低AI决策成本80-90%

## 🎯 设计思路

### 当前方案（Time-based）
- 固定间隔：300秒（5分钟）
- 每日决策：288次
- 优点：简单、可预测、易调试
- 缺点：市场平静时也频繁决策，浪费成本

### 智能触发方案（Event-based）
- 触发条件：市场事件驱动
- 每日决策：30-50次（根据市场波动）
- 优点：成本节省80-90%
- 缺点：系统复杂度增加

## 🔧 实现方案

### 方案1：纯事件驱动
```python
触发条件：
1. 价格波动 > 2%
2. 成交量突增 > 50%
3. 情报系统重大事件
4. 持仓盈亏达到阈值（±5%）
5. 技术指标突破关键位

优点：最大化节省成本
缺点：可能错过缓慢变化的机会
```

### 方案2：混合模式（推荐）
```python
基础间隔：10-15分钟（保底）
事件触发：
  - 价格变化 > 2%（立即触发）
  - 持仓盈亏 > 5%（立即触发）
  - 情报高优先级事件（立即触发）
  - 技术指标突破（立即触发）

优点：平衡成本和机会
缺点：需要实时市场监控
```

## 📊 预期效果

### 成本对比
| 模式 | 每日决策次数 | 日成本 | 月成本 | 节省比例 |
|------|------------|--------|--------|---------|
| 当前（5分钟） | 288次 | ¥150 | ¥4,500 | - |
| 智能触发 | 30-50次 | ¥31 | ¥942 | 79-90% |

### 决策质量
- ✅ 关键时刻不错过（事件触发）
- ✅ 平静期不浪费（减少无效决策）
- ✅ 保底机制（混合模式下）

## 🛠️ 技术实现要点

### 1. 市场监控服务
```python
class MarketMonitor:
    """实时监控市场变化"""
    
    async def monitor_price_change(self):
        """监控价格变化"""
        # 计算价格变化率
        # 超过阈值触发事件
        
    async def monitor_volume_spike(self):
        """监控成交量异常"""
        # 检测成交量突增
        
    async def monitor_position_risk(self):
        """监控持仓风险"""
        # 计算持仓盈亏
        # 达到阈值触发
```

### 2. 事件总线
```python
class EventBus:
    """事件分发系统"""
    
    async def emit(self, event_type: str, data: dict):
        """发送事件"""
        
    async def subscribe(self, event_type: str, handler):
        """订阅事件"""
```

### 3. 智能触发器
```python
class SmartTrigger:
    """智能触发决策"""
    
    def __init__(self):
        self.last_decision_time = None
        self.min_interval = 60  # 最小间隔1分钟
        self.max_interval = 900  # 最大间隔15分钟
        
    async def should_trigger(self, event: Event) -> bool:
        """判断是否应该触发决策"""
        # 检查最小间隔
        # 评估事件重要性
        # 返回是否触发
```

### 4. 修改Orchestrator
```python
class AITradingOrchestratorV3:
    """支持智能触发的编排器"""
    
    def __init__(self):
        self.market_monitor = MarketMonitor()
        self.event_bus = EventBus()
        self.smart_trigger = SmartTrigger()
        
    async def start(self):
        """启动混合模式"""
        # 启动基础定时循环（15分钟）
        asyncio.create_task(self._baseline_loop())
        
        # 启动市场监控
        asyncio.create_task(self._market_monitoring())
        
        # 订阅触发事件
        self.event_bus.subscribe('trigger_decision', self._handle_trigger)
```

## 📋 开发任务清单

### Phase 1: 基础设施
- [ ] 实现 MarketMonitor 服务
- [ ] 实现 EventBus 事件总线
- [ ] 实现 SmartTrigger 触发器

### Phase 2: 触发条件
- [ ] 价格变化监控
- [ ] 成交量监控
- [ ] 持仓风险监控
- [ ] 情报事件集成

### Phase 3: 集成测试
- [ ] 单元测试
- [ ] 集成测试
- [ ] 成本效果验证
- [ ] 性能测试

### Phase 4: 优化调整
- [ ] 阈值优化
- [ ] 性能优化
- [ ] 监控告警
- [ ] 文档完善

## 🎯 触发条件配置

```python
# config.py
class SmartTriggerConfig:
    # 价格变化阈值
    PRICE_CHANGE_THRESHOLD = 0.02  # 2%
    
    # 成交量异常阈值
    VOLUME_SPIKE_THRESHOLD = 0.5  # 50%增长
    
    # 持仓盈亏阈值
    POSITION_PNL_THRESHOLD = 0.05  # ±5%
    
    # 最小触发间隔
    MIN_TRIGGER_INTERVAL = 60  # 1分钟
    
    # 基础决策间隔（保底）
    BASELINE_INTERVAL = 900  # 15分钟
    
    # 情报优先级阈值
    INTELLIGENCE_PRIORITY_THRESHOLD = 8  # 优先级>=8触发
```

## 📈 监控指标

需要监控的关键指标：
1. 每日实际触发次数
2. 事件触发 vs 定时触发比例
3. 成本节省比例
4. 决策质量（盈亏）
5. 错过的机会（回测）

## 🚀 启用方式

```python
# 环境变量
SMART_TRIGGER_ENABLED=true
SMART_TRIGGER_MODE=hybrid  # pure_event | hybrid
BASELINE_INTERVAL=900
PRICE_CHANGE_THRESHOLD=0.02
```

## 💡 注意事项

1. **不要过度优化** - 在真正需要之前不要实现
2. **先收集数据** - 运行一段时间收集决策数据，分析哪些决策是有效的
3. **逐步实施** - 先实现混合模式，再考虑纯事件驱动
4. **保持简单** - 不要让触发逻辑过于复杂
5. **可回退** - 保留固定间隔模式作为备选

## 📅 实施时机

建议在以下情况下考虑实施：
- ✅ 系统稳定运行3个月以上
- ✅ 收集了足够的决策数据
- ✅ AI成本占比超过总成本的30%
- ✅ 有明确的成本压力
- ✅ 团队有足够的开发资源

## 🔗 相关文档

- `docs/cost_optimization_plan.md` - 成本优化计划
- `backend/app/services/orchestrator_v2.py` - 当前编排器实现
- `backend/app/core/config.py` - 配置文件

---

**创建时间**：2025年11月9日  
**状态**：待实现  
**优先级**：低（P3）  
**预计工作量**：2-3周

