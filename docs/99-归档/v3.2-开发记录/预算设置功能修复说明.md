# é¢„ç®—è®¾ç½®åŠŸèƒ½ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨"å„æ¨¡å‹é¢„ç®—"é¡µé¢è®¾ç½®é¢„ç®—æ—¶é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š
1. **æ•°æ®æœªä¿å­˜**ï¼šè¾“å…¥é¢„ç®—åç„¦ç‚¹ç¦»å¼€ï¼Œæç¤ºä¿å­˜æˆåŠŸï¼Œä½†åˆ·æ–°é¡µé¢åæ•°æ®ä¸¢å¤±
2. **ç•Œé¢æ–‡æ¡ˆé‡å¤**ï¼šæ˜¾ç¤º"é¢„ç®—é¢„ç®—"è€Œä¸æ˜¯"å‰©ä½™é¢„ç®—"
3. **æ•°æ®ä¸åŒæ­¥**ï¼šä¿å­˜åé¡¶éƒ¨æ€»é¢„ç®—æœ‰å˜åŒ–ï¼Œä½†å³ä¾§"å‰©ä½™é¢„ç®—"ä»æ˜¾ç¤º"æœªè®¾ç½®"

## ğŸ”§ é—®é¢˜åˆ†æ

### 1. æ•°æ®æœªä¿å­˜åˆ°æ•°æ®åº“
**æ ¹æœ¬åŸå› **ï¼šSQLAlchemyçš„JSONå­—æ®µæ›´æ–°æœºåˆ¶é—®é¢˜

å½“ç›´æ¥ä¿®æ”¹JSONå­—æ®µçš„å†…å®¹æ—¶ï¼š
```python
# âŒ é”™è¯¯åšæ³• - SQLAlchemyä¸ä¼šæ£€æµ‹åˆ°å˜åŒ–
config = platform.config_json or {}
config['monthly_budget'] = budget.monthly_budget
platform.config_json = config
```

SQLAlchemyçš„ORMä¸ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°JSONå­—æ®µå†…éƒ¨çš„å˜åŒ–ï¼Œå¯¼è‡´ `commit()` æ—¶ä¸ä¼šæ›´æ–°æ•°æ®åº“ã€‚

### 2. ç•Œé¢æ˜¾ç¤ºé—®é¢˜
- æ ‡ç­¾æ–‡æ¡ˆé”™è¯¯ï¼š"é¢„ç®—é¢„ç®—" â†’ åº”ä¸º"å‰©ä½™é¢„ç®—"
- æ•°æ®æ›´æ–°å»¶è¿Ÿï¼šä¿å­˜åéœ€è¦ç­‰å¾… `fetchData()` å®Œæˆæ‰èƒ½çœ‹åˆ°æ›´æ–°

## âœ… è§£å†³æ–¹æ¡ˆ

### åç«¯ä¿®å¤ (platform_budget.py)

```python
@router.put("/platforms/{platform_id}/budget")
async def update_platform_budget(
    platform_id: int,
    budget: BudgetUpdate,
    db: AsyncSession = Depends(get_db)
) -> Dict[str, Any]:
    """æ›´æ–°å•ä¸ªå¹³å°çš„é¢„ç®—"""
    result = await db.execute(
        select(IntelligencePlatform).where(IntelligencePlatform.id == platform_id)
    )
    platform = result.scalar_one_or_none()
    
    if not platform:
        raise HTTPException(status_code=404, detail="å¹³å°ä¸å­˜åœ¨")
    
    # âœ… æ­£ç¡®åšæ³•ï¼šåˆ›å»ºæ–°çš„dictå¯¹è±¡
    config = dict(platform.config_json or {})
    config['monthly_budget'] = budget.monthly_budget
    config['alert_threshold'] = budget.alert_threshold
    
    # âœ… ä½¿ç”¨flag_modifiedæ˜¾å¼æ ‡è®°å­—æ®µå·²ä¿®æ”¹
    from sqlalchemy.orm.attributes import flag_modified
    platform.config_json = config
    flag_modified(platform, 'config_json')
    
    # âœ… æäº¤å¹¶åˆ·æ–°
    await db.commit()
    await db.refresh(platform)
    
    # éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
    print(f"âœ… é¢„ç®—ä¿å­˜æˆåŠŸ: {platform.name} - æœˆåº¦é¢„ç®—: Â¥{budget.monthly_budget}")
    print(f"   å½“å‰config_json: {platform.config_json}")
    
    return {
        "success": True,
        "message": f"å·²æ›´æ–° {platform.name} çš„é¢„ç®—è®¾ç½®",
        "data": {
            "platform_id": platform_id,
            "platform_name": platform.name,
            "monthly_budget": budget.monthly_budget,
            "alert_threshold": budget.alert_threshold,
            "config_json": platform.config_json,
        }
    }
```

**å…³é”®æ”¹è¿›**ï¼š
1. ä½¿ç”¨ `dict()` åˆ›å»ºæ–°çš„å­—å…¸å¯¹è±¡
2. ä½¿ç”¨ `flag_modified()` æ˜¾å¼æ ‡è®°å­—æ®µå·²ä¿®æ”¹
3. ä½¿ç”¨ `await db.refresh()` ç¡®ä¿è·å–æœ€æ–°æ•°æ®
4. æ·»åŠ è°ƒè¯•æ—¥å¿—

### å‰ç«¯ä¿®å¤ (budget/page.tsx)

#### 1. ä¿®å¤æ–‡æ¡ˆ
```typescript
<label className="block text-sm font-medium text-gray-700 mb-2">
  å‰©ä½™é¢„ç®—ï¼ˆÂ¥ï¼‰  {/* âœ… ä¿®æ­£ï¼šä»"é¢„ç®—é¢„ç®—"æ”¹ä¸º"å‰©ä½™é¢„ç®—" */}
</label>
```

#### 2. ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
```typescript
if (data.success) {
  console.log('âœ… é¢„ç®—ä¿å­˜æˆåŠŸ:', data.data);
  
  // âœ… ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œä¸éœ€è¦ç­‰å¾…fetchData
  setModels(prevModels => 
    prevModels.map(m => 
      m.model_name === modelName 
        ? {
            ...m,
            monthly_budget: budget,
            remaining_budget: budget - m.current_month_cost,
            usage_percentage: budget > 0 ? (m.current_month_cost / budget) * 100 : 0,
          }
        : m
    )
  );
  
  // æ˜¾ç¤ºæˆåŠŸæç¤º
  const toast = document.createElement('div');
  toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  toast.textContent = `âœ… ${model.display_name} é¢„ç®—å·²ä¿å­˜: Â¥${budget}`;
  document.body.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
  
  // åå°é™é»˜åˆ·æ–°å®Œæ•´æ•°æ®
  fetchData();
}
```

**å…³é”®æ”¹è¿›**ï¼š
1. ä½¿ç”¨ `setModels()` ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
2. è®¡ç®—å¹¶æ›´æ–° `remaining_budget` å’Œ `usage_percentage`
3. Toastæç¤ºä¸­æ˜¾ç¤ºå…·ä½“çš„é¢„ç®—é‡‘é¢
4. åå°å¼‚æ­¥åˆ·æ–°å®Œæ•´æ•°æ®ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

#### 3. æ”¹è¿›ä¿å­˜çŠ¶æ€æŒ‡ç¤º
```typescript
<label className="block text-sm font-medium text-gray-700 mb-2">
  æœˆåº¦é¢„ç®—ï¼ˆÂ¥ï¼‰
  {savingModel === model.model_name && (
    <span className="ml-2 text-xs text-blue-600">ğŸ’¾ ä¿å­˜ä¸­...</span>
  )}
</label>
<input
  type="number"
  defaultValue={model.monthly_budget}
  onBlur={(e) => {
    const budget = Number(e.target.value);
    if (budget !== model.monthly_budget && !isNaN(budget)) {
      handleSaveBudget(model.model_name, budget);
    }
  }}
  disabled={savingModel === model.model_name}
  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
  placeholder="0"
  min="0"
  step="0.01"
/>
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼š
- âŒ è¾“å…¥é¢„ç®— â†’ ç„¦ç‚¹ç¦»å¼€ â†’ æç¤ºæˆåŠŸ â†’ åˆ·æ–°é¡µé¢ â†’ æ•°æ®ä¸¢å¤±
- âŒ æ˜¾ç¤º"é¢„ç®—é¢„ç®—"ï¼ˆæ–‡æ¡ˆé”™è¯¯ï¼‰
- âŒ ä¿å­˜åå³ä¾§ä»æ˜¾ç¤º"æœªè®¾ç½®"

### ä¿®å¤åï¼š
- âœ… è¾“å…¥é¢„ç®— â†’ ç„¦ç‚¹ç¦»å¼€ â†’ ç«‹å³æ˜¾ç¤ºæ–°å€¼ â†’ åˆ·æ–°é¡µé¢ â†’ æ•°æ®ä¿æŒ
- âœ… æ˜¾ç¤º"å‰©ä½™é¢„ç®—"ï¼ˆæ–‡æ¡ˆæ­£ç¡®ï¼‰
- âœ… ä¿å­˜åç«‹å³æ˜¾ç¤ºè®¡ç®—åçš„å‰©ä½™é¢„ç®—
- âœ… Toastæç¤ºæ˜¾ç¤ºå…·ä½“ä¿å­˜çš„é‡‘é¢
- âœ… ä¿å­˜æ—¶è¾“å…¥æ¡†ç¦ç”¨ï¼Œé˜²æ­¢é‡å¤æäº¤
- âœ… æ˜¾ç¤º"ğŸ’¾ ä¿å­˜ä¸­..."çŠ¶æ€

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. **æ‰“å¼€é¢„ç®—è®¾ç½®é¡µé¢**ï¼š`http://localhost:3000/admin/ai-cost/budget`
2. **è¾“å…¥é¢„ç®—**ï¼šåœ¨ä»»æ„æ¨¡å‹çš„"æœˆåº¦é¢„ç®—"è¾“å…¥æ¡†ä¸­è¾“å…¥é‡‘é¢ï¼ˆå¦‚ 100ï¼‰
3. **è§¦å‘ä¿å­˜**ï¼šç‚¹å‡»å…¶ä»–åœ°æ–¹æˆ–æŒ‰Tabé”®ç¦»å¼€è¾“å…¥æ¡†
4. **éªŒè¯å³æ—¶åé¦ˆ**ï¼š
   - çœ‹åˆ°"ğŸ’¾ ä¿å­˜ä¸­..."æç¤º
   - è¾“å…¥æ¡†çŸ­æš‚ç¦ç”¨
   - å³ä¸Šè§’å‡ºç°ç»¿è‰²Toastï¼š"âœ… [æ¨¡å‹å] é¢„ç®—å·²ä¿å­˜: Â¥100"
   - å³ä¾§"å‰©ä½™é¢„ç®—"ç«‹å³æ˜¾ç¤ºè®¡ç®—åçš„å€¼
5. **éªŒè¯æŒä¹…åŒ–**ï¼šåˆ·æ–°é¡µé¢ï¼Œé¢„ç®—å€¼åº”è¯¥ä¿æŒ
6. **éªŒè¯æ•°æ®åº“**ï¼šå¯ä»¥é€šè¿‡æ•°æ®åº“ç®¡ç†é¡µé¢æŸ¥çœ‹ `intelligence_platforms` è¡¨çš„ `config_json` å­—æ®µ

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### SQLAlchemy JSONå­—æ®µæ›´æ–°çš„æ­£ç¡®å§¿åŠ¿

1. **åˆ›å»ºæ–°å¯¹è±¡**ï¼š
   ```python
   config = dict(platform.config_json or {})  # åˆ›å»ºæ–°dict
   ```

2. **æ ‡è®°ä¿®æ”¹**ï¼š
   ```python
   from sqlalchemy.orm.attributes import flag_modified
   flag_modified(platform, 'config_json')
   ```

3. **æäº¤å¹¶åˆ·æ–°**ï¼š
   ```python
   await db.commit()
   await db.refresh(platform)
   ```

### ReactçŠ¶æ€æ›´æ–°çš„æœ€ä½³å®è·µ

1. **ç«‹å³æ›´æ–°UI**ï¼šä¸è¦ç­‰å¾…APIå“åº”
   ```typescript
   setModels(prevModels => prevModels.map(...))
   ```

2. **åå°åŒæ­¥**ï¼šå¼‚æ­¥åˆ·æ–°å®Œæ•´æ•°æ®
   ```typescript
   fetchData()  // ä¸éœ€è¦await
   ```

3. **ä¹è§‚æ›´æ–°**ï¼šå…ˆæ›´æ–°UIï¼Œå¤±è´¥æ—¶å›æ»š

## ğŸ“… å®Œæˆæ—¶é—´

- é—®é¢˜å‘ç°ï¼š2025å¹´11æœˆ9æ—¥ 13:42
- ä¿®å¤å®Œæˆï¼š2025å¹´11æœˆ9æ—¥ 14:00
- æµ‹è¯•éªŒè¯ï¼šâœ… é€šè¿‡

## ğŸ¯ ç›¸å…³æ–‡ä»¶

### åç«¯
- `backend/app/api/v1/endpoints/platform_budget.py` - é¢„ç®—ç®¡ç†API

### å‰ç«¯
- `frontend/app/admin/ai-cost/budget/page.tsx` - é¢„ç®—è®¾ç½®é¡µé¢

## ğŸ’¡ ç»éªŒæ€»ç»“

1. **JSONå­—æ®µæ›´æ–°è¦å°å¿ƒ**ï¼šSQLAlchemyä¸ä¼šè‡ªåŠ¨æ£€æµ‹JSONå­—æ®µå†…éƒ¨çš„å˜åŒ–
2. **ä½¿ç”¨flag_modified**ï¼šå¤„ç†JSONã€ARRAYç­‰å¯å˜ç±»å‹å­—æ®µæ—¶å¿…é¡»æ˜¾å¼æ ‡è®°
3. **ç«‹å³æ›´æ–°UI**ï¼šä¸è¦è®©ç”¨æˆ·ç­‰å¾…ï¼Œå…ˆæ›´æ–°UIå†åŒæ­¥æ•°æ®
4. **æ·»åŠ è¯¦ç»†æ—¥å¿—**ï¼šæ–¹ä¾¿è°ƒè¯•å’ŒéªŒè¯æ•°æ®æ˜¯å¦çœŸæ­£ä¿å­˜
5. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šä¿å­˜çŠ¶æ€ã€æˆåŠŸæç¤ºã€å³æ—¶åé¦ˆéƒ½å¾ˆé‡è¦

