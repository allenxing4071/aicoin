# 🎯 AI成本优化方案

## 📊 当前问题分析

### 成本数据
- **单次调用成本**: ¥1.047/分钟
- **决策间隔**: 60秒（1分钟）
- **每小时决策**: 60次
- **每天决策**: 1,440次
- **预估月成本**: ¥45,000+ 😱

### 根本原因
1. **决策频率过高**: 60秒间隔 → 每天1440次决策
2. **Token消耗大**: 每次决策使用大量tokens
3. **多模型调用**: 可能同时调用多个AI模型
4. **情报更新频繁**: 30分钟更新一次情报

---

## 🔧 优化方案

### 方案一：调整决策频率（推荐）

#### 当前配置
```python
DECISION_INTERVAL = 60  # 60秒 = 1分钟
```

#### 优化建议
```python
# 保守模式（推荐新手）
DECISION_INTERVAL = 900  # 15分钟
# 预估成本: ¥1.047 × 96次/天 = ¥100/天 = ¥3,000/月

# 平衡模式（推荐）
DECISION_INTERVAL = 600  # 10分钟  
# 预估成本: ¥1.047 × 144次/天 = ¥150/天 = ¥4,500/月

# 标准模式
DECISION_INTERVAL = 300  # 5分钟
# 预估成本: ¥1.047 × 288次/天 = ¥300/天 = ¥9,000/月

# 激进模式（当前）
DECISION_INTERVAL = 60   # 1分钟
# 预估成本: ¥1.047 × 1440次/天 = ¥1,500/天 = ¥45,000/月 ❌
```

**成本对比**:
| 模式 | 间隔 | 日决策次数 | 日成本 | 月成本 | 节省 |
|------|------|-----------|--------|--------|------|
| 激进 | 1分钟 | 1,440 | ¥1,500 | ¥45,000 | - |
| 标准 | 5分钟 | 288 | ¥300 | ¥9,000 | 80% ↓ |
| 平衡 | 10分钟 | 144 | ¥150 | ¥4,500 | 90% ↓ |
| 保守 | 15分钟 | 96 | ¥100 | ¥3,000 | 93% ↓ |

---

### 方案二：优化Token使用

#### 1. 减少Prompt长度
```python
# 当前: 每次决策发送大量市场数据
# 优化: 只发送关键指标

# 优化前
market_data = {
    "klines": [...],  # 100条K线数据
    "orderbook": {...},  # 完整订单簿
    "trades": [...]  # 最近交易
}

# 优化后
market_data = {
    "price": current_price,
    "change_24h": change_pct,
    "volume_24h": volume,
    "key_levels": [support, resistance]
}
```

**预期效果**: 减少50-70% tokens

#### 2. 使用更便宜的模型
```python
# 当前可能使用的模型
"qwen-plus"      # ¥0.50/1M input tokens
"qwen-turbo"     # ¥0.30/1M input tokens (更便宜)
"qwen-7b"        # ¥0.10/1M input tokens (最便宜)
```

#### 3. 缓存常用数据
```python
# 缓存市场分析结果，避免重复计算
# 缓存时间: 5分钟
```

---

### 方案三：智能决策触发

#### 概念
不是每N秒都决策，而是在关键时刻才决策

#### 触发条件
```python
# 只在以下情况触发决策:
1. 价格变化 > 2%
2. 成交量异常 (> 平均值 2倍)
3. 持仓盈亏 > 5%
4. 重要新闻/事件
5. 定时检查 (15分钟)
```

**预期效果**: 减少70-80%无效决策

---

### 方案四：分层决策策略

#### 快速检查（本地，免费）
```python
# 每1分钟执行
def quick_check():
    # 本地计算，不调用AI
    if price_change > 5%:
        return "需要AI决策"
    if position_pnl < -10%:
        return "需要AI决策"
    return "继续观察"
```

#### AI决策（调用API，收费）
```python
# 只在快速检查触发时执行
def ai_decision():
    # 调用AI模型
    return decision
```

**预期效果**: 减少80-90%成本

---

## 🚀 立即执行的优化

### 1. 修改决策间隔（最简单）

```bash
# 编辑.env文件
cd /Users/xinghailong/Documents/soft/AIcoin
echo "DECISION_INTERVAL=600" >> .env  # 改为10分钟

# 重启后端
docker restart aicoin-backend
```

### 2. 修改配置文件

```bash
# 编辑 backend/app/core/config.py
vim backend/app/core/config.py

# 找到这一行:
DECISION_INTERVAL: int = 60

# 改为:
DECISION_INTERVAL: int = 600  # 10分钟

# 重启
docker restart aicoin-backend
```

---

## 📈 预期效果

### 优化前
- 决策间隔: 60秒
- 日决策: 1,440次
- 日成本: ¥1,500
- 月成本: ¥45,000

### 优化后（10分钟间隔）
- 决策间隔: 600秒
- 日决策: 144次
- 日成本: ¥150
- 月成本: ¥4,500
- **节省: 90% ↓**

---

## 💡 其他优化建议

### 1. 使用本地模型
- 部署本地Qwen模型
- 成本: 仅GPU费用
- 适合: 高频交易

### 2. 混合策略
- 快速决策: 本地模型（免费）
- 重要决策: 云端模型（收费）

### 3. 批量处理
- 收集多个信号
- 一次性调用AI
- 减少API调用次数

---

## ⚠️ 注意事项

1. **不要过度优化**: 太长的间隔可能错过机会
2. **监控效果**: 观察优化后的交易表现
3. **逐步调整**: 先改为10分钟，观察1-2天，再决定是否继续优化
4. **保留日志**: 记录每次优化的效果

---

## 📝 实施步骤

### 第一步：立即优化（今天）
```bash
# 1. 修改决策间隔为10分钟
echo "DECISION_INTERVAL=600" >> .env
docker restart aicoin-backend

# 2. 观察成本变化
# 预期: 成本降低90%
```

### 第二步：监控效果（1-2天）
```bash
# 检查决策质量
curl http://localhost:8000/api/v1/ai/status

# 检查成本
# 查看云平台账单
```

### 第三步：进一步优化（如需要）
```bash
# 如果成本还是高，可以:
# 1. 增加到15分钟
# 2. 实施智能触发
# 3. 优化Prompt
```

---

## 🎯 推荐配置

根据您的使用场景：

### 测试/学习阶段
```python
DECISION_INTERVAL = 900  # 15分钟
# 成本: ¥3,000/月
```

### 正式交易阶段
```python
DECISION_INTERVAL = 600  # 10分钟
# 成本: ¥4,500/月
```

### 高频交易阶段（不推荐新手）
```python
DECISION_INTERVAL = 300  # 5分钟
# 成本: ¥9,000/月
# 需要: 更好的策略 + 更多资金
```

