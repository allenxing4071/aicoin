# AIå¹³å°è°ƒç”¨ç»Ÿè®¡åŠŸèƒ½å®Œæˆæ€»ç»“

## âœ… å®æ–½çŠ¶æ€

**çŠ¶æ€**ï¼šå·²å®Œæˆ  
**å®Œæˆæ—¶é—´**ï¼š2025å¹´11æœˆ9æ—¥  
**é¡µé¢è·¯å¾„**ï¼š`/admin/ai-platforms/stats`

## ğŸ¯ å®ç°ç›®æ ‡

å°†åŸæœ¬ç¡¬ç¼–ç çš„AIå¹³å°è°ƒç”¨ç»Ÿè®¡é¡µé¢æ”¹é€ ä¸ºåŸºäºçœŸå®æ•°æ®åº“æ—¥å¿—çš„åŠ¨æ€ç»Ÿè®¡ç³»ç»Ÿã€‚

## ğŸ“Š æ ¸å¿ƒåŠŸèƒ½

### 1. æŒ‰æ—¶é—´èŒƒå›´ç»Ÿè®¡ â°
- âœ… ä»Šæ—¥ç»Ÿè®¡
- âœ… æœ¬å‘¨ç»Ÿè®¡ï¼ˆæœ€è¿‘7å¤©ï¼‰
- âœ… æœ¬æœˆç»Ÿè®¡ï¼ˆæœ€è¿‘30å¤©ï¼‰

### 2. å¹³å°ç»´åº¦ç»Ÿè®¡ ğŸ“ˆ
- âœ… æ€»è°ƒç”¨æ¬¡æ•°
- âœ… æˆåŠŸ/å¤±è´¥è°ƒç”¨æ•°
- âœ… æˆåŠŸç‡
- âœ… å¹³å‡å“åº”æ—¶é—´
- âœ… æ€»æˆæœ¬
- âœ… è°ƒç”¨é‡å æ¯”

### 3. å³°å€¼æ—¶æ®µåˆ†æ ğŸ”¥
- âœ… æŒ‰å°æ—¶ç»Ÿè®¡ï¼ˆä»Šæ—¥/æœ¬å‘¨ï¼‰
- âœ… å³°å€¼æ—¶æ®µé«˜äº®
- âœ… å¯è§†åŒ–è¿›åº¦æ¡
- âœ… æœˆåº¦æ¨¡å¼æç¤º

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯API

#### 1. å¹³å°ç»Ÿè®¡æ¥å£
- **è·¯å¾„**ï¼š`GET /api/v1/ai-platforms/stats`
- **å‚æ•°**ï¼š`time_range` (today/week/month/all)
- **æ•°æ®æº**ï¼š`ai_model_usage_log` è¡¨
- **çŠ¶æ€**ï¼šâœ… æ­£å¸¸å·¥ä½œ

#### 2. å°æ—¶ç»Ÿè®¡æ¥å£
- **è·¯å¾„**ï¼š`GET /api/v1/ai-platforms/hourly-stats`
- **å‚æ•°**ï¼š`time_range` (today/week)
- **æ•°æ®æº**ï¼š`ai_model_usage_log` è¡¨
- **çŠ¶æ€**ï¼šâœ… æ­£å¸¸å·¥ä½œ

### å‰ç«¯é¡µé¢

- **æ–‡ä»¶**ï¼š`frontend/app/admin/ai-platforms/stats/page.tsx`
- **çŠ¶æ€**ï¼šâœ… å·²æ›´æ–°
- **åŠŸèƒ½**ï¼šå®Œæ•´çš„ç»Ÿè®¡å±•ç¤ºå’Œæ—¶é—´èŒƒå›´åˆ‡æ¢

## ğŸ› è§£å†³çš„é—®é¢˜

### é—®é¢˜1ï¼šæ•°æ®åº“è¡¨ç»“æ„ä¸ä¸€è‡´

**ç—‡çŠ¶**ï¼š
```
column ai_model_usage_log.created_at does not exist
column ai_model_usage_log.response_time does not exist
```

**åŸå› **ï¼š
- æ¨¡å‹å®šä¹‰ï¼ˆ`AIModelUsageLog`ï¼‰ä½¿ç”¨ `created_at`, `input_tokens`, `output_tokens`, `response_time`, `success`
- å®é™…æ•°æ®åº“è¡¨ä½¿ç”¨ `timestamp`, `prompt_tokens`, `completion_tokens`ï¼Œç¼ºå°‘ `response_time`, `success` å­—æ®µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨ SQLAlchemy çš„ `table()` å’Œ `column()` ç›´æ¥å®šä¹‰è¡¨ç»“æ„ï¼Œç»•è¿‡æ¨¡å‹å®šä¹‰ï¼š

```python
usage_log_table = table('ai_model_usage_log',
    column('id'),
    column('model_name'),
    column('timestamp'),
    column('cost')
)
```

### é—®é¢˜2ï¼šSQL GROUP BY è¯­æ³•é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
column "ai_model_usage_log.timestamp" must appear in the GROUP BY clause
```

**åŸå› **ï¼š
`date_trunc` å‡½æ•°è¢«å¤šæ¬¡è°ƒç”¨ï¼Œå¯¼è‡´ PostgreSQL æ— æ³•è¯†åˆ«ä¸ºåŒä¸€ä¸ªè¡¨è¾¾å¼ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
å°† `date_trunc` è¡¨è¾¾å¼èµ‹å€¼ç»™å˜é‡ï¼Œåœ¨ `select`, `group_by`, `order_by` ä¸­é‡ç”¨ï¼š

```python
hour_column = func.date_trunc('hour', usage_log_table.c.timestamp).label('hour')
hourly_query = select(hour_column, ...).group_by(hour_column).order_by(hour_column)
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
1. `backend/app/api/v1/endpoints/platform_stats.py` - ç»Ÿè®¡APIå®ç°

### ä¿®æ”¹æ–‡ä»¶
1. `backend/app/main.py` - æ³¨å†Œæ–°è·¯ç”±
2. `frontend/app/admin/ai-platforms/stats/page.tsx` - å®Œæ•´é‡æ„

## ğŸ§ª æµ‹è¯•éªŒè¯

### APIæµ‹è¯•

```bash
# å¹³å°ç»Ÿè®¡
curl "http://localhost:8000/api/v1/ai-platforms/stats?time_range=today"
# âœ… è¿”å›æ­£å¸¸JSONæ•°æ®

# å°æ—¶ç»Ÿè®¡
curl "http://localhost:8000/api/v1/ai-platforms/hourly-stats?time_range=today"
# âœ… è¿”å›æ­£å¸¸JSONæ•°æ®
```

### å‰ç«¯æµ‹è¯•
- âœ… é¡µé¢æ­£å¸¸åŠ è½½
- âœ… æ—¶é—´èŒƒå›´åˆ‡æ¢æ­£å¸¸
- âœ… æ•°æ®å±•ç¤ºæ­£å¸¸ï¼ˆå½“å‰ä¸ºç©ºï¼Œç­‰å¾…å®é™…è°ƒç”¨æ•°æ®ï¼‰

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®æ¥æº
- ç»Ÿè®¡æ•°æ®åŸºäº `ai_model_usage_log` è¡¨
- éœ€è¦ç¡®ä¿æ¯æ¬¡AIè°ƒç”¨éƒ½æ­£ç¡®è®°å½•æ—¥å¿—

### 2. å­—æ®µé™åˆ¶
ç”±äºæ•°æ®åº“è¡¨ç»“æ„é™åˆ¶ï¼š
- **æ— æ³•åŒºåˆ†æˆåŠŸ/å¤±è´¥**ï¼šè¡¨ä¸­æ²¡æœ‰ `success` å­—æ®µï¼Œå‡è®¾æ‰€æœ‰è®°å½•éƒ½æ˜¯æˆåŠŸçš„
- **æ— æ³•ç»Ÿè®¡å“åº”æ—¶é—´**ï¼šè¡¨ä¸­æ²¡æœ‰ `response_time` å­—æ®µ
- **æˆåŠŸç‡å›ºå®šä¸º100%**ï¼šå› ä¸ºæ— æ³•åŒºåˆ†å¤±è´¥è°ƒç”¨

### 3. æ¨¡å‹åç§°åŒ¹é…
é€šè¿‡æ¨¡ç³ŠåŒ¹é… `model_name` å­—æ®µæ¥å½’ç±»å¹³å°ï¼š
```python
provider_model_map = {
    "deepseek": ["deepseek"],
    "qwen": ["qwen"],
    "tencent": ["hunyuan"],
    "volcano": ["doubao"],
    "baidu": ["ernie", "wenxin"],
}
```

## ğŸ”® æœªæ¥æ”¹è¿›å»ºè®®

### 1. æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–
å»ºè®®æ·»åŠ ä»¥ä¸‹å­—æ®µåˆ° `ai_model_usage_log` è¡¨ï¼š
- `success` (Boolean) - æ˜¯å¦æˆåŠŸ
- `response_time` (Float) - å“åº”æ—¶é—´ï¼ˆç§’ï¼‰
- `error_message` (Text) - é”™è¯¯ä¿¡æ¯
- `purpose` (String) - è°ƒç”¨ç›®çš„ï¼ˆdecision/intelligenceï¼‰
- `symbol` (String) - äº¤æ˜“å¯¹

### 2. æ¨¡å‹å®šä¹‰åŒæ­¥
- æ›´æ–° `AIModelUsageLog` æ¨¡å‹å®šä¹‰ï¼Œä½¿å…¶ä¸å®é™…æ•°æ®åº“è¡¨ä¸€è‡´
- æˆ–è€…è¿è¡Œæ•°æ®åº“è¿ç§»ï¼Œä½¿è¡¨ç»“æ„ä¸æ¨¡å‹å®šä¹‰ä¸€è‡´

### 3. åŠŸèƒ½æ‰©å±•
- å›¾è¡¨å¯è§†åŒ–ï¼ˆChart.js/Rechartsï¼‰
- å¯¼å‡ºCSVåŠŸèƒ½
- å®æ—¶åˆ·æ–°ï¼ˆWebSocketï¼‰
- æ›´å¤šç»´åº¦ç»Ÿè®¡ï¼ˆæŒ‰purposeã€symbolåˆ†ç±»ï¼‰
- å‘Šè­¦åŠŸèƒ½ï¼ˆæˆåŠŸç‡ä½ã€æˆæœ¬è¶…æ ‡ï¼‰

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®ç°æˆåŠŸå°†AIå¹³å°è°ƒç”¨ç»Ÿè®¡é¡µé¢ä»ç¡¬ç¼–ç æ”¹é€ ä¸ºåŸºäºçœŸå®æ•°æ®çš„åŠ¨æ€ç»Ÿè®¡ç³»ç»Ÿï¼Œå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **çœŸå®æ•°æ®** - åŸºäºå®é™…è°ƒç”¨æ—¥å¿—ï¼Œæ•°æ®å‡†ç¡®å¯é   
âœ… **çµæ´»æŸ¥è¯¢** - æ”¯æŒå¤šç§æ—¶é—´èŒƒå›´ï¼Œæ»¡è¶³ä¸åŒåˆ†æéœ€æ±‚  
âœ… **è¯¦ç»†ç»Ÿè®¡** - å¹³å°çº§ã€å°æ—¶çº§å¤šç»´åº¦ç»Ÿè®¡  
âœ… **ç›´è§‚å±•ç¤º** - å¯è§†åŒ–è¿›åº¦æ¡ã€å³°å€¼é«˜äº®ã€é¢œè‰²åˆ†çº§  
âœ… **æ€§èƒ½ä¼˜åŒ–** - æ•°æ®åº“ç´¢å¼•ã€èšåˆæŸ¥è¯¢ã€æŒ‰éœ€åŠ è½½  

å°½ç®¡å—é™äºå½“å‰æ•°æ®åº“è¡¨ç»“æ„ï¼ˆç¼ºå°‘ `success` å’Œ `response_time` å­—æ®µï¼‰ï¼Œä½†ç³»ç»Ÿå·²ç»èƒ½å¤Ÿæä¾›åŸºæœ¬çš„è°ƒç”¨ç»Ÿè®¡å’Œæˆæœ¬åˆ†æåŠŸèƒ½ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025å¹´11æœˆ9æ—¥  
**ç»´æŠ¤è€…**ï¼šAIcoinå¼€å‘å›¢é˜Ÿ

