# AI多平台使用指南

## 概述

AIcoin v3.1 引入了强大的多平台智能路由系统，包括：
1. **Qwen情报员**: 三大云平台联网搜索（百度+腾讯+火山）
2. **DeepSeek交易员**: 智能混合路由（训练70B + 默认API）

本指南将帮助您充分利用这些新功能。

## 一、Qwen情报员多平台协同

### 1.1 系统架构

```
┌─────────────┐
│  市场数据   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│      Qwen情报员多平台协调器          │
│                                     │
│  ┌────────┐  ┌────────┐  ┌────────┐│
│  │百度智能云│  │ 腾讯云 │  │火山引擎││
│  │ Qwen  │  │ Qwen  │  │ Qwen  ││
│  └────────┘  └────────┘  └────────┘│
│                                     │
│  智能负载均衡 + 故障转移             │
└─────────────┬───────────────────────┘
              │
              ▼
       ┌──────────────┐
       │ 情报报告汇总  │
       └──────────────┘
              │
              ▼
    ┌─────────────────┐
    │ DeepSeek交易员   │
    └─────────────────┘
```

### 1.2 多平台并行策略（核心设计）

**重要理念**：三大云平台**同时使用**，而不是单选或轮询！

#### 工作原理

```
收到情报需求
    ↓
同时调用三个平台
    ├─→ 百度智能云搜索
    ├─→ 腾讯云搜索
    └─→ 火山引擎搜索
    ↓
汇总三份结果
    ↓
交叉验证与信息融合
    ├─ 共同信息（高置信度）
    ├─ 部分信息（中置信度）
    └─ 单源信息（低置信度）
    ↓
输出综合情报报告
```

#### 核心优势

1. **信息交叉验证**
   - 三个平台搜索同一主题
   - 自动对比验证信息真实性
   - 过滤单源错误信息

2. **信息互补增强**
   - 发现单平台遗漏的关键信息
   - 从不同角度理解市场动态
   - 覆盖更全面的信息源

3. **置信度评分**
   - 三平台共识：置信度90%+
   - 两平台共识：置信度70-80%
   - 单平台独有：置信度50-60%

4. **故障容错**
   - 某个平台失败不影响整体
   - 至少有两个平台的信息保底
   - 确保情报系统高可用

### 1.3 管理后台操作

访问 `/admin/intelligence-platforms` 查看和管理平台：

- ✅ 查看各平台状态和性能指标
- 🔄 启用/停用特定平台
- ➕ 添加新平台（如AWS）
- 📊 查看调用统计和成本

### 1.4 添加AWS平台

如需添加AWS平台：

1. 访问管理后台 → 情报平台
2. 点击"添加平台"
3. 填写配置信息：
   - 名称: AWS (Qwen搜索)
   - 提供商: aws
   - API密钥: 您的AWS API Key
   - Base URL: AWS端点地址
4. 点击"添加"并启用

## 二、DeepSeek交易员智能混合路由

### 核心理念：智能混合使用，而非单选

**重要说明**: 训练70B模型和默认API应该**智能混合使用**，类似Qwen的多平台策略：
- **可以单独使用**：某个模型明显更优时
- **可以同时使用**：双模型投票，提升决策可靠性
- **智能切换**：根据场景、性能、风险等因素动态选择

### 2.1 五种路由策略

#### (1) 自适应策略 (adaptive) **[推荐]**

系统自动选择最优策略：
- 样本不足时 → AB测试（轮流用，积累数据）
- 效果接近时 → 双模型投票（同时用，互相验证）
- 明显优劣时 → 单模型（用更好的那个）
- 其他情况 → 场景分配（根据风险选择）

**核心价值**: 
- 不固定使用某一个模型
- 根据实际效果动态调整
- 兼顾准确性、速度、成本

**适用场景**: 大多数情况下的最佳选择

#### (2) 单模型策略 (single_best)

选择综合得分最高的模型：
- 计算准确率、盈利率、响应时间、成本
- 加权评分（准确率40% + 盈利率30% + 速度15% + 成本15%）
- 选择得分高的模型

**适用场景**: 已经明确知道哪个模型更优时

#### (3) AB测试策略 (ab_testing)

轮流使用两个模型：
- 50-50分配决策
- 积累对比数据
- 用于评估模型实际效果

**适用场景**: 初期积累性能数据时

#### (4) 双模型投票 (ensemble_voting) **[智能混合核心]**

**同时调用两个模型**，综合决策：
- 意见一致 → 采纳共识，置信度提升
- 意见不一致 → 选择置信度×准确率更高的
- 加权考虑历史准确率

**工作流程**:
```
决策需求
    ↓
同时调用两个模型
    ├─→ 训练70B模型决策
    └─→ 默认API决策
    ↓
对比两个结果
    ├─ 一致：高置信度输出
    └─ 不一致：选择更可靠的
    ↓
输出最终决策
```

**核心价值**:
- 类似Qwen的三平台验证思想
- 两个模型互相验证，降低错误率
- 重要交易时的"双保险"

**适用场景**: 
- 重要决策（大额交易）
- 高风险场景
- 需要更高可靠性时

#### (5) 场景分配 (scenario_based)

根据风险等级分配模型：
- 高风险 → 使用准确率更高的模型
- 低风险 → 使用响应更快的模型
- 中风险 → 双模型投票

**适用场景**: 不同风险等级需要差异化处理时

### 2.2 管理后台操作

访问 `/admin/model-performance` 查看和管理路由：

1. **查看性能对比**
   - 训练70B模型 vs 默认API
   - 准确率、盈利率、响应时间
   - 累计盈亏统计

2. **切换路由策略**
   - 下拉选择策略
   - 查看系统推荐
   - 实时生效

3. **查看路由统计**
   - 决策分布
   - 降级次数
   - 模型使用率

### 2.3 智能混合使用策略

#### 什么时候同时使用两个模型？

1. **重要决策场景**
   - 大额交易（超过账户5%）
   - 高风险市场环境
   - 策略：双模型投票

2. **效果接近时**
   - 两个模型准确率差距<5%
   - 难以判断谁更优
   - 策略：同时使用，互相验证

3. **初期积累阶段**
   - 部署初期（前1-2周）
   - 样本不足
   - 策略：AB测试，轮流使用

#### 什么时候单独使用一个模型？

1. **明显优劣时**
   - 某个模型准确率高出15%+
   - 历史表现稳定
   - 策略：单模型

2. **低风险场景**
   - 小额试探性交易
   - 优先考虑速度和成本
   - 策略：单模型（速度快的）

3. **某个模型不可用**
   - 70B模型未部署或故障
   - 自动降级到默认API
   - 策略：单模型（可用的那个）

#### 准确率优化建议

1. **部署训练70B模型**
   - 在百度智能云部署
   - 配置API密钥和端点
   - 设置 `DEEPSEEK_70B_AVAILABLE=true`

2. **优先使用双模型投票**（推荐）
   - 类似Qwen的多平台验证思想
   - 两个模型互相验证
   - 准确率可提升5-10%

3. **让系统自动选择**
   - 使用"自适应"策略
   - 系统会根据实际效果智能调整
   - 兼顾准确性、速度、成本

#### 成本优化

1. **使用场景分配策略**
   - 高风险用高准确率模型
   - 低风险用默认API（更便宜）

2. **合理设置决策频率**
   - `DECISION_INTERVAL`: 决策间隔（秒）
   - 不要过于频繁

### 2.4 自动降级机制

当训练70B模型不可用时，系统会自动降级到默认API：

```
训练70B模型失败
   ↓
检查 AUTO_FALLBACK
   ↓
自动切换到默认API
   ↓
记录降级事件
```

**配置项**:
```env
DEEPSEEK_AUTO_FALLBACK=true  # 推荐开启
```

## 三、系统监控

### 3.1 情报平台监控

访问 `/admin/intelligence-platforms` 查看：

- 📞 调用次数
- ✅ 成功率
- ⏱️ 平均响应时间
- 💰 累计成本
- 🟢 健康状态

### 3.2 模型性能监控

访问 `/admin/model-performance` 查看：

- 📊 决策准确率
- 💵 交易盈利率
- ⚡ 响应时间
- 📈 历史趋势

### 3.3 记忆系统监控

访问 `/admin/memory` 查看：

- **DeepSeek交易员记忆 (3层)**
  - 短期记忆（Redis）
  - 长期记忆（PostgreSQL）
  - 向量知识库（Qdrant）

- **Qwen情报员存储 (4层)**
  - 短期缓存（Redis）
  - 中期分析
  - 长期存储（PostgreSQL）
  - 向量知识库（Qdrant）

## 四、最佳实践

### 4.1 初始阶段（第1-7天）

1. **配置**: **必须同时启用三大Qwen平台**（百度+腾讯+火山）
   - 这是信息交叉验证的基础
   - 不能只启用单个平台
   
2. **路由**: 使用AB测试策略（DeepSeek）
3. **监控**: 每天查看性能数据和平台调用情况
4. **目标**: 积累至少50次决策样本，验证多平台信息准确性

### 4.2 优化阶段（第8-30天）

1. **路由**: 切换到自适应策略
2. **分析**: 对比两个模型的表现
3. **调整**: 根据实际效果调整策略
4. **目标**: 找到最优配置

### 4.3 稳定阶段（第30天后）

1. **路由**: 使用单模型或场景分配
2. **监控**: 定期检查性能指标
3. **优化**: 根据市场变化调整
4. **目标**: 持续优化收益

### 4.2 成本与价值

#### 成本说明

1. **Qwen平台**: 三个平台同时使用（**不可单选**）
   - 标准成本：约¥4/天（三平台）
   - 国际化成本：约¥5.5/天（含AWS）
   
2. **为什么必须三平台同时用？**
   - 信息准确性 > 成本节省
   - 一次错误决策的损失 >> 月度API成本
   - 置信度从70%提升到90%+

3. **成本优化建议**
   - 调整决策频率（不要过于频繁）
   - 监控各平台调用统计
   - 发现异常及时处理

#### 投资回报率（ROI）

**案例分析**：
- API成本：¥120/月（三平台）
- 避免一次错误决策损失：$50+
- 只需避免3次错误，即可覆盖全年API成本
- **结论**：多平台验证是高性价比的投资

### 4.3 风险管理

1. **启用自动降级**: `DEEPSEEK_AUTO_FALLBACK=true`
2. **多平台冗余**: 至少启用2个Qwen平台
3. **监控告警**: 关注失败率和降级次数
4. **定期测试**: 定期测试故障转移机制

## 五、故障排查

### 5.1 Qwen平台调用失败

**症状**: 情报平台显示"异常"状态

**排查步骤**:
1. 检查API密钥是否正确
2. 检查网络连接
3. 查看后台日志: `docker-compose logs backend`
4. 尝试健康检查
5. 如果单个平台失败，系统会自动切换到其他平台

### 5.2 DeepSeek路由器不工作

**症状**: 始终使用同一个模型

**排查步骤**:
1. 检查性能数据是否积累足够
2. 查看当前策略设置
3. 检查训练70B模型是否可用
4. 查看路由决策日志

### 5.3 性能数据不更新

**症状**: 模型性能页面数据不变

**排查步骤**:
1. 确认系统有实际交易决策
2. 检查数据库连接
3. 查看Celery任务是否运行
4. 检查性能计算任务

## 六、高级功能

### 6.1 自定义路由策略

虽然系统提供了5种内置策略，您也可以：
1. 修改 `backend/app/services/decision/smart_router.py`
2. 添加自定义策略逻辑
3. 在管理后台选择使用

### 6.2 API编程调用

如需通过API调用系统功能：

```python
# 获取性能对比
import requests
response = requests.get("http://localhost:8000/api/v1/decision/performance")
data = response.json()

# 切换策略
response = requests.post(
    "http://localhost:8000/api/v1/decision/strategy",
    json={"strategy": "ensemble_voting"}
)
```

### 6.3 数据导出

所有性能数据都存储在PostgreSQL中，可以直接查询：

```sql
-- 查看路由决策历史
SELECT * FROM routing_decisions 
ORDER BY created_at DESC 
LIMIT 100;

-- 查看模型性能指标
SELECT * FROM model_performance_metrics
WHERE model_name = 'trained_70b'
ORDER BY metric_date DESC;
```

## 七、FAQ

### Q1: 必须配置所有Qwen平台吗？

A: **强烈建议三个平台同时启用**（百度+腾讯+火山）。这不是可选项，而是核心设计：
- **最低要求**: 至少两个平台（保证交叉验证）
- **标准配置**: 三个平台同时使用（推荐）
- **国际化配置**: 四个平台全开（含AWS）

**原因**: 单个平台无法进行信息交叉验证，可能导致错误决策。

### Q2: 70B模型必须部署吗？

A: **不必须，但强烈推荐部署**：
- **不部署**：系统使用默认API，也能正常工作
- **部署后**：可以启用"双模型投票"策略
  - 两个模型互相验证（类似Qwen三平台验证）
  - 准确率可提升5-10%
  - 重要决策时的"双保险"

**最佳实践**：
1. 初期：只用默认API也可以
2. 有条件：部署70B，启用智能混合
3. 理想状态：两个模型都可用，系统自动选择最优策略

### Q3: 自适应策略如何选择子策略？

A: 根据样本数量、性能差异等指标自动选择。详见"路由策略"章节。

### Q4: 成本大约是多少？

A: 三平台并行使用的成本（必需配置）：
- Qwen标准配置: 约¥4/天 = ¥120/月（三平台同时使用）
- Qwen国际化: 约¥5.5/天 = ¥165/月（含AWS）
- DeepSeek: 约$0.05/天 = $1.5/月（默认API）

**价值说明**: 
- 虽然是单平台的3倍成本，但准确性大幅提升
- 一次避免错误决策节省的损失 > 数月API成本
- 这是"必要成本"而非"可选成本"

### Q5: 如何优化准确率？

A: **三个层次的优化**：

1. **基础层**：只用默认API
   - 准确率：~75%
   - 成本：最低
   
2. **进阶层**：部署70B，智能混合使用⭐推荐
   - 准确率：~80-85%
   - 双模型投票时可达85-90%
   - 成本：适中
   
3. **高级层**：持续训练优化
   - 准确率：90%+
   - 需要更多训练数据
   - 成本：较高

**最有效方法**：启用"双模型投票"策略
- 类似Qwen的多平台验证
- 两个模型同时决策，互相验证
- 性价比最高的优化方案

### Q6: 系统会自动优化吗？

A: 是的。使用自适应策略时，系统会根据实际效果自动调整。

## 八、技术支持

如有问题，请：
1. 查看本文档
2. 查看API密钥配置指南
3. 查看后台日志
4. 提交GitHub Issue

---

**祝您使用愉快！** 🚀

