'use client';

import { useState, useEffect } from 'react';
import axios from 'axios';
import ExchangeSelector from '../../components/exchange/ExchangeSelector';

const API_BASE = 'http://localhost:8000/api/v1';

interface Exchange {
  id: number;
  name: string;
  display_name: string;
  is_active: boolean;
  market_type: string;
  testnet: boolean;
  created_at: string;
  updated_at: string;
}

export default function ExchangesPage() {
  const [exchanges, setExchanges] = useState<Exchange[]>([]);
  const [supportedExchanges, setSupportedExchanges] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'list' | 'supported'>('list');

  useEffect(() => {
    fetchExchanges();
    fetchSupportedExchanges();
  }, []);

  const fetchExchanges = async () => {
    try {
      const response = await axios.get(`${API_BASE}/exchanges`);
      if (response.data.success) {
        setExchanges(response.data.data);
      }
    } catch (error) {
      console.error('è·å–äº¤æ˜“æ‰€åˆ—è¡¨å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchSupportedExchanges = async () => {
    try {
      const response = await axios.get(`${API_BASE}/exchanges/supported`);
      if (response.data.success) {
        setSupportedExchanges(response.data.data);
      }
    } catch (error) {
      console.error('è·å–æ”¯æŒçš„äº¤æ˜“æ‰€å¤±è´¥:', error);
    }
  };

  const handleReload = async () => {
    try {
      const response = await axios.post(`${API_BASE}/exchanges/reload`);
      if (response.data.success) {
        alert('âœ… é‡æ–°åŠ è½½æˆåŠŸ!');
        fetchExchanges();
      }
    } catch (error: any) {
      alert(`âŒ é‡æ–°åŠ è½½å¤±è´¥: ${error.response?.data?.detail || error.message}`);
    }
  };

  const handleDelete = async (id: number, name: string) => {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤äº¤æ˜“æ‰€é…ç½®"${name}"å—?`)) {
      return;
    }

    try {
      const response = await axios.delete(`${API_BASE}/exchanges/${id}`);
      if (response.data.success) {
        alert('âœ… åˆ é™¤æˆåŠŸ!');
        fetchExchanges();
      }
    } catch (error: any) {
      alert(`âŒ åˆ é™¤å¤±è´¥: ${error.response?.data?.detail || error.message}`);
    }
  };

  return (
    <div className="p-6 space-y-6">
      {/* é¡µé¢æ ‡é¢˜ */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-white mb-2">äº¤æ˜“æ‰€ç®¡ç†</h1>
          <p className="text-gray-400">ç®¡ç†å’Œåˆ‡æ¢ä¸åŒçš„äº¤æ˜“æ‰€</p>
        </div>
        
        <button
          onClick={handleReload}
          className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          é‡æ–°åŠ è½½é€‚é…å™¨
        </button>
      </div>

      {/* å½“å‰äº¤æ˜“æ‰€é€‰æ‹©å™¨ */}
      <ExchangeSelector />

      {/* æ ‡ç­¾åˆ‡æ¢ */}
      <div className="flex gap-2 border-b border-gray-700">
        <button
          onClick={() => setActiveTab('list')}
          className={`px-4 py-2 font-medium transition-colors ${
            activeTab === 'list'
              ? 'text-blue-400 border-b-2 border-blue-400'
              : 'text-gray-400 hover:text-white'
          }`}
        >
          é…ç½®åˆ—è¡¨
        </button>
        <button
          onClick={() => setActiveTab('supported')}
          className={`px-4 py-2 font-medium transition-colors ${
            activeTab === 'supported'
              ? 'text-blue-400 border-b-2 border-blue-400'
              : 'text-gray-400 hover:text-white'
          }`}
        >
          æ”¯æŒçš„äº¤æ˜“æ‰€
        </button>
      </div>

      {/* é…ç½®åˆ—è¡¨ */}
      {activeTab === 'list' && (
        <div className="bg-gray-800/50 backdrop-blur-sm rounded-lg border border-gray-700 overflow-hidden">
          {loading ? (
            <div className="p-8 text-center text-gray-400">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
              åŠ è½½ä¸­...
            </div>
          ) : exchanges.length === 0 ? (
            <div className="p-8 text-center text-gray-400">
              æš‚æ— äº¤æ˜“æ‰€é…ç½®
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-900/50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                      äº¤æ˜“æ‰€
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                      å¸‚åœºç±»å‹
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                      çŠ¶æ€
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                      ç¯å¢ƒ
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                      åˆ›å»ºæ—¶é—´
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                      æ“ä½œ
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-700">
                  {exchanges.map((exchange) => (
                    <tr key={exchange.id} className="hover:bg-gray-700/30 transition-colors">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center gap-2">
                          <span className="text-2xl">
                            {exchange.name === 'binance' ? 'ğŸŸ¡' : 'ğŸ”·'}
                          </span>
                          <div>
                            <div className="text-sm font-medium text-white">
                              {exchange.display_name}
                            </div>
                            <div className="text-xs text-gray-400">
                              {exchange.name}
                            </div>
                          </div>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className="px-2 py-1 text-xs font-medium bg-gray-700 text-gray-300 rounded">
                          {exchange.market_type}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        {exchange.is_active ? (
                          <span className="px-2 py-1 text-xs font-medium bg-green-900/30 text-green-400 rounded flex items-center gap-1 w-fit">
                            <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            æ¿€æ´»ä¸­
                          </span>
                        ) : (
                          <span className="px-2 py-1 text-xs font-medium bg-gray-700 text-gray-400 rounded">
                            æœªæ¿€æ´»
                          </span>
                        )}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {exchange.testnet ? 'æµ‹è¯•ç½‘' : 'ä¸»ç½‘'}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                        {new Date(exchange.created_at).toLocaleString('zh-CN')}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm">
                        {!exchange.is_active && (
                          <button
                            onClick={() => handleDelete(exchange.id, exchange.display_name)}
                            className="text-red-400 hover:text-red-300 transition-colors"
                          >
                            åˆ é™¤
                          </button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}

      {/* æ”¯æŒçš„äº¤æ˜“æ‰€ */}
      {activeTab === 'supported' && (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {supportedExchanges.map((exchange) => (
            <div
              key={exchange.name}
              className="bg-gray-800/50 backdrop-blur-sm rounded-lg p-6 border border-gray-700"
            >
              <div className="flex items-start justify-between mb-4">
                <div className="flex items-center gap-3">
                  <span className="text-4xl">
                    {exchange.name === 'binance' ? 'ğŸŸ¡' : 'ğŸ”·'}
                  </span>
                  <div>
                    <h3 className="text-xl font-bold text-white">
                      {exchange.display_name}
                    </h3>
                    <p className="text-sm text-gray-400">{exchange.name}</p>
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <div className="flex items-center justify-between text-sm">
                  <span className="text-gray-400">ç°è´§äº¤æ˜“</span>
                  <span className={exchange.supports_spot ? 'text-green-400' : 'text-red-400'}>
                    {exchange.supports_spot ? 'âœ“ æ”¯æŒ' : 'âœ— ä¸æ”¯æŒ'}
                  </span>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-gray-400">åˆçº¦äº¤æ˜“</span>
                  <span className={exchange.supports_futures ? 'text-green-400' : 'text-red-400'}>
                    {exchange.supports_futures ? 'âœ“ æ”¯æŒ' : 'âœ— ä¸æ”¯æŒ'}
                  </span>
                </div>
              </div>

              {exchange.name === 'binance' && (
                <div className="mt-4 p-3 bg-yellow-900/20 border border-yellow-700 rounded-lg">
                  <p className="text-xs text-yellow-400">
                    âš ï¸ éœ€è¦é…ç½® BINANCE_API_KEY å’Œ BINANCE_API_SECRET
                  </p>
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

