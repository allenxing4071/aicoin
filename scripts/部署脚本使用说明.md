# 🚀 AIcoin 部署脚本 - 快速使用指南

## 一句话总结

| 场景 | 使用脚本 | 命令 |
|------|---------|------|
| **开发阶段频繁修改代码** | `deploy-rsync.sh` | `./scripts/deploy-rsync.sh` |
| **正式发布新版本** | `deploy-git.sh` | `./scripts/deploy-git.sh` |
| **仅修改配置文件** | `deploy-quick.sh` | `./scripts/deploy-quick.sh` |

---

## 🆚 Git vs rsync 对比

### Git 方式（更专业）

```bash
# 工作流程
git add .
git commit -m "功能描述"
git push origin main

# 服务器执行
git pull origin main
docker compose build --no-cache
docker compose up -d
```

**优点：**
- ✅ 有完整的版本历史
- ✅ 可以随时回滚
- ✅ 团队协作更规范
- ✅ 有代码审计记录

**缺点：**
- ❌ 需要先 commit（即使是小改动）
- ❌ 需要 push 到远程仓库
- ❌ 速度稍慢（需要经过 Git 服务器）

---

### rsync 方式（更快速）

```bash
# 工作流程
直接运行 ./scripts/deploy-rsync.sh

# 自动执行
rsync 同步代码（仅传输修改的文件）
docker compose build --no-cache
docker compose up -d
```

**优点：**
- ✅ 速度极快（增量传输）
- ✅ 无需 commit
- ✅ 无需 push
- ✅ 开发阶段更灵活

**缺点：**
- ❌ 没有版本历史
- ❌ 无法回滚
- ❌ 不适合多人协作

---

## 🎯 推荐使用策略

### 场景 1：开发阶段（快速迭代）

**使用 rsync：**
```bash
# 修改了 frontend/app/page.tsx
./scripts/deploy-rsync.sh

# 优势：立即部署，无需 commit
# 速度：5-10 秒（增量传输）
```

---

### 场景 2：功能完成（提交记录）

**使用 Git：**
```bash
# 提交代码
git add .
git commit -m "feat: 添加用户权限管理功能"

# 部署
./scripts/deploy-git.sh

# 优势：有版本记录，可追踪
# 速度：15-20 秒
```

---

### 场景 3：修改配置文件

**使用快速重启：**
```bash
# 仅修改了 .env 或 docker-compose.yml
./scripts/deploy-quick.sh

# 优势：不重新构建镜像
# 速度：3-5 秒
```

---

### 场景 4：正式发布版本

**使用 Git + 标签：**
```bash
# 打版本标签
git tag -a v3.3.0 -m "Release: RBAC权限系统"
git push origin v3.3.0

# 部署
./scripts/deploy-git.sh

# 优势：版本清晰，便于回滚
```

---

## 📊 实际使用示例

### 示例 1：修复 Bug（开发环境）

```bash
# 1. 修改代码
vim backend/app/api/v1/admin_rbac.py

# 2. 快速部署（无需 commit）
./scripts/deploy-rsync.sh

# 3. 浏览器测试
# 4. 如果有问题，继续修改并重新部署
```

**时间：** 5-10 秒/次，可以快速迭代

---

### 示例 2：新功能开发完成（生产环境）

```bash
# 1. 提交代码
git add .
git commit -m "feat: 添加日志管理功能"

# 2. 打标签
git tag -a v3.3.1 -m "Release: 日志管理"
git push origin main --tags

# 3. 部署
./scripts/deploy-git.sh

# 4. 验证
# 5. 如果有问题，可以回滚到上一个 tag
```

**时间：** 15-20 秒，有版本记录

---

### 示例 3：修改环境变量

```bash
# 1. 修改 .env 文件
vim .env

# 2. 同步到服务器
rsync -avz .env root@47.250.132.166:/root/AIcoin/

# 3. 快速重启
./scripts/deploy-quick.sh

# 4. 验证新配置
```

**时间：** 3-5 秒，仅重启服务

---

## 🔄 混合使用策略（推荐）

```
开发阶段：
  修改代码 → rsync 快速部署 → 测试 → 继续修改
          ↓
功能完成：
  git commit → 本地测试通过
          ↓
测试环境：
  git push → deploy-git.sh → 测试
          ↓
生产环境：
  git tag v3.x.x → deploy-git.sh → 正式发布
```

---

## ⚙️ 脚本内部流程

### deploy-rsync.sh 流程

```
1️⃣ 检查本地环境
   ├─ SSH 密钥是否存在
   └─ 项目目录是否存在

2️⃣ 测试服务器连接
   └─ SSH 能否连接成功

3️⃣ rsync 同步代码
   ├─ 排除 node_modules/
   ├─ 排除 .next/
   ├─ 排除 logs/
   └─ 仅传输修改的文件

4️⃣ 服务器构建镜像
   ├─ docker compose down
   ├─ docker compose build frontend --no-cache
   ├─ docker compose build backend --no-cache
   └─ docker compose up -d

5️⃣ 验证部署
   └─ docker compose ps
```

---

### deploy-git.sh 流程

```
1️⃣ 检查 Git 状态
   ├─ 是否有未提交的更改？
   └─ 提示用户提交

2️⃣ 推送到远程仓库
   └─ git push origin main

3️⃣ 服务器拉取代码
   └─ git pull origin main

4️⃣ 服务器构建镜像
   ├─ docker compose down
   ├─ docker compose build --no-cache
   └─ docker compose up -d

5️⃣ 验证部署
   └─ docker compose ps
```

---

## 🛠️ 自定义配置

### 修改服务器地址

编辑脚本开头：

```bash
SERVER_USER="root"
SERVER_HOST="47.250.132.166"
SERVER_PATH="/root/AIcoin"
```

### 修改 rsync 排除规则

在 `deploy-rsync.sh` 中：

```bash
rsync -avz --delete \
    --exclude='node_modules/' \
    --exclude='.next/' \
    --exclude='your-custom-folder/' \  # 添加自定义排除
    ...
```

---

## ❓ 常见问题

### Q: rsync 和 Git 能同时使用吗？

**A:** 可以！推荐策略：
- 开发阶段用 rsync 快速迭代
- 功能完成后用 Git 提交记录
- 正式发布时用 Git 打标签

### Q: 如何回滚到上一个版本？

**A:** 使用 Git 方式部署的才能回滚：
```bash
# 在服务器上
git log --oneline  # 查看历史
git checkout v3.3.0  # 回滚到指定版本
docker compose build --no-cache
docker compose up -d
```

### Q: rsync 会删除服务器上的文件吗？

**A:** 会！`--delete` 参数会删除服务器上本地没有的文件。
如果不想删除，可以去掉这个参数。

---

## 📈 性能数据（实测）

| 场景 | rsync | Git | 快速重启 |
|------|-------|-----|---------|
| 首次部署 | 30秒 | 45秒 | - |
| 修改 1 个文件 | 5秒 | 12秒 | - |
| 修改 10 个文件 | 8秒 | 15秒 | - |
| 仅重启服务 | - | - | 3秒 |

---

## ✅ 最佳实践

1. **开发阶段**：优先使用 `deploy-rsync.sh`
2. **功能完成**：使用 `deploy-git.sh` 并打 commit
3. **正式发布**：使用 `deploy-git.sh` 并打 tag
4. **配置修改**：使用 `deploy-quick.sh`
5. **定期提交**：即使用 rsync，也要定期 git commit 保存进度

---

## 📞 遇到问题？

1. 查看脚本日志输出（有详细错误信息）
2. SSH 到服务器手动排查：
   ```bash
   ssh -i ssh-configs/cloud-servers/AIcoin.pem root@47.250.132.166
   cd /root/AIcoin
   docker compose logs --tail=100
   ```
3. 检查 `.gitignore` 是否正确配置
4. 确认 SSH 密钥权限（400）

---

**最后更新：** 2025-11-12

