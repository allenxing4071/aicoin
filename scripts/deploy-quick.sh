#!/bin/bash

################################################################################
# AIcoin 项目 - 快速部署脚本（仅重启服务）
# 用途：当只修改了配置文件或环境变量时使用
# 适用场景：不需要重新构建镜像的快速部署
################################################################################

set -e  # 遇到错误立即退出

# ============================================================================
# 配置区域
# ============================================================================
SERVER_USER="root"
SERVER_HOST="47.250.132.166"
SERVER_PATH="/root/AIcoin"
SSH_KEY="/Users/xinghailong/Documents/soft/AIcoin/ssh-configs/cloud-servers/AIcoin.pem"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# 辅助函数
# ============================================================================
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ============================================================================
# 主流程
# ============================================================================

echo "════════════════════════════════════════════════════════════════"
echo "  ⚡ AIcoin 项目 - 快速重启服务"
echo "════════════════════════════════════════════════════════════════"
echo ""

log_info "重启服务器上的 Docker 容器..."
ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no \
    "${SERVER_USER}@${SERVER_HOST}" << 'ENDSSH'
set -e
cd /root/AIcoin

echo "🔄 重启所有服务..."
docker compose restart

echo "⏳ 等待服务启动 (10秒)..."
sleep 10

echo "📊 检查容器状态..."
docker compose ps

echo "✅ 重启完成！"
ENDSSH

if [ $? -eq 0 ]; then
    log_success "服务重启成功"
else
    log_error "服务重启失败"
    exit 1
fi

echo ""
log_success "🎉 快速部署完成！请访问 https://jifenpay.cc 验证"
echo ""
echo "════════════════════════════════════════════════════════════════"

